<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="theme-color" content="#123456"><meta name="generator" content="Hexo 4.2.0"><meta><title>ES - Zeroornull</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="zeroornull"><meta name="msapplication-TileImage" content="icons/touch-icon-iphone.png"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="zeroornull"><meta name="apple-mobile-web-app-status-bar-style" content="default"><link rel="apple-touch-icon" sizes="144x144" href="icons/touch-icon-iphone.png"><link rel="apple-touch-icon" sizes="152x152" href="icons/touch-icon-ipad.png"><link rel="apple-touch-icon" sizes="72x72" href="icon/logo.ico"><link rel="apple-touch-icon" sizes="96x96" href="icon/logo.ico"><link rel="apple-touch-icon" sizes="128x128" href="icon/logo.ico"><link rel="apple-touch-icon" sizes="256x256" href="icon/logo.ico"><meta name="description" content="es笔记"><meta property="og:type" content="blog"><meta property="og:title" content="ES"><meta property="og:url" content="https://zeroornull.github.io/2021/04/13/ES%E7%AC%94%E8%AE%B0/"><meta property="og:site_name" content="Zeroornull"><meta property="og:description" content="es笔记"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210409154614421.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210409154701047.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20201103214857.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20201103215035.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20201103215946.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20201103220041.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20201104190359.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20201104190534.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20201104191119.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20201104191326.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20201104191248.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20201104191605.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20201104191935.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20201104192419.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20201104192729.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20201104193751.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210409174420672.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210409181128130.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210409181136903.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210412181413857.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210413103142558.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210413103153966.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210413103208875.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210413114335205.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210413132456894.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210413132716160.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210413133939545.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210413142752714.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210413165810514.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210419181937.png"><meta property="article:published_time" content="2021-04-13T05:15:06.000Z"><meta property="article:modified_time" content="2021-04-20T10:10:55.193Z"><meta property="article:author" content="Zeroornull"><meta property="article:tag" content="es"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://gitee.com/penno/blogimg/raw/master/img/image-20210409154614421.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zeroornull.github.io/2021/04/13/ES%E7%AC%94%E8%AE%B0/"},"headline":"ES","image":["https://gitee.com/penno/blogimg/raw/master/img/image-20210409154614421.png","https://gitee.com/penno/blogimg/raw/master/img/image-20210409154701047.png","https://gitee.com/penno/blogimg/raw/master/img/20201103214857.png","https://gitee.com/penno/blogimg/raw/master/img/20201103215035.png","https://gitee.com/penno/blogimg/raw/master/img/20201103215946.png","https://gitee.com/penno/blogimg/raw/master/img/20201103220041.png","https://gitee.com/penno/blogimg/raw/master/img/20201104190359.png","https://gitee.com/penno/blogimg/raw/master/img/20201104190534.png","https://gitee.com/penno/blogimg/raw/master/img/20201104191119.png","https://gitee.com/penno/blogimg/raw/master/img/20201104191326.png","https://gitee.com/penno/blogimg/raw/master/img/20201104191248.png","https://gitee.com/penno/blogimg/raw/master/img/20201104191605.png","https://gitee.com/penno/blogimg/raw/master/img/20201104191935.png","https://gitee.com/penno/blogimg/raw/master/img/20201104192419.png","https://gitee.com/penno/blogimg/raw/master/img/20201104192729.png","https://gitee.com/penno/blogimg/raw/master/img/20201104193751.png","https://gitee.com/penno/blogimg/raw/master/img/image-20210409174420672.png","https://gitee.com/penno/blogimg/raw/master/img/image-20210409181128130.png","https://gitee.com/penno/blogimg/raw/master/img/image-20210409181136903.png","https://gitee.com/penno/blogimg/raw/master/img/image-20210412181413857.png","https://gitee.com/penno/blogimg/raw/master/img/image-20210413103142558.png","https://gitee.com/penno/blogimg/raw/master/img/image-20210413103153966.png","https://gitee.com/penno/blogimg/raw/master/img/image-20210413103208875.png","https://gitee.com/penno/blogimg/raw/master/img/image-20210413114335205.png","https://gitee.com/penno/blogimg/raw/master/img/image-20210413132456894.png","https://gitee.com/penno/blogimg/raw/master/img/image-20210413132716160.png","https://gitee.com/penno/blogimg/raw/master/img/image-20210413133939545.png","https://gitee.com/penno/blogimg/raw/master/img/image-20210413142752714.png","https://gitee.com/penno/blogimg/raw/master/img/image-20210413165810514.png","https://gitee.com/penno/blogimg/raw/master/img/20210419181937.png"],"datePublished":"2021-04-13T05:15:06.000Z","dateModified":"2021-04-20T10:10:55.193Z","author":{"@type":"Person","name":"Zeroornull"},"description":"es笔记"}</script><link rel="canonical" href="https://zeroornull.github.io/2021/04/13/ES%E7%AC%94%E8%AE%B0/"><link rel="alternate" href="/path/to/atom.xml" title="Zeroornull" type="application/atom+xml"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!-->
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Zeroornull</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com">GitHub</a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zeroornull"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-13T05:15:06.000Z" title="2021/4/13 下午1:15:06">2021-04-13</time>发表</span><span class="level-item"><time dateTime="2021-04-20T10:10:55.193Z" title="2021/4/20 下午6:10:55">2021-04-20</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/es/">es</a></span><span class="level-item">3 小时读完 (大约30996个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">ES</h1><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>  最近的elasticsearch笔记</p>
<p>​        2021-04-20 18:05:26</p>
<span id="more"></span>

<h1 id="ES"><a href="#ES" class="headerlink" title="ES"></a>ES</h1><p>个人使用环境为 es7.12</p>
<h2 id="1-ElasticSearch-核心概念介绍"><a href="#1-ElasticSearch-核心概念介绍" class="headerlink" title="1.ElasticSearch 核心概念介绍"></a>1.ElasticSearch 核心概念介绍</h2><h3 id="4-1-ElasticSearch-十大核心概念"><a href="#4-1-ElasticSearch-十大核心概念" class="headerlink" title="4.1 ElasticSearch 十大核心概念"></a>4.1 ElasticSearch 十大核心概念</h3><h4 id="4-1-1-集群（Cluster）"><a href="#4-1-1-集群（Cluster）" class="headerlink" title="4.1.1 集群（Cluster）"></a>4.1.1 集群（Cluster）</h4><p>一个或者多个安装了 es 节点的服务器组织在一起，就是集群，这些节点共同持有数据，共同提供搜索服务。</p>
<p>一个集群有一个名字，这个名字是集群的唯一标识，该名字成为 cluster name，默认的集群名称是 elasticsearch，具有相同名称的节点才会组成一个集群。</p>
<p>可以在 config/elasticsearch.yml 文件中配置集群名称：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: javaboy-es</span><br></pre></td></tr></tbody></table></figure>

<p>在集群中，节点的状态有三种：绿色、黄色、红色：</p>
<ul>
<li>绿色：节点运行状态为健康状态。所有的主分片、副本分片都可以正常工作。</li>
<li>黄色：表示节点的运行状态为警告状态，所有的主分片目前都可以直接运行，但是至少有一个副本分片是不能正常工作的。</li>
<li>红色：表示集群无法正常工作。</li>
</ul>
<h4 id="4-1-2-节点（Node）"><a href="#4-1-2-节点（Node）" class="headerlink" title="4.1.2 节点（Node）"></a>4.1.2 节点（Node）</h4><p>集群中的一个服务器就是一个节点，节点中会存储数据，同时参与集群的索引以及搜索功能。一个节点想要加入一个集群，只需要配置一下集群名称即可。默认情况下，如果我们启动了多个节点，多个节点还能够互相发现彼此，那么它们会自动组成一个集群，这是 es 默认提供的，但是这种方式并不可靠，有可能会发生脑裂现象。所以在实际使用中，建议一定手动配置一下集群信息。</p>
<h4 id="4-1-3-索引（Index）"><a href="#4-1-3-索引（Index）" class="headerlink" title="4.1.3 索引（Index）"></a>4.1.3 索引（Index）</h4><p>索引可以从两方面来理解：</p>
<p><strong>名词</strong></p>
<p>具有相似特征文档的集合。</p>
<p><strong>动词</strong></p>
<p>索引数据以及对数据进行索引操作。</p>
<h4 id="4-1-4-类型（Type）"><a href="#4-1-4-类型（Type）" class="headerlink" title="4.1.4 类型（Type）"></a>4.1.4 类型（Type）</h4><p>类型是索引上的逻辑分类或者分区。在 es6 之前，一个索引中可以有多个类型，从 es7 开始，一个索引中，只能有一个类型。在 es6.x 中，依然保持了兼容，依然支持单 index 多个 type 结构，但是已经不建议这么使用。</p>
<h4 id="4-1-5-文档（Document）"><a href="#4-1-5-文档（Document）" class="headerlink" title="4.1.5 文档（Document）"></a>4.1.5 文档（Document）</h4><p>一个可以被索引的数据单元。例如一个用户的文档、一个产品的文档等等。文档都是 JSON 格式的。</p>
<h4 id="4-1-6-分片（Shards）"><a href="#4-1-6-分片（Shards）" class="headerlink" title="4.1.6 分片（Shards）"></a>4.1.6 分片（Shards）</h4><p>索引都是存储在节点上的，但是受限于节点的空间大小以及数据处理能力，单个节点的处理效果可能不理想，此时我们可以对索引进行分片。当我们创建一个索引的时候，就需要指定分片的数量。每个分片本身也是一个功能完善并且独立的索引。</p>
<p>默认情况下，一个索引会自动创建 1 个分片，并且为每一个分片创建一个副本。</p>
<h4 id="4-1-7-副本（Replicas）"><a href="#4-1-7-副本（Replicas）" class="headerlink" title="4.1.7 副本（Replicas）"></a>4.1.7 副本（Replicas）</h4><p>副本也就是备份，是对主分片的一个备份。</p>
<h4 id="4-1-8-Settings"><a href="#4-1-8-Settings" class="headerlink" title="4.1.8 Settings"></a>4.1.8 Settings</h4><p>集群中对索引的定义信息，例如索引的分片数、副本数等等。</p>
<h4 id="4-1-9-Mapping"><a href="#4-1-9-Mapping" class="headerlink" title="4.1.9 Mapping"></a>4.1.9 Mapping</h4><p>Mapping 保存了定义索引字段的存储类型、分词方式、是否存储等信息。</p>
<h4 id="4-1-10-Analyzer"><a href="#4-1-10-Analyzer" class="headerlink" title="4.1.10 Analyzer"></a>4.1.10 Analyzer</h4><p>字段分词方式的定义。</p>
<h3 id="4-2-ElasticSearch-Vs-关系型数据库"><a href="#4-2-ElasticSearch-Vs-关系型数据库" class="headerlink" title="4.2 ElasticSearch Vs 关系型数据库"></a>4.2 ElasticSearch Vs 关系型数据库</h3><table>
<thead>
<tr>
<th align="left">关系型数据库</th>
<th align="left">ElasticSearch</th>
</tr>
</thead>
<tbody><tr>
<td align="left">数据库</td>
<td align="left">索引</td>
</tr>
<tr>
<td align="left">表</td>
<td align="left">类型</td>
</tr>
<tr>
<td align="left">行</td>
<td align="left">文档</td>
</tr>
<tr>
<td align="left">列</td>
<td align="left">字段</td>
</tr>
<tr>
<td align="left">表结构</td>
<td align="left">映射（Mapping）</td>
</tr>
<tr>
<td align="left">SQL</td>
<td align="left">DSL(Domain Specific Language)</td>
</tr>
<tr>
<td align="left">Select * from xxx</td>
<td align="left">GET http://</td>
</tr>
<tr>
<td align="left">update xxx set xx=xxx</td>
<td align="left">PUT http://</td>
</tr>
<tr>
<td align="left">Delete xxx</td>
<td align="left">DELETE http://</td>
</tr>
<tr>
<td align="left">索引</td>
<td align="left">全文索引</td>
</tr>
</tbody></table>
<h2 id="2-ElasticSearch-分词器"><a href="#2-ElasticSearch-分词器" class="headerlink" title="2.ElasticSearch 分词器"></a>2.ElasticSearch 分词器</h2><h3 id="1-1-内置分词器"><a href="#1-1-内置分词器" class="headerlink" title="1.1 内置分词器"></a>1.1 内置分词器</h3><p>ElasticSearch 核心功能就是数据检索，首先通过索引将文档写入 es。查询分析则主要分为两个步骤：</p>
<ol>
<li>词条化：<strong>分词器</strong>将输入的文本转为一个一个的词条流。</li>
<li>过滤：比如停用词过滤器会从词条中去除不相干的词条（的，嗯，啊，呢）停用词；另外还有同义词过滤器、小写过滤器等。</li>
</ol>
<p>ElasticSearch 中内置了多种分词器可以供使用。</p>
<p>内置分词器：</p>
<table>
<thead>
<tr>
<th align="left">分词器</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Standard Analyzer</td>
<td align="left">标准分词器，适用于英语等。</td>
</tr>
<tr>
<td align="left">Simple Analyzer</td>
<td align="left">简单分词器，基于非字母字符进行分词，单词会被转为小写字母。</td>
</tr>
<tr>
<td align="left">Whitespace Analyzer</td>
<td align="left">空格分词器。按照空格进行切分。</td>
</tr>
<tr>
<td align="left">Stop Analyzer</td>
<td align="left">类似于简单分词器，但是增加了停用词的功能。</td>
</tr>
<tr>
<td align="left">Keyword Analyzer</td>
<td align="left">关键词分词器，输入文本等于输出文本。</td>
</tr>
<tr>
<td align="left">Pattern Analyzer</td>
<td align="left">利用正则表达式对文本进行切分，支持停用词。</td>
</tr>
<tr>
<td align="left">Language Analyzer</td>
<td align="left">针对特定语言的分词器。</td>
</tr>
<tr>
<td align="left">Fingerprint Analyzer</td>
<td align="left">指纹分析仪分词器，通过创建标记进行重复检测。</td>
</tr>
</tbody></table>
<h3 id="1-2-中文分词器"><a href="#1-2-中文分词器" class="headerlink" title="1.2 中文分词器"></a>1.2 中文分词器</h3><p>在 Es 中，使用较多的中文分词器是 elasticsearch-analysis-ik，这个是 es 的一个第三方插件，代码托管在 GitHub 上：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></li>
</ul>
<h4 id="1-2-1-安装"><a href="#1-2-1-安装" class="headerlink" title="1.2.1 安装"></a>1.2.1 安装</h4><p>两种使用方式：</p>
<p><strong>第一种：</strong></p>
<ol>
<li>首先打开分词器官网：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik%E3%80%82">https://github.com/medcl/elasticsearch-analysis-ik。</a></li>
<li>在 <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a> 页面找到最新的正式版，下载下来。我们这里的下载链接是 <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.3/elasticsearch-analysis-ik-7.9.3.zip%E3%80%82">https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.3/elasticsearch-analysis-ik-7.9.3.zip。</a></li>
<li>将下载文件解压。</li>
<li>在 es/plugins 目录下，新建 ik 目录，并将解压后的所有文件拷贝到 ik 目录下。</li>
<li>重启 es 服务。</li>
</ol>
<p><strong>第二种：</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.3/elasticsearch-analysis-ik-7.9.3.zip</span><br></pre></td></tr></tbody></table></figure>

<h4 id="1-2-2-测试"><a href="#1-2-2-测试" class="headerlink" title="1.2.2 测试"></a>1.2.2 测试</h4><p>es 重启成功后，首先创建一个名为 test 的索引：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210409154614421.png" alt="image-20210409154614421"></p>
<p>接下来，在该索引中进行分词测试：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210409154701047.png" alt="image-20210409154701047"></p>
<h4 id="1-2-3-自定义扩展词库"><a href="#1-2-3-自定义扩展词库" class="headerlink" title="1.2.3 自定义扩展词库"></a>1.2.3 自定义扩展词库</h4><h5 id="1-2-3-1-本地自定义"><a href="#1-2-3-1-本地自定义" class="headerlink" title="1.2.3.1 本地自定义"></a>1.2.3.1 本地自定义</h5><p>在 es/plugins/ik/config 目录下，新建 ext.dic 文件（文件名任意），在该文件中可以配置自定义的词库。</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20201103214857.png" alt="img"></p>
<p>如果有多个词，换行写入新词即可。</p>
<p>然后在 es/plugins/ik/config/IKAnalyzer.cfg.xml 中配置扩展词典的位置：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20201103215035.png" alt="img"></p>
<h5 id="1-2-3-2-远程词库"><a href="#1-2-3-2-远程词库" class="headerlink" title="1.2.3.2 远程词库"></a>1.2.3.2 远程词库</h5><p>也可以配置远程词库，远程词库支持热更新（不用重启 es 就可以生效）。</p>
<p>热更新只需要提供一个接口，接口返回扩展词即可。</p>
<p>具体使用方式如下，新建一个 Spring Boot 项目，引入 Web 依赖即可。然后在 resources/stastic 目录下新建 ext.dic 文件，写入扩展词：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20201103215946.png" alt="img"></p>
<p>接下来，在 es/plugins/ik/config/IKAnalyzer.cfg.xml 文件中配置远程扩展词接口：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20201103220041.png" alt="img"></p>
<p>配置完成后，重启 es ，即可生效。</p>
<p>热更新，主要是响应头的 <code>Last-Modified</code> 或者 <code>ETag</code> 字段发生变化，ik 就会自动重新加载远程扩展辞典。</p>
<h2 id="3-ElasticSearch-索引管理"><a href="#3-ElasticSearch-索引管理" class="headerlink" title="3. ElasticSearch 索引管理"></a>3. ElasticSearch 索引管理</h2><p>启动一个 master 节点和两个 slave 节点进行测试。</p>
<h3 id="2-1-新建索引"><a href="#2-1-新建索引" class="headerlink" title="2.1 新建索引"></a>2.1 新建索引</h3><h4 id="2-1-1-通过-head-插件新建索引"><a href="#2-1-1-通过-head-插件新建索引" class="headerlink" title="2.1.1 通过 head 插件新建索引"></a>2.1.1 通过 head 插件新建索引</h4><p>在 head 插件中，选择 索引选项卡，然后点击新建索引。新建索引时，需要填入索引名称、分片数以及副本数。</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20201104190359.png" alt="img"></p>
<p>索引创建成功后，如下图：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20201104190534.png" alt="img"></p>
<p>0、1、2、3、4 分别表示索引的分片，粗框表示主分片，细框表示副本（点一下框，通过 primary 属性可以查看是主分片还是副本）。.kibana 索引只有一个分片和一个副本，所以只有 0。</p>
<h4 id="2-1-2-通过请求创建"><a href="#2-1-2-通过请求创建" class="headerlink" title="2.1.2 通过请求创建"></a>2.1.2 通过请求创建</h4><p>可以通过 postman 发送请求，也可以通过 kibana 发送请求，由于 kibana 有提示，所以这里采用 kibana。</p>
<p>创建索引请求：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT book</span><br></pre></td></tr></tbody></table></figure>

<p>创建成功后，可以查看索引信息：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20201104191119.png" alt="img"></p>
<p>需要注意两点：</p>
<ul>
<li>索引名称不能有大写字母</li>
</ul>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20201104191326.png" alt="img"></p>
<ul>
<li>索引名是唯一的，不能重复，重复创建会出错</li>
</ul>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20201104191248.png" alt="img"></p>
<h3 id="2-2-更新索引"><a href="#2-2-更新索引" class="headerlink" title="2.2 更新索引"></a>2.2 更新索引</h3><p>索引创建好之后，可以修改其属性。</p>
<p>例如修改索引的副本数：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT book/_settings</span><br><span class="line">{</span><br><span class="line">  "number_of_replicas": 2</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>修改成功后，如下：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20201104191605.png" alt="img"></p>
<p>更新分片数也是一样。</p>
<h3 id="2-3-修改索引的读写权限"><a href="#2-3-修改索引的读写权限" class="headerlink" title="2.3 修改索引的读写权限"></a>2.3 修改索引的读写权限</h3><p>索引创建成功后，可以向索引中写入文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT book/_doc/1</span><br><span class="line">{</span><br><span class="line">  "title":"三国演义"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>写入成功后，可以在 head 插件中查看：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20201104191935.png" alt="img"></p>
<p>默认情况下，索引是具备读写权限的，当然这个读写权限可以关闭。</p>
<p>例如，关闭索引的写权限：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT book/_settings</span><br><span class="line">{</span><br><span class="line">  "blocks.write": true</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>关闭之后，就无法添加文档了。关闭了写权限之后，如果想要再次打开，方式如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT book/_settings</span><br><span class="line">{</span><br><span class="line">  "blocks.write": false</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其他类似的权限有：</p>
<ul>
<li>blocks.write</li>
<li>blocks.read</li>
<li>blocks.read_only</li>
</ul>
<h3 id="2-4-查看索引"><a href="#2-4-查看索引" class="headerlink" title="2.4 查看索引"></a>2.4 查看索引</h3><p>head 插件查看方式如下：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20201104192419.png" alt="img"></p>
<p>请求查看方式如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET book/_settings</span><br></pre></td></tr></tbody></table></figure>

<p>也可以同时查看多个索引信息：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET book,test/_settings</span><br></pre></td></tr></tbody></table></figure>

<p>也可以查看所有索引信息：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET book,test/_settings</span><br></pre></td></tr></tbody></table></figure>

<h3 id="2-5-删除索引"><a href="#2-5-删除索引" class="headerlink" title="2.5 删除索引"></a>2.5 删除索引</h3><p>head 插件可以删除索引：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20201104192729.png" alt="img"></p>
<p>请求删除如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE test</span><br></pre></td></tr></tbody></table></figure>

<p>删除一个不存在的索引会报错。</p>
<h3 id="5-6-索引打开-关闭"><a href="#5-6-索引打开-关闭" class="headerlink" title="5.6 索引打开/关闭"></a>5.6 索引打开/关闭</h3><p>关闭索引：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST book/_close</span><br></pre></td></tr></tbody></table></figure>

<p>打开索引：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST book/_open</span><br></pre></td></tr></tbody></table></figure>

<p>当然，可以同时关闭/打开多个索引，多个索引用 , 隔开，或者直接使用 _all 代表所有索引。</p>
<h3 id="2-7-复制索引"><a href="#2-7-复制索引" class="headerlink" title="2.7 复制索引"></a>2.7 复制索引</h3><p>索引复制，只会复制数据，不会复制索引配置。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">{</span><br><span class="line">  "source": {"index":"book"},</span><br><span class="line">  "dest": {"index":"book_new"}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>复制的时候，可以添加查询条件。</p>
<h3 id="2-8-索引别名"><a href="#2-8-索引别名" class="headerlink" title="2.8 索引别名"></a>2.8 索引别名</h3><p>可以为索引创建别名，如果这个别名是唯一的，该别名可以代替索引名称。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">{</span><br><span class="line">  "actions": [</span><br><span class="line">    {</span><br><span class="line">      "add": {</span><br><span class="line">        "index": "book",</span><br><span class="line">        "alias": "book_alias"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>添加结果如下：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20201104193751.png" alt="img"></p>
<p>将 add 改为 remove 就表示移除别名：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">{</span><br><span class="line">  "actions": [</span><br><span class="line">    {</span><br><span class="line">      "remove": {</span><br><span class="line">        "index": "book",</span><br><span class="line">        "alias": "book_alias"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查看某一个索引的别名：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_alias</span><br></pre></td></tr></tbody></table></figure>

<p>查看某一个别名对应的索引（book_alias 表示一个别名）：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /book_alias/_alias</span><br></pre></td></tr></tbody></table></figure>

<p>可以查看集群上所有可用别名：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_alias</span><br></pre></td></tr></tbody></table></figure>

<h2 id="6-ElasticSearch-文档基本操作"><a href="#6-ElasticSearch-文档基本操作" class="headerlink" title="6.ElasticSearch 文档基本操作"></a>6.ElasticSearch 文档基本操作</h2><h3 id="6-1创建文档"><a href="#6-1创建文档" class="headerlink" title="6.1创建文档"></a>6.1创建文档</h3><p>首先新建一个索引 blog</p>
<p>然后向索引添加一个文档</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/1</span><br><span class="line">{</span><br><span class="line">  "title":"ElasticSearch 文档基本操作",</span><br><span class="line">  "data":"2021-04-09",</span><br><span class="line">  "content":"### 6.1创建文档首先新建一个索引 blog"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>1 表示新建文档的id</p>
<p>添加成功后响应的json如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "_index" : "blog",</span><br><span class="line">  "_type" : "_doc",</span><br><span class="line">  "_id" : "1",</span><br><span class="line">  "_version" : 1,</span><br><span class="line">  "result" : "created",</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 2,</span><br><span class="line">    "successful" : 2,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "_seq_no" : 0,</span><br><span class="line">  "_primary_term" : 1</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>_index 表示文档的索引。</li>
<li>_type 表示文档的类型。</li>
<li>_id 表示文档的id。</li>
<li>_version 表示文档的版本(更新文档，版本会自动+1，针对一个文档的更新)。</li>
<li>result 表示执行结果。</li>
<li>_shards 表示分片信息。</li>
<li><code>_seq_no</code>  <code>_primary_term</code> 这两个也是版本控制用的(针对当前index)</li>
</ul>
<p>添加成功后可以添加查看的文档：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210409174420672.png" alt="image-20210409174420672"></p>
<p>添加文档是也可以不指定id，此时系统会默认给出一个id，如果不指定id，则需要使用POST请求，而不能使用PUT请求</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "error" : "Incorrect HTTP method for uri [/blog/_doc?pretty=true] and method [PUT], allowed: [POST]",</span><br><span class="line">  "status" : 405</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">"_index": "blog",</span><br><span class="line">"_type": "_doc",</span><br><span class="line">"_id": "5zULtngB3KliN6uQB99S",</span><br><span class="line">"_version": 1,</span><br><span class="line">"_score": 1,</span><br><span class="line">"_source": {</span><br><span class="line">"title": "666",</span><br><span class="line">"data": "2021-04-09",</span><br><span class="line">"content": "### 6.1创建文档首先新建一个索引 blog"</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="6-2获取文档"><a href="#6-2获取文档" class="headerlink" title="6.2获取文档"></a>6.2获取文档</h3><p>Es 中提供了GET API来查看存储在es中的文档。使用方式如下</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_doc/5zULtngB3KliN6uQB99S</span><br></pre></td></tr></tbody></table></figure>

<p>上面的命令表示获取id为 5zULtngB3KliN6uQB99S 的文档。</p>
<p>如果获取不存在的文档，会返回如下信息</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "_index" : "blog",</span><br><span class="line">  "_type" : "_doc",</span><br><span class="line">  "_id" : "2",</span><br><span class="line">  "found" : false</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果仅仅只是想探测某个文档是否存在，可以使用head请求：</p>
<p>不存在的响应</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210409181128130.png" alt="image-20210409181128130"></p>
<p>存在的响应</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210409181136903.png" alt="image-20210409181136903"></p>
<p>也可以批量获取文档</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_mget</span><br><span class="line">{</span><br><span class="line">  "ids":["1","5zULtngB3KliN6uQB99S"]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>GET 请求携带了请求体？</p>
<p>某些特定请求，例如JS的HTTP请求库是不允许存在GET请求有请求体的，实际上在RFC7231文档中，并没有规定GET请求的请求体改如何处理，这造成了一定程度的混乱，有的HTTP服务器支持GET请求携带请求体，有的HTTP服务器则不支持。虽然ES工程师倾向于使用GET做查询，但是为了保证兼容性，ES同时也支持使用POST，例如上面的的批量查询案例也可以使用POST请求。</p>
<h3 id="6-3文档更新"><a href="#6-3文档更新" class="headerlink" title="6.3文档更新"></a>6.3文档更新</h3><p>文档更新一次，version就会自增1。</p>
<p>可以直接更新整个文档</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/5zULtngB3KliN6uQB99S</span><br><span class="line">{</span><br><span class="line">  "title":"666"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这总方式，更新的文档会覆盖掉原有的文档</p>
<p>只想更新文档字段，可以通过脚本来实现</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST blog/_update/1</span><br><span class="line">{</span><br><span class="line">  "script": {</span><br><span class="line">    "lang":"painless",</span><br><span class="line">    "source":"ctx._source.title=params.title",</span><br><span class="line">    "params":{</span><br><span class="line">      "title":"666666"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>更新的请求格式：POST{index}/_update/{id}</p>
<p>在脚本中lang表示脚本语言,painless是es内置的一种脚本语言，source表示具体执行的脚本，ctx是一个上下文对象，通过ctx可以访问到<code>_source</code>、<code>_title</code>等。</p>
<p>也可以通过同样的方式向文档中添加字段</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST blog/_update/1</span><br><span class="line">{</span><br><span class="line">  "script": {</span><br><span class="line">    "lang": "painless",</span><br><span class="line">    "source": "ctx._source.tags=[\"java\",\"php\"]"</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>成功后的文档如下</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "_index" : "blog",</span><br><span class="line">  "_type" : "_doc",</span><br><span class="line">  "_id" : "1",</span><br><span class="line">  "_version" : 3,</span><br><span class="line">  "_seq_no" : 2,</span><br><span class="line">  "_primary_term" : 1,</span><br><span class="line">  "found" : true,</span><br><span class="line">  "_source" : {</span><br><span class="line">    "title" : "666666",</span><br><span class="line">    "data" : "2021-04-09",</span><br><span class="line">    "content" : "### 6.1创建文档首先新建一个索引 blog",</span><br><span class="line">    "tags" : [</span><br><span class="line">      "java",</span><br><span class="line">      "php"</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h2 id="7-ElasticSearch-文档路由"><a href="#7-ElasticSearch-文档路由" class="headerlink" title="7.ElasticSearch 文档路由"></a>7.ElasticSearch 文档路由</h2><p>es 是一个分布式系统，当我们存储一个文档到 es 上之后，这个文档实际上是被存储到 master 节点中的某一个主分片上。</p>
<p>例如新建一个索引，该索引有两个分片，0个副本，如下：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210412181413857.png" alt="image-20210412181413857"></p>
<p>接下来，向该索引中保存一个文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/a</span><br><span class="line">{</span><br><span class="line">  "title":"a"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>文档保存成功后，可以查看该文档被保存到哪个分片中去了：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _cat/shards/blog?v</span><br></pre></td></tr></tbody></table></figure>

<p>查看结果如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">index shard prirep state   docs store ip        node</span><br><span class="line">blog  1     p      STARTED    0  208b 127.0.0.1 master</span><br><span class="line">blog  0     p      STARTED    0  208b 127.0.0.1 slave02</span><br></pre></td></tr></tbody></table></figure>

<p>从这个结果中，可以看出，文档被保存到分片 0 中。</p>
<p>那么 es 中到底是按照什么样的规则去分配分片的？</p>
<p>es 中的路由机制是通过哈希算法，将具有相同哈希值的文档放到一个主分片中，分片位置的计算方式如下：</p>
<p>shard=hash(routing) % number_of_primary_shards</p>
<p>routing 可以是一个任意字符串，es 默认是将文档的 id 作为 routing 值，通过哈希函数根据 routing 生成一个数字，然后将该数字和分片数取余，取余的结果就是分片的位置。</p>
<p>默认的这种路由模式，最大的优势在于负载均衡，这种方式可以保证数据平均分配在不同的分片上。但是他有一个很大的劣势，就是查询时候无法确定文档的位置，此时它会将请求广播到所有的分片上去执行。另一方面，使用默认的路由模式，后期修改分片数量不方便。</p>
<p>当然开发者也可以自定义 routing 的值，方式如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/d?routing=javaboy</span><br><span class="line">{</span><br><span class="line"> "title":"d"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果文档在添加时指定了 routing，则查询、删除、更新时也需要指定 routing。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_doc/d?routing=javaboy</span><br></pre></td></tr></tbody></table></figure>

<p>自定义 routing 有可能会导致负载不均衡，这个还是要结合实际情况选择。</p>
<p>典型场景：</p>
<p>对于用户数据，我们可以将 userid 作为 routing，这样就能保证同一个用户的数据保存在同一个分片中，检索时，同样使用 userid 作为 routing，这样就可以精准的从某一个分片中获取数据。</p>
<h2 id="8-ElasticSearch-并发的处理方式：锁和版本控制"><a href="#8-ElasticSearch-并发的处理方式：锁和版本控制" class="headerlink" title="8.ElasticSearch 并发的处理方式：锁和版本控制"></a>8.ElasticSearch 并发的处理方式：锁和版本控制</h2><p>当我们使用 es 的 API 去进行文档更新时，它首先读取原文档出来，然后对原文档进行更新，更新完成后再重新索引整个文档。不论你执行多少次更新，最终保存在 es 中的是最后一次更新的文档。但是如果有两个线程同时去更新，就有可能出问题。</p>
<p>要解决问题，就是锁。</p>
<h3 id="8-1-锁"><a href="#8-1-锁" class="headerlink" title="8.1 锁"></a>8.1 锁</h3><p><strong>悲观锁</strong></p>
<p>很悲观，每一次去读取数据的时候，都认为别人可能会修改数据，所以屏蔽一切可能破坏数据完整性的操作。关系型数据库中，悲观锁使用较多，例如行锁、表锁等等。</p>
<p><strong>乐观锁</strong></p>
<p>很乐观，每次读取数据时，都认为别人不会修改数据，因此也不锁定数据，只有在提交数据时，才会检查数据完整性。这种方式可以省去锁的开销，进而提高吞吐量。</p>
<p>在 es 中，实际上使用的就是乐观锁。</p>
<h3 id="8-2-版本控制"><a href="#8-2-版本控制" class="headerlink" title="8.2 版本控制"></a>8.2 版本控制</h3><p><strong>es6.7之前</strong></p>
<p>在 es6.7 之前，使用 version+version_type 来进行乐观并发控制。根据前面的介绍，文档每被修改一个，version 就会自增一次，es 通过 version 字段来确保所有的操作都有序进行。</p>
<p>version 分为内部版本控制和外部版本控制。</p>
<h4 id="8-2-1-内部版本"><a href="#8-2-1-内部版本" class="headerlink" title="8.2.1 内部版本"></a>8.2.1 内部版本</h4><p>es 自己维护的就是内部版本，当创建一个文档时，es 会给文档的版本赋值为 1。</p>
<p>每当用户修改一次文档，版本号就回自增 1。</p>
<p>如果使用内部版本，es 要求 version 参数的值必须和 es 文档中 version 的值相当，才能操作成功。</p>
<h4 id="8-2-2-外部版本"><a href="#8-2-2-外部版本" class="headerlink" title="8.2.2 外部版本"></a>8.2.2 外部版本</h4><p>也可以维护外部版本。</p>
<p>在添加文档时，就指定版本号：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/1?version=200&amp;version_type=external</span><br><span class="line">{</span><br><span class="line">  "title":"2222"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>以后更新的时候，版本要大于已有的版本号。</p>
<ul>
<li>version_type=external 或者 version_type=external_gt 表示以后更新的时候，版本要大于已有的版本号。</li>
<li>version_type=external_gte 表示以后更新的时候，版本要大于等于已有的版本号。</li>
</ul>
<h4 id="8-2-3-最新方案（Es6-7-之后）"><a href="#8-2-3-最新方案（Es6-7-之后）" class="headerlink" title="8.2.3 最新方案（Es6.7 之后）"></a>8.2.3 最新方案（Es6.7 之后）</h4><p>现在使用 <code>if_seq_no</code> 和 <code>if_primary_term</code> 两个参数来做并发控制。</p>
<p><code>seq_no</code> 不属于某一个文档，它是属于整个索引的（version 则是属于某一个文档的，每个文档的 version 互不影响）。现在更新文档时，使用 <code>seq_no</code> 来做并发。由于 <code>seq_no</code> 是属于整个 index 的，所以任何文档的修改或者新增，<code>seq_no</code> 都会自增。</p>
<p>现在就可以通过 <code>seq_no</code> 和 <code>primary_term</code> 来做乐观并发控制。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/2?if_seq_no=5&amp;if_primary_term=1</span><br><span class="line">{</span><br><span class="line">  "title":"6666"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="es倒排索引"><a href="#es倒排索引" class="headerlink" title="es倒排索引"></a>es倒排索引</h2><p>倒排索引是 es 中非常重要的索引结构，是从<strong>文档词项到文档 ID</strong> 的一个映射过程。</p>
<h3 id="8-1-“正排索引”"><a href="#8-1-“正排索引”" class="headerlink" title="8.1 “正排索引”"></a>8.1 “正排索引”</h3><p>我们在关系型数据库中见到的索引，就是“正排索引”。</p>
<p>关系型数据库中的索引如下，假设我有一个博客表：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210413103142558.png" alt="image-20210413103142558"></p>
<p>我们可以针对这个表建立索引（正排索引）：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210413103153966.png" alt="image-20210413103153966"></p>
<p>当我们通过 id 或者标题去搜索文章时，就可以快速搜到。</p>
<p>但是如果我们按照文章内容的关键字去搜索，就只能去内容中做字符匹配了。为了提高查询效率，就要考虑使用倒排索引。</p>
<h3 id="8-2-倒排索引"><a href="#8-2-倒排索引" class="headerlink" title="8.2 倒排索引"></a>8.2 倒排索引</h3><p>倒排索引就是以内容的关键字建立索引，通过索引找到文档 id，再进而找到整个文档。</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210413103208875.png" alt="image-20210413103208875"></p>
<p>一般来说，倒排索引分为两个部分：</p>
<ul>
<li>单词词典（记录所有的文档词项，以及词项到倒排列表的关联关系）</li>
<li>倒排列表（记录单词与对应的关系，由一系列倒排索引项组成，倒排索引项指：文档 id、词频（TF）（词项在文档中出现的次数，评分时使用）、位置（Position，词项在文档中分词的位置）、偏移（记录词项开始和结束的位置））</li>
</ul>
<p>当我们去索引一个文档时，就回建立倒排索引，搜索时，直接根据倒排索引搜索。</p>
<h2 id="9-ElasticSearch-动态映射与静态映射"><a href="#9-ElasticSearch-动态映射与静态映射" class="headerlink" title="9.ElasticSearch 动态映射与静态映射"></a>9.ElasticSearch 动态映射与静态映射</h2><p>映射就是 Mapping，它用来定义一个文档以及文档所包含的字段该如何被存储和索引。所以，它其实有点类似于关系型数据库中表的定义。</p>
<h3 id="9-1-映射分类"><a href="#9-1-映射分类" class="headerlink" title="9.1 映射分类"></a>9.1 映射分类</h3><p><strong>动态映射</strong></p>
<p>顾名思义，就是自动创建出来的映射。es 根据存入的文档，自动分析出来文档中字段的类型以及存储方式，这种就是动态映射。</p>
<p>举一个简单例子，新建一个索引，然后查看索引信息：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210413114335205.png" alt="image-20210413114335205"></p>
<p>在创建好的索引信息中，可以看到，mappings 为空，这个 mappings 中保存的就是映射信息。</p>
<p>现在我们向索引中添加一个文档，如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/1</span><br><span class="line">{</span><br><span class="line">  "title":"1111",</span><br><span class="line">  "date":"2020-11-11"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>文档添加成功后，就会自动生成 Mappings：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210413132456894.png" alt="image-20210413132456894"></p>
<p>可以看到，date 字段的类型为 date，title 的类型有两个，text 和 keyword。</p>
<p>默认情况下，文档中如果新增了字段，mappings 中也会自动新增进来。</p>
<p>有的时候，如果希望新增字段时，能够抛出异常来提醒开发者，这个可以通过 mappings 中 dynamic 属性来配置。</p>
<p>dynamic 属性有三种取值：</p>
<ul>
<li>true，默认即此。自动添加新字段。</li>
<li>false，忽略新字段。</li>
<li>strict，严格模式，发现新字段会抛出异常。</li>
</ul>
<p>具体配置方式如下，创建索引时指定 mappings（这其实就是静态映射）：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "dynamic":"strict",</span><br><span class="line">    "properties": {</span><br><span class="line">      "title":{</span><br><span class="line">        "type": "text"</span><br><span class="line">      },</span><br><span class="line">      "age":{</span><br><span class="line">        "type":"long"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后向 blog 中索引中添加数据：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/2</span><br><span class="line">{</span><br><span class="line">  "title":"1111",</span><br><span class="line">  "date":"2020-11-11",</span><br><span class="line">  "age":99</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在添加的文档中，多出了一个 date 字段，而该字段没有预定义，所以这个添加操作就回报错：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "error" : {</span><br><span class="line">    "root_cause" : [</span><br><span class="line">      {</span><br><span class="line">        "type" : "strict_dynamic_mapping_exception",</span><br><span class="line">        "reason" : "mapping set to strict, dynamic introduction of [date] within [_doc] is not allowed"</span><br><span class="line">      }</span><br><span class="line">    ],</span><br><span class="line">    "type" : "strict_dynamic_mapping_exception",</span><br><span class="line">    "reason" : "mapping set to strict, dynamic introduction of [date] within [_doc] is not allowed"</span><br><span class="line">  },</span><br><span class="line">  "status" : 400</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>动态映射还有一个日期检测的问题。</p>
<p>例如新建一个索引，然后添加一个含有日期的文档，如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/1</span><br><span class="line">{</span><br><span class="line">  "remark":"2020-11-11"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>添加成功后，remark 字段会被推断是一个日期类型。</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210413132716160.png" alt="image-20210413132716160"></p>
<p>此时，remark 字段就无法存储其他类型了。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/1</span><br><span class="line">{</span><br><span class="line">  "remark":"javaboy"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>此时报错如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "error" : {</span><br><span class="line">    "root_cause" : [</span><br><span class="line">      {</span><br><span class="line">        "type" : "mapper_parsing_exception",</span><br><span class="line">        "reason" : "failed to parse field [remark] of type [date] in document with id '1'. Preview of field's value: 'javaboy'"</span><br><span class="line">      }</span><br><span class="line">    ],</span><br><span class="line">    "type" : "mapper_parsing_exception",</span><br><span class="line">    "reason" : "failed to parse field [remark] of type [date] in document with id '1'. Preview of field's value: 'javaboy'",</span><br><span class="line">    "caused_by" : {</span><br><span class="line">      "type" : "illegal_argument_exception",</span><br><span class="line">      "reason" : "failed to parse date field [javaboy] with format [strict_date_optional_time||epoch_millis]",</span><br><span class="line">      "caused_by" : {</span><br><span class="line">        "type" : "date_time_parse_exception",</span><br><span class="line">        "reason" : "Failed to parse with all enclosed parsers"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "status" : 400</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>要解决这个问题，可以使用静态映射，即在索引定义时，将 remark 指定为 text 类型。也可以关闭日期检测。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "date_detection": false</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>此时日期类型就回当成文本来处理。</p>
<p><strong>静态映射</strong></p>
<p>略。</p>
<h3 id="9-2-类型推断"><a href="#9-2-类型推断" class="headerlink" title="9.2 类型推断"></a>9.2 类型推断</h3><p>es 中动态映射类型推断方式如下：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210413133939545.png" alt="image-20210413133939545"></p>
<h2 id="10-ElasticSearch-四种字段类型详解"><a href="#10-ElasticSearch-四种字段类型详解" class="headerlink" title="10.ElasticSearch 四种字段类型详解"></a>10.ElasticSearch 四种字段类型详解</h2><h3 id="10-1-核心类型"><a href="#10-1-核心类型" class="headerlink" title="10.1 核心类型"></a>10.1 核心类型</h3><h4 id="10-1-1-字符串类型"><a href="#10-1-1-字符串类型" class="headerlink" title="10.1.1 字符串类型"></a>10.1.1 字符串类型</h4><ul>
<li>string：这是一个已经过期的字符串类型。在 es5 之前，用这个来描述字符串，现在的话，它已经被 text 和 keyword 替代了。</li>
<li>text：如果一个字段是要被全文检索的，比如说博客内容、新闻内容、产品描述，那么可以使用 text。用了 text 之后，字段内容会被分析，在生成倒排索引之前，字符串会被分词器分成一个个词项。text 类型的字段不用于排序，很少用于聚合。这种字符串也被称为 analyzed 字段。</li>
<li>keyword：这种类型适用于结构化的字段，例如标签、email 地址、手机号码等等，这种类型的字段可以用作过滤、排序、聚合等。这种字符串也称之为 not-analyzed 字段。</li>
</ul>
<h4 id="10-1-2-数字类型"><a href="#10-1-2-数字类型" class="headerlink" title="10.1.2 数字类型"></a>10.1.2 数字类型</h4><p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210413142752714.png" alt="image-20210413142752714"></p>
<ul>
<li>在满足需求的情况下，优先使用范围小的字段。字段长度越短，索引和搜索的效率越高。</li>
<li>浮点数，优先考虑使用 scaled_float。通过缩放因子（底层将一个浮点数变为整数和一个缩放倍数，用来节省空间）将浮点数缩放，更好的空间利用</li>
</ul>
<p>在使用scaled_float时，需要制定缩放因子scaled_float</p>
<p>scaled_float 举例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT product</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "name":{</span><br><span class="line">        "type": "text"</span><br><span class="line">      },</span><br><span class="line">      "price":{</span><br><span class="line">        "type": "scaled_float",</span><br><span class="line">        "scaling_factor": 100</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="10-1-3-日期类型"><a href="#10-1-3-日期类型" class="headerlink" title="10.1.3 日期类型"></a>10.1.3 日期类型</h4><p>由于 JSON 中没有日期类型，所以 es 中的日期类型形式就比较多样：</p>
<ul>
<li>2020-11-11 或者 2020-11-11 11:11:11</li>
<li>一个从 1970.1.1 零点到现在的一个秒数或者毫秒数。</li>
</ul>
<p>es 内部将时间转为 UTC，然后将时间按照 millseconds-since-the-epoch 的长整型来存储。</p>
<p>自定义日期类型：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT product</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "date":{</span><br><span class="line">        "type": "date"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个能够解析出来的时间格式比较多。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT product/_doc/1</span><br><span class="line">{</span><br><span class="line">  "date":"2020-11-11"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT product/_doc/2</span><br><span class="line">{</span><br><span class="line">  "date":"2020-11-11T11:11:11Z"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT product/_doc/3</span><br><span class="line">{</span><br><span class="line">  "date":"1604672099958"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>上面三个文档中的日期都可以被解析，内部存储的是毫秒计时的长整型数。</p>
<h4 id="10-1-4-布尔类型（boolean）"><a href="#10-1-4-布尔类型（boolean）" class="headerlink" title="10.1.4 布尔类型（boolean）"></a>10.1.4 布尔类型（boolean）</h4><p>JSON 中的 “true”、“false”、true、false 都可以。</p>
<h4 id="10-1-5-二进制类型（binary）"><a href="#10-1-5-二进制类型（binary）" class="headerlink" title="10.1.5 二进制类型（binary）"></a>10.1.5 二进制类型（binary）</h4><p>二进制接受的是 base64 编码的字符串，默认不存储，也不可搜索。</p>
<h4 id="10-1-6-范围类型"><a href="#10-1-6-范围类型" class="headerlink" title="10.1.6 范围类型"></a>10.1.6 范围类型</h4><ul>
<li>integer_range</li>
<li>float_range</li>
<li>long_range</li>
<li>double_range</li>
<li>date_range</li>
<li>ip_range</li>
</ul>
<p>定义的时候，指定范围类型即可：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT product</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "date":{</span><br><span class="line">        "type": "date"</span><br><span class="line">      },</span><br><span class="line">      "price":{</span><br><span class="line">        "type":"float_range"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>插入文档的时候，需要指定范围的界限：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT product</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "date":{</span><br><span class="line">        "type": "date"</span><br><span class="line">      },</span><br><span class="line">      "price":{</span><br><span class="line">        "type":"float_range"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>指定范围的时，可以使用 gt、gte、lt、lte。</p>
<h3 id="10-2-复合类型"><a href="#10-2-复合类型" class="headerlink" title="10.2 复合类型"></a>10.2 复合类型</h3><h4 id="10-2-1-数组类型"><a href="#10-2-1-数组类型" class="headerlink" title="10.2.1 数组类型"></a>10.2.1 数组类型</h4><p>es 中没有专门的数组类型。默认情况下，任何字段都可以有一个或者多个值。需要注意的是，数组中的元素必须是<strong>同一种类型。</strong></p>
<p>添加数组是，数组中的<strong>第一个元素</strong>决定了整个数组的类型。</p>
<h4 id="10-2-2-对象类型（object）"><a href="#10-2-2-对象类型（object）" class="headerlink" title="10.2.2 对象类型（object）"></a>10.2.2 对象类型（object）</h4><p>由于 JSON 本身具有层级关系，所以文档包含内部对象。内部对象中，还可以再包含内部对象。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT product/_doc/2</span><br><span class="line">{</span><br><span class="line">  "date":"2020-11-11T11:11:11Z",</span><br><span class="line">  "ext_info":{</span><br><span class="line">    "address":"China"</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="10-2-3-嵌套类型（nested）"><a href="#10-2-3-嵌套类型（nested）" class="headerlink" title="10.2.3 嵌套类型（nested）"></a>10.2.3 嵌套类型（nested）</h4><p>nested 是 object 中的一个特例。</p>
<p>如果使用 object 类型，假如有如下一个文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "user":[</span><br><span class="line">    {</span><br><span class="line">      "first":"Zhang",</span><br><span class="line">      "last":"san"</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      "first":"Li",</span><br><span class="line">      "last":"si"</span><br><span class="line">    }</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>由于 Lucene 没有内部对象的概念，所以 es 会将对象层次扁平化，将一个对象转为字段名和值构成的简单列表。即上面的文档，最终存储形式如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">"user.first":["Zhang","Li"],</span><br><span class="line">"user.last":["san","si"]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>扁平化之后，用户名之间的关系没了。这样会导致如果搜索 Zhang si 这个人，会搜索到。</p>
<p>此时可以 nested 类型来解决问题，nested 对象类型可以保持数组中每个对象的独立性。nested 类型将数组中的每一饿对象作为独立隐藏文档来索引，这样每一个嵌套对象都可以独立被索引。</p>
<p>{<br>{<br>“user.first”:”Zhang”,<br>“user.last”:”san”<br>},{<br>“user.first”:”Li”,<br>“user.last”:”si”<br>}<br>}</p>
<p><strong>优点</strong></p>
<p>文档存储在一起，读取性能高。</p>
<p><strong>缺点</strong></p>
<p>更新父或者子文档时需要更新更个文档。</p>
<h3 id="10-3-地理类型"><a href="#10-3-地理类型" class="headerlink" title="10.3 地理类型"></a>10.3 地理类型</h3><p>使用场景：</p>
<ul>
<li>查找某一个范围内的地理位置</li>
<li>通过地理位置或者相对中心点的距离来聚合文档</li>
<li>把距离整个到文档的评分中</li>
<li>通过距离对文档进行排序</li>
</ul>
<h4 id="10-3-1-geo-point"><a href="#10-3-1-geo-point" class="headerlink" title="10.3.1 geo_point"></a>10.3.1 geo_point</h4><p>geo_point 就是一个坐标点，定义方式如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT people</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "location":{</span><br><span class="line">        "type": "geo_point"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>创建时指定字段类型，存储的时候，有四种方式：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//object</span><br><span class="line">PUT people/_doc/1</span><br><span class="line">{</span><br><span class="line">  "location":{</span><br><span class="line">    "lat": 34.27,</span><br><span class="line">    "lon": 108.94</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">//字符串</span><br><span class="line">PUT people/_doc/2</span><br><span class="line">{</span><br><span class="line">  "location":"34.27,108.94"</span><br><span class="line">}</span><br><span class="line">//经纬度的hash值</span><br><span class="line">PUT people/_doc/3</span><br><span class="line">{</span><br><span class="line">  "location":"uzbrgzfxuzup"</span><br><span class="line">}</span><br><span class="line">//数组 经度在前，纬度在后</span><br><span class="line">PUT people/_doc/4</span><br><span class="line">{</span><br><span class="line">  "location":[108.94,34.27]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意，使用数组描述，先经度后纬度。</p>
<p>地址位置转 geo_hash：<a target="_blank" rel="noopener" href="http://www.csxgame.top/#/">http://www.csxgame.top/#/</a></p>
<h4 id="10-3-2-geo-shape"><a href="#10-3-2-geo-shape" class="headerlink" title="10.3.2 geo_shape"></a>10.3.2 geo_shape</h4><p><img src="https://gitee.com/penno/blogimg/raw/master/img/image-20210413165810514.png" alt="image-20210413165810514"></p>
<p>指定 geo_shape 类型：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT people</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "location":{</span><br><span class="line">        "type": "geo_shape"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>添加文档时需要指定具体的类型：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT people/_doc/1</span><br><span class="line">{</span><br><span class="line">  "location":{</span><br><span class="line">    "type":"point",</span><br><span class="line">    "coordinates": [108.94,34.27]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果是 linestring，如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT people/_doc/2</span><br><span class="line">{</span><br><span class="line">  "location":{</span><br><span class="line">    "type":"linestring",</span><br><span class="line">    "coordinates": [[108.94,34.27],[100,33]]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="10-4-特殊类型"><a href="#10-4-特殊类型" class="headerlink" title="10.4 特殊类型"></a>10.4 特殊类型</h3><h4 id="10-4-1-IP"><a href="#10-4-1-IP" class="headerlink" title="10.4.1 IP"></a>10.4.1 IP</h4><p>存储 IP 地址，类型是 ip：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "address":{</span><br><span class="line">        "type": "ip"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>添加文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/1</span><br><span class="line">{</span><br><span class="line">  "address":"192.168.91.1"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>搜索文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "address": "192.168.0.0/16"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="10-4-2-token-count"><a href="#10-4-2-token-count" class="headerlink" title="10.4.2 token_count"></a>10.4.2 token_count</h4><p>用于统计字符串分词后的词项个数。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "title":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "fields": {</span><br><span class="line">          "length":{</span><br><span class="line">            "type":"token_count",</span><br><span class="line">            "analyzer":"standard"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>相当于新增了 title.length 字段用来统计分词后词项的个数。</p>
<p>添加文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/1</span><br><span class="line">{</span><br><span class="line">  "title":"zhang san"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>可以通过 token_count 去查询：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "title.length": 2</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="11-ElasticSearch-23-种映射参数详解"><a href="#11-ElasticSearch-23-种映射参数详解" class="headerlink" title="11.ElasticSearch 23 种映射参数详解"></a>11.ElasticSearch 23 种映射参数详解</h2><h3 id="11-1-analyzer"><a href="#11-1-analyzer" class="headerlink" title="11.1 analyzer"></a>11.1 analyzer</h3><p>定义文本字段的分词器。默认对索引和查询都是有效的。</p>
<p>假设不用分词器，我们先来看一下索引的结果，创建一个索引并添加一个文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line"></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">{</span><br><span class="line">  "title":"定义文本字段的分词器。默认对索引和查询都是有效的。"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查看词条向量（term vectors）</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_termvectors/1</span><br><span class="line">{</span><br><span class="line">  "fields": ["title"]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查看结果如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "_index" : "blog",</span><br><span class="line">  "_type" : "_doc",</span><br><span class="line">  "_id" : "1",</span><br><span class="line">  "_version" : 1,</span><br><span class="line">  "found" : true,</span><br><span class="line">  "took" : 0,</span><br><span class="line">  "term_vectors" : {</span><br><span class="line">    "title" : {</span><br><span class="line">      "field_statistics" : {</span><br><span class="line">        "sum_doc_freq" : 22,</span><br><span class="line">        "doc_count" : 1,</span><br><span class="line">        "sum_ttf" : 23</span><br><span class="line">      },</span><br><span class="line">      "terms" : {</span><br><span class="line">        "义" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 1,</span><br><span class="line">              "start_offset" : 1,</span><br><span class="line">              "end_offset" : 2</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "分" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 7,</span><br><span class="line">              "start_offset" : 7,</span><br><span class="line">              "end_offset" : 8</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "和" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 15,</span><br><span class="line">              "start_offset" : 16,</span><br><span class="line">              "end_offset" : 17</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "器" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 9,</span><br><span class="line">              "start_offset" : 9,</span><br><span class="line">              "end_offset" : 10</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "字" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 4,</span><br><span class="line">              "start_offset" : 4,</span><br><span class="line">              "end_offset" : 5</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "定" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 0,</span><br><span class="line">              "start_offset" : 0,</span><br><span class="line">              "end_offset" : 1</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "对" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 12,</span><br><span class="line">              "start_offset" : 13,</span><br><span class="line">              "end_offset" : 14</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "引" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 14,</span><br><span class="line">              "start_offset" : 15,</span><br><span class="line">              "end_offset" : 16</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "效" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 21,</span><br><span class="line">              "start_offset" : 22,</span><br><span class="line">              "end_offset" : 23</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "文" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 2,</span><br><span class="line">              "start_offset" : 2,</span><br><span class="line">              "end_offset" : 3</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "是" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 19,</span><br><span class="line">              "start_offset" : 20,</span><br><span class="line">              "end_offset" : 21</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "有" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 20,</span><br><span class="line">              "start_offset" : 21,</span><br><span class="line">              "end_offset" : 22</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "本" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 3,</span><br><span class="line">              "start_offset" : 3,</span><br><span class="line">              "end_offset" : 4</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "查" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 16,</span><br><span class="line">              "start_offset" : 17,</span><br><span class="line">              "end_offset" : 18</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "段" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 5,</span><br><span class="line">              "start_offset" : 5,</span><br><span class="line">              "end_offset" : 6</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "的" : {</span><br><span class="line">          "term_freq" : 2,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 6,</span><br><span class="line">              "start_offset" : 6,</span><br><span class="line">              "end_offset" : 7</span><br><span class="line">            },</span><br><span class="line">            {</span><br><span class="line">              "position" : 22,</span><br><span class="line">              "start_offset" : 23,</span><br><span class="line">              "end_offset" : 24</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "索" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 13,</span><br><span class="line">              "start_offset" : 14,</span><br><span class="line">              "end_offset" : 15</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "认" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 11,</span><br><span class="line">              "start_offset" : 12,</span><br><span class="line">              "end_offset" : 13</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "词" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 8,</span><br><span class="line">              "start_offset" : 8,</span><br><span class="line">              "end_offset" : 9</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "询" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 17,</span><br><span class="line">              "start_offset" : 18,</span><br><span class="line">              "end_offset" : 19</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "都" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 18,</span><br><span class="line">              "start_offset" : 19,</span><br><span class="line">              "end_offset" : 20</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "默" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 10,</span><br><span class="line">              "start_offset" : 11,</span><br><span class="line">              "end_offset" : 12</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到，默认情况下，中文就是一个字一个字的分，这种分词方式没有任何意义。如果这样分词，查询就只能按照一个字一个字来查，像下面这样：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "title": "定"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>无意义！！！</p>
<p>所以，我们要根据实际情况，配置合适的分词器。</p>
<p>给字段设定分词器：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "title":{</span><br><span class="line">        "type":"text",</span><br><span class="line">        "analyzer": "ik_smart"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>存储文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/1</span><br><span class="line">{</span><br><span class="line">  "title":"定义文本字段的分词器。默认对索引和查询都是有效的。"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查看词条向量：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_termvectors/1</span><br><span class="line">{</span><br><span class="line">  "fields": ["title"]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询结果如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "_index" : "blog",</span><br><span class="line">  "_type" : "_doc",</span><br><span class="line">  "_id" : "1",</span><br><span class="line">  "_version" : 1,</span><br><span class="line">  "found" : true,</span><br><span class="line">  "took" : 1,</span><br><span class="line">  "term_vectors" : {</span><br><span class="line">    "title" : {</span><br><span class="line">      "field_statistics" : {</span><br><span class="line">        "sum_doc_freq" : 12,</span><br><span class="line">        "doc_count" : 1,</span><br><span class="line">        "sum_ttf" : 13</span><br><span class="line">      },</span><br><span class="line">      "terms" : {</span><br><span class="line">        "分词器" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 4,</span><br><span class="line">              "start_offset" : 7,</span><br><span class="line">              "end_offset" : 10</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "和" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 8,</span><br><span class="line">              "start_offset" : 16,</span><br><span class="line">              "end_offset" : 17</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "字段" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 2,</span><br><span class="line">              "start_offset" : 4,</span><br><span class="line">              "end_offset" : 6</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "定义" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 0,</span><br><span class="line">              "start_offset" : 0,</span><br><span class="line">              "end_offset" : 2</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "对" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 6,</span><br><span class="line">              "start_offset" : 13,</span><br><span class="line">              "end_offset" : 14</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "文本" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 1,</span><br><span class="line">              "start_offset" : 2,</span><br><span class="line">              "end_offset" : 4</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "有效" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 11,</span><br><span class="line">              "start_offset" : 21,</span><br><span class="line">              "end_offset" : 23</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "查询" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 9,</span><br><span class="line">              "start_offset" : 17,</span><br><span class="line">              "end_offset" : 19</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "的" : {</span><br><span class="line">          "term_freq" : 2,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 3,</span><br><span class="line">              "start_offset" : 6,</span><br><span class="line">              "end_offset" : 7</span><br><span class="line">            },</span><br><span class="line">            {</span><br><span class="line">              "position" : 12,</span><br><span class="line">              "start_offset" : 23,</span><br><span class="line">              "end_offset" : 24</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "索引" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 7,</span><br><span class="line">              "start_offset" : 14,</span><br><span class="line">              "end_offset" : 16</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "都是" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 10,</span><br><span class="line">              "start_offset" : 19,</span><br><span class="line">              "end_offset" : 21</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        },</span><br><span class="line">        "默认" : {</span><br><span class="line">          "term_freq" : 1,</span><br><span class="line">          "tokens" : [</span><br><span class="line">            {</span><br><span class="line">              "position" : 5,</span><br><span class="line">              "start_offset" : 11,</span><br><span class="line">              "end_offset" : 13</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后就可以通过词去搜索了：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "title": "索引"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="11-2-search-analyzer"><a href="#11-2-search-analyzer" class="headerlink" title="11.2 search_analyzer"></a>11.2 search_analyzer</h3><p>查询时候的分词器。默认情况下，如果没有配置 search_analyzer，则查询时，首先查看有没有 search_analyzer，有的话，就用 search_analyzer 来进行分词，如果没有，则看有没有 analyzer，如果有，则用 analyzer 来进行分词，否则使用 es 默认的分词器。</p>
<h3 id="11-3-normalizer"><a href="#11-3-normalizer" class="headerlink" title="11.3 normalizer"></a>11.3 normalizer</h3><p>normalizer 参数用于<strong>解析前（索引或者查询）</strong>的标准化配置。</p>
<p>比如，在 es 中，对于一些我们不想切分的字符串，我们通常会将其设置为 keyword，搜索时候也是使用整个词进行搜索。如果在索引前没有做好数据清洗，导致大小写不一致，例如 javaboy 和 JAVABOY，此时，我们就可以使用 normalizer 在索引之前以及查询之前进行文档的标准化。</p>
<p>先来一个反例，创建一个名为 blog 的索引，设置 author 字段类型为 keyword：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "author":{</span><br><span class="line">        "type": "keyword"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>添加两个文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/1</span><br><span class="line">{</span><br><span class="line">  "author":"javaboy"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT blog/_doc/2</span><br><span class="line">{</span><br><span class="line">  "author":"JAVABOY"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后进行搜索：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "author": "JAVABOY"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>大写关键字可以搜到大写的文档，小写关键字可以搜到小写的文档。</p>
<p>如果使用了 normalizer，可以在索引和查询时，分别对文档进行预处理。</p>
<p>normalizer 定义方式如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">{</span><br><span class="line">  "settings": {</span><br><span class="line">    "analysis": {</span><br><span class="line">      "normalizer":{</span><br><span class="line">        "my_normalizer":{</span><br><span class="line">          "type":"custom",</span><br><span class="line">          "filter":["lowercase"]</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }, </span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "author":{</span><br><span class="line">        "type": "keyword",</span><br><span class="line">        "normalizer":"my_normalizer"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在 settings 中定义 normalizer，然后在 mappings 中引用。</p>
<p>测试方式和前面一致。此时查询的时候，大写关键字也可以查询到小写文档，因为无论是索引还是查询，都会将大写转为小写。</p>
<h3 id="11-4-boost"><a href="#11-4-boost" class="headerlink" title="11.4 boost"></a>11.4 boost</h3><p>boost 参数可以设置字段的权重。</p>
<p>默认权重为1</p>
<p>boost 有两种使用思路，一种就是在定义 mappings 的时候使用，在指定字段类型时使用；另一种就是在查询时使用。</p>
<p>实际开发中建议使用后者，前者有问题：如果不重新索引文档，权重无法修改。</p>
<p>只支持 term 查询 (不支持prefix，range，fuzzy查询)</p>
<p>mapping 中使用 boost（不推荐）：7.12出现提示将在8.0移除</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "content":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "boost": 2</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>另一种方式就是在查询的时候，指定 boost</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "content":{</span><br><span class="line">        "type": "text"</span><br><span class="line">        , "analyzer": "ik_smart"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST blog/_doc</span><br><span class="line">{</span><br><span class="line">  "content":"你好测试的人,你好测试的人,你好测试的人"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "content": {</span><br><span class="line">        "query": "你好",</span><br><span class="line">        "boost": 2</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>为何在建索引时加权重是一个不好的行为</strong>？</p>
<p>1.如果不重新索引文档，权重无法修改。</p>
<p>2.在查询时可以调整权重而不需要重新索引</p>
<p>3.在索引添加权重会占用一个字节的空间，<code>This reduces the resolution of the field length normalization factor which can lead to lower quality relevance calculations.</code>(这一段没看懂)</p>
<h3 id="11-5-coerce"><a href="#11-5-coerce" class="headerlink" title="11.5 coerce"></a>11.5 coerce</h3><p>coerce 用来清除脏数据，默认为 true。</p>
<p>比如一个数字 5 ，一般是integer，但是可能是String “5”，也可能是是浮点数 float 5.0, 甚至 “5.0”String</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "number_one":{</span><br><span class="line">        "type": "integer"</span><br><span class="line">      },</span><br><span class="line">      "number_two":{</span><br><span class="line">        "type": "integer",</span><br><span class="line">        "coerce": false</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">{</span><br><span class="line">  "number_one":"10"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT blog/_doc/2</span><br><span class="line">{</span><br><span class="line">  "number_two":"10"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>可以通过update mapping api 让coerce 更新已有的字段</p>
<p>同样可以在建索引时全局禁用coercion并启用部分</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PUT my-index-000001</span><br><span class="line">{</span><br><span class="line">  "settings": {</span><br><span class="line">    "index.mapping.coerce": false</span><br><span class="line">  },</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "number_one": {</span><br><span class="line">        "type": "integer",</span><br><span class="line">        "coerce": true</span><br><span class="line">      },</span><br><span class="line">      "number_two": {</span><br><span class="line">        "type": "integer"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT my-index-000001/_doc/1</span><br><span class="line">{ </span><br><span class="line">"number_one": "10" </span><br><span class="line">} </span><br><span class="line"></span><br><span class="line">PUT my-index-000001/_doc/2</span><br><span class="line">{ </span><br><span class="line">"number_two": "10" </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="11-6-copy-to"><a href="#11-6-copy-to" class="headerlink" title="11.6 copy_to"></a>11.6 copy_to</h3><p>将多个字段的值复制到一个字段中</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">PUT my-index-000001</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "first_name": {</span><br><span class="line">        "type": "text",</span><br><span class="line">        "copy_to": "full_name" </span><br><span class="line">      },</span><br><span class="line">      "last_name": {</span><br><span class="line">        "type": "text",</span><br><span class="line">        "copy_to": "full_name" </span><br><span class="line">      },</span><br><span class="line">      "full_name": {</span><br><span class="line">        "type": "text"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT my-index-000001/_doc/1</span><br><span class="line">{</span><br><span class="line">  "first_name": "John",</span><br><span class="line">  "last_name": "Smith"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET my-index-000001/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "full_name": { </span><br><span class="line">        "query": "John Smith",</span><br><span class="line">        "operator": "and"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="11-7-doc-values-和-fielddata"><a href="#11-7-doc-values-和-fielddata" class="headerlink" title="11.7 doc_values 和 fielddata"></a>11.7 doc_values 和 fielddata</h3><p>es 中的搜索主要是用到倒排索引，doc_values 参数是为了加快排序、聚合操作而生的。当建立倒排索引的时候，会额外增加列式存储映射。</p>
<p>doc_values 默认是开启的，如果确定某个字段不需要排序或者不需要聚合，那么可以关闭 doc_values。</p>
<p>大部分的字段在索引时都会生成 doc_values，除了 text。text 字段在查询时会生成一个 fielddata 的数据结构，fieldata 在字段首次被聚合、排序的时候生成。</p>
<table>
<thead>
<tr>
<th>doc_value</th>
<th>fielddata</th>
</tr>
</thead>
<tbody><tr>
<td>索引时创建</td>
<td>使用时动态创建</td>
</tr>
<tr>
<td>磁盘</td>
<td>内存</td>
</tr>
<tr>
<td>不占用内存</td>
<td>不占用磁盘</td>
</tr>
<tr>
<td>索引速度稍微低一点</td>
<td>文档很多时，动态创建慢，占内存</td>
</tr>
</tbody></table>
<p>doc_values 默认开启，fielddata 默认关闭。</p>
<p>doc_values 演示：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">PUT users</span><br><span class="line"></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">{</span><br><span class="line">  "age":100</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT users/_doc/2</span><br><span class="line">{</span><br><span class="line">  "age":99</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT users/_doc/3</span><br><span class="line">{</span><br><span class="line">  "age":98</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT users/_doc/4</span><br><span class="line">{</span><br><span class="line">  "age":101</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET users/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match_all": {}</span><br><span class="line">  },</span><br><span class="line">  "sort":[</span><br><span class="line">    {</span><br><span class="line">      "age":{</span><br><span class="line">        "order": "desc"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>由于 doc_values 默认时开启的，所以可以直接使用该字段排序，如果想关闭 doc_values ，如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">PUT users</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "age":{</span><br><span class="line">        "type": "integer",</span><br><span class="line">        "doc_values": false</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">{</span><br><span class="line">  "age":100</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT users/_doc/2</span><br><span class="line">{</span><br><span class="line">  "age":99</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT users/_doc/3</span><br><span class="line">{</span><br><span class="line">  "age":98</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT users/_doc/4</span><br><span class="line">{</span><br><span class="line">  "age":101</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET users/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match_all": {}</span><br><span class="line">  },</span><br><span class="line">  "sort":[</span><br><span class="line">    {</span><br><span class="line">      "age":{</span><br><span class="line">        "order": "desc"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="11-8-dynamic"><a href="#11-8-dynamic" class="headerlink" title="11.8 dynamic"></a>11.8 dynamic</h3><p>当对包含新字段的文档建立索引时，ElasticSearch会将字段动态添加到文档或文档中的内部对象。</p>
<p>内部对象从其父对象或映射类型继承动态设置。在类型级别禁用了动态映射，因此不会动态的添加新的顶级字段。</p>
<p>dynamic 可选参数</p>
<table>
<thead>
<tr>
<th>param</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>true</td>
<td>默认</td>
</tr>
<tr>
<td>runtime</td>
<td>新字段作为运行时字段添加到映射中。未建立索引，而是在查询时从_source加载</td>
</tr>
<tr>
<td>false</td>
<td>新字段会被忽略，不能被索引和搜索，但仍会出现在返回的匹配的_source字段中，不会添加到映射中，必须显式添加新字段</td>
</tr>
<tr>
<td>strict</td>
<td>如果检测到新字段，会引发异常并拒绝，必须显式添加新字段</td>
</tr>
</tbody></table>
<h3 id="11-9-enabled"><a href="#11-9-enabled" class="headerlink" title="11.9 enabled"></a>11.9 enabled</h3><p>es 默认会索引所有的字段，但是有的字段可能只需要存储，不需要索引。此时可以通过 enabled 字段来控制：</p>
<p>只能应用于顶级映射定义和对象字段。仍然可以从_source字段中检索JSON，但无法搜索或以其他任何方式存储；</p>
<p>已经存在的字段和顶级映射无法更新enabled</p>
<p>可以将非对象字段添加到禁用字段</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT my-index-000001</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "session_data": {</span><br><span class="line">        "type": "object",</span><br><span class="line">        "enabled": false</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT my-index-000001/_doc/session_1</span><br><span class="line">{</span><br><span class="line">  "session_data": "foo bar" </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>返回的结果为</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "_index" : "my-index-000001",</span><br><span class="line">  "_type" : "_doc",</span><br><span class="line">  "_id" : "session_1",</span><br><span class="line">  "_version" : 1,</span><br><span class="line">  "result" : "created",</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 2,</span><br><span class="line">    "successful" : 2,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "_seq_no" : 0,</span><br><span class="line">  "_primary_term" : 1</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="11-10-format"><a href="#11-10-format" class="headerlink" title="11.10 format"></a>11.10 format</h3><p>日期格式。format 可以规范日期格式，而且一次可以定义多个 format。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">PUT users</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "birthday":{</span><br><span class="line">        "type": "date",</span><br><span class="line">        "format": "yyyy-MM-dd||yyyy-MM-dd HH:mm:ss"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">{</span><br><span class="line">  "birthday":"2020-11-11"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT users/_doc/2</span><br><span class="line">{</span><br><span class="line">  "birthday":"2020-11-11 11:11:11"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>多个日期格式之间，使用 || 符号连接，注意没有空格。</li>
<li>如果用户没有指定日期的 format，默认的日期格式是 <code>strict_date_optional_time||epoch_mills</code></li>
</ul>
<p>另外，所有的日期格式，可以在 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-date-format.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-date-format.html</a> 网址查看。</p>
<h3 id="11-11-ignore-above"><a href="#11-11-ignore-above" class="headerlink" title="11.11 ignore_above"></a>11.11 ignore_above</h3><p>igbore_above 用于指定分词和索引的字符串最大长度，超过最大长度的话，该字段将不会被索引，这个字段只适用于 keyword 类型。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "title":{</span><br><span class="line">        "type": "keyword",</span><br><span class="line">        "ignore_above": 10</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">{</span><br><span class="line">  "title":"javaboy"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT blog/_doc/2</span><br><span class="line">{</span><br><span class="line">  "title":"javaboyjavaboyjavaboy"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "title": "javaboyjavaboyjavaboy"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="10-12-ignore-malformed"><a href="#10-12-ignore-malformed" class="headerlink" title="10.12 ignore_malformed"></a>10.12 ignore_malformed</h3><p>ignore_malformed 可以忽略不规则的数据，该参数默认为 false。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">PUT users</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "birthday":{</span><br><span class="line">        "type": "date",</span><br><span class="line">        "format": "yyyy-MM-dd||yyyy-MM-dd HH:mm:ss"</span><br><span class="line">      },</span><br><span class="line">      "age":{</span><br><span class="line">        "type": "integer",</span><br><span class="line">        "ignore_malformed": true</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">{</span><br><span class="line">  "birthday":"2020-11-11",</span><br><span class="line">  "age":99</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT users/_doc/2</span><br><span class="line">{</span><br><span class="line">  "birthday":"2020-11-11 11:11:11",</span><br><span class="line">  "age":"abc"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT users/_doc/2</span><br><span class="line">{</span><br><span class="line">  "birthday":"2020-11-11 11:11:11aaa",</span><br><span class="line">  "age":"abc"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="10-13-include-in-all"><a href="#10-13-include-in-all" class="headerlink" title="10.13 include_in_all"></a>10.13 include_in_all</h3><p>这个是针对 <code>_all</code> 字段的，但是在 es7 中，该字段已经被废弃了。</p>
<h3 id="10-14-index"><a href="#10-14-index" class="headerlink" title="10.14 index"></a>10.14 index</h3><p>index 属性指定一个字段是否被索引，该属性为 true 表示字段被索引，false 表示字段不被索引。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PUT users</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "age":{</span><br><span class="line">        "type": "integer",</span><br><span class="line">        "index": false</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">{</span><br><span class="line">  "age":99</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET users/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "age": 99</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>如果 index 为 false，则不能通过对应的字段搜索。</li>
</ul>
<h3 id="10-15-index-options"><a href="#10-15-index-options" class="headerlink" title="10.15 index_options"></a>10.15 index_options</h3><p>index_options 控制索引时哪些信息被存储到倒排索引中（用在 text 字段中），有四种取值：</p>
<table>
<thead>
<tr>
<th>index_options</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>docs</td>
<td>只存储文档编号，默认</td>
</tr>
<tr>
<td>freqs</td>
<td>在doc基础上，存储词项频率</td>
</tr>
<tr>
<td>positions</td>
<td>在freqs基础上，存储词项偏移位置</td>
</tr>
<tr>
<td>offsets</td>
<td>在positions基础上，存储词项开始和结束的字符位置</td>
</tr>
</tbody></table>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">//这段没怎么懂</span><br><span class="line"></span><br><span class="line">PUT my-index-000001</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "text": {</span><br><span class="line">        "type": "text",</span><br><span class="line">        "index_options": "offsets"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT my-index-000001/_doc/1</span><br><span class="line">{</span><br><span class="line">  "text": "Quick brown fox"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET my-index-000001/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "text": "brown fox"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "highlight": {</span><br><span class="line">    "fields": {</span><br><span class="line">      "text": {} </span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3 id="10-16-norms"><a href="#10-16-norms" class="headerlink" title="10.16 norms"></a>10.16 norms</h3><p>norms 对字段评分有用，text 默认开启 norms，如果不是特别需要，不要开启 norms。</p>
<h3 id="10-17-null-value"><a href="#10-17-null-value" class="headerlink" title="10.17 null_value"></a>10.17 null_value</h3><p>在 es 中，值为 null 的字段不索引也不可以被搜索，null_value 可以让值为 null 的字段显式的可索引、可搜索：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">PUT users</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "name":{</span><br><span class="line">        "type": "keyword",</span><br><span class="line">        "null_value": "javaboy_null"  /*这个里面的value有什么意义呢*/</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT users/_doc/1</span><br><span class="line">{</span><br><span class="line">  "name":null,</span><br><span class="line">  "age":99</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET users/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "name": "javaboy_null"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="10-18-position-increment-gap"><a href="#10-18-position-increment-gap" class="headerlink" title="10.18 position_increment_gap"></a>10.18 position_increment_gap</h3><p>被解析的 text 字段会将 term 的位置考虑进去，目的是为了支持近似查询和短语查询，当我们去索引一个含有多个值的 text 字段时，会在各个值之间添加一个假想的空间，将值隔开，这样就可以有效避免一些无意义的短语匹配，间隙大小通过 position_increment_gap 来控制，默认是 100。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PUT my-index-000001/_doc/1</span><br><span class="line">{</span><br><span class="line">  "names": [ "John Abraham", "Lincoln Smith"]</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET my-index-000001/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match_phrase": {</span><br><span class="line">      "names": {</span><br><span class="line">        "query": "Abraham Lincoln" </span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET my-index-000001/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match_phrase": {</span><br><span class="line">      "names": {</span><br><span class="line">        "query": "Abraham Lincoln",</span><br><span class="line">        "slop": 101 </span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>This phrase query matches our document, even though <code>Abraham</code> and <code>Lincoln</code> are in separate strings, because <code>slop</code> &gt; <code>position_increment_gap</code>.</p>
<p>两个get请求两种返回</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "took" : 3,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 1,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "hits" : {</span><br><span class="line">    "total" : {</span><br><span class="line">      "value" : 0,</span><br><span class="line">      "relation" : "eq"</span><br><span class="line">    },</span><br><span class="line">    "max_score" : null,</span><br><span class="line">    "hits" : [ ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "took" : 3,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 1,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "hits" : {</span><br><span class="line">    "total" : {</span><br><span class="line">      "value" : 1,</span><br><span class="line">      "relation" : "eq"</span><br><span class="line">    },</span><br><span class="line">    "max_score" : 0.010358453,</span><br><span class="line">    "hits" : [</span><br><span class="line">      {</span><br><span class="line">        "_index" : "my-index-000001",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "1",</span><br><span class="line">        "_score" : 0.010358453,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "names" : [</span><br><span class="line">            "John Abraham",</span><br><span class="line">            "Lincoln Smith"</span><br><span class="line">          ]</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>可以在映射中指定<code>position_increment_gap</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PUT my-index-000001</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "names": {</span><br><span class="line">        "type": "text",</span><br><span class="line">        "position_increment_gap": 0 </span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT my-index-000001/_doc/1</span><br><span class="line">{</span><br><span class="line">  "names": [ "John Abraham", "Lincoln Smith"]</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET my-index-000001/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match_phrase": {</span><br><span class="line">      "names": "Abraham Lincoln" </span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="10-19-properties"><a href="#10-19-properties" class="headerlink" title="10.19 properties"></a>10.19 properties</h3><p>可以在查询，聚合等中使用点表示法来引用内部字段：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET my-index-000001/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "manager.name": "Alice White"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "aggs": {</span><br><span class="line">    "Employees": {</span><br><span class="line">      "nested": {</span><br><span class="line">        "path": "employees"</span><br><span class="line">      },</span><br><span class="line">      "aggs": {</span><br><span class="line">        "Employee Ages": {</span><br><span class="line">          "histogram": {</span><br><span class="line">            "field": "employees.age",</span><br><span class="line">            "interval": 5</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="10-20-similarity"><a href="#10-20-similarity" class="headerlink" title="10.20 similarity"></a>10.20 similarity</h3><p>similarity 指定文档的评分模型，默认有三种：</p>
<table>
<thead>
<tr>
<th>similarity</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>BM25</td>
<td>es和lucene默认的评分模型</td>
</tr>
<tr>
<td>classic</td>
<td>TF/IDF评分</td>
</tr>
<tr>
<td>boolean</td>
<td>boolean模型评分</td>
</tr>
</tbody></table>
<h3 id="10-21-store"><a href="#10-21-store" class="headerlink" title="10.21 store"></a>10.21 store</h3><p>默认情况下，字段会被索引，也可以搜索，但是不会存储，虽然不会被存储的，但是 <code>_source</code> 中有一个字段的备份。如果想将字段存储下来，可以通过配置 store 来实现。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">PUT my-index-000001</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "title": {</span><br><span class="line">        "type": "text",</span><br><span class="line">        "store": true </span><br><span class="line">      },</span><br><span class="line">      "date": {</span><br><span class="line">        "type": "date",</span><br><span class="line">        "store": true </span><br><span class="line">      },</span><br><span class="line">      "content": {</span><br><span class="line">        "type": "text"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT my-index-000001/_doc/1</span><br><span class="line">{</span><br><span class="line">  "title":   "Some short title",</span><br><span class="line">  "date":    "2015-01-01",</span><br><span class="line">  "content": "A very long content field..."</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET my-index-000001/_search</span><br><span class="line">{</span><br><span class="line">  "stored_fields": [ "title", "date" ] </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="10-22-term-vectors"><a href="#10-22-term-vectors" class="headerlink" title="10.22 term_vectors"></a>10.22 term_vectors</h3><p>term_vectors 是通过分词器产生的信息，包括：</p>
<ul>
<li>一组 terms</li>
<li>每个 term 的位置</li>
<li>term 的首字符/尾字符与原始字符串原点的偏移量</li>
</ul>
<p>term_vectors 取值：</p>
<table>
<thead>
<tr>
<th>取值</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>no</td>
<td>不存储信息，默认</td>
</tr>
<tr>
<td>yes</td>
<td>term被存储</td>
</tr>
<tr>
<td>with_positions</td>
<td>在yes的基础上增加位置信息</td>
</tr>
<tr>
<td>with_offset</td>
<td>在yes的基础上增加偏移信息</td>
</tr>
<tr>
<td>with_positions_offsets</td>
<td>term，positons，offsets都存储</td>
</tr>
<tr>
<td>with_positions_payloads</td>
<td></td>
</tr>
<tr>
<td>with_positions_offsets_payloads</td>
<td></td>
</tr>
</tbody></table>
<ul>
<li>设置 with_postions_offsets将使字段索引大小翻倍</li>
</ul>
<h3 id="11-23-fields"><a href="#11-23-fields" class="headerlink" title="11.23 fields"></a>11.23 fields</h3><p>fields 参数可以让同一字段有多种不同的索引方式。例如：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "title":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "fields": {</span><br><span class="line">          "raw":{</span><br><span class="line">            "type":"keyword"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">{</span><br><span class="line">  "title":"javaboy"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "title.raw": "javaboy"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="12-映射模板"><a href="#12-映射模板" class="headerlink" title="12.映射模板"></a>12.映射模板</h2><h2 id="13-ElasticSearch-搜索数据导入"><a href="#13-ElasticSearch-搜索数据导入" class="headerlink" title="13.ElasticSearch 搜索数据导入"></a>13.ElasticSearch 搜索数据导入</h2><ol>
<li>下载脚本<strong>bookdata.json</strong>。<br>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/12Gj5aovYKI5g2X8pPJZtLw">https://pan.baidu.com/s/12Gj5aovYKI5g2X8pPJZtLw</a> 提取码: a5h4 </li>
<li>创建索引：</li>
</ol>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PUT books</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "name":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word"</span><br><span class="line">      },</span><br><span class="line">      "publish":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word"</span><br><span class="line">      },</span><br><span class="line">      "type":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word"</span><br><span class="line">      },</span><br><span class="line">      "author":{</span><br><span class="line">        "type": "keyword"</span><br><span class="line">      },</span><br><span class="line">      "info":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word"</span><br><span class="line">      },</span><br><span class="line">      "price":{</span><br><span class="line">        "type": "double"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>执行如下脚本导入命令：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST "http://localhost:9200/books/_bulk?pretty" -H "content-type:application/json" --data-binary @bookdata.json</span><br></pre></td></tr></tbody></table></figure>

<h2 id="14-ElasticSearch-搜索入门"><a href="#14-ElasticSearch-搜索入门" class="headerlink" title="14.ElasticSearch 搜索入门"></a>14.ElasticSearch 搜索入门</h2><p>搜索分为两个过程：</p>
<ol>
<li>当向索引中保存文档时，默认情况下，es 会保存两份内容，一份是 <code>_source</code> 中的数据，另一份则是通过分词、排序等一系列过程生成的倒排索引文件，倒排索引中保存了词项和文档之间的对应关系。</li>
<li>搜索时，当 es 接收到用户的搜索请求之后，就会去倒排索引中查询，通过的倒排索引中维护的倒排记录表找到关键词对应的文档集合，然后对文档进行评分、排序、高亮等处理，处理完成后返回文档。</li>
</ol>
<h3 id="14-1-简单搜索"><a href="#14-1-简单搜索" class="headerlink" title="14.1 简单搜索"></a>14.1 简单搜索</h3><p>查询文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match_all": {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询结果如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "took" : 19,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 1,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "hits" : {</span><br><span class="line">    "total" : {</span><br><span class="line">      "value" : 38,</span><br><span class="line">      "relation" : "eq"</span><br><span class="line">    },</span><br><span class="line">    "max_score" : 4.217799,</span><br><span class="line">    "hits" : [</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "279",</span><br><span class="line">        "_score" : 4.217799,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "name" : "计算机应用基础",</span><br><span class="line">          "publish" : "高等教育出版社",</span><br><span class="line">          "type" : "计算机理论、基础知识",</span><br><span class="line">          "author" : "张宇，赖麟",</span><br><span class="line">          "info" : "《计算机应用基础》是国家精品课程“计算机文件基础”的配套教材。全书按照工学结合人才培养模式的要求，以培养能力为目标，基于工作过程组织课程；以典型的工作任务为载体，采用任务驱动的方式来构造知识和技能平台，强调理论和训练一体化，做到“教、学、做”相结合，让学生对知识有整体认识，即按照“先行后知、先学后教”的思想编写。全书内容包括：计算机基础知识、WnwsXP操作系统、McsfOffc2003办公自动化软件、计算机网络基础。《计算机应用基础》的显著特点是以学生为主体，通过实际工作过程中的典型工作任务来训练学生，培养学生解决和处理实际问题的能力，将被动学习转变为主动学习，突出学生能力的培养，更加符合职业技术教育的特点和规律。《计算机应用基础》适合作为普通高等院校和高职高专院校“计算机应用基础”课程的教材，也可作为计算机初学者的入门参考书。",</span><br><span class="line">          "price" : 29</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "298",</span><br><span class="line">        "_score" : 3.8557193,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "name" : "高等学校大学计算机基础课程系列教材：大学计算机基础教程",</span><br><span class="line">          "publish" : "高等教育出版社",</span><br><span class="line">          "type" : "大学教材",</span><br><span class="line">          "author" : "",</span><br><span class="line">          "info" : "本书作为高等学校非计算机专业计算机基础课程群（1+X）第一门课程的主教材，主要介绍计算机基础知识和应用技能。本书共包含7章：计算机基础知识、操作系统用户界面及使用、办公自动化软件及使用、多媒体技术基础及应用、网络技术基础及应用、网页设计与制作、数据库技术基础及应用。每章都结合通用的软件版本进行讲解，同时为了帮助学生加深对所学知识的理解，还配备了大量习题。作为国家精品课程主讲教材，本书配有丰富的教学资源，包括多媒体教学课件、课程实验系统、上机练习和考试评价系统、教学素材等计算机辅助教学软件，还有功能完善的教学专用网站。本书可作为高等学校学生学习第一门计算机课程的教材，也可作为计算机爱好者的自学读本。",</span><br><span class="line">          "price" : 22</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "789",</span><br><span class="line">        "_score" : 3.58548,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "name" : "高等学校文科计算机课程系列教材：计算机平面设计技术（CorelDRAW与Photoshop）（附光盘）",</span><br><span class="line">          "publish" : "高等教育出版社",</span><br><span class="line">          "type" : "大学教材",</span><br><span class="line">          "author" : "",</span><br><span class="line">          "info" : "《计算机平面设计技术――CDRAW与Ps》是根据教育部高等学校文科类专业计算机课程教学基本要求（美术类）而编写的。《计算机平面设计技术――CDRAW与Ps》系统全面地介绍了平面设计艺术专业最常用、最基本、最普及、最成熟的两个应用软件――CDRAW与Ps，结合实际的设计案例，讲授平面图形的造型方法与技巧、图像的处理方法与技巧、跨程序编辑的方法和意义等知识与技术。教材浓缩了其重要的工具和功能的使用方法，可作为平面设计专业的计算机应用基础课程的教材，也可作为学习计算机平面设计技术的参考。",</span><br><span class="line">          "price" : 28</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "282",</span><br><span class="line">        "_score" : 3.4969957,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "name" : "计算机文化基础（Windows XP＋Office2003）",</span><br><span class="line">          "publish" : "高等教育出版社",</span><br><span class="line">          "type" : "计算机理论、基础知识",</span><br><span class="line">          "author" : "赵秀英",</span><br><span class="line">          "info" : "《计算机文化基础(WnwsXP+Offc2003",</span><br><span class="line">          "price" : 0</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "783",</span><br><span class="line">        "_score" : 3.3814218,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "name" : "计算机科学与技术丛书：现代语音编码技术",</span><br><span class="line">          "publish" : "科学出版社",</span><br><span class="line">          "type" : "电子与通信",</span><br><span class="line">          "author" : "",</span><br><span class="line">          "info" : "本书全面、系统地阐述了现代语音编码的原理、技术及应用。　本书分为12章，第一章介绍现代语音编码的基础知识和基本概念，第二章阐述标量量化和矢量量化原理，这两章是语音编码的入门知识；第三章至第七章讨论广泛应用的几种重要的现代语音编码技术原理、系统组成、实用技术及编码标准，是本书的重点；第八章至第十章介绍目前语音编码的最新的一些研究课题及其进展；第十一章、第十二章讨论语音编码的今后发展趋势和方向。主要内容有：语音编码导论、量化原理、时域波形编码技术、频域波形编码技术、变换域波形编码技术、参数编码技术、混合编码技术、极低速率语音编码、宽频带高音质声频编码、第三代移动通信的语音编码、信源-信道联合编码、软件无线电技术在语音编码中的应用。　本书内容丰富、取材新颖、阐述清晰、结构合理、实用性强，包含有最近二十几年来现代语音编码技术的许多新成果和新进展，是一本很好的关于语音编码原理、技术及应用的教科书和参考书。",</span><br><span class="line">          "price" : 31</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "465",</span><br><span class="line">        "_score" : 3.3506408,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "name" : "国家精品课程主讲教材・高等学校大学计算机基础课程系列教材：大学计算机基础实践教程",</span><br><span class="line">          "publish" : "高等教育出版社",</span><br><span class="line">          "type" : "大学教材",</span><br><span class="line">          "author" : "詹国华",</span><br><span class="line">          "info" : "《大学计算机基础实践教程》作为高等学校非计算机专业计算机基础课程群（1+X）第一门课程主教材《大学计算机基础教程》的配套实验教材，精心设计了一组综合性、应用性实验，注重实践技能的培养和理论知识的渗透。《大学计算机基础实践教程》共分7章：硬件连接和汉字输入实验、Wnws操作实验、办公软件操作实验、多媒体基础实验、因特网操作实验、网页设计与制作实验、Accss数据库操作实验。作为国家精品课程主讲教材的配套用书，《大学计算机基础实践教程》提供了丰富的教学资源，包括多媒体教学课件、课程实验系统、上机练习和考试评价系统、教学素材等计算机辅助教学软件，还有功能完善的课程教学网站。《大学计算机基础实践教程》可作为高等学校学生学习第一门计算机基础课程的配套教材，也可作为计算机爱好者的自学读本。",</span><br><span class="line">          "price" : 17</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "429",</span><br><span class="line">        "_score" : 3.1717708,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "name" : "微型计算机原理与接口技术（第2版）",</span><br><span class="line">          "publish" : "高等教育出版社",</span><br><span class="line">          "type" : "计算机组织与体系结构",</span><br><span class="line">          "author" : "尹建华",</span><br><span class="line">          "info" : "《微型计算机原理与接口技术》以In系列微处理器为背景，以16位微处理器8086为核心，追踪In主流系列高性能微型计算机萼术的发展方向，全面讲述微型计算机系统的基本组成、工作原理、硬件接口技术和典型应用，在此基础上介绍80386，80486和Pn等高档微处理器的发展和特点。使学生系统掌握汇编语言程序设计的基本方法和硬件接口技术，建立微型计算机系统的整体概念，并且使之具有微型计算机软件及硬件初步开发、设计的能力。为使于教师授课和学生学习，《微型计算机原理与接口技术》配备了多媒体CAI课件。全书共11章。主要内容包括：微型计算机基础知识、80x86CPU、微型计算机指令系统、汇编语言程序设计、存储器及其与CPU的接口、输入／输出接口及中断技术、总线和总线标准、常用可编程并行数字接口芯片及其应用、串行通信接口及总线标准、模拟接口技术、常用外设和人机交互接口。《微型计算机原理与接口技术》可作为高等学校工科非计算机专业微型计算机原理及应用课程的教材，也可供从事微型计算机硬件和软件设计的工程技术人员参考。",</span><br><span class="line">          "price" : 54</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "70",</span><br><span class="line">        "_score" : 2.9018917,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "name" : "计算机基础课程系列教材：数据库技术及应用 SQL Server",</span><br><span class="line">          "publish" : "高等教育出版社",</span><br><span class="line">          "type" : "数据库",</span><br><span class="line">          "author" : "李雁翎",</span><br><span class="line">          "info" : "SQLSv是一种典型的数据库管理系统，是目前深受广大用户欢迎的数据库应用开发平台。它适应网络技术环境，支持客户／服务器模式，能够满足创建各种类型数据库的需求，因此是目前高等学校讲授大型数据库管理系统的首选软件平台。《数据库技术及应用――SQLSv》以培养学生利用数据库技术对数据和信息进行管理、加工和利用的意识与能力为目标，以数据库原理和技术为知识讲授核心，建构教材的体例。《数据库技术及应用――SQLSv》分为上、下两篇。上篇为基础篇，主要介绍与数据库相关的基本概念，数据库设计方法，SQLSv-体系结构，数据库对象管理，T―SQL语言及应用，存储过程和触发器的使用技术。下篇为应用篇，主要介绍安全管理技术，数据备份、恢复及转换技术，ADO数据对象，VB／SQLSv的应用程序开发方法及实例。《数据库技术及应用――SQLSv》体系完整，结构清晰，实例丰富，图文并茂，精编精讲，易读易懂。全书体例创新，由一组系统化的、围绕一个数据库应用系统的相关例子贯穿始终，特色鲜明，具有普遍适用性。《数据库技术及应用――SQLSv》可作为高等学校本、专科学生的教科书，也可作为学习数据库应用技术读者的自学用书。为了方便教师教学和学生自主学习，《数据库技术及应用――SQLSv》配有《数据库技术及应用――习题与实验指导（SQLSv）》和电子教案、例题、实验软件的电子文档以及相关的教学网站，网址为：／／c.cncs.c／c／nx。",</span><br><span class="line">          "price" : 22</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "116",</span><br><span class="line">        "_score" : 2.9018917,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "name" : "全国计算机等级考试一级B教程（2010年版）",</span><br><span class="line">          "publish" : "高等教育出版社",</span><br><span class="line">          "type" : "计算机考试",</span><br><span class="line">          "author" : "",</span><br><span class="line">          "info" : "《全国计算机等级考试一级B教程（2010年版）》由教育部考试中心组织，在全国计算机等级考试委员会指导下由有关专家按照《全国计算机等级考试一级B考试大纲（2007年版）》的要求而编写，内容包括计算机基础知识、WnwsXP操作系统、W2003的使用、Exc2003的使用、因特网的基础知识和简单应用等。由教育部考试中心组织和实施的计算机等级考试，是一种客观、公正、科学的专门测试计算机应用人员的计算机知识与技能的全国范围的等级考试。它面向社会，服务于社会。《全国计算机等级考试一级B教程（2010年版）》除了可以作为计算机等级考试的教材外，还可作为学习计算机基础知识的参考书。",</span><br><span class="line">          "price" : 33</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "138",</span><br><span class="line">        "_score" : 2.821856,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "name" : "全国计算机等级考试三级教程：PC技术（2010年版）",</span><br><span class="line">          "publish" : "高等教育出版社",</span><br><span class="line">          "type" : "考试认证",</span><br><span class="line">          "author" : "",</span><br><span class="line">          "info" : "《全国计算机等级考试三级教程：PC技术(2010年版",</span><br><span class="line">          "price" : 0</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match_all": {}</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>hits 中就是查询结果，total 是符合查询条件的文档数。</p>
<p>简单搜索可以简写为：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br></pre></td></tr></tbody></table></figure>

<p>简单搜索默认查询 10 条记录。</p>
<h3 id="14-2-词项查询"><a href="#14-2-词项查询" class="headerlink" title="14.2 词项查询"></a>14.2 词项查询</h3><p>即 term 查询，就是根据<strong>词</strong>去查询，查询指定字段中包含给定单词的文档，term 查询不被解析，只有搜索的词和文档中的词<strong>精确匹配</strong>，才会返回文档。应用场景如：人名、地名等等。</p>
<p>查询 name 字段中包含 <strong>十一五</strong> 的文档。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "name": "十一五"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="14-3-分页"><a href="#14-3-分页" class="headerlink" title="14.3 分页"></a>14.3 分页</h3><p>默认返回前 10 条数据，es 中也可以像关系型数据库一样，给一个分页参数：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "name": "十一五"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "size": 10,</span><br><span class="line">  "from": 10</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="14-4-过滤返回字段"><a href="#14-4-过滤返回字段" class="headerlink" title="14.4 过滤返回字段"></a>14.4 过滤返回字段</h3><p>如果返回的字段比较多，又不需要这么多字段，此时可以指定返回的字段：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "name": "十一五"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "size": 10,</span><br><span class="line">  "from": 10,</span><br><span class="line">  "_source": ["name","author"]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>此时，返回的字段就只有 name 和 author 了。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "took" : 7,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 1,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "hits" : {</span><br><span class="line">    "total" : {</span><br><span class="line">      "value" : 142,</span><br><span class="line">      "relation" : "eq"</span><br><span class="line">    },</span><br><span class="line">    "max_score" : 1.7939949,</span><br><span class="line">    "hits" : [</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "323",</span><br><span class="line">        "_score" : 1.7416272,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "author" : "徐春祥",</span><br><span class="line">          "name" : "普通高等教育十一五国家级规划教材・医学化学"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "476",</span><br><span class="line">        "_score" : 1.7416272,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "author" : "陈后金，胡健，薛健",</span><br><span class="line">          "name" : "普通高等教育“十一五”国家级规划教材：信号与系统"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "480",</span><br><span class="line">        "_score" : 1.7416272,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "author" : "余家荣",</span><br><span class="line">          "name" : "普通高等教育“十一五”国家级规划教材：复变函数"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "494",</span><br><span class="line">        "_score" : 1.7416272,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "author" : "徐美银",</span><br><span class="line">          "name" : "全国高职高专教育“十一五”规划教材：经济学原理"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "498",</span><br><span class="line">        "_score" : 1.7416272,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "author" : "",</span><br><span class="line">          "name" : "普通高等教育“十一五”国家级规划教材：组合学讲义"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "502",</span><br><span class="line">        "_score" : 1.7416272,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "author" : "卞毓宁",</span><br><span class="line">          "name" : "全国高职高专教育十一五规划教材：统计学概论"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "614",</span><br><span class="line">        "_score" : 1.7416272,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "author" : "陈洪亮，张峰，田社平",</span><br><span class="line">          "name" : "普通高等教育“十一五”国家级规划教材：电路基础"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "13",</span><br><span class="line">        "_score" : 1.69223,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "author" : "胡立勇，丁艳锋",</span><br><span class="line">          "name" : "普通高等教育“十一五”国家级规划教材：作物栽培学"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "65",</span><br><span class="line">        "_score" : 1.69223,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "author" : "",</span><br><span class="line">          "name" : "普通高等教育“十一五”国家级规划教材：有机化学"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "87",</span><br><span class="line">        "_score" : 1.69223,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "author" : "",</span><br><span class="line">          "name" : "普通高等教育“十一五”国家级规划教材：美术设计基础"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="14-5-最小评分"><a href="#14-5-最小评分" class="headerlink" title="14.5 最小评分"></a>14.5 最小评分</h3><p>有的文档得分特别低，说明这个文档和我们查询的关键字相关度很低。我们可以设置一个最低分，只有得分超过最低分的文档才会被返回。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "name": "十一五"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "min_score":1.75,</span><br><span class="line">  "_source": ["name","author"]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>得分低于 1.75 的文档将直接被舍弃。</p>
<h3 id="14-6-高亮"><a href="#14-6-高亮" class="headerlink" title="14.6 高亮"></a>14.6 高亮</h3><p>查询关键字高亮：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "name": "十一五"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "min_score":1.75,</span><br><span class="line">  "_source": ["name","author"],</span><br><span class="line">  "highlight": {</span><br><span class="line">    "fields": {</span><br><span class="line">      "name": {}</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="15-ElasticSearch-全文查询"><a href="#15-ElasticSearch-全文查询" class="headerlink" title="15.ElasticSearch 全文查询"></a>15.ElasticSearch 全文查询</h2><h3 id="15-1-match-query"><a href="#15-1-match-query" class="headerlink" title="15.1 match query"></a>15.1 match query</h3><p>match query 会对查询语句进行分词，分词后，如果查询语句中的任何一个词项被匹配，则文档就会被索引到。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "name": "美术计算机"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个查询首先会对 <code>美术计算机</code> 进行分词，分词之后，再去查询，只要文档中包含一个分词结果，就回返回文档。换句话说，<strong>默认词项之间是 OR 的关系</strong>，如果想要修改，也可以改为 AND。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "name": {</span><br><span class="line">        "query": "美术计算机",</span><br><span class="line">        "operator": "and"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>此时就会要求文档中必须同时包含 <strong>美术</strong> 和 <strong>计算机</strong> 两个词。</p>
<h3 id="15-2-match-phrase-query"><a href="#15-2-match-phrase-query" class="headerlink" title="15.2 match_phrase query"></a>15.2 match_phrase query</h3><p>match_phrase query 也会对查询的关键字进行分词，但是它分词后有两个特点：</p>
<ul>
<li>分词后的词项顺序必须和文档中词项的顺序一致</li>
<li>所有的词都必须出现在文档中</li>
</ul>
<p>示例如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match_phrase": {</span><br><span class="line">        "name": {</span><br><span class="line">          "query": "十一五计算机",</span><br><span class="line">          "slop": 7</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>query 是查询的关键字，会被分词器进行分解，分解之后去倒排索引中进行匹配。</p>
<p>slop 是指关键字之间的最小距离，但是注意不是关键字之间间隔的字数。文档中的字段被分词器解析之后，解析出来的词项都包含一个 position 字段表示词项的位置，查询短语分词之后 的 position 之间的间隔要满足 slop 的要求。</p>
<h3 id="15-3-match-phrase-prefix-query"><a href="#15-3-match-phrase-prefix-query" class="headerlink" title="15.3 match_phrase_prefix query"></a>15.3 match_phrase_prefix query</h3><p>这个类似于 match_phrase query，只不过这里多了一个通配符，match_phrase_prefix 支持最后一个词项的前缀匹配，但是由于这种匹配方式效率较低，因此大家作为了解即可。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match_phrase_prefix": {</span><br><span class="line">      "name": "计"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个查询过程，会自动进行单词匹配，会自动查找以<strong>计</strong>开始的单词，默认是 50 个，可以自己控制：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match_phrase_prefix": {</span><br><span class="line">      "name": {</span><br><span class="line">        "query": "计",</span><br><span class="line">        "max_expansions": 3</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>match_phrase_prefix 是针对分片级别的查询，假设 max_expansions 为 1，可能返回多个文档，但是只有一个词，这是我们预期的结果。有的时候实际返回结果和我们预期结果并不一致，原因在于这个查询是分片级别的，不同的分片确实只返回了一个词，但是结果可能来自不同的分片，所以最终会看到多个词。</p>
<h3 id="15-4-multi-match-query"><a href="#15-4-multi-match-query" class="headerlink" title="15.4 multi_match query"></a>15.4 multi_match query</h3><p>match 查询的升级版，可以指定多个查询域：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "multi_match": {</span><br><span class="line">      "query": "java",</span><br><span class="line">      "fields": ["name","info"]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这种查询方式还可以指定字段的权重：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "multi_match": {</span><br><span class="line">      "query": "阳光",</span><br><span class="line">      "fields": ["name^4","info"]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个表示关键字出现在 name 中的权重是出现在 info 中权重的 4 倍。</p>
<h3 id="15-5-query-string-query"><a href="#15-5-query-string-query" class="headerlink" title="15.5 query_string query"></a>15.5 query_string query</h3><p>query_string 是一种紧密结合 Lucene 的查询方式，在一个查询语句中可以用到 Lucene 的一些查询语法：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "query_string": {</span><br><span class="line">      "default_field": "name",</span><br><span class="line">      "query": "(十一五) AND (计算机)"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="15-6-simple-query-string"><a href="#15-6-simple-query-string" class="headerlink" title="15.6 simple_query_string"></a>15.6 simple_query_string</h3><p>这个是 query_string 的升级，可以直接使用 +、|、- 代替 AND、OR、NOT 等。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "simple_query_string": {</span><br><span class="line">      "fields": ["name"],</span><br><span class="line">      "query": "(十一五) + (计算机)"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询结果和 query_string。</p>
<h2 id="16-ElasticSearch词项查询"><a href="#16-ElasticSearch词项查询" class="headerlink" title="16.ElasticSearch词项查询"></a>16.ElasticSearch词项查询</h2><h3 id="16-1-term-query"><a href="#16-1-term-query" class="headerlink" title="16.1 term query"></a>16.1 term query</h3><p>词项查询。词项查询不会分析查询字符，直接拿查询字符去倒排索引中比对。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "name": "程序设计"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="16-2-terms-query"><a href="#16-2-terms-query" class="headerlink" title="16.2 terms query"></a>16.2 terms query</h3><p>词项查询，但是可以给多个关键词。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "terms": {</span><br><span class="line">      "name": ["程序","设计","java"]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="16-3-range-query"><a href="#16-3-range-query" class="headerlink" title="16.3 range query"></a>16.3 range query</h3><p>范围查询，可以按照日期范围、数字范围等查询。</p>
<p>range query 中的参数主要有四个：</p>
<ul>
<li>gt</li>
<li>lt</li>
<li>gte</li>
<li>lte</li>
</ul>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "range": {</span><br><span class="line">      "price": {</span><br><span class="line">        "gte": 10,</span><br><span class="line">        "lt": 20</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "sort": [</span><br><span class="line">    {</span><br><span class="line">      "price": {</span><br><span class="line">        "order": "desc"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="16-4-exists-query"><a href="#16-4-exists-query" class="headerlink" title="16.4 exists query"></a>16.4 exists query</h3><p>exists query 会返回指定字段中至少有一个非空值的文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "exists": {</span><br><span class="line">      "field": "javaboy"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注意，空字符串也是有值。null 是空值。</strong></p>
<h3 id="16-5-prefix-query"><a href="#16-5-prefix-query" class="headerlink" title="16.5 prefix query"></a>16.5 prefix query</h3><p>前缀查询，效率略低，除非必要，一般不太建议使用。</p>
<p>给定关键词的前缀去查询：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "prefix": {</span><br><span class="line">      "name": {</span><br><span class="line">        "value": "大学"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="16-6-wildcard-query"><a href="#16-6-wildcard-query" class="headerlink" title="16.6 wildcard query"></a>16.6 wildcard query</h3><p>wildcard query 即通配符查询。支持单字符和多字符通配符：</p>
<ul>
<li>？表示一个任意字符。</li>
<li><code>*</code> 表示零个或者多个字符。</li>
</ul>
<p>查询所有姓张的作者的书：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "wildcard": {</span><br><span class="line">      "author": {</span><br><span class="line">        "value": "张*"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询所有姓张并且名字只有两个字的作者的书：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "wildcard": {</span><br><span class="line">      "author": {</span><br><span class="line">        "value": "张?"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="16-7-regexp-query"><a href="#16-7-regexp-query" class="headerlink" title="16.7 regexp query"></a>16.7 regexp query</h3><p>支持正则表达式查询。</p>
<p>查询所有姓张并且名字只有两个字的作者的书：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "regexp": {</span><br><span class="line">      "author": "张."</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="16-8-fuzzy-query"><a href="#16-8-fuzzy-query" class="headerlink" title="16.8 fuzzy query"></a>16.8 fuzzy query</h3><p>在实际搜索中，有时我们可能会打错字，从而导致搜索不到，在 match query 中，可以通过 fuzziness 属性实现模糊查询。</p>
<p>fuzzy query 返回与搜索关键字相似的文档。怎么样就算相似？以LevenShtein 编辑距离为准。编辑距离是指将一个字符变为另一个字符所需要更改字符的次数，更改主要包括四种：</p>
<ul>
<li>更改字符（javb–〉java）</li>
<li>删除字符（javva–〉java）</li>
<li>插入字符（jaa–〉java）</li>
<li>转置字符（ajva–〉java）</li>
</ul>
<p>为了找到相似的词，模糊查询会在指定的编辑距离中创建搜索关键词的所有可能变化或者扩展的集合，然后进行搜索匹配。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "fuzzy": {</span><br><span class="line">      "name": "javba"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="16-9-ids-query"><a href="#16-9-ids-query" class="headerlink" title="16.9 ids query"></a>16.9 ids query</h3><p>根据指定的 id 查询。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "ids":{</span><br><span class="line">      "values":  [1,2,3]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="17-ElasticSearch-复合查询"><a href="#17-ElasticSearch-复合查询" class="headerlink" title="17.ElasticSearch 复合查询"></a>17.ElasticSearch 复合查询</h2><h3 id="17-1-constant-score-query"><a href="#17-1-constant-score-query" class="headerlink" title="17.1 constant_score query"></a>17.1 constant_score query</h3><p>当我们不关心检索词项的频率（TF）对搜索结果排序的影响时，可以使用 constant_score 将查询语句或者过滤语句包裹起来。一般来说词项出现次数多会靠前？</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "constant_score": {</span><br><span class="line">      "filter": {</span><br><span class="line">        "term": {</span><br><span class="line">          "name": "java"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      "boost": 1.5</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="17-2-bool-query"><a href="#17-2-bool-query" class="headerlink" title="17.2 bool query"></a>17.2 bool query</h3><p>bool query 可以将任意多个简单查询组装在一起，有四个关键字可供选择，四个关键字所描述的条件可以有一个或者多个。</p>
<ul>
<li>must：文档必须匹配 must 选项下的查询条件。</li>
<li>should：文档可以匹配 should 下的查询条件，也可以不匹配。</li>
<li>must_not：文档必须不满足 must_not 选项下的查询条件。</li>
<li>filter：类似于 must，但是 filter 不评分，只是过滤数据。</li>
</ul>
<p>例如查询 name 属性中必须包含 java，同时书价不在 [0,35] 区间内，info 属性可以包含 程序设计 也可以不包含程序 设计：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "must": [</span><br><span class="line">        {</span><br><span class="line">          "term": {</span><br><span class="line">            "name": {</span><br><span class="line">              "value": "java"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      "must_not": [</span><br><span class="line">        {</span><br><span class="line">          "range": {</span><br><span class="line">            "price": {</span><br><span class="line">              "gte": 0,</span><br><span class="line">              "lte": 35</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      "should": [</span><br><span class="line">        {</span><br><span class="line">          "match": {</span><br><span class="line">            "info": "程序设计"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里还涉及到一个关键字，<code>minmum_should_match</code> 参数。</p>
<p><code>minmum_should_match</code> 参数在 es 官网上称作最小匹配度。在之前学习的 <code>multi_match</code> 或者这里的 should 查询中，都可以设置 <code>minmum_should_match</code> 参数。</p>
<p>假设我们要做一次查询，查询 name 中包含 语言程序设计 关键字的文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "name": "语言程序设计"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在这个查询过程中，首先会进行分词，分词方式如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET books/_analyze</span><br><span class="line">{</span><br><span class="line">  "text": ["语言程序设计"],</span><br><span class="line">  "analyzer": "ik_max_word"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>分词后的 term 会构造成一个 should 的 bool query，每一个 term 都会变成一个 term query 的子句。换句话说，上面的查询和下面的查询等价：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "should": [</span><br><span class="line">        {</span><br><span class="line">          "term": {</span><br><span class="line">            "name": {</span><br><span class="line">              "value": "语言"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "term": {</span><br><span class="line">            "name": {</span><br><span class="line">              "value": "程序设计"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "term": {</span><br><span class="line">            "name": {</span><br><span class="line">              "value": "程序"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "term": {</span><br><span class="line">            "name": {</span><br><span class="line">              "value": "设计"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在这两个查询语句中，都是文档只需要包含词项中的任意一项即可，文档就回被返回，在 match 查询中，可以通过 operator 参数设置文档必须匹配所有词项。</p>
<p>如果想匹配一部分词项，就涉及到一个参数，就是 <code>minmum_should_match</code>，即最小匹配度。即至少匹配多少个词。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "name": {</span><br><span class="line">        "query": "语言程序设计",</span><br><span class="line">        "operator": "and"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "should": [</span><br><span class="line">        {</span><br><span class="line">          "term": {</span><br><span class="line">            "name": {</span><br><span class="line">              "value": "语言"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "term": {</span><br><span class="line">            "name": {</span><br><span class="line">              "value": "程序设计"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "term": {</span><br><span class="line">            "name": {</span><br><span class="line">              "value": "程序"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "term": {</span><br><span class="line">            "name": {</span><br><span class="line">              "value": "设计"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      "minimum_should_match": "50%"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "from": 0,</span><br><span class="line">  "size": 70</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>50% 表示词项个数的 50%。</p>
<p>如下两个查询等价（参数 4 是因为查询关键字分词后有 4 项）：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "name": {</span><br><span class="line">        "query": "语言程序设计",</span><br><span class="line">        "minimum_should_match": 4</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "name": {</span><br><span class="line">        "query": "语言程序设计",</span><br><span class="line">        "operator": "and"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="17-3-dis-max-query"><a href="#17-3-dis-max-query" class="headerlink" title="17.3 dis_max query"></a>17.3 dis_max query</h3><p>假设现在有两本书：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "title":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word"</span><br><span class="line">      },</span><br><span class="line">      "content":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">POST blog/_doc</span><br><span class="line">{</span><br><span class="line">  "title":"如何通过Java代码调用ElasticSearch",</span><br><span class="line">  "content":"松哥力荐，这是一篇很好的解决方案"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">POST blog/_doc</span><br><span class="line">{</span><br><span class="line">  "title":"初识 MongoDB",</span><br><span class="line">  "content":"简单介绍一下 MongoDB，以及如何通过 Java 调用 MongoDB，MongoDB 是一个不错 NoSQL 解决方案"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>现在假设搜索 <strong>Java解决方案</strong> 关键字，但是不确定关键字是在 title 还是在 content，所以两者都搜索：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "should": [</span><br><span class="line">        {</span><br><span class="line">          "match": {</span><br><span class="line">            "title": "java解决方案"</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "match": {</span><br><span class="line">            "content": "java解决方案"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>搜索结果如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "took" : 882,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 1,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "hits" : {</span><br><span class="line">    "total" : {</span><br><span class="line">      "value" : 2,</span><br><span class="line">      "relation" : "eq"</span><br><span class="line">    },</span><br><span class="line">    "max_score" : 1.1972204,</span><br><span class="line">    "hits" : [</span><br><span class="line">      {</span><br><span class="line">        "_index" : "blog",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "HhK653gBeADYd85qxnL3",</span><br><span class="line">        "_score" : 1.1972204,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "title" : "如何通过Java代码调用ElasticSearch",</span><br><span class="line">          "content" : "松哥力荐，这是一篇很好的解决方案"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "blog",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "HxK753gBeADYd85qCnLy",</span><br><span class="line">        "_score" : 1.1069256,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "title" : "初识 MongoDB",</span><br><span class="line">          "content" : "简单介绍一下 MongoDB，以及如何通过 Java 调用 MongoDB，MongoDB 是一个不错 NoSQL 解决方案"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>要理解这个原因，我们需要来看下 should query 中的评分策略：</p>
<ol>
<li>首先会执行 should 中的两个查询</li>
<li>对两个查询结果的评分求和</li>
<li>对求和结果乘以匹配语句总数</li>
<li>在对第三步的结果除以所有语句总数</li>
</ol>
<p>反映到具体的查询中：</p>
<p><strong>前者</strong></p>
<ol>
<li>title 中 包含 java，假设评分是 1.1</li>
<li>content 中包含解决方案，假设评分是 1.2</li>
<li>有得分的 query 数量，这里是 2</li>
<li>总的 query 数量也是 2</li>
</ol>
<p>最终结果：<code>（1.1+1.2）*2/2=2.3</code></p>
<p><strong>后者</strong></p>
<ol>
<li>title 中 不包含查询关键字，没有得分</li>
<li>content 中包含解决方案和 java，假设评分是 2</li>
<li>有得分的 query 数量，这里是 1</li>
<li>总的 query 数量也是 2</li>
</ol>
<p>最终结果：<code>2*1/2=1</code></p>
<p>在这种查询中，title 和 content 相当于是相互竞争的关系，所以我们需要找到一个最佳匹配字段。</p>
<p>为了解决这一问题，就需要用到 dis_max query（disjunction max query，分离最大化查询）：匹配的文档依然返回，但是只将最佳匹配的评分作为查询的评分。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "dis_max": {</span><br><span class="line">      "queries": [</span><br><span class="line">        {</span><br><span class="line">          "match": {</span><br><span class="line">            "title": "java解决方案"</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "match": {</span><br><span class="line">            "content": "java解决方案"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">        ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询结果如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "took" : 14,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 1,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "hits" : {</span><br><span class="line">    "total" : {</span><br><span class="line">      "value" : 2,</span><br><span class="line">      "relation" : "eq"</span><br><span class="line">    },</span><br><span class="line">    "max_score" : 1.1069256,</span><br><span class="line">    "hits" : [</span><br><span class="line">      {</span><br><span class="line">        "_index" : "blog",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "HxK753gBeADYd85qCnLy",</span><br><span class="line">        "_score" : 1.1069256,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "title" : "初识 MongoDB",</span><br><span class="line">          "content" : "简单介绍一下 MongoDB，以及如何通过 Java 调用 MongoDB，MongoDB 是一个不错 NoSQL 解决方案"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "blog",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "HhK653gBeADYd85qxnL3",</span><br><span class="line">        "_score" : 0.62177753,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "title" : "如何通过Java代码调用ElasticSearch",</span><br><span class="line">          "content" : "松哥力荐，这是一篇很好的解决方案"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在 dis_max query 中，还有一个参数 <code>tie_breaker</code>（取值在0～1），在 dis_max query 中，是完全不考虑其他 query 的分数，只是将最佳匹配的字段的评分返回。但是，有的时候，我们又不得不考虑一下其他 query 的分数，此时，可以通过 <code>tie_breaker</code> 来优化 dis_max query。<code>tie_breaker</code> 会将其他 query 的分数，乘以 <code>tie_breaker</code>，然后和分数最高的 query 进行一个综合计算。</p>
<h3 id="17-4-function-score-query"><a href="#17-4-function-score-query" class="headerlink" title="17.4 function_score query"></a>17.4 function_score query</h3><p>场景：例如想要搜索附近的肯德基，搜索的关键字是肯德基，但是我希望能够将评分较高的肯德基优先展示出来。但是默认的评分策略是没有办法考虑到餐厅评分的，他只是考虑相关性，这个时候可以通过 function_score query 来实现。</p>
<p>准备两条测试数据：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "title":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word"</span><br><span class="line">      },</span><br><span class="line">      "votes":{</span><br><span class="line">        "type": "integer"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">{</span><br><span class="line">  "title":"Java集合详解",</span><br><span class="line">  "votes":100</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT blog/_doc/2</span><br><span class="line">{</span><br><span class="line">  "title":"Java多线程详解，Java锁详解",</span><br><span class="line">  "votes":10</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>现在搜索标题中包含 java 关键字的文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "title": "java"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询结果如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "took" : 3,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 1,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "hits" : {</span><br><span class="line">    "total" : {</span><br><span class="line">      "value" : 2,</span><br><span class="line">      "relation" : "eq"</span><br><span class="line">    },</span><br><span class="line">    "max_score" : 0.22534126,</span><br><span class="line">    "hits" : [</span><br><span class="line">      {</span><br><span class="line">        "_index" : "blog",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "2",</span><br><span class="line">        "_score" : 0.22534126,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "title" : "Java多线程详解，Java锁详解",</span><br><span class="line">          "votes" : 10</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "blog",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "1",</span><br><span class="line">        "_score" : 0.21799318,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "title" : "Java集合详解",</span><br><span class="line">          "votes" : 100</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>默认情况下，id 为 2 的记录得分较高，因为他的 title 中包含两个 java。</p>
<p>如果我们在查询中，希望能够充分考虑 votes 字段，将 votes 较高的文档优先展示，就可以通过 function_score 来实现。</p>
<p>具体的思路，就是在旧的得分基础上，根据 votes 的数值进行综合运算，重新得出一个新的评分。</p>
<p>具体有几种不同的计算方式：</p>
<ul>
<li>weight</li>
<li>random_score</li>
<li>script_score</li>
<li>field_value_factor</li>
</ul>
<p><strong>weight</strong></p>
<p>weight 可以对评分设置权重，就是在旧的评分基础上乘以 weight，他其实无法解决我们上面所说的问题。具体用法如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "function_score": {</span><br><span class="line">      "query": {</span><br><span class="line">        "match": {</span><br><span class="line">          "title": "java"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      "functions": [</span><br><span class="line">        {</span><br><span class="line">          "weight": 10</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询结果如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "took" : 11,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 1,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "hits" : {</span><br><span class="line">    "total" : {</span><br><span class="line">      "value" : 2,</span><br><span class="line">      "relation" : "eq"</span><br><span class="line">    },</span><br><span class="line">    "max_score" : 2.2534127,</span><br><span class="line">    "hits" : [</span><br><span class="line">      {</span><br><span class="line">        "_index" : "blog",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "2",</span><br><span class="line">        "_score" : 2.2534127,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "title" : "Java多线程详解，Java锁详解",</span><br><span class="line">          "votes" : 10</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "blog",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "1",</span><br><span class="line">        "_score" : 2.1799319,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "title" : "Java集合详解",</span><br><span class="line">          "votes" : 100</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到，此时的评分，在之前的评分基础上<code>*</code>10</p>
<p><strong>random_score</strong></p>
<p><code>random_score</code> 会根据 uid 字段进行 hash 运算，生成分数，使用 <code>random_score</code> 时可以配置一个种子，如果不配置，默认使用当前时间。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "function_score": {</span><br><span class="line">      "query": {</span><br><span class="line">        "match": {</span><br><span class="line">          "title": "java"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      "functions": [</span><br><span class="line">        {</span><br><span class="line">          "random_score": {}</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>script_score</strong></p>
<p>自定义评分脚本。假设每个文档的最终得分是旧的分数加上votes。查询方式如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "function_score": {</span><br><span class="line">      "query": {</span><br><span class="line">        "match": {</span><br><span class="line">          "title": "java"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      "functions": [</span><br><span class="line">        {</span><br><span class="line">          "script_score": {</span><br><span class="line">            "script": {</span><br><span class="line">              "lang": "painless",</span><br><span class="line">              "source": "_score + doc['votes'].value"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>现在，最终得分是 <code>(oldScore+votes)*oldScore</code>。</p>
<p><strong>多了<code>，</code> 都会提示错误</strong></p>
<p>如果不想乘以 oldScore，查询方式如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "function_score": {</span><br><span class="line">      "query": {</span><br><span class="line">        "match": {</span><br><span class="line">          "title": "java"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      "functions": [</span><br><span class="line">        {</span><br><span class="line">          "script_score": {</span><br><span class="line">            "script": {</span><br><span class="line">              "lang": "painless",</span><br><span class="line">              "source": "_score + doc['votes'].value"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      "boost_mode": "replace"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>通过 <code>boost_mode</code> 参数，可以设置最终的计算方式。该参数还有其他取值：</p>
<ul>
<li>multiply：分数相乘</li>
<li>sum：分数相加</li>
<li>avg：求平均数</li>
<li>max：最大分</li>
<li>min：最小分</li>
<li>replace：不进行二次计算</li>
</ul>
<p><strong>field_value_factor</strong></p>
<p>这个的功能类似于 <code>script_score</code>，但是不用自己写脚本。</p>
<p>假设每个文档的最终得分是旧的分数乘以votes。查询方式如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "function_score": {</span><br><span class="line">      "query": {</span><br><span class="line">        "match": {</span><br><span class="line">          "title": "java"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      "functions": [</span><br><span class="line">        {</span><br><span class="line">          "field_value_factor": {</span><br><span class="line">            "field": "votes"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>默认的得分就是<code>oldScore*votes</code>。</p>
<p>还可以利用 es 内置的函数进行一些更复杂的运算：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "function_score": {</span><br><span class="line">      "query": {</span><br><span class="line">        "match": {</span><br><span class="line">          "title": "java"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      "functions": [</span><br><span class="line">        {</span><br><span class="line">          "field_value_factor": {</span><br><span class="line">            "field": "votes",</span><br><span class="line">            "modifier": "sqrt"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      "boost_mode": "replace"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>此时，最终的得分是（sqrt(votes)）。</p>
<p>modifier 中可以设置内置函数，其他的内置函数还有：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>none</td>
<td>默认的，不进行任何计算</td>
</tr>
<tr>
<td>log</td>
<td>对字段值取对数</td>
</tr>
<tr>
<td>log1p</td>
<td>字段值+1 然后取对数</td>
</tr>
<tr>
<td>log2p</td>
<td>字段值+2 然后取对数</td>
</tr>
<tr>
<td>ln</td>
<td>取字段值的自然对数</td>
</tr>
<tr>
<td>ln1p</td>
<td>字段值+1 然后取自然对数</td>
</tr>
<tr>
<td>ln2p</td>
<td>字段值+2 然后取自然对数</td>
</tr>
<tr>
<td>sqrt</td>
<td>字段值求平方根</td>
</tr>
<tr>
<td>square</td>
<td>字段值的平方</td>
</tr>
<tr>
<td>reciprocal</td>
<td>倒数</td>
</tr>
</tbody></table>
<p>另外还有个参数 factor ，影响因子。字段值先乘以影响因子，然后再进行计算。以 sqrt 为例，计算方式为 <code>sqrt(factor*votes)</code>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "function_score": {</span><br><span class="line">      "query": {</span><br><span class="line">        "match": {</span><br><span class="line">          "title": "java"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      "functions": [</span><br><span class="line">        {</span><br><span class="line">          "field_value_factor": {</span><br><span class="line">            "field": "votes",</span><br><span class="line">            "modifier": "sqrt",</span><br><span class="line">            "factor": 10</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      "boost_mode": "replace"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>还有一个参数 <code>max_boost</code>，控制计算结果的范围：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "function_score": {</span><br><span class="line">      "query": {</span><br><span class="line">        "match": {</span><br><span class="line">          "title": "java"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      "functions": [</span><br><span class="line">        {</span><br><span class="line">          "field_value_factor": {</span><br><span class="line">            "field": "votes"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      "boost_mode": "sum",</span><br><span class="line">      "max_boost": 100</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>max_boost</code> 参数表示 functions 模块中，最终的计算结果上限。如果超过上限，就按照上线计算。</p>
<h3 id="17-5-boosting-query"><a href="#17-5-boosting-query" class="headerlink" title="17.5 boosting query"></a>17.5 boosting query</h3><p>boosting query 中包含三部分：</p>
<ul>
<li>positive：得分不变</li>
<li>negative：降低得分</li>
<li>negative_boost：降低的权重</li>
</ul>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "boosting": {</span><br><span class="line">      "positive": {</span><br><span class="line">        "match": {</span><br><span class="line">          "name": "java"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      "negative": {</span><br><span class="line">        "match": {</span><br><span class="line">          "name": "2008"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      "negative_boost": 0.5</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询结果如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "took" : 15,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 1,</span><br><span class="line">    "successful" : 1,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "hits" : {</span><br><span class="line">    "total" : {</span><br><span class="line">      "value" : 2,</span><br><span class="line">      "relation" : "eq"</span><br><span class="line">    },</span><br><span class="line">    "max_score" : 4.5299835,</span><br><span class="line">    "hits" : [</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "549",</span><br><span class="line">        "_score" : 4.5299835,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "name" : "全国计算机等级考试笔试＋上机全真模拟：二级Java语言程序设计（最新版）",</span><br><span class="line">          "publish" : "高等教育出版社",</span><br><span class="line">          "type" : "考试认证",</span><br><span class="line">          "author" : "",</span><br><span class="line">          "info" : "为了更好地服务于考生，引导考生尽快掌握考试大纲中要求的知识点和技能，顺利通过计算机等级考试，根据最新的考试大纲，高等教育出版社组织长期从事计算机等级考试命题研究和培训工作的专家编写了这套“笔试+上机考试全真模拟”，全面模拟考试真题，让考生在做题的同时全面巩固复习考点，提前熟悉考试环境，在短时间内冲刺过关。本书内容包括20套笔试模拟题和20套上机模拟题，还给出了参考答案和解析，尤其适合参加计算机等级考试的考生考前实战演练。",</span><br><span class="line">          "price" : 30</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index" : "books",</span><br><span class="line">        "_type" : "_doc",</span><br><span class="line">        "_id" : "86",</span><br><span class="line">        "_score" : 2.5018067,</span><br><span class="line">        "_source" : {</span><br><span class="line">          "name" : "全国计算机等级考试2级教程：Java语言程序设计（2008年版）",</span><br><span class="line">          "publish" : "高等教育出版社",</span><br><span class="line">          "type" : "计算机考试",</span><br><span class="line">          "author" : "",</span><br><span class="line">          "info" : "由国家教育部考试中心推出的计算机等级考试是一种客观、公正、科学的专门测试计算机应用人员的计算机知识与技能的全国性考试，它面向社会，服务于社会。本书在教育部考试中心组织下、在全国计算机等级考试委员会指导下，由有关专家执笔编写而成。本书按照《全国计算机等级考试二级Java语言程序设计考试大纲（2007年版）》的要求编写，内容包括：Java体系结构、基本数据类型、流程控制语句、类、数组和字符串操作、输入输出及文件操作、图形用户界面编写、线程和串行化技术、A程序设计以及应用开发工具和安装使用等。本书是参加全国计算机等级考试二级Java语言程序设计的考生的良师益友，是教育部考试中心指定教材，也可作为欲学习Java编程的读者的参考书。",</span><br><span class="line">          "price" : 37</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到，id 为 86 的文档满足条件，因此它的最终得分在旧的分数上<code>*0.5</code>。</p>
<h2 id="18-ElasticSearch-嵌套查询"><a href="#18-ElasticSearch-嵌套查询" class="headerlink" title="18.ElasticSearch 嵌套查询"></a>18.ElasticSearch 嵌套查询</h2><p>关系型数据库中有表的关联关系，在 es 中，我们也有类似的需求，例如订单表和商品表，在 es 中，这样的一对多一般来说有两种方式：</p>
<ul>
<li>嵌套文档（nested）</li>
<li>父子文档</li>
</ul>
<h3 id="18-1-嵌套文档"><a href="#18-1-嵌套文档" class="headerlink" title="18.1 嵌套文档"></a>18.1 嵌套文档</h3><p>假设：有一个电影文档，每个电影都有演员信息：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PUT movies</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "actors":{</span><br><span class="line">        "type": "nested"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT movies/_doc/1</span><br><span class="line">{</span><br><span class="line">  "name":"霸王别姬",</span><br><span class="line">  "actors":[</span><br><span class="line">    {</span><br><span class="line">      "name":"张国荣",</span><br><span class="line">      "gender":"男"</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      "name":"巩俐",</span><br><span class="line">      "gender":"女"</span><br><span class="line">    }</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意 actors 类型要是 nested，具体原因参考 10.2.3 小节。</p>
<p><strong>缺点</strong></p>
<p>查看文档数量：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _cat/indices?v</span><br></pre></td></tr></tbody></table></figure>

<p>查看结果如下：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210419181937.png" alt="image-20210419181937314"></p>
<p>添加了1个文档，显示存了3个</p>
<p>这是因为 nested 文档在 es 内部其实也是独立的 lucene 文档，只是在我们查询的时候，es 内部帮我们做了 join 处理，所以最终看起来就像一个独立文档一样。因此这种方案性能并不是特别好。</p>
<h3 id="18-2-嵌套查询"><a href="#18-2-嵌套查询" class="headerlink" title="18.2 嵌套查询"></a>18.2 嵌套查询</h3><p>这个用来查询嵌套文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET movies/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "nested": {</span><br><span class="line">      "path": "actors",</span><br><span class="line">      "query": {</span><br><span class="line">        "bool": {</span><br><span class="line">          "must": [</span><br><span class="line">            {</span><br><span class="line">              "match": {</span><br><span class="line">                "actors.name": "张国荣"</span><br><span class="line">              }</span><br><span class="line">            },</span><br><span class="line">            {</span><br><span class="line">              "match": {</span><br><span class="line">                "actors.gender": "男"</span><br><span class="line">              }</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="18-3-父子文档"><a href="#18-3-父子文档" class="headerlink" title="18.3 父子文档"></a>18.3 父子文档</h3><p>相比于嵌套文档，父子文档主要有如下优势：</p>
<ul>
<li>更新父文档时，不会重新索引子文档</li>
<li>创建、修改或者删除子文档时，不会影响父文档或者其他的子文档。</li>
<li>子文档可以作为搜索结果独立返回。</li>
</ul>
<p>例如学生和班级的关系：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT stu_class</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "name":{</span><br><span class="line">        "type": "keyword"</span><br><span class="line">      },</span><br><span class="line">      "s_c":{</span><br><span class="line">        "type": "join",</span><br><span class="line">        "relations":{</span><br><span class="line">          "class":"student"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>s_c</code> 表示父子文档关系的名字，可以自定义。join 表示这是一个父子文档。relations 里边，class 这个位置是 parent，student 这个位置是 child。</p>
<p>接下来，插入两个父文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT stu_class/_doc/1</span><br><span class="line">{</span><br><span class="line">  "name":"一班",</span><br><span class="line">  "s_c":{</span><br><span class="line">    "name":"class"</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">PUT stu_class/_doc/2</span><br><span class="line">{	</span><br><span class="line">  "name":"二班",</span><br><span class="line">  "s_c":{</span><br><span class="line">    "name":"class"</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>再来添加三个子文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUT stu_class/_doc/3?routing=1</span><br><span class="line">{</span><br><span class="line">  "name":"zhangsan",</span><br><span class="line">  "s_c":{</span><br><span class="line">    "name":"student",</span><br><span class="line">    "parent":1</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">PUT stu_class/_doc/4?routing=1</span><br><span class="line">{</span><br><span class="line">  "name":"lisi",</span><br><span class="line">  "s_c":{</span><br><span class="line">    "name":"student",</span><br><span class="line">    "parent":1</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">PUT stu_class/_doc/5?routing=2</span><br><span class="line">{</span><br><span class="line">  "name":"wangwu",</span><br><span class="line">  "s_c":{</span><br><span class="line">    "name":"student",</span><br><span class="line">    "parent":2</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>首先大家可以看到，子文档都是独立的文档。特别需要注意的地方是，子文档需要和父文档在同一个分片上，所以 routing 关键字的值为父文档的 id。另外，name 属性表明这是一个子文档。</p>
<p>父子文档需要注意的地方：</p>
<ol>
<li>每个索引只能定义一个 join filed</li>
<li>父子文档需要在同一个分片上（查询，修改需要routing）</li>
<li>可以向一个已经存在的 join filed 上新增关系</li>
</ol>
<h3 id="18-4-has-child-query"><a href="#18-4-has-child-query" class="headerlink" title="18.4 has_child query"></a>18.4 has_child query</h3><p>通过子文档查询父文档使用 <code>has_child</code> query。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET stu_class/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "has_child": {</span><br><span class="line">      "type": "student",</span><br><span class="line">      "query": {</span><br><span class="line">        "match": {</span><br><span class="line">          "name": "wangwu"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询 wangwu 所属的班级。</p>
<h3 id="18-5-has-parent-query"><a href="#18-5-has-parent-query" class="headerlink" title="18.5 has_parent query"></a>18.5 has_parent query</h3><p>通过父文档查询子文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET stu_class/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "has_parent": {</span><br><span class="line">      "parent_type": "class",</span><br><span class="line">      "query": {</span><br><span class="line">        "match": {</span><br><span class="line">          "name": "二班"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询二班的学生。但是大家注意，<strong>这种查询没有评分。</strong></p>
<p>可以使用 parent id 查询子文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET stu_class/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "parent_id":{</span><br><span class="line">      "type":"student",</span><br><span class="line">      "id":1</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>通过 parent id 查询，默认情况下使<strong>用相关性计算分数</strong>。</p>
<h3 id="18-6-小结"><a href="#18-6-小结" class="headerlink" title="18.6 小结"></a>18.6 小结</h3><p>整体上来说：</p>
<ol>
<li>普通子对象实现一对多，会损失子文档的边界，子对象之间的属性关系丢失。</li>
<li>nested 可以解决第 1 点的问题，但是 nested 有两个缺点：更新主文档的时候要全部更新，不支持子文档属于多个主文档。<ol>
<li>父子文档解决 1、2 点的问题，但是它主要适用于<strong>写多读少</strong>的场景。</li>
</ol>
</li>
</ol>
<h2 id="19-ElasticSearch-地理位置查询"><a href="#19-ElasticSearch-地理位置查询" class="headerlink" title="19.ElasticSearch 地理位置查询"></a>19.ElasticSearch 地理位置查询</h2><h3 id="19-1-数据准备"><a href="#19-1-数据准备" class="headerlink" title="19.1 数据准备"></a>19.1 数据准备</h3><p>创建一个索引：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT geo</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "name":{</span><br><span class="line">        "type": "keyword"</span><br><span class="line">      },</span><br><span class="line">      "location":{</span><br><span class="line">        "type": "geo_point"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>准备一个 geo.json 文件：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">{"index":{"_index":"geo","_id":1}}</span><br><span class="line">{"name":"西安","location":"34.288991865037524,108.9404296875"}</span><br><span class="line">{"index":{"_index":"geo","_id":2}}</span><br><span class="line">{"name":"北京","location":"39.926588421909436,116.43310546875"}</span><br><span class="line">{"index":{"_index":"geo","_id":3}}</span><br><span class="line">{"name":"上海","location":"31.240985378021307,121.53076171875"}</span><br><span class="line">{"index":{"_index":"geo","_id":4}}</span><br><span class="line">{"name":"天津","location":"39.13006024213511,117.20214843749999"}</span><br><span class="line">{"index":{"_index":"geo","_id":5}}</span><br><span class="line">{"name":"杭州","location":"30.259067203213018,120.21240234375001"}</span><br><span class="line">{"index":{"_index":"geo","_id":6}}</span><br><span class="line">{"name":"武汉","location":"30.581179257386985,114.3017578125"}</span><br><span class="line">{"index":{"_index":"geo","_id":7}}</span><br><span class="line">{"name":"合肥","location":"31.840232667909365,117.20214843749999"}</span><br><span class="line">{"index":{"_index":"geo","_id":8}}</span><br><span class="line">{"name":"重庆","location":"29.592565403314087,106.5673828125"}</span><br></pre></td></tr></tbody></table></figure>

<p>最后，执行如下命令，批量导入 geo.json 数据：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST "http://localhost:9200/geo/_bulk?pretty" -H "content-type:application/json" --data-binary @geo.json</span><br></pre></td></tr></tbody></table></figure>

<p>可能用到的工具网站：</p>
<p><a target="_blank" rel="noopener" href="http://geojson.io/#map=6/32.741/116.521">http://geojson.io/#map=6/32.741/116.521</a></p>
<h3 id="19-2-geo-distance-query"><a href="#19-2-geo-distance-query" class="headerlink" title="19.2 geo_distance query"></a>19.2 geo_distance query</h3><p>给出一个中心点，查询距离该中心点指定范围内的文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET geo/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "must": [</span><br><span class="line">        {</span><br><span class="line">          "match_all": {}</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      "filter": [</span><br><span class="line">        {</span><br><span class="line">          "geo_distance": {</span><br><span class="line">            "distance": "600km",</span><br><span class="line">            "location": {</span><br><span class="line">              "lat": 34.288991865037524,</span><br><span class="line">              "lon": 108.9404296875</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>以(34.288991865037524,108.9404296875) 为圆心，以 600KM 为半径，这个范围内的数据。</p>
<h3 id="19-3-geo-bounding-box-query"><a href="#19-3-geo-bounding-box-query" class="headerlink" title="19.3 geo_bounding_box query"></a>19.3 geo_bounding_box query</h3><p>在某一个矩形内的点，通过两个点锁定一个矩形：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET geo/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "must": [</span><br><span class="line">        {</span><br><span class="line">          "match_all": {}</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      "filter": [</span><br><span class="line">        {</span><br><span class="line">          "geo_bounding_box": {</span><br><span class="line">            "location": {</span><br><span class="line">              "top_left": {</span><br><span class="line">                "lat": 32.0639555946604,</span><br><span class="line">                "lon": 118.78967285156249</span><br><span class="line">              },</span><br><span class="line">              "bottom_right": {</span><br><span class="line">                "lat": 29.98824461550903,</span><br><span class="line">                "lon": 122.20642089843749</span><br><span class="line">              }</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>以南京经纬度作为矩形的左上角，以舟山经纬度作为矩形的右下角，构造出来的矩形中，包含上海和杭州两个城市。</p>
<h3 id="19-4-geo-polygon-query"><a href="#19-4-geo-polygon-query" class="headerlink" title="19.4 geo_polygon query"></a>19.4 geo_polygon query</h3><p>在某一个多边形范围内的查询。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">GET geo/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "must": [</span><br><span class="line">        {</span><br><span class="line">          "match_all": {}</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      "filter": [</span><br><span class="line">        {</span><br><span class="line">          "geo_polygon": {</span><br><span class="line">            "location": {</span><br><span class="line">              "points": [</span><br><span class="line">                {</span><br><span class="line">                  "lat": 31.793755581217674,</span><br><span class="line">                  "lon": 113.8238525390625</span><br><span class="line">                },</span><br><span class="line">                {</span><br><span class="line">                  "lat": 30.007273923504556,</span><br><span class="line">                  "lon":114.224853515625</span><br><span class="line">                },</span><br><span class="line">                {</span><br><span class="line">                  "lat": 30.007273923504556,</span><br><span class="line">                  "lon":114.8345947265625</span><br><span class="line">                }</span><br><span class="line">              ]</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>给定多个点，由多个点组成的多边形中的数据。    </p>
<p>es7.12出现提示 #! Deprecated field [geo_polygon] used, replaced by [[geo_shape] query where polygons are defined in geojson or wkt]</p>
<h3 id="19-5-geo-shape-query"><a href="#19-5-geo-shape-query" class="headerlink" title="19.5 geo_shape query"></a>19.5 geo_shape query</h3><p><code>geo_shape</code> 用来查询图形，针对 <code>geo_shape</code>，两个图形之间的关系有：相交、包含、不相交。</p>
<p>新建索引：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT geo_shape</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "name":{</span><br><span class="line">        "type": "keyword"</span><br><span class="line">      },</span><br><span class="line">      "location":{</span><br><span class="line">        "type": "geo_shape"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后添加一条线：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT geo_shape/_doc/1</span><br><span class="line">{</span><br><span class="line">  "name":"西安-郑州",</span><br><span class="line">  "location":{</span><br><span class="line">    "type":"linestring",</span><br><span class="line">    "coordinates":[</span><br><span class="line">      [108.9404296875,34.279914398549934],</span><br><span class="line">      [113.66455078125,34.768691457552706]</span><br><span class="line">      ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>接下来查询某一个图形中是否包含该线：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">GET geo_shape/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "must": [</span><br><span class="line">        {</span><br><span class="line">          "match_all": {}</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      "filter": [</span><br><span class="line">        {</span><br><span class="line">          "geo_shape": {</span><br><span class="line">            "location": {</span><br><span class="line">              "shape": {</span><br><span class="line">                "type": "envelope",</span><br><span class="line">                "coordinates": [</span><br><span class="line">                  [</span><br><span class="line">            106.5234375,</span><br><span class="line">            36.80928470205937</span><br><span class="line">          ],</span><br><span class="line">          [</span><br><span class="line">            115.33447265625,</span><br><span class="line">            32.24997445586331</span><br><span class="line">          ]</span><br><span class="line">                ]</span><br><span class="line">              },</span><br><span class="line">              "relation": "within"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>relation 属性表示两个图形的关系：</p>
<ul>
<li>within 包含</li>
<li>intersects 相交</li>
<li>disjoint 不相交</li>
</ul>
<h2 id="20-ElasticSearch-特殊查询"><a href="#20-ElasticSearch-特殊查询" class="headerlink" title="20.ElasticSearch 特殊查询"></a>20.ElasticSearch 特殊查询</h2><h3 id="20-1-more-like-this-query"><a href="#20-1-more-like-this-query" class="headerlink" title="20.1 more_like_this query"></a>20.1 more_like_this query</h3><p><code>more_like_this</code> query 可以实现基于内容的推荐，给定一篇文章，可以查询出和该文章相似的内容。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "more_like_this": {</span><br><span class="line">      "fields": [</span><br><span class="line">        "info"</span><br><span class="line">      ],</span><br><span class="line">      "like": "大学战略",</span><br><span class="line">      "min_term_freq": 1,</span><br><span class="line">      "max_query_terms": 12</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>fields：要匹配的字段，可以有多个</li>
<li>like：要匹配的文本</li>
<li>min_term_freq：词项的最低频率，默认是 2。<strong>特别注意，这个是指词项在要匹配的文本中的频率，而不是 es 文档中的频率</strong></li>
<li>max_query_terms：query 中包含的最大词项数目</li>
<li>min_doc_freq：最小的文档频率，搜索的词，至少在多少个文档中出现，少于指定数目，该词会被忽略</li>
<li>max_doc_freq：最大文档频率</li>
<li>analyzer：分词器，默认使用字段的分词器</li>
<li>stop_words：停用词列表</li>
<li>minmum_should_match</li>
</ul>
<h3 id="20-2-script-query"><a href="#20-2-script-query" class="headerlink" title="20.2 script query"></a>20.2 script query</h3><p>脚本查询，例如查询所有价格大于 200 的图书：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "filter": [</span><br><span class="line">        {</span><br><span class="line">          "script": {</span><br><span class="line">            "script": {</span><br><span class="line">              "lang": "painless",</span><br><span class="line">              "source": "if(doc['price'].size()!=0){doc['price'].value &gt; 200}"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="20-3-percolate-query"><a href="#20-3-percolate-query" class="headerlink" title="20.3 percolate query"></a>20.3 percolate query</h3><p>percolate query 译作渗透查询或者反向查询。</p>
<ul>
<li>正常操作：根据查询语句找到对应的文档 query-&gt;document</li>
<li>percolate query：根据文档，返回与之匹配的查询语句，document-&gt;query</li>
</ul>
<p>应用场景：</p>
<ul>
<li>价格监控</li>
<li>库存报警</li>
<li>股票警告</li>
<li>…</li>
</ul>
<p>例如阈值告警，假设指定字段值大于阈值，报警提示。</p>
<p>percolate mapping 定义：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT log</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "threshold":{</span><br><span class="line">        "type": "long"</span><br><span class="line">      },</span><br><span class="line">      "count":{</span><br><span class="line">        "type": "long"</span><br><span class="line">      },</span><br><span class="line">      "query":{</span><br><span class="line">        "type":"percolator"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>percolator 类型相当于 keyword、long 以及 integer 等。</p>
<p>插入文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT log/_doc/1</span><br><span class="line">{</span><br><span class="line">  "threshold":10,</span><br><span class="line">  "query":{</span><br><span class="line">    "bool":{</span><br><span class="line">      "must":{</span><br><span class="line">        "range":{</span><br><span class="line">          "count":{</span><br><span class="line">            "gt":10</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>最后查询：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GET log/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "percolate": {</span><br><span class="line">      "field": "query",</span><br><span class="line">      "documents": [</span><br><span class="line">        {</span><br><span class="line">          "count":3</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "count":6</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "count":90</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "count":12</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "count":15</span><br><span class="line">        }</span><br><span class="line">        ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询结果中会列出不满足条件的文档。</p>
<p>查询结果中的 <code>_percolator_document_slot</code> 字段表示文档的 position，从 0 开始计。</p>
<h2 id="21-ElasticSearch-搜索高亮与排序"><a href="#21-ElasticSearch-搜索高亮与排序" class="headerlink" title="21.ElasticSearch 搜索高亮与排序"></a>21.ElasticSearch 搜索高亮与排序</h2><h3 id="21-1-搜索高亮"><a href="#21-1-搜索高亮" class="headerlink" title="21.1 搜索高亮"></a>21.1 搜索高亮</h3><p>普通高亮，默认会自动添加 em 标签：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "name": "大学"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "highlight": {</span><br><span class="line">    "fields": {</span><br><span class="line">      "name": {}</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>正常来说，我们见到的高亮可能是红色、黄色之类的。</p>
<p>可以自定义高亮标签：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "name": "大学"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "highlight": {</span><br><span class="line">    "fields": {</span><br><span class="line">      "name": {</span><br><span class="line">        "pre_tags": ["&lt;strong&gt;"],</span><br><span class="line">        "post_tags": ["&lt;/strong&gt;"]</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>有的时候，虽然我们是在 name 字段中搜索的，但是我们希望 info 字段中，相关的关键字也能高亮：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "name": "大学"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "highlight": {</span><br><span class="line">    "require_field_match": "false", </span><br><span class="line">    "fields": {</span><br><span class="line">      "name": {</span><br><span class="line">        "pre_tags": ["&lt;strong&gt;"],</span><br><span class="line">        "post_tags": ["&lt;/strong&gt;"]</span><br><span class="line">      },</span><br><span class="line">      "info": {</span><br><span class="line">        "pre_tags": ["&lt;strong&gt;"],</span><br><span class="line">        "post_tags": ["&lt;/strong&gt;"]</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>require_field_match</strong></p>
<p>By default, only fields that contains a query match are highlighted. Set <code>require_field_match</code> to <code>false</code> to highlight all fields. Defaults to <code>true</code>.</p>
<h3 id="21-2-排序"><a href="#21-2-排序" class="headerlink" title="21.2 排序"></a>21.2 排序</h3><p>排序很简单，默认是按照查询文档的相关度来排序的，即（<code>_score</code> 字段）：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "name": {</span><br><span class="line">        "value": "java"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>等价于：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "name": {</span><br><span class="line">        "value": "java"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "sort": [</span><br><span class="line">    {</span><br><span class="line">      "_score": {</span><br><span class="line">        "order": "desc"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>match_all 查询只是返回所有文档，不评分，默认按照添加顺序返回，可以通过 <code>_doc</code> 字段对其进行排序：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match_all": {}</span><br><span class="line">  },</span><br><span class="line">  "sort": [</span><br><span class="line">    {</span><br><span class="line">      "_doc": {</span><br><span class="line">        "order": "desc"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  "size": 20</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>es 同时也支持多字段排序。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match_all": {}</span><br><span class="line">  },</span><br><span class="line">  "sort": [</span><br><span class="line">    {</span><br><span class="line">      "price": {</span><br><span class="line">        "order": "asc"</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      "_doc": {</span><br><span class="line">        "order": "desc"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  ],</span><br><span class="line">  "size": 20</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="22-ElasticSearch-指标聚合"><a href="#22-ElasticSearch-指标聚合" class="headerlink" title="22.ElasticSearch 指标聚合"></a>22.ElasticSearch 指标聚合</h2><h3 id="22-1-Max-Aggregation"><a href="#22-1-Max-Aggregation" class="headerlink" title="22.1 Max Aggregation"></a>22.1 Max Aggregation</h3><p>统计最大值。例如查询价格最高的书：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "max_price": {</span><br><span class="line">      "max": {</span><br><span class="line">        "field": "price"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "max_price": {</span><br><span class="line">      "max": {</span><br><span class="line">        "field": "price",</span><br><span class="line">        "missing": 1000</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果某个文档中缺少 price 字段，则设置该字段的值为 1000。</p>
<p>也可以通过脚本来查询最大值：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "max_price": {</span><br><span class="line">      "max": {</span><br><span class="line">        "script": {</span><br><span class="line">          "source": "if(doc['price'].size()!=0){doc.price.value}"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>使用脚本时，可以先通过 <code>doc['price'].size()!=0</code> 去判断文档是否有对应的属性。</p>
<h3 id="22-2-Min-Aggregation"><a href="#22-2-Min-Aggregation" class="headerlink" title="22.2 Min Aggregation"></a>22.2 Min Aggregation</h3><p>统计最小值，用法和 Max Aggregation 基本一致：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "min_price": {</span><br><span class="line">      "min": {</span><br><span class="line">        "field": "price",</span><br><span class="line">        "missing": 1000</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>脚本：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "min_price": {</span><br><span class="line">      "min": {</span><br><span class="line">        "script": {</span><br><span class="line">          "source": "if(doc['price'].size()!=0){doc.price.value}"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="22-3-Avg-Aggregation"><a href="#22-3-Avg-Aggregation" class="headerlink" title="22.3 Avg Aggregation"></a>22.3 Avg Aggregation</h3><p>统计平均值：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "avg_price": {</span><br><span class="line">      "avg": {</span><br><span class="line">        "field": "price"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "avg_price": {</span><br><span class="line">      "avg": {</span><br><span class="line">        "script": {</span><br><span class="line">          "source": "if(doc['price'].size()!=0){doc.price.value}"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="22-4-Sum-Aggregation"><a href="#22-4-Sum-Aggregation" class="headerlink" title="22.4 Sum Aggregation"></a>22.4 Sum Aggregation</h3><p>求和：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "sum_price": {</span><br><span class="line">      "sum": {</span><br><span class="line">        "field": "price"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "sum_price": {</span><br><span class="line">      "sum": {</span><br><span class="line">        "script": {</span><br><span class="line">          "source": "if(doc['price'].size()!=0){doc.price.value}"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="22-5-Cardinality-Aggregation"><a href="#22-5-Cardinality-Aggregation" class="headerlink" title="22.5 Cardinality Aggregation"></a>22.5 Cardinality Aggregation</h3><p>cardinality aggregation 用于基数统计。类似于 SQL 中的 distinct count(0)：</p>
<p>text 类型是分析型类型，默认是不允许进行聚合操作的，如果相对 text 类型进行聚合操作，需要设置其 fielddata 属性为 true，这种方式虽然可以使 text 类型进行聚合操作，但是无法满足精准聚合，如果需要精准聚合，可以设置字段的子域为 keyword。</p>
<p><strong>方式一：</strong></p>
<p>重新定义 books 索引：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">PUT books</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "name":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word"</span><br><span class="line">      },</span><br><span class="line">      "publish":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word",</span><br><span class="line">        "fielddata": true</span><br><span class="line">      },</span><br><span class="line">      "type":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word"</span><br><span class="line">      },</span><br><span class="line">      "author":{</span><br><span class="line">        "type": "keyword"</span><br><span class="line">      },</span><br><span class="line">      "info":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word"</span><br><span class="line">      },</span><br><span class="line">      "price":{</span><br><span class="line">        "type": "double"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>定义完成后，重新插入数据（参考之前的视频）。</p>
<p>接下来就可以查询出版社的总数量：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "publish_count": {</span><br><span class="line">      "cardinality": {</span><br><span class="line">        "field": "publish"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这种聚合方式可能会不准确。可以将 publish 设置为 keyword 类型或者设置子域为 keyword。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PUT books</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "properties": {</span><br><span class="line">      "name":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word"</span><br><span class="line">      },</span><br><span class="line">      "publish":{</span><br><span class="line">        "type": "keyword"</span><br><span class="line">      },</span><br><span class="line">      "type":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word"</span><br><span class="line">      },</span><br><span class="line">      "author":{</span><br><span class="line">        "type": "keyword"</span><br><span class="line">      },</span><br><span class="line">      "info":{</span><br><span class="line">        "type": "text",</span><br><span class="line">        "analyzer": "ik_max_word"</span><br><span class="line">      },</span><br><span class="line">      "price":{</span><br><span class="line">        "type": "double"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>对比查询结果可知，使用 fileddata 的方式，查询结果不准确。</p>
<h3 id="22-6-Stats-Aggregation"><a href="#22-6-Stats-Aggregation" class="headerlink" title="22.6 Stats Aggregation"></a>22.6 Stats Aggregation</h3><p>基本统计，一次性返回 count、max、min、avg、sum：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "stats_query": {</span><br><span class="line">      "stats": {</span><br><span class="line">        "field": "price"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="22-7-Extends-Stats-Aggregation"><a href="#22-7-Extends-Stats-Aggregation" class="headerlink" title="22.7 Extends Stats Aggregation"></a>22.7 Extends Stats Aggregation</h3><p>高级统计，比 stats 多出来：平方和、方差、标准差、平均值加减两个标准差的区间：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "es": {</span><br><span class="line">      "extended_stats": {</span><br><span class="line">        "field": "price"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="22-8-Percentiles-Aggregation"><a href="#22-8-Percentiles-Aggregation" class="headerlink" title="22.8 Percentiles Aggregation"></a>22.8 Percentiles Aggregation</h3><p>百分位统计。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "p": {</span><br><span class="line">      "percentiles": {</span><br><span class="line">        "field": "price",</span><br><span class="line">        "percents": [</span><br><span class="line">          1,</span><br><span class="line">          5,</span><br><span class="line">          10,</span><br><span class="line">          15,</span><br><span class="line">          25,</span><br><span class="line">          50,</span><br><span class="line">          75,</span><br><span class="line">          95,</span><br><span class="line">          99</span><br><span class="line">        ]</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="22-9-Value-Count-Aggregation"><a href="#22-9-Value-Count-Aggregation" class="headerlink" title="22.9 Value Count Aggregation"></a>22.9 Value Count Aggregation</h3><p>可以按照字段统计文档数量（包含指定字段的文档数量）：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "count": {</span><br><span class="line">      "value_count": {</span><br><span class="line">        "field": "price"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="23-ElasticSearch-桶聚合（bucket）"><a href="#23-ElasticSearch-桶聚合（bucket）" class="headerlink" title="23.ElasticSearch 桶聚合（bucket）"></a>23.ElasticSearch 桶聚合（bucket）</h2><h3 id="23-1-Terms-Aggregation"><a href="#23-1-Terms-Aggregation" class="headerlink" title="23.1 Terms Aggregation"></a>23.1 Terms Aggregation</h3><p>Terms Aggregation 用于分组聚合，例如，统计各个出版社出版的图书总数量:</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "NAME": {</span><br><span class="line">      "terms": {</span><br><span class="line">        "field": "publish",</span><br><span class="line">        "size": 20</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在 terms 分桶的基础上，还可以对每个桶进行指标聚合。</p>
<p>统计不同出版社所出版的图书的平均价格：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "NAME": {</span><br><span class="line">      "terms": {</span><br><span class="line">        "field": "publish",</span><br><span class="line">        "size": 20</span><br><span class="line">      },</span><br><span class="line">      "aggs": {</span><br><span class="line">        "avg_price": {</span><br><span class="line">          "avg": {</span><br><span class="line">            "field": "price"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="23-2-Filter-Aggregation"><a href="#23-2-Filter-Aggregation" class="headerlink" title="23.2 Filter Aggregation"></a>23.2 Filter Aggregation</h3><p>过滤器聚合。可以将符合过滤器中条件的文档分到一个桶中，然后可以求其平均值。</p>
<p>例如查询书名中包含 java 的图书的平均价格：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "NAME": {</span><br><span class="line">      "filter": {</span><br><span class="line">        "term": {</span><br><span class="line">          "name": "java"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      "aggs": {</span><br><span class="line">        "avg_price": {</span><br><span class="line">          "avg": {</span><br><span class="line">            "field": "price"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="23-3-Filters-Aggregation"><a href="#23-3-Filters-Aggregation" class="headerlink" title="23.3 Filters Aggregation"></a>23.3 Filters Aggregation</h3><p>多过滤器聚合。过滤条件可以有多个。</p>
<p>例如查询书名中包含 java 或者 office 的图书的平均价格：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "NAME": {</span><br><span class="line">      "filters": {</span><br><span class="line">        "filters": [</span><br><span class="line">          {</span><br><span class="line">            "term":{</span><br><span class="line">              "name":"java"</span><br><span class="line">            }</span><br><span class="line">          },{</span><br><span class="line">            "term":{</span><br><span class="line">              "name":"office"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">          ]</span><br><span class="line">      },</span><br><span class="line">      "aggs": {</span><br><span class="line">        "avg_price": {</span><br><span class="line">          "avg": {</span><br><span class="line">            "field": "price"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="23-4-Range-Aggregation"><a href="#23-4-Range-Aggregation" class="headerlink" title="23.4 Range Aggregation"></a>23.4 Range Aggregation</h3><p>按照范围聚合，在某一个范围内的文档数统计。</p>
<p>例如统计图书价格在 0-50、50-100、100-150、150以上的图书数量：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "NAME": {</span><br><span class="line">      "range": {</span><br><span class="line">        "field": "price",</span><br><span class="line">        "ranges": [</span><br><span class="line">          {</span><br><span class="line">            "to": 50</span><br><span class="line">          },{</span><br><span class="line">            "from": 50,</span><br><span class="line">            "to": 100</span><br><span class="line">          },{</span><br><span class="line">            "from": 100,</span><br><span class="line">            "to": 150</span><br><span class="line">          },{</span><br><span class="line">            "from": 150</span><br><span class="line">          }</span><br><span class="line">        ]</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="23-5-Date-Range-Aggregation"><a href="#23-5-Date-Range-Aggregation" class="headerlink" title="23.5 Date Range Aggregation"></a>23.5 Date Range Aggregation</h3><p>Range Aggregation 也可以用来统计日期，但是也可以使用 Date Range Aggregation，后者的优势在于可以使用日期表达式。</p>
<p>造数据：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/1</span><br><span class="line">{</span><br><span class="line">  "title":"java",</span><br><span class="line">  "date":"2018-12-30"</span><br><span class="line">}</span><br><span class="line">PUT blog/_doc/2</span><br><span class="line">{</span><br><span class="line">  "title":"java",</span><br><span class="line">  "date":"2020-12-30"</span><br><span class="line">}</span><br><span class="line">PUT blog/_doc/3</span><br><span class="line">{</span><br><span class="line">  "title":"java",</span><br><span class="line">  "date":"2022-10-30"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>统计一年前到一年后的博客数量：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "NAME": {</span><br><span class="line">      "date_range": {</span><br><span class="line">        "field": "date",</span><br><span class="line">        "ranges": [</span><br><span class="line">          {</span><br><span class="line">            "from": "now-12M/M",</span><br><span class="line">            "to": "now+1y/y"</span><br><span class="line">          }</span><br><span class="line">        ]</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>12M/M 表示 12 个月。</li>
<li>1y/y 表示 1年。</li>
<li>d 表示天</li>
</ul>
<h3 id="23-6-Date-Histogram-Aggregation"><a href="#23-6-Date-Histogram-Aggregation" class="headerlink" title="23.6 Date Histogram Aggregation"></a>23.6 Date Histogram Aggregation</h3><p>时间直方图聚合。</p>
<p>例如统计各个月份的博客数量</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "NAME": {</span><br><span class="line">      "date_histogram": {</span><br><span class="line">        "field": "date",</span><br><span class="line">        "calendar_interval": "month"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="23-7-Missing-Aggregation"><a href="#23-7-Missing-Aggregation" class="headerlink" title="23.7 Missing Aggregation"></a>23.7 Missing Aggregation</h3><p>空值聚合。</p>
<p>统计所有没有 price 字段的文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "NAME": {</span><br><span class="line">      "missing": {</span><br><span class="line">        "field": "price"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="23-8-Children-Aggregation"><a href="#23-8-Children-Aggregation" class="headerlink" title="23.8 Children Aggregation"></a>23.8 Children Aggregation</h3><p>可以根据父子文档关系进行分桶。</p>
<p>查询子类型为 student 的文档数量：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET stu_class/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "NAME": {</span><br><span class="line">      "children": {</span><br><span class="line">        "type": "student"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="23-9-Geo-Distance-Aggregation"><a href="#23-9-Geo-Distance-Aggregation" class="headerlink" title="23.9 Geo Distance Aggregation"></a>23.9 Geo Distance Aggregation</h3><p>对地理位置数据做统计。</p>
<p>例如查询(34.288991865037524,108.9404296875)坐标方圆 600KM 和 超过 600KM 的城市数量。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET geo/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "NAME": {</span><br><span class="line">      "geo_distance": {</span><br><span class="line">        "field": "location",</span><br><span class="line">        "origin": "34.288991865037524,108.9404296875",</span><br><span class="line">        "unit": "km", </span><br><span class="line">        "ranges": [</span><br><span class="line">          {</span><br><span class="line">            "to": 600</span><br><span class="line">          },{</span><br><span class="line">            "from": 600</span><br><span class="line">          }</span><br><span class="line">        ]</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="23-10-IP-Range-Aggregation"><a href="#23-10-IP-Range-Aggregation" class="headerlink" title="23.10 IP Range Aggregation"></a>23.10 IP Range Aggregation</h3><p>IP 地址范围查询。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "NAME": {</span><br><span class="line">      "ip_range": {</span><br><span class="line">        "field": "ip",</span><br><span class="line">        "ranges": [</span><br><span class="line">          {</span><br><span class="line">            "from": "127.0.0.5",</span><br><span class="line">            "to": "127.0.0.11"</span><br><span class="line">          }</span><br><span class="line">        ]</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="24-ElasticSearch-管道聚合-类似于linux的-管道符"><a href="#24-ElasticSearch-管道聚合-类似于linux的-管道符" class="headerlink" title="24.ElasticSearch 管道聚合 类似于linux的 | 管道符"></a>24.ElasticSearch 管道聚合 类似于linux的 | 管道符</h2><p>管道聚合相当于在之前聚合的基础上，再次聚合。</p>
<h3 id="24-1-Avg-Bucket-Aggregation"><a href="#24-1-Avg-Bucket-Aggregation" class="headerlink" title="24.1 Avg Bucket Aggregation"></a>24.1 Avg Bucket Aggregation</h3><p>计算聚合平均值。例如，统计每个出版社所出版图书的平均值，然后再统计所有出版社的平均值：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "book_count": {</span><br><span class="line">      "terms": {</span><br><span class="line">        "field": "publish",</span><br><span class="line">        "size": 3</span><br><span class="line">      },</span><br><span class="line">      "aggs": {</span><br><span class="line">        "book_avg": {</span><br><span class="line">          "avg": {</span><br><span class="line">            "field": "price"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    "avg_book":{</span><br><span class="line">      "avg_bucket": {</span><br><span class="line">        "buckets_path": "book_count&gt;book_avg"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="24-2-Max-Bucket-Aggregation"><a href="#24-2-Max-Bucket-Aggregation" class="headerlink" title="24.2 Max Bucket Aggregation"></a>24.2 Max Bucket Aggregation</h3><p>统计每个出版社所出版图书的平均值，然后再统计平均值中的最大值：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "book_count": {</span><br><span class="line">      "terms": {</span><br><span class="line">        "field": "publish",</span><br><span class="line">        "size": 3</span><br><span class="line">      },</span><br><span class="line">      "aggs": {</span><br><span class="line">        "book_avg": {</span><br><span class="line">          "avg": {</span><br><span class="line">            "field": "price"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    "avg_book":{</span><br><span class="line">      "max_bucket": {</span><br><span class="line">        "buckets_path": "book_count&gt;book_avg"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="24-3-Min-Bucket-Aggregation"><a href="#24-3-Min-Bucket-Aggregation" class="headerlink" title="24.3 Min Bucket Aggregation"></a>24.3 Min Bucket Aggregation</h3><p>统计每个出版社所出版图书的平均值，然后再统计平均值中的最小值：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "book_count": {</span><br><span class="line">      "terms": {</span><br><span class="line">        "field": "publish",</span><br><span class="line">        "size": 3</span><br><span class="line">      },</span><br><span class="line">      "aggs": {</span><br><span class="line">        "book_avg": {</span><br><span class="line">          "avg": {</span><br><span class="line">            "field": "price"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    "avg_book":{</span><br><span class="line">      "min_bucket": {</span><br><span class="line">        "buckets_path": "book_count&gt;book_avg"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="24-4-Sum-Bucket-Aggregation"><a href="#24-4-Sum-Bucket-Aggregation" class="headerlink" title="24.4 Sum Bucket Aggregation"></a>24.4 Sum Bucket Aggregation</h3><p>统计每个出版社所出版图书的平均值，然后再统计平均值之和：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "book_count": {</span><br><span class="line">      "terms": {</span><br><span class="line">        "field": "publish",</span><br><span class="line">        "size": 3</span><br><span class="line">      },</span><br><span class="line">      "aggs": {</span><br><span class="line">        "book_avg": {</span><br><span class="line">          "avg": {</span><br><span class="line">            "field": "price"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    "avg_book":{</span><br><span class="line">      "sum_bucket": {</span><br><span class="line">        "buckets_path": "book_count&gt;book_avg"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="24-5-Stats-Bucket-Aggregation"><a href="#24-5-Stats-Bucket-Aggregation" class="headerlink" title="24.5 Stats Bucket Aggregation"></a>24.5 Stats Bucket Aggregation</h3><p>统计每个出版社所出版图书的平均值，然后再统计平均值的各种数据：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "book_count": {</span><br><span class="line">      "terms": {</span><br><span class="line">        "field": "publish",</span><br><span class="line">        "size": 3</span><br><span class="line">      },</span><br><span class="line">      "aggs": {</span><br><span class="line">        "book_avg": {</span><br><span class="line">          "avg": {</span><br><span class="line">            "field": "price"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    "avg_book":{</span><br><span class="line">      "stats_bucket": {</span><br><span class="line">        "buckets_path": "book_count&gt;book_avg"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="24-6-Extended-Stats-Bucket-Aggregation"><a href="#24-6-Extended-Stats-Bucket-Aggregation" class="headerlink" title="24.6 Extended Stats Bucket Aggregation"></a>24.6 Extended Stats Bucket Aggregation</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "book_count": {</span><br><span class="line">      "terms": {</span><br><span class="line">        "field": "publish",</span><br><span class="line">        "size": 3</span><br><span class="line">      },</span><br><span class="line">      "aggs": {</span><br><span class="line">        "book_avg": {</span><br><span class="line">          "avg": {</span><br><span class="line">            "field": "price"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    "avg_book":{</span><br><span class="line">      "extended_stats_bucket": {</span><br><span class="line">        "buckets_path": "book_count&gt;book_avg"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="24-7-Percentiles-Bucket-Aggregation"><a href="#24-7-Percentiles-Bucket-Aggregation" class="headerlink" title="24.7 Percentiles Bucket Aggregation"></a>24.7 Percentiles Bucket Aggregation</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">{</span><br><span class="line">  "aggs": {</span><br><span class="line">    "book_count": {</span><br><span class="line">      "terms": {</span><br><span class="line">        "field": "publish",</span><br><span class="line">        "size": 3</span><br><span class="line">      },</span><br><span class="line">      "aggs": {</span><br><span class="line">        "book_avg": {</span><br><span class="line">          "avg": {</span><br><span class="line">            "field": "price"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    "avg_book":{</span><br><span class="line">      "percentiles_bucket": {</span><br><span class="line">        "buckets_path": "book_count&gt;book_avg"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="25-ElasticSearch-Java-Api-概览"><a href="#25-ElasticSearch-Java-Api-概览" class="headerlink" title="25.ElasticSearch Java Api 概览"></a>25.ElasticSearch Java Api 概览</h2><p>Java操作Es的方案:</p>
<h3 id="1-直接使用Http请求"><a href="#1-直接使用Http请求" class="headerlink" title="1.直接使用Http请求"></a>1.直接使用Http请求</h3><p>以 HttpUrlConnection 为例，请求方式如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class HttpRequestTest {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        URL url = new URL("http://localhost:9200/books/_search?pretty=true");</span><br><span class="line">        HttpURLConnection con = (HttpURLConnection) url.openConnection();</span><br><span class="line">        if (con.getResponseCode() == 200) {</span><br><span class="line">            BufferedReader br = new BufferedReader(new InputStreamReader(con.getInputStream()));</span><br><span class="line">            String str = null;</span><br><span class="line">            while ((str = br.readLine()) != null) {</span><br><span class="line">                System.out.println(str);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>弊端：需要自己组装请求参数，自己去解析响应的json</p>
<h3 id="2-Java-Low-Level-REST-Client"><a href="#2-Java-Low-Level-REST-Client" class="headerlink" title="2.Java Low Level REST Client"></a>2.Java Low Level REST Client</h3><p>从字面上来理解，这个叫做低级客户端。</p>
<p>它允许通过 Http 与一个 Elasticsearch 集群通信。将请求的 JSON 参数拼接和响应的 JSON 字符串解析留给用户自己处理。低级客户端最大的优势在于兼容所有的 ElasticSearch 的版本（因为它的 API 并没有封装 JSON 操作，所有的 JSON 操作还是由开发者自己完成），同时低级客户端要求 JDK 为 1.7 及以上。</p>
<p>低级客户端主要包括如下一些功能：</p>
<ul>
<li>最小的依赖</li>
<li>跨所有可用节点的负载均衡</li>
<li>节点故障和特定响应代码时的故障转移</li>
<li>连接失败重试（是否重试失败的节点取决于它失败的连续次数；失败次数越多，客户端在再次尝试同一节点之前等待的时间越长）</li>
<li>持久连接</li>
<li>跟踪请求和响应的日志记录</li>
<li>可选自动发现集群节点</li>
</ul>
<p>Java Low Level REST Client 的操作其实比较简单，松哥后面会录制一个视频和大家分享相关操作。</p>
<h3 id="3-Java-High-Level-REST-Client"><a href="#3-Java-High-Level-REST-Client" class="headerlink" title="3.Java High Level REST Client"></a>3.Java High Level REST Client</h3><p>从字面上来理解，这个叫做高级客户端，也是目前使用最多的一种客户端。它其实有点像之前的 TransportClient。</p>
<p>这个所谓的高级客户端它的内部其实还是基于低级客户端，只不过针对 ElasticSearch 它提供了更多的 API，将请求参数和响应参数都封装成了相应的 API，开发者只需要调用相关的方法就可以拼接参数或者解析响应结果。</p>
<p>Java High Level REST Client 中的每个 API 都可以同步或异步调用，同步方法返回一个响应对象，而异步方法的名称则以 Async 为后缀结尾，异步请求一般需要一个监听器参数，用来处理响应结果。</p>
<p>相对于低级客户端，高级客户端的兼容性就要差很多（因为 JSON 的拼接和解析它已经帮我们做好了）。高级客户端需要 JDK1.8 及以上版本并且依赖版本需要与 ElasticSearch 版本相同（主版本号需要一致，次版本号不必相同）。</p>
<p>举个简单例子：</p>
<p>7.0 客户端能够与任何 7.x ElasticSearch 节点进行通信，而 7.1 客户端肯定能够与 7.1，7.2 和任何后来的 7.x 版本进行通信，但与旧版本的 ElasticSearch 节点通信时可能会存在不兼容的问题。</p>
<h3 id="4-其他"><a href="#4-其他" class="headerlink" title="4.其他"></a>4.其他</h3><p>ElasticSearch 的 Java 客户端</p>
<ul>
<li><p>TransportClient</p>
</li>
<li><p>Jest</p>
</li>
<li><p>Spring Data Elasticsearch</p>
</li>
<li><p>Java Low Level REST Client</p>
</li>
<li><p>Java High Level REST Client</p>
</li>
</ul>
<p><strong>TransportClient</strong></p>
<p>官方已经不再推荐使用 TransportClient，并且表示会在 ElasticSearch8.0 中完全移除相关支持。</p>
<p><strong>Jest</strong></p>
<p>Jest 提供了更流畅的 API 和更容易使用的接口，并且它的版本是遵循 ElasticSearch 的主版本号的，这样可以确保客户端和服务端之间的兼容性。</p>
<p>早期的 ElasticSearch 官方客户端对 RESTful 支持不够完美， Jest 在一定程度上弥补了官方客户端的不足，但是随着近两年官方客户端对 RESTful 功能的增强，Jest 早已成了明日黄花，最近的一次更新也停留在 2018 年 4 月，所以 Jest 小伙伴们也不必花时间去学了，知道曾经有过这么一个东西就行了。</p>
<p><strong>Spring Data Elasticsearch</strong></p>
<p>Spring Data 是 Spring 的一个子项目。用于简化数据库访问，支持NoSQL 和关系数据存储。其主要目标是使数据库的访问变得方便快捷。Spring Data 具有如下特点：</p>
<p>Spring Data 项目支持 NoSQL 存储：</p>
<ul>
<li>MongoDB （文档数据库）</li>
<li>Neo4j（图形数据库）</li>
<li>Redis（键/值存储）</li>
<li>Hbase（列族数据库）</li>
<li>ElasticSearch</li>
</ul>
<p>Spring Data 项目所支持的关系数据存储技术：</p>
<ul>
<li>JDBC</li>
<li>JPA</li>
</ul>
<h2 id="26-ElasticSearch普通HTTP请求"><a href="#26-ElasticSearch普通HTTP请求" class="headerlink" title="26.ElasticSearch普通HTTP请求"></a>26.ElasticSearch普通HTTP请求</h2><p>以 HttpUrlConnection 为例，请求方式如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class HttpRequestTest {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        URL url = new URL("http://localhost:9200/books/_search?pretty=true");</span><br><span class="line">        HttpURLConnection con = (HttpURLConnection) url.openConnection();</span><br><span class="line">        if (con.getResponseCode() == 200) {</span><br><span class="line">            BufferedReader br = new BufferedReader(new InputStreamReader(con.getInputStream()));</span><br><span class="line">            String str = null;</span><br><span class="line">            while ((str = br.readLine()) != null) {</span><br><span class="line">                System.out.println(str);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>弊端：需要自己组装请求参数，自己去解析响应的json</p>
<h2 id="27-ElasticSearch-Java-Low-Level-REST-Client"><a href="#27-ElasticSearch-Java-Low-Level-REST-Client" class="headerlink" title="27.ElasticSearch Java Low Level REST Client"></a>27.ElasticSearch Java Low Level REST Client</h2><p>首先创建一个普通的 Maven 工程，添加如下依赖：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;elasticsearch-rest-client&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;7.10.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>然后添加如下代码，发起一个简单的查询请求：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LowLevelTest</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">        <span class="comment">//1.构建一个 RestClient 对象</span></span><br><span class="line">        RestClientBuilder builder = RestClient.builder(</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9200</span>, <span class="string">"http"</span>),</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9201</span>, <span class="string">"http"</span>),</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9202</span>, <span class="string">"http"</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//2.如果需要在请求头中设置认证信息等，可以通过 builder 来设置</span></span><br><span class="line"><span class="comment">//        builder.setDefaultHeaders(new Header[]{new BasicHeader("key","value")});</span></span><br><span class="line">        RestClient restClient = builder.build();</span><br><span class="line">        <span class="comment">//3.构建请求</span></span><br><span class="line">        Request request = <span class="keyword">new</span> Request(<span class="string">"GET"</span>, <span class="string">"/books/_search"</span>);</span><br><span class="line">        <span class="comment">//添加请求参数</span></span><br><span class="line">        request.addParameter(<span class="string">"pretty"</span>,<span class="string">"true"</span>);</span><br><span class="line">        <span class="comment">//4.发起请求，发起请求有两种方式，可以同步，可以异步</span></span><br><span class="line">        <span class="comment">//这种请求发起方式，会阻塞后面的代码</span></span><br><span class="line">        Response response = restClient.performRequest(request);</span><br><span class="line">        <span class="comment">//5.解析 response，获取响应结果</span></span><br><span class="line">        BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(response.getEntity().getContent()));</span><br><span class="line">        String str = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> ((str = br.readLine()) != <span class="keyword">null</span>) {</span><br><span class="line">            System.out.println(str);</span><br><span class="line">        }</span><br><span class="line">        br.close();</span><br><span class="line">        <span class="comment">//最后记得关闭 RestClient</span></span><br><span class="line">        restClient.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个查询请求，是一个同步请求，在请求的过程中，后面的代码会被阻塞，如果不希望后面的代码被阻塞，可以使用异步请求。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LowLevelTest2</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">        <span class="comment">//1.构建一个 RestClient 对象</span></span><br><span class="line">        RestClientBuilder builder = RestClient.builder(</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9200</span>, <span class="string">"http"</span>),</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9201</span>, <span class="string">"http"</span>),</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9202</span>, <span class="string">"http"</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//2.如果需要在请求头中设置认证信息等，可以通过 builder 来设置</span></span><br><span class="line"><span class="comment">//        builder.setDefaultHeaders(new Header[]{new BasicHeader("key","value")});</span></span><br><span class="line">        RestClient restClient = builder.build();</span><br><span class="line">        <span class="comment">//3.构建请求</span></span><br><span class="line">        Request request = <span class="keyword">new</span> Request(<span class="string">"GET"</span>, <span class="string">"/books/_search"</span>);</span><br><span class="line">        <span class="comment">//添加请求参数</span></span><br><span class="line">        request.addParameter(<span class="string">"pretty"</span>,<span class="string">"true"</span>);</span><br><span class="line">        <span class="comment">//4.发起请求，发起请求有两种方式，可以同步，可以异步</span></span><br><span class="line">        <span class="comment">//异步请求</span></span><br><span class="line">        restClient.performRequestAsync(request, <span class="keyword">new</span> ResponseListener() {</span><br><span class="line">            <span class="comment">//请求成功的回调</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Response response)</span> </span>{</span><br><span class="line">                <span class="comment">//5.解析 response，获取响应结果</span></span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(response.getEntity().getContent()));</span><br><span class="line">                    String str = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">while</span> ((str = br.readLine()) != <span class="keyword">null</span>) {</span><br><span class="line">                        System.out.println(str);</span><br><span class="line">                    }</span><br><span class="line">                    br.close();</span><br><span class="line">                    <span class="comment">//最后记得关闭 RestClient</span></span><br><span class="line">                    restClient.close();</span><br><span class="line">                } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//请求失败的回调</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>{</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>开发者在请求时，也可以携带 JSON 参数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LowLevelTest3</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">        <span class="comment">//1.构建一个 RestClient 对象</span></span><br><span class="line">        RestClientBuilder builder = RestClient.builder(</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9200</span>, <span class="string">"http"</span>),</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9201</span>, <span class="string">"http"</span>),</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9202</span>, <span class="string">"http"</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//2.如果需要在请求头中设置认证信息等，可以通过 builder 来设置</span></span><br><span class="line"><span class="comment">//        builder.setDefaultHeaders(new Header[]{new BasicHeader("key","value")});</span></span><br><span class="line">        RestClient restClient = builder.build();</span><br><span class="line">        <span class="comment">//3.构建请求</span></span><br><span class="line">        Request request = <span class="keyword">new</span> Request(<span class="string">"GET"</span>, <span class="string">"/books/_search"</span>);</span><br><span class="line">        <span class="comment">//添加请求参数</span></span><br><span class="line">        request.addParameter(<span class="string">"pretty"</span>,<span class="string">"true"</span>);</span><br><span class="line">        <span class="comment">//添加请求体</span></span><br><span class="line">        request.setEntity(<span class="keyword">new</span> NStringEntity(<span class="string">"{\"query\": {\"term\": {\"name\": {\"value\": \"java\"}}}}"</span>, ContentType.APPLICATION_JSON));</span><br><span class="line">        <span class="comment">//4.发起请求，发起请求有两种方式，可以同步，可以异步</span></span><br><span class="line">        <span class="comment">//异步请求</span></span><br><span class="line">        restClient.performRequestAsync(request, <span class="keyword">new</span> ResponseListener() {</span><br><span class="line">            <span class="comment">//请求成功的回调</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Response response)</span> </span>{</span><br><span class="line">                <span class="comment">//5.解析 response，获取响应结果</span></span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(response.getEntity().getContent()));</span><br><span class="line">                    String str = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">while</span> ((str = br.readLine()) != <span class="keyword">null</span>) {</span><br><span class="line">                        System.out.println(str);</span><br><span class="line">                    }</span><br><span class="line">                    br.close();</span><br><span class="line">                    <span class="comment">//最后记得关闭 RestClient</span></span><br><span class="line">                    restClient.close();</span><br><span class="line">                } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//请求失败的回调</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>{</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="28-Java-High-Level-REST-Client"><a href="#28-Java-High-Level-REST-Client" class="headerlink" title="28.Java High Level REST Client"></a>28.Java High Level REST Client</h2><h3 id="28-1-索引管理"><a href="#28-1-索引管理" class="headerlink" title="28.1 索引管理"></a>28.1 索引管理</h3><h4 id="28-1-1-创建索引"><a href="#28-1-1-创建索引" class="headerlink" title="28.1.1 创建索引"></a>28.1.1 创建索引</h4><p>首先创建一个普通的 Maven 项目，然后引入 high level rest client 依赖：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;7.10.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>需要注意，依赖的版本和 Es 的版本要对应。</p>
<p>创建一个索引：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        //删除已经存在的索引</span><br><span class="line">        DeleteIndexRequest deleteIndexRequest = new DeleteIndexRequest("blog");</span><br><span class="line">        client.indices().delete(deleteIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line">        //创建一个索引</span><br><span class="line">        CreateIndexRequest blog1 = new CreateIndexRequest("blog");</span><br><span class="line">        //配置 settings，分片、副本等信息</span><br><span class="line">        blog1.settings(Settings.builder().put("index.number_of_shards", 3).put("index.number_of_replicas", 2));</span><br><span class="line">        //配置字段类型，字段类型可以通过 JSON 字符串、Map 以及 XContentBuilder 三种方式来构建</span><br><span class="line">        //json 字符串的方式</span><br><span class="line">        blog1.mapping("{\"properties\": {\"title\": {\"type\": \"text\"}}}", XContentType.JSON);</span><br><span class="line">        //执行请求，创建索引</span><br><span class="line">        client.indices().create(blog1, RequestOptions.DEFAULT);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>mapping 的配置，还有另外两种方式：</p>
<p>第一种，通过 map 构建 mapping：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        //删除已经存在的索引</span><br><span class="line">        DeleteIndexRequest deleteIndexRequest = new DeleteIndexRequest("blog");</span><br><span class="line">        client.indices().delete(deleteIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line">        //创建一个索引</span><br><span class="line">        CreateIndexRequest blog1 = new CreateIndexRequest("blog");</span><br><span class="line">        //配置 settings，分片、副本等信息</span><br><span class="line">        blog1.settings(Settings.builder().put("index.number_of_shards", 3).put("index.number_of_replicas", 2));</span><br><span class="line">        //配置字段类型，字段类型可以通过 JSON 字符串、Map 以及 XContentBuilder 三种方式来构建</span><br><span class="line">        //json 字符串的方式</span><br><span class="line">//        blog1.mapping("{\"properties\": {\"title\": {\"type\": \"text\"}}}", XContentType.JSON);</span><br><span class="line">        //map 的方式</span><br><span class="line">        Map&lt;String, String&gt; title = new HashMap&lt;&gt;();</span><br><span class="line">        title.put("type", "text");</span><br><span class="line">        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span><br><span class="line">        properties.put("title", title);</span><br><span class="line">        Map&lt;String, Object&gt; mappings = new HashMap&lt;&gt;();</span><br><span class="line">        mappings.put("properties", properties);</span><br><span class="line">        blog1.mapping(mappings);</span><br><span class="line">        //执行请求，创建索引</span><br><span class="line">        client.indices().create(blog1, RequestOptions.DEFAULT);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>第二种，通过 XContentBuilder 构建 mapping：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        //删除已经存在的索引</span><br><span class="line">        DeleteIndexRequest deleteIndexRequest = new DeleteIndexRequest("blog");</span><br><span class="line">        client.indices().delete(deleteIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line">        //创建一个索引</span><br><span class="line">        CreateIndexRequest blog1 = new CreateIndexRequest("blog");</span><br><span class="line">        //配置 settings，分片、副本等信息</span><br><span class="line">        blog1.settings(Settings.builder().put("index.number_of_shards", 3).put("index.number_of_replicas", 2));</span><br><span class="line">        //配置字段类型，字段类型可以通过 JSON 字符串、Map 以及 XContentBuilder 三种方式来构建</span><br><span class="line">        //json 字符串的方式</span><br><span class="line">//        blog1.mapping("{\"properties\": {\"title\": {\"type\": \"text\"}}}", XContentType.JSON);</span><br><span class="line">        //map 的方式</span><br><span class="line">//        Map&lt;String, String&gt; title = new HashMap&lt;&gt;();</span><br><span class="line">//        title.put("type", "text");</span><br><span class="line">//        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span><br><span class="line">//        properties.put("title", title);</span><br><span class="line">//        Map&lt;String, Object&gt; mappings = new HashMap&lt;&gt;();</span><br><span class="line">//        mappings.put("properties", properties);</span><br><span class="line">//        blog1.mapping(mappings);</span><br><span class="line">        //XContentBuilder 方式</span><br><span class="line">        XContentBuilder builder = XContentFactory.jsonBuilder();</span><br><span class="line">        builder.startObject();</span><br><span class="line">        builder.startObject("properties");</span><br><span class="line">        builder.startObject("title");</span><br><span class="line">        builder.field("type", "text");</span><br><span class="line">        builder.endObject();</span><br><span class="line">        builder.endObject();</span><br><span class="line">        builder.endObject();</span><br><span class="line">        blog1.mapping(builder);</span><br><span class="line">        //执行请求，创建索引</span><br><span class="line">        client.indices().create(blog1, RequestOptions.DEFAULT);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>还可以给索引配置别名：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        //删除已经存在的索引</span><br><span class="line">        DeleteIndexRequest deleteIndexRequest = new DeleteIndexRequest("blog");</span><br><span class="line">        client.indices().delete(deleteIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line">        //创建一个索引</span><br><span class="line">        CreateIndexRequest blog1 = new CreateIndexRequest("blog");</span><br><span class="line">        //配置 settings，分片、副本等信息</span><br><span class="line">        blog1.settings(Settings.builder().put("index.number_of_shards", 3).put("index.number_of_replicas", 2));</span><br><span class="line">        //配置字段类型，字段类型可以通过 JSON 字符串、Map 以及 XContentBuilder 三种方式来构建</span><br><span class="line">        //json 字符串的方式</span><br><span class="line">//        blog1.mapping("{\"properties\": {\"title\": {\"type\": \"text\"}}}", XContentType.JSON);</span><br><span class="line">        //map 的方式</span><br><span class="line">//        Map&lt;String, String&gt; title = new HashMap&lt;&gt;();</span><br><span class="line">//        title.put("type", "text");</span><br><span class="line">//        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span><br><span class="line">//        properties.put("title", title);</span><br><span class="line">//        Map&lt;String, Object&gt; mappings = new HashMap&lt;&gt;();</span><br><span class="line">//        mappings.put("properties", properties);</span><br><span class="line">//        blog1.mapping(mappings);</span><br><span class="line">        //XContentBuilder 方式</span><br><span class="line">        XContentBuilder builder = XContentFactory.jsonBuilder();</span><br><span class="line">        builder.startObject();</span><br><span class="line">        builder.startObject("properties");</span><br><span class="line">        builder.startObject("title");</span><br><span class="line">        builder.field("type", "text");</span><br><span class="line">        builder.endObject();</span><br><span class="line">        builder.endObject();</span><br><span class="line">        builder.endObject();</span><br><span class="line">        blog1.mapping(builder);</span><br><span class="line">        //配置别名</span><br><span class="line">        blog1.alias(new Alias("blog_alias"));</span><br><span class="line">        //执行请求，创建索引</span><br><span class="line">        client.indices().create(blog1, RequestOptions.DEFAULT);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果觉得调 API 太麻烦，也可以直接上 JSON：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest2 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        //删除已经存在的索引</span><br><span class="line">        DeleteIndexRequest deleteIndexRequest = new DeleteIndexRequest("blog");</span><br><span class="line">        client.indices().delete(deleteIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line">        //创建一个索引</span><br><span class="line">        CreateIndexRequest blog1 = new CreateIndexRequest("blog");</span><br><span class="line">        //直接同构 JSON 配置索引</span><br><span class="line">            blog1.source("{\"settings\": {\"number_of_shards\": 3,\"number_of_replicas\": 2},\"mappings\": {\"properties\": {\"title\": {\"type\": \"keyword\"}}},\"aliases\": {\"blog_alias_javaboy\": {}}}", XContentType.JSON);</span><br><span class="line">        //执行请求，创建索引</span><br><span class="line">        client.indices().create(blog1, RequestOptions.DEFAULT);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>另外还有一些其他的可选配置：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest2 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        //删除已经存在的索引</span><br><span class="line">        DeleteIndexRequest deleteIndexRequest = new DeleteIndexRequest("blog");</span><br><span class="line">        client.indices().delete(deleteIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line">        //创建一个索引</span><br><span class="line">        CreateIndexRequest blog1 = new CreateIndexRequest("blog");</span><br><span class="line">        //直接同构 JSON 配置索引</span><br><span class="line">        blog1.source("{\"settings\": {\"number_of_shards\": 3,\"number_of_replicas\": 2},\"mappings\": {\"properties\": {\"title\": {\"type\": \"keyword\"}}},\"aliases\": {\"blog_alias_javaboy\": {}}}", XContentType.JSON);</span><br><span class="line">        //请求超时时间，连接所有节点的超时时间</span><br><span class="line">        blog1.setTimeout(TimeValue.timeValueMinutes(2));</span><br><span class="line">        //连接 master 节点的超时时间</span><br><span class="line">        blog1.setMasterTimeout(TimeValue.timeValueMinutes(1));</span><br><span class="line">        //执行请求，创建索引</span><br><span class="line">        client.indices().create(blog1, RequestOptions.DEFAULT);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>前面所有的请求都是同步的，会阻塞的，也可以异步：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest2 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        //删除已经存在的索引</span><br><span class="line">        DeleteIndexRequest deleteIndexRequest = new DeleteIndexRequest("blog");</span><br><span class="line">        client.indices().delete(deleteIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line">        //创建一个索引</span><br><span class="line">        CreateIndexRequest blog1 = new CreateIndexRequest("blog");</span><br><span class="line">        //直接同构 JSON 配置索引</span><br><span class="line">        blog1.source("{\"settings\": {\"number_of_shards\": 3,\"number_of_replicas\": 2},\"mappings\": {\"properties\": {\"title\": {\"type\": \"keyword\"}}},\"aliases\": {\"blog_alias_javaboy\": {}}}", XContentType.JSON);</span><br><span class="line">        //请求超时时间，连接所有节点的超时时间</span><br><span class="line">        blog1.setTimeout(TimeValue.timeValueMinutes(2));</span><br><span class="line">        //连接 master 节点的超时时间</span><br><span class="line">        blog1.setMasterTimeout(TimeValue.timeValueMinutes(1));</span><br><span class="line">        //执行请求，创建索引</span><br><span class="line">//        client.indices().create(blog1, RequestOptions.DEFAULT);</span><br><span class="line">        //异步创建索引</span><br><span class="line">        client.indices().createAsync(blog1, RequestOptions.DEFAULT, new ActionListener&lt;CreateIndexResponse&gt;() {</span><br><span class="line">            //请求成功</span><br><span class="line">            @Override</span><br><span class="line">            public void onResponse(CreateIndexResponse createIndexResponse) {</span><br><span class="line">                //关闭 client</span><br><span class="line">                try {</span><br><span class="line">                    client.close();</span><br><span class="line">                } catch (IOException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            //请求失败</span><br><span class="line">            @Override</span><br><span class="line">            public void onFailure(Exception e) {</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        //关闭 client</span><br><span class="line">//        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="28-1-2-查询索引是否存在"><a href="#28-1-2-查询索引是否存在" class="headerlink" title="28.1.2 查询索引是否存在"></a>28.1.2 查询索引是否存在</h4><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest3 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        GetIndexRequest blog = new GetIndexRequest("blog2");</span><br><span class="line">        boolean exists = client.indices().exists(blog, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println("exists = " + exists);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="28-1-3-关闭-打开索引"><a href="#28-1-3-关闭-打开索引" class="headerlink" title="28.1.3 关闭/打开索引"></a>28.1.3 关闭/打开索引</h4><p>关闭：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest4 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        CloseIndexRequest blog = new CloseIndexRequest("blog");</span><br><span class="line">        CloseIndexResponse close = client.indices().close(blog, RequestOptions.DEFAULT);</span><br><span class="line">        List&lt;CloseIndexResponse.IndexResult&gt; indices = close.getIndices();</span><br><span class="line">        for (CloseIndexResponse.IndexResult index : indices) {</span><br><span class="line">            System.out.println("index.getIndex() = " + index.getIndex());</span><br><span class="line">        }</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>触发warning[“the default value for the ?wait_for_active_shards parameter will change from ‘0’ to ‘index-setting’ in version 8; specify ‘?wait_for_active_shards=index-setting’ to adopt the future default behaviour, or ‘?wait_for_active_shards=0’ to preserve today’s behaviour”]</p>
<p>打开：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest4 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        OpenIndexRequest blog = new OpenIndexRequest("blog");</span><br><span class="line">        client.indices().open(blog, RequestOptions.DEFAULT);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="28-1-4-索引修改"><a href="#28-1-4-索引修改" class="headerlink" title="28.1.4 索引修改"></a>28.1.4 索引修改</h4><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest5 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        UpdateSettingsRequest request = new UpdateSettingsRequest("blog");</span><br><span class="line">        request.settings(Settings.builder().put("index.blocks.write", true).build());</span><br><span class="line">        client.indices().putSettings(request, RequestOptions.DEFAULT);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="28-1-5-克隆索引"><a href="#28-1-5-克隆索引" class="headerlink" title="28.1.5 克隆索引"></a>28.1.5 克隆索引</h4><p>被克隆的索引需要是只读索引，可以通过 28.1.4 小节中的方式设置索引为只读。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest6 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        ResizeRequest request = new ResizeRequest("blog2", "blog");</span><br><span class="line">        client.indices().clone(request, RequestOptions.DEFAULT);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="28-1-6-查看索引"><a href="#28-1-6-查看索引" class="headerlink" title="28.1.6 查看索引"></a>28.1.6 查看索引</h4><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest7 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        GetSettingsRequest request = new GetSettingsRequest().indices("blog");</span><br><span class="line">        //设置需要互殴去的具体的参数，不设置则返回所有参数</span><br><span class="line">        request.names("index.blocks.write");</span><br><span class="line">        GetSettingsResponse response = client.indices().getSettings(request, RequestOptions.DEFAULT);</span><br><span class="line">        ImmutableOpenMap&lt;String, Settings&gt; indexToSettings = response.getIndexToSettings();</span><br><span class="line">        System.out.println(indexToSettings);</span><br><span class="line">        String s = response.getSetting("blog", "index.number_of_replicas");</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="28-1-7-Refresh-amp-Flush"><a href="#28-1-7-Refresh-amp-Flush" class="headerlink" title="28.1.7 Refresh &amp; Flush"></a>28.1.7 Refresh &amp; Flush</h4><p>Es 底层依赖 Lucene，而 Lucene 中有 reopen 和 commit 两种操作，还有一个特殊的概念叫做 segment。</p>
<p>Es 中，基本的存储单元是 shard，对应到 Lucene 上，就是一个索引，Lucene 中的索引由 segment 组成，每个 segment 相当于 es 中的倒排索引。每个 es 文档创建时，都会写入到一个新的 segment 中，删除文档时，只是从属于它的 segment 处标记为删除，并没有从磁盘中删除。</p>
<p>Lucene 中：</p>
<p>reopen 可以让数据搜索到，但是不保证数据被持久化到磁盘中。</p>
<p>commit 可以让数据持久化。</p>
<p>Es 中：</p>
<p>默认是每秒 refresh 一次（Es 中文档被索引之后，首先添加到内存缓冲区，refresh 操作将内存缓冲区中的数据拷贝到新创建的 segment 中，这里是在内存中操作的）。</p>
<p>flush 将内存中的数据持久化到磁盘中。一般来说，flush 的时间间隔比较久，默认 30 分钟。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest8 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        RefreshRequest request = new RefreshRequest("blog");</span><br><span class="line">        client.indices().refresh(request, RequestOptions.DEFAULT);</span><br><span class="line">        FlushRequest flushRequest = new FlushRequest("blog");</span><br><span class="line">        client.indices().flush(flushRequest, RequestOptions.DEFAULT);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="28-1-9-索引别名"><a href="#28-1-9-索引别名" class="headerlink" title="28.1.9 索引别名"></a>28.1.9 索引别名</h4><p>索引的别名类似于 MySQL 中的视图。</p>
<h5 id="28-1-9-1-添加别名"><a href="#28-1-9-1-添加别名" class="headerlink" title="28.1.9.1 添加别名"></a>28.1.9.1 添加别名</h5><p>添加一个普通的别名：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest9 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        IndicesAliasesRequest indicesAliasesRequest = new IndicesAliasesRequest();</span><br><span class="line">        IndicesAliasesRequest.AliasActions aliasAction = new IndicesAliasesRequest.AliasActions(IndicesAliasesRequest.AliasActions.Type.ADD);</span><br><span class="line">        aliasAction.index("books").alias("books_alias");</span><br><span class="line">        indicesAliasesRequest.addAliasAction(aliasAction);</span><br><span class="line">        client.indices().updateAliases(indicesAliasesRequest, RequestOptions.DEFAULT);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>添加一个带 filter 的别名：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest9 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        IndicesAliasesRequest indicesAliasesRequest = new IndicesAliasesRequest();</span><br><span class="line">        IndicesAliasesRequest.AliasActions aliasAction = new IndicesAliasesRequest.AliasActions(IndicesAliasesRequest.AliasActions.Type.ADD);</span><br><span class="line">        aliasAction.index("books").alias("books_alias2").filter("{\"term\": {\"name\": \"java\"}}");</span><br><span class="line">        indicesAliasesRequest.addAliasAction(aliasAction);</span><br><span class="line">        client.indices().updateAliases(indicesAliasesRequest, RequestOptions.DEFAULT);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>现在，books 索引将存在两个别名，其中，books_alias2 自动过滤 name 中含有 java 的文档。</p>
<h5 id="28-1-9-2-删除别名"><a href="#28-1-9-2-删除别名" class="headerlink" title="28.1.9.2 删除别名"></a>28.1.9.2 删除别名</h5><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest9 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        IndicesAliasesRequest indicesAliasesRequest = new IndicesAliasesRequest();</span><br><span class="line">        IndicesAliasesRequest.AliasActions aliasAction = new IndicesAliasesRequest.AliasActions(IndicesAliasesRequest.AliasActions.Type.REMOVE);</span><br><span class="line">        aliasAction.index("books").alias("books_alias");</span><br><span class="line">        indicesAliasesRequest.addAliasAction(aliasAction);</span><br><span class="line">        client.indices().updateAliases(indicesAliasesRequest, RequestOptions.DEFAULT);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>第二种移除方式：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest9 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        DeleteAliasRequest deleteAliasRequest = new DeleteAliasRequest("books", "books_alias2");</span><br><span class="line">        client.indices().deleteAlias(deleteAliasRequest, RequestOptions.DEFAULT);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5 id="28-1-9-3-判断别名是否存在"><a href="#28-1-9-3-判断别名是否存在" class="headerlink" title="28.1.9.3 判断别名是否存在"></a>28.1.9.3 判断别名是否存在</h5><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest9 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        GetAliasesRequest books_alias = new GetAliasesRequest("books_alias");</span><br><span class="line">        //指定查看某一个索引的别名，不指定，则会搜索所有的别名</span><br><span class="line">        books_alias.indices("books");</span><br><span class="line">        boolean b = client.indices().existsAlias(books_alias, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(b);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5 id="28-1-9-4-获取别名"><a href="#28-1-9-4-获取别名" class="headerlink" title="28.1.9.4 获取别名"></a>28.1.9.4 获取别名</h5><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class HighLevelTest9 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        GetAliasesRequest books_alias = new GetAliasesRequest("books_alias");</span><br><span class="line">        //指定查看某一个索引的别名，不指定，则会搜索所有的别名</span><br><span class="line">        books_alias.indices("books");</span><br><span class="line">        GetAliasesResponse response = client.indices().getAlias(books_alias, RequestOptions.DEFAULT);</span><br><span class="line">        Map&lt;String, Set&lt;AliasMetadata&gt;&gt; aliases = response.getAliases();</span><br><span class="line">        System.out.println("aliases = " + aliases);</span><br><span class="line">        //关闭 client</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="29-1-添加文档"><a href="#29-1-添加文档" class="headerlink" title="29.1 添加文档"></a>29.1 添加文档</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">public class DocTest01 {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        //构建一个 IndexRequest 请求，参数就是索引名称</span><br><span class="line">        IndexRequest request = new IndexRequest("book");</span><br><span class="line">        //给请求配置一个 id，这个就是文档 id。如果指定了 id，相当于 put book/_doc/id ，也可以不指定 id，相当于 post book/_doc</span><br><span class="line">//        request.id("1");</span><br><span class="line">        //构建索引文本，有三种方式：JSON 字符串、Map 对象、XContentBuilder</span><br><span class="line">        request.source("{\"name\": \"三国演义\",\"author\": \"罗贯中\"}", XContentType.JSON);</span><br><span class="line">        //执行请求，有同步和异步两种方式</span><br><span class="line">        //同步</span><br><span class="line">        IndexResponse indexResponse = client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">        //获取文档id</span><br><span class="line">        String id = indexResponse.getId();</span><br><span class="line">        System.out.println("id = " + id);</span><br><span class="line">        //获取索引名称</span><br><span class="line">        String index = indexResponse.getIndex();</span><br><span class="line">        System.out.println("index = " + index);</span><br><span class="line">        //判断文档是否添加成功</span><br><span class="line">        if (indexResponse.getResult() == DocWriteResponse.Result.CREATED) {</span><br><span class="line">            System.out.println("文档添加成功");</span><br><span class="line">        }</span><br><span class="line">        //判断文档是否更新成功（如果 id 已经存在）</span><br><span class="line">        if (indexResponse.getResult() == DocWriteResponse.Result.UPDATED) {</span><br><span class="line">            System.out.println("文档更新成功");</span><br><span class="line">        }</span><br><span class="line">        ReplicationResponse.ShardInfo shardInfo = indexResponse.getShardInfo();</span><br><span class="line">        //判断分片操作是否都成功</span><br><span class="line">        if (shardInfo.getTotal() != shardInfo.getSuccessful()) {</span><br><span class="line">            System.out.println("有存在问题的分片");</span><br><span class="line">        }</span><br><span class="line">        //有存在失败的分片</span><br><span class="line">        if (shardInfo.getFailed() &gt; 0) {</span><br><span class="line">            //打印错误信息</span><br><span class="line">            for (ReplicationResponse.ShardInfo.Failure failure : shardInfo.getFailures()) {</span><br><span class="line">                System.out.println("failure.reason() = " + failure.reason());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        //异步</span><br><span class="line">//        client.indexAsync(request, RequestOptions.DEFAULT, new ActionListener&lt;IndexResponse&gt;() {</span><br><span class="line">//            @Override</span><br><span class="line">//            public void onResponse(IndexResponse indexResponse) {</span><br><span class="line">//</span><br><span class="line">//            }</span><br><span class="line">//</span><br><span class="line">//            @Override</span><br><span class="line">//            public void onFailure(Exception e) {</span><br><span class="line">//</span><br><span class="line">//            }</span><br><span class="line">//        });</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>演示分片存在问题的情况。由于我只有三个节点，但是在创建索引时，设置需要三个副本，此时的节点就不够用：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT book</span><br><span class="line">{</span><br><span class="line">  "settings": {</span><br><span class="line">    "number_of_replicas": 3,</span><br><span class="line">    "number_of_shards": 3  </span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>创建完成后，再次执行上面的添加代码，此时就会打印出 <code>有存在问题的分片</code>。</p>
<p>构建索引信息，有三种方式：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//构建索引文本，有三种方式：JSON 字符串、Map 对象、XContentBuilder</span><br><span class="line">//request.source("{\"name\": \"三国演义\",\"author\": \"罗贯中\"}", XContentType.JSON);</span><br><span class="line">//Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">//map.put("name", "水浒传");</span><br><span class="line">//map.put("author", "施耐庵");</span><br><span class="line">//request.source(map).id("99");</span><br><span class="line">XContentBuilder jsonBuilder = XContentFactory.jsonBuilder();</span><br><span class="line">jsonBuilder.startObject();</span><br><span class="line">jsonBuilder.field("name", "西游记");</span><br><span class="line">jsonBuilder.field("author", "吴承恩");</span><br><span class="line">jsonBuilder.endObject();</span><br><span class="line">request.source(jsonBuilder);</span><br></pre></td></tr></tbody></table></figure>

<p>默认情况下，如果 request 中包含有 id 属性，则相当于 <code>PUT book/_doc/1</code> 这样的请求，如果 request 中不包含 id 属性，则相当于 <code>POST book/_doc</code>，此时 id 会自动生成。对于前者，如果 id 已经存在，则会执行一个更新操作。也就是 es 的具体操作，会自动调整。</p>
<p>当然，也可以直接指定操作。例如，指定为添加文档的操作：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//构建一个 IndexRequest 请求，参数就是索引名称</span><br><span class="line">IndexRequest request = new IndexRequest("book");</span><br><span class="line">XContentBuilder jsonBuilder = XContentFactory.jsonBuilder();</span><br><span class="line">jsonBuilder.startObject();</span><br><span class="line">jsonBuilder.field("name", "西游记");</span><br><span class="line">jsonBuilder.field("author", "吴承恩");</span><br><span class="line">jsonBuilder.endObject();</span><br><span class="line">request.source(jsonBuilder).id("99");</span><br><span class="line">//这是一个添加操作，不要自动调整为更新操作</span><br><span class="line">request.opType(DocWriteRequest.OpType.CREATE);</span><br><span class="line">//执行请求，有同步和异步两种方式</span><br><span class="line">//同步</span><br><span class="line">IndexResponse indexResponse = client.index(request, RequestOptions.DEFAULT);</span><br></pre></td></tr></tbody></table></figure>

<h3 id="29-2-获取文档"><a href="#29-2-获取文档" class="headerlink" title="29.2 获取文档"></a>29.2 获取文档</h3><p>根据 id 获取文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class GetDoc {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        GetRequest request = new GetRequest("book", "98");</span><br><span class="line">        GetResponse response = client.get(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println("response.getId() = " + response.getId());</span><br><span class="line">        System.out.println("response.getIndex() = " + response.getIndex());</span><br><span class="line">        if (response.isExists()) {</span><br><span class="line">            //如果文档存在</span><br><span class="line">            long version = response.getVersion();</span><br><span class="line">            System.out.println("version = " + version);</span><br><span class="line">            String sourceAsString = response.getSourceAsString();</span><br><span class="line">            System.out.println("sourceAsString = " + sourceAsString);</span><br><span class="line">        }else{</span><br><span class="line">            System.out.println("文档不存在");</span><br><span class="line">        }</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="29-3-判断文档是否存在"><a href="#29-3-判断文档是否存在" class="headerlink" title="29.3 判断文档是否存在"></a>29.3 判断文档是否存在</h3><p>判断文档是否存在和获取文档的 API 是一致的。只不过在判断文档是否存在时，不需要获取 source。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class ExistsDoc {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        GetRequest request = new GetRequest("book", "99");</span><br><span class="line">        request.fetchSourceContext(new FetchSourceContext(false));</span><br><span class="line">        boolean exists = client.exists(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println("exists = " + exists);</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="29-4-删除文档"><a href="#29-4-删除文档" class="headerlink" title="29.4 删除文档"></a>29.4 删除文档</h3><p>删除 id 为 99 的文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public class DeleteDoc {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        DeleteRequest request = new DeleteRequest("book", "99");</span><br><span class="line">        DeleteResponse response = client.delete(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println("response.getId() = " + response.getId());</span><br><span class="line">        System.out.println("response.getIndex() = " + response.getIndex());</span><br><span class="line">        System.out.println("response.getVersion() = " + response.getVersion());</span><br><span class="line">        ReplicationResponse.ShardInfo shardInfo = response.getShardInfo();</span><br><span class="line">        if (shardInfo.getTotal() != shardInfo.getSuccessful()) {</span><br><span class="line">            System.out.println("有分片存在问题");</span><br><span class="line">        }</span><br><span class="line">        if (shardInfo.getFailed() &gt; 0) {</span><br><span class="line">            for (ReplicationResponse.ShardInfo.Failure failure : shardInfo.getFailures()) {</span><br><span class="line">                System.out.println("failure.reason() = " + failure.reason());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>删除文档的响应和添加文档成功的响应类似，可以对照着理解。</p>
<h3 id="29-4-更新文档"><a href="#29-4-更新文档" class="headerlink" title="29.4 更新文档"></a>29.4 更新文档</h3><p>通过脚本更新：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public class UpdateDoc {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        UpdateRequest request = new UpdateRequest("book", "1");</span><br><span class="line">        //通过脚本更新</span><br><span class="line">        Map&lt;String, Object&gt; params = Collections.singletonMap("name", "三国演义666");</span><br><span class="line">        Script inline = new Script(ScriptType.INLINE, "painless", "ctx._source.name=params.name", params);</span><br><span class="line">        request.script(inline);</span><br><span class="line">        UpdateResponse response = client.update(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println("response.getId() = " + response.getId());</span><br><span class="line">        System.out.println("response.getIndex() = " + response.getIndex());</span><br><span class="line">        System.out.println("response.getVersion() = " + response.getVersion());</span><br><span class="line">        if (response.getResult() == DocWriteResponse.Result.UPDATED) {</span><br><span class="line">            System.out.println("更新成功!");</span><br><span class="line">        }</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>通过 JSON 更新：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class UpdateDoc {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        UpdateRequest request = new UpdateRequest("book", "1");</span><br><span class="line">        request.doc("{\"name\": \"三国演义\"}", XContentType.JSON);</span><br><span class="line">        UpdateResponse response = client.update(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println("response.getId() = " + response.getId());</span><br><span class="line">        System.out.println("response.getIndex() = " + response.getIndex());</span><br><span class="line">        System.out.println("response.getVersion() = " + response.getVersion());</span><br><span class="line">        if (response.getResult() == DocWriteResponse.Result.UPDATED) {</span><br><span class="line">            System.out.println("更新成功!");</span><br><span class="line">        }</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>当然，这个 JSON 字符串也可以通过 Map 或者 XContentBuilder 来构建：</p>
<p>Map:</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class UpdateDoc {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        UpdateRequest request = new UpdateRequest("book", "1");</span><br><span class="line">        Map&lt;String, Object&gt; docMap = new HashMap&lt;&gt;();</span><br><span class="line">        docMap.put("name", "三国演义888");</span><br><span class="line">        request.doc(docMap);</span><br><span class="line">        UpdateResponse response = client.update(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println("response.getId() = " + response.getId());</span><br><span class="line">        System.out.println("response.getIndex() = " + response.getIndex());</span><br><span class="line">        System.out.println("response.getVersion() = " + response.getVersion());</span><br><span class="line">        if (response.getResult() == DocWriteResponse.Result.UPDATED) {</span><br><span class="line">            System.out.println("更新成功!");</span><br><span class="line">        }</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>XContentBuilder:</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class UpdateDoc {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        UpdateRequest request = new UpdateRequest("book", "1");</span><br><span class="line">        XContentBuilder jsonBuilder = XContentFactory.jsonBuilder();</span><br><span class="line">        jsonBuilder.startObject();</span><br><span class="line">        jsonBuilder.field("name", "三国演义666");</span><br><span class="line">        jsonBuilder.endObject();</span><br><span class="line">        request.doc(jsonBuilder);</span><br><span class="line">        UpdateResponse response = client.update(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println("response.getId() = " + response.getId());</span><br><span class="line">        System.out.println("response.getIndex() = " + response.getIndex());</span><br><span class="line">        System.out.println("response.getVersion() = " + response.getVersion());</span><br><span class="line">        if (response.getResult() == DocWriteResponse.Result.UPDATED) {</span><br><span class="line">            System.out.println("更新成功!");</span><br><span class="line">        }</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>也可以通过 upsert 方法实现文档不存在时就添加文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class UpdateDoc {</span><br><span class="line">    public static void main(String[] args) throws IOException {</span><br><span class="line">        RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(</span><br><span class="line">                new HttpHost("localhost", 9200, "http"),</span><br><span class="line">                new HttpHost("localhost", 9201, "http"),</span><br><span class="line">                new HttpHost("localhost", 9202, "http")</span><br><span class="line">        ));</span><br><span class="line">        UpdateRequest request = new UpdateRequest("book", "99");</span><br><span class="line">        XContentBuilder jsonBuilder = XContentFactory.jsonBuilder();</span><br><span class="line">        jsonBuilder.startObject();</span><br><span class="line">        jsonBuilder.field("name", "三国演义666");</span><br><span class="line">        jsonBuilder.endObject();</span><br><span class="line">        request.doc(jsonBuilder);</span><br><span class="line">        request.upsert("{\"name\": \"红楼梦\",\"author\": \"曹雪芹\"}", XContentType.JSON);</span><br><span class="line">        UpdateResponse response = client.update(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println("response.getId() = " + response.getId());</span><br><span class="line">        System.out.println("response.getIndex() = " + response.getIndex());</span><br><span class="line">        System.out.println("response.getVersion() = " + response.getVersion());</span><br><span class="line">        if (response.getResult() == DocWriteResponse.Result.UPDATED) {</span><br><span class="line">            System.out.println("更新成功!");</span><br><span class="line">        } else if (response.getResult() == DocWriteResponse.Result.CREATED) {</span><br><span class="line">            System.out.println("文档添加成功");</span><br><span class="line">        }</span><br><span class="line">        client.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div><div class="article-licensing box"><div class="licensing-title"><p>ES</p><p><a href="https://zeroornull.github.io/2021/04/13/ES笔记/">https://zeroornull.github.io/2021/04/13/ES笔记/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Zeroornull</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-04-13</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-04-20</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/es/">es</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=60667abe39329f00123aea68&amp;product=sticky-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" href="https://www.afdian.net/@zeroornull" target="_blank" rel="noopener" data-type="afdian"><span class="icon is-small"><i class="fas fa-charging-station"></i></span><span>爱发电</span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="https://qr.alipay.com/fkx00721flijbw5hdn0kab5" alt="支付宝"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/05/11/DB2%20windows%E4%B8%8B9.5%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">DB2 windows下9.5安装教程</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/04/09/linux%E9%9F%A9%E9%A1%BA%E5%B9%B32021/"><span class="level-item">linux韩顺平2021笔记</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://cdn.dribbble.com/users/594253/screenshots/4650044/dribbble-pineapple.gif" alt="Zeroornull"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Zeroornull</p><p class="is-size-6 is-block">just one newbie</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>ShangHai</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">12</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">9</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/zeroornull" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zeroornull"><i class="fab fa-github"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#前言"><span class="level-left"><span class="level-item">1</span><span class="level-item">前言</span></span></a></li><li><a class="level is-mobile" href="#ES"><span class="level-left"><span class="level-item">2</span><span class="level-item">ES</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-ElasticSearch-核心概念介绍"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">1.ElasticSearch 核心概念介绍</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-1-ElasticSearch-十大核心概念"><span class="level-left"><span class="level-item">2.1.1</span><span class="level-item">4.1 ElasticSearch 十大核心概念</span></span></a></li><li><a class="level is-mobile" href="#4-2-ElasticSearch-Vs-关系型数据库"><span class="level-left"><span class="level-item">2.1.2</span><span class="level-item">4.2 ElasticSearch Vs 关系型数据库</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-ElasticSearch-分词器"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">2.ElasticSearch 分词器</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-内置分词器"><span class="level-left"><span class="level-item">2.2.1</span><span class="level-item">1.1 内置分词器</span></span></a></li><li><a class="level is-mobile" href="#1-2-中文分词器"><span class="level-left"><span class="level-item">2.2.2</span><span class="level-item">1.2 中文分词器</span></span></a></li></ul></li><li><a class="level is-mobile" href="#3-ElasticSearch-索引管理"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">3. ElasticSearch 索引管理</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-新建索引"><span class="level-left"><span class="level-item">2.3.1</span><span class="level-item">2.1 新建索引</span></span></a></li><li><a class="level is-mobile" href="#2-2-更新索引"><span class="level-left"><span class="level-item">2.3.2</span><span class="level-item">2.2 更新索引</span></span></a></li><li><a class="level is-mobile" href="#2-3-修改索引的读写权限"><span class="level-left"><span class="level-item">2.3.3</span><span class="level-item">2.3 修改索引的读写权限</span></span></a></li><li><a class="level is-mobile" href="#2-4-查看索引"><span class="level-left"><span class="level-item">2.3.4</span><span class="level-item">2.4 查看索引</span></span></a></li><li><a class="level is-mobile" href="#2-5-删除索引"><span class="level-left"><span class="level-item">2.3.5</span><span class="level-item">2.5 删除索引</span></span></a></li><li><a class="level is-mobile" href="#5-6-索引打开-关闭"><span class="level-left"><span class="level-item">2.3.6</span><span class="level-item">5.6 索引打开/关闭</span></span></a></li><li><a class="level is-mobile" href="#2-7-复制索引"><span class="level-left"><span class="level-item">2.3.7</span><span class="level-item">2.7 复制索引</span></span></a></li><li><a class="level is-mobile" href="#2-8-索引别名"><span class="level-left"><span class="level-item">2.3.8</span><span class="level-item">2.8 索引别名</span></span></a></li></ul></li><li><a class="level is-mobile" href="#6-ElasticSearch-文档基本操作"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">6.ElasticSearch 文档基本操作</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-1创建文档"><span class="level-left"><span class="level-item">2.4.1</span><span class="level-item">6.1创建文档</span></span></a></li><li><a class="level is-mobile" href="#6-2获取文档"><span class="level-left"><span class="level-item">2.4.2</span><span class="level-item">6.2获取文档</span></span></a></li><li><a class="level is-mobile" href="#6-3文档更新"><span class="level-left"><span class="level-item">2.4.3</span><span class="level-item">6.3文档更新</span></span></a></li></ul></li><li><a class="level is-mobile" href="#7-ElasticSearch-文档路由"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">7.ElasticSearch 文档路由</span></span></a></li><li><a class="level is-mobile" href="#8-ElasticSearch-并发的处理方式：锁和版本控制"><span class="level-left"><span class="level-item">2.6</span><span class="level-item">8.ElasticSearch 并发的处理方式：锁和版本控制</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#8-1-锁"><span class="level-left"><span class="level-item">2.6.1</span><span class="level-item">8.1 锁</span></span></a></li><li><a class="level is-mobile" href="#8-2-版本控制"><span class="level-left"><span class="level-item">2.6.2</span><span class="level-item">8.2 版本控制</span></span></a></li></ul></li><li><a class="level is-mobile" href="#es倒排索引"><span class="level-left"><span class="level-item">2.7</span><span class="level-item">es倒排索引</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#8-1-“正排索引”"><span class="level-left"><span class="level-item">2.7.1</span><span class="level-item">8.1 “正排索引”</span></span></a></li><li><a class="level is-mobile" href="#8-2-倒排索引"><span class="level-left"><span class="level-item">2.7.2</span><span class="level-item">8.2 倒排索引</span></span></a></li></ul></li><li><a class="level is-mobile" href="#9-ElasticSearch-动态映射与静态映射"><span class="level-left"><span class="level-item">2.8</span><span class="level-item">9.ElasticSearch 动态映射与静态映射</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#9-1-映射分类"><span class="level-left"><span class="level-item">2.8.1</span><span class="level-item">9.1 映射分类</span></span></a></li><li><a class="level is-mobile" href="#9-2-类型推断"><span class="level-left"><span class="level-item">2.8.2</span><span class="level-item">9.2 类型推断</span></span></a></li></ul></li><li><a class="level is-mobile" href="#10-ElasticSearch-四种字段类型详解"><span class="level-left"><span class="level-item">2.9</span><span class="level-item">10.ElasticSearch 四种字段类型详解</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#10-1-核心类型"><span class="level-left"><span class="level-item">2.9.1</span><span class="level-item">10.1 核心类型</span></span></a></li><li><a class="level is-mobile" href="#10-2-复合类型"><span class="level-left"><span class="level-item">2.9.2</span><span class="level-item">10.2 复合类型</span></span></a></li><li><a class="level is-mobile" href="#10-3-地理类型"><span class="level-left"><span class="level-item">2.9.3</span><span class="level-item">10.3 地理类型</span></span></a></li><li><a class="level is-mobile" href="#10-4-特殊类型"><span class="level-left"><span class="level-item">2.9.4</span><span class="level-item">10.4 特殊类型</span></span></a></li></ul></li><li><a class="level is-mobile" href="#11-ElasticSearch-23-种映射参数详解"><span class="level-left"><span class="level-item">2.10</span><span class="level-item">11.ElasticSearch 23 种映射参数详解</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#11-1-analyzer"><span class="level-left"><span class="level-item">2.10.1</span><span class="level-item">11.1 analyzer</span></span></a></li><li><a class="level is-mobile" href="#11-2-search-analyzer"><span class="level-left"><span class="level-item">2.10.2</span><span class="level-item">11.2 search_analyzer</span></span></a></li><li><a class="level is-mobile" href="#11-3-normalizer"><span class="level-left"><span class="level-item">2.10.3</span><span class="level-item">11.3 normalizer</span></span></a></li><li><a class="level is-mobile" href="#11-4-boost"><span class="level-left"><span class="level-item">2.10.4</span><span class="level-item">11.4 boost</span></span></a></li><li><a class="level is-mobile" href="#11-5-coerce"><span class="level-left"><span class="level-item">2.10.5</span><span class="level-item">11.5 coerce</span></span></a></li><li><a class="level is-mobile" href="#11-6-copy-to"><span class="level-left"><span class="level-item">2.10.6</span><span class="level-item">11.6 copy_to</span></span></a></li><li><a class="level is-mobile" href="#11-7-doc-values-和-fielddata"><span class="level-left"><span class="level-item">2.10.7</span><span class="level-item">11.7 doc_values 和 fielddata</span></span></a></li><li><a class="level is-mobile" href="#11-8-dynamic"><span class="level-left"><span class="level-item">2.10.8</span><span class="level-item">11.8 dynamic</span></span></a></li><li><a class="level is-mobile" href="#11-9-enabled"><span class="level-left"><span class="level-item">2.10.9</span><span class="level-item">11.9 enabled</span></span></a></li><li><a class="level is-mobile" href="#11-10-format"><span class="level-left"><span class="level-item">2.10.10</span><span class="level-item">11.10 format</span></span></a></li><li><a class="level is-mobile" href="#11-11-ignore-above"><span class="level-left"><span class="level-item">2.10.11</span><span class="level-item">11.11 ignore_above</span></span></a></li><li><a class="level is-mobile" href="#10-12-ignore-malformed"><span class="level-left"><span class="level-item">2.10.12</span><span class="level-item">10.12 ignore_malformed</span></span></a></li><li><a class="level is-mobile" href="#10-13-include-in-all"><span class="level-left"><span class="level-item">2.10.13</span><span class="level-item">10.13 include_in_all</span></span></a></li><li><a class="level is-mobile" href="#10-14-index"><span class="level-left"><span class="level-item">2.10.14</span><span class="level-item">10.14 index</span></span></a></li><li><a class="level is-mobile" href="#10-15-index-options"><span class="level-left"><span class="level-item">2.10.15</span><span class="level-item">10.15 index_options</span></span></a></li><li><a class="level is-mobile" href="#10-16-norms"><span class="level-left"><span class="level-item">2.10.16</span><span class="level-item">10.16 norms</span></span></a></li><li><a class="level is-mobile" href="#10-17-null-value"><span class="level-left"><span class="level-item">2.10.17</span><span class="level-item">10.17 null_value</span></span></a></li><li><a class="level is-mobile" href="#10-18-position-increment-gap"><span class="level-left"><span class="level-item">2.10.18</span><span class="level-item">10.18 position_increment_gap</span></span></a></li><li><a class="level is-mobile" href="#10-19-properties"><span class="level-left"><span class="level-item">2.10.19</span><span class="level-item">10.19 properties</span></span></a></li><li><a class="level is-mobile" href="#10-20-similarity"><span class="level-left"><span class="level-item">2.10.20</span><span class="level-item">10.20 similarity</span></span></a></li><li><a class="level is-mobile" href="#10-21-store"><span class="level-left"><span class="level-item">2.10.21</span><span class="level-item">10.21 store</span></span></a></li><li><a class="level is-mobile" href="#10-22-term-vectors"><span class="level-left"><span class="level-item">2.10.22</span><span class="level-item">10.22 term_vectors</span></span></a></li><li><a class="level is-mobile" href="#11-23-fields"><span class="level-left"><span class="level-item">2.10.23</span><span class="level-item">11.23 fields</span></span></a></li></ul></li><li><a class="level is-mobile" href="#12-映射模板"><span class="level-left"><span class="level-item">2.11</span><span class="level-item">12.映射模板</span></span></a></li><li><a class="level is-mobile" href="#13-ElasticSearch-搜索数据导入"><span class="level-left"><span class="level-item">2.12</span><span class="level-item">13.ElasticSearch 搜索数据导入</span></span></a></li><li><a class="level is-mobile" href="#14-ElasticSearch-搜索入门"><span class="level-left"><span class="level-item">2.13</span><span class="level-item">14.ElasticSearch 搜索入门</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#14-1-简单搜索"><span class="level-left"><span class="level-item">2.13.1</span><span class="level-item">14.1 简单搜索</span></span></a></li><li><a class="level is-mobile" href="#14-2-词项查询"><span class="level-left"><span class="level-item">2.13.2</span><span class="level-item">14.2 词项查询</span></span></a></li><li><a class="level is-mobile" href="#14-3-分页"><span class="level-left"><span class="level-item">2.13.3</span><span class="level-item">14.3 分页</span></span></a></li><li><a class="level is-mobile" href="#14-4-过滤返回字段"><span class="level-left"><span class="level-item">2.13.4</span><span class="level-item">14.4 过滤返回字段</span></span></a></li><li><a class="level is-mobile" href="#14-5-最小评分"><span class="level-left"><span class="level-item">2.13.5</span><span class="level-item">14.5 最小评分</span></span></a></li><li><a class="level is-mobile" href="#14-6-高亮"><span class="level-left"><span class="level-item">2.13.6</span><span class="level-item">14.6 高亮</span></span></a></li></ul></li><li><a class="level is-mobile" href="#15-ElasticSearch-全文查询"><span class="level-left"><span class="level-item">2.14</span><span class="level-item">15.ElasticSearch 全文查询</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#15-1-match-query"><span class="level-left"><span class="level-item">2.14.1</span><span class="level-item">15.1 match query</span></span></a></li><li><a class="level is-mobile" href="#15-2-match-phrase-query"><span class="level-left"><span class="level-item">2.14.2</span><span class="level-item">15.2 match_phrase query</span></span></a></li><li><a class="level is-mobile" href="#15-3-match-phrase-prefix-query"><span class="level-left"><span class="level-item">2.14.3</span><span class="level-item">15.3 match_phrase_prefix query</span></span></a></li><li><a class="level is-mobile" href="#15-4-multi-match-query"><span class="level-left"><span class="level-item">2.14.4</span><span class="level-item">15.4 multi_match query</span></span></a></li><li><a class="level is-mobile" href="#15-5-query-string-query"><span class="level-left"><span class="level-item">2.14.5</span><span class="level-item">15.5 query_string query</span></span></a></li><li><a class="level is-mobile" href="#15-6-simple-query-string"><span class="level-left"><span class="level-item">2.14.6</span><span class="level-item">15.6 simple_query_string</span></span></a></li></ul></li><li><a class="level is-mobile" href="#16-ElasticSearch词项查询"><span class="level-left"><span class="level-item">2.15</span><span class="level-item">16.ElasticSearch词项查询</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#16-1-term-query"><span class="level-left"><span class="level-item">2.15.1</span><span class="level-item">16.1 term query</span></span></a></li><li><a class="level is-mobile" href="#16-2-terms-query"><span class="level-left"><span class="level-item">2.15.2</span><span class="level-item">16.2 terms query</span></span></a></li><li><a class="level is-mobile" href="#16-3-range-query"><span class="level-left"><span class="level-item">2.15.3</span><span class="level-item">16.3 range query</span></span></a></li><li><a class="level is-mobile" href="#16-4-exists-query"><span class="level-left"><span class="level-item">2.15.4</span><span class="level-item">16.4 exists query</span></span></a></li><li><a class="level is-mobile" href="#16-5-prefix-query"><span class="level-left"><span class="level-item">2.15.5</span><span class="level-item">16.5 prefix query</span></span></a></li><li><a class="level is-mobile" href="#16-6-wildcard-query"><span class="level-left"><span class="level-item">2.15.6</span><span class="level-item">16.6 wildcard query</span></span></a></li><li><a class="level is-mobile" href="#16-7-regexp-query"><span class="level-left"><span class="level-item">2.15.7</span><span class="level-item">16.7 regexp query</span></span></a></li><li><a class="level is-mobile" href="#16-8-fuzzy-query"><span class="level-left"><span class="level-item">2.15.8</span><span class="level-item">16.8 fuzzy query</span></span></a></li><li><a class="level is-mobile" href="#16-9-ids-query"><span class="level-left"><span class="level-item">2.15.9</span><span class="level-item">16.9 ids query</span></span></a></li></ul></li><li><a class="level is-mobile" href="#17-ElasticSearch-复合查询"><span class="level-left"><span class="level-item">2.16</span><span class="level-item">17.ElasticSearch 复合查询</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#17-1-constant-score-query"><span class="level-left"><span class="level-item">2.16.1</span><span class="level-item">17.1 constant_score query</span></span></a></li><li><a class="level is-mobile" href="#17-2-bool-query"><span class="level-left"><span class="level-item">2.16.2</span><span class="level-item">17.2 bool query</span></span></a></li><li><a class="level is-mobile" href="#17-3-dis-max-query"><span class="level-left"><span class="level-item">2.16.3</span><span class="level-item">17.3 dis_max query</span></span></a></li><li><a class="level is-mobile" href="#17-4-function-score-query"><span class="level-left"><span class="level-item">2.16.4</span><span class="level-item">17.4 function_score query</span></span></a></li><li><a class="level is-mobile" href="#17-5-boosting-query"><span class="level-left"><span class="level-item">2.16.5</span><span class="level-item">17.5 boosting query</span></span></a></li></ul></li><li><a class="level is-mobile" href="#18-ElasticSearch-嵌套查询"><span class="level-left"><span class="level-item">2.17</span><span class="level-item">18.ElasticSearch 嵌套查询</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#18-1-嵌套文档"><span class="level-left"><span class="level-item">2.17.1</span><span class="level-item">18.1 嵌套文档</span></span></a></li><li><a class="level is-mobile" href="#18-2-嵌套查询"><span class="level-left"><span class="level-item">2.17.2</span><span class="level-item">18.2 嵌套查询</span></span></a></li><li><a class="level is-mobile" href="#18-3-父子文档"><span class="level-left"><span class="level-item">2.17.3</span><span class="level-item">18.3 父子文档</span></span></a></li><li><a class="level is-mobile" href="#18-4-has-child-query"><span class="level-left"><span class="level-item">2.17.4</span><span class="level-item">18.4 has_child query</span></span></a></li><li><a class="level is-mobile" href="#18-5-has-parent-query"><span class="level-left"><span class="level-item">2.17.5</span><span class="level-item">18.5 has_parent query</span></span></a></li><li><a class="level is-mobile" href="#18-6-小结"><span class="level-left"><span class="level-item">2.17.6</span><span class="level-item">18.6 小结</span></span></a></li></ul></li><li><a class="level is-mobile" href="#19-ElasticSearch-地理位置查询"><span class="level-left"><span class="level-item">2.18</span><span class="level-item">19.ElasticSearch 地理位置查询</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#19-1-数据准备"><span class="level-left"><span class="level-item">2.18.1</span><span class="level-item">19.1 数据准备</span></span></a></li><li><a class="level is-mobile" href="#19-2-geo-distance-query"><span class="level-left"><span class="level-item">2.18.2</span><span class="level-item">19.2 geo_distance query</span></span></a></li><li><a class="level is-mobile" href="#19-3-geo-bounding-box-query"><span class="level-left"><span class="level-item">2.18.3</span><span class="level-item">19.3 geo_bounding_box query</span></span></a></li><li><a class="level is-mobile" href="#19-4-geo-polygon-query"><span class="level-left"><span class="level-item">2.18.4</span><span class="level-item">19.4 geo_polygon query</span></span></a></li><li><a class="level is-mobile" href="#19-5-geo-shape-query"><span class="level-left"><span class="level-item">2.18.5</span><span class="level-item">19.5 geo_shape query</span></span></a></li></ul></li><li><a class="level is-mobile" href="#20-ElasticSearch-特殊查询"><span class="level-left"><span class="level-item">2.19</span><span class="level-item">20.ElasticSearch 特殊查询</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#20-1-more-like-this-query"><span class="level-left"><span class="level-item">2.19.1</span><span class="level-item">20.1 more_like_this query</span></span></a></li><li><a class="level is-mobile" href="#20-2-script-query"><span class="level-left"><span class="level-item">2.19.2</span><span class="level-item">20.2 script query</span></span></a></li><li><a class="level is-mobile" href="#20-3-percolate-query"><span class="level-left"><span class="level-item">2.19.3</span><span class="level-item">20.3 percolate query</span></span></a></li></ul></li><li><a class="level is-mobile" href="#21-ElasticSearch-搜索高亮与排序"><span class="level-left"><span class="level-item">2.20</span><span class="level-item">21.ElasticSearch 搜索高亮与排序</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#21-1-搜索高亮"><span class="level-left"><span class="level-item">2.20.1</span><span class="level-item">21.1 搜索高亮</span></span></a></li><li><a class="level is-mobile" href="#21-2-排序"><span class="level-left"><span class="level-item">2.20.2</span><span class="level-item">21.2 排序</span></span></a></li></ul></li><li><a class="level is-mobile" href="#22-ElasticSearch-指标聚合"><span class="level-left"><span class="level-item">2.21</span><span class="level-item">22.ElasticSearch 指标聚合</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#22-1-Max-Aggregation"><span class="level-left"><span class="level-item">2.21.1</span><span class="level-item">22.1 Max Aggregation</span></span></a></li><li><a class="level is-mobile" href="#22-2-Min-Aggregation"><span class="level-left"><span class="level-item">2.21.2</span><span class="level-item">22.2 Min Aggregation</span></span></a></li><li><a class="level is-mobile" href="#22-3-Avg-Aggregation"><span class="level-left"><span class="level-item">2.21.3</span><span class="level-item">22.3 Avg Aggregation</span></span></a></li><li><a class="level is-mobile" href="#22-4-Sum-Aggregation"><span class="level-left"><span class="level-item">2.21.4</span><span class="level-item">22.4 Sum Aggregation</span></span></a></li><li><a class="level is-mobile" href="#22-5-Cardinality-Aggregation"><span class="level-left"><span class="level-item">2.21.5</span><span class="level-item">22.5 Cardinality Aggregation</span></span></a></li><li><a class="level is-mobile" href="#22-6-Stats-Aggregation"><span class="level-left"><span class="level-item">2.21.6</span><span class="level-item">22.6 Stats Aggregation</span></span></a></li><li><a class="level is-mobile" href="#22-7-Extends-Stats-Aggregation"><span class="level-left"><span class="level-item">2.21.7</span><span class="level-item">22.7 Extends Stats Aggregation</span></span></a></li><li><a class="level is-mobile" href="#22-8-Percentiles-Aggregation"><span class="level-left"><span class="level-item">2.21.8</span><span class="level-item">22.8 Percentiles Aggregation</span></span></a></li><li><a class="level is-mobile" href="#22-9-Value-Count-Aggregation"><span class="level-left"><span class="level-item">2.21.9</span><span class="level-item">22.9 Value Count Aggregation</span></span></a></li></ul></li><li><a class="level is-mobile" href="#23-ElasticSearch-桶聚合（bucket）"><span class="level-left"><span class="level-item">2.22</span><span class="level-item">23.ElasticSearch 桶聚合（bucket）</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#23-1-Terms-Aggregation"><span class="level-left"><span class="level-item">2.22.1</span><span class="level-item">23.1 Terms Aggregation</span></span></a></li><li><a class="level is-mobile" href="#23-2-Filter-Aggregation"><span class="level-left"><span class="level-item">2.22.2</span><span class="level-item">23.2 Filter Aggregation</span></span></a></li><li><a class="level is-mobile" href="#23-3-Filters-Aggregation"><span class="level-left"><span class="level-item">2.22.3</span><span class="level-item">23.3 Filters Aggregation</span></span></a></li><li><a class="level is-mobile" href="#23-4-Range-Aggregation"><span class="level-left"><span class="level-item">2.22.4</span><span class="level-item">23.4 Range Aggregation</span></span></a></li><li><a class="level is-mobile" href="#23-5-Date-Range-Aggregation"><span class="level-left"><span class="level-item">2.22.5</span><span class="level-item">23.5 Date Range Aggregation</span></span></a></li><li><a class="level is-mobile" href="#23-6-Date-Histogram-Aggregation"><span class="level-left"><span class="level-item">2.22.6</span><span class="level-item">23.6 Date Histogram Aggregation</span></span></a></li><li><a class="level is-mobile" href="#23-7-Missing-Aggregation"><span class="level-left"><span class="level-item">2.22.7</span><span class="level-item">23.7 Missing Aggregation</span></span></a></li><li><a class="level is-mobile" href="#23-8-Children-Aggregation"><span class="level-left"><span class="level-item">2.22.8</span><span class="level-item">23.8 Children Aggregation</span></span></a></li><li><a class="level is-mobile" href="#23-9-Geo-Distance-Aggregation"><span class="level-left"><span class="level-item">2.22.9</span><span class="level-item">23.9 Geo Distance Aggregation</span></span></a></li><li><a class="level is-mobile" href="#23-10-IP-Range-Aggregation"><span class="level-left"><span class="level-item">2.22.10</span><span class="level-item">23.10 IP Range Aggregation</span></span></a></li></ul></li><li><a class="level is-mobile" href="#24-ElasticSearch-管道聚合-类似于linux的-管道符"><span class="level-left"><span class="level-item">2.23</span><span class="level-item">24.ElasticSearch 管道聚合 类似于linux的 | 管道符</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#24-1-Avg-Bucket-Aggregation"><span class="level-left"><span class="level-item">2.23.1</span><span class="level-item">24.1 Avg Bucket Aggregation</span></span></a></li><li><a class="level is-mobile" href="#24-2-Max-Bucket-Aggregation"><span class="level-left"><span class="level-item">2.23.2</span><span class="level-item">24.2 Max Bucket Aggregation</span></span></a></li><li><a class="level is-mobile" href="#24-3-Min-Bucket-Aggregation"><span class="level-left"><span class="level-item">2.23.3</span><span class="level-item">24.3 Min Bucket Aggregation</span></span></a></li><li><a class="level is-mobile" href="#24-4-Sum-Bucket-Aggregation"><span class="level-left"><span class="level-item">2.23.4</span><span class="level-item">24.4 Sum Bucket Aggregation</span></span></a></li><li><a class="level is-mobile" href="#24-5-Stats-Bucket-Aggregation"><span class="level-left"><span class="level-item">2.23.5</span><span class="level-item">24.5 Stats Bucket Aggregation</span></span></a></li><li><a class="level is-mobile" href="#24-6-Extended-Stats-Bucket-Aggregation"><span class="level-left"><span class="level-item">2.23.6</span><span class="level-item">24.6 Extended Stats Bucket Aggregation</span></span></a></li><li><a class="level is-mobile" href="#24-7-Percentiles-Bucket-Aggregation"><span class="level-left"><span class="level-item">2.23.7</span><span class="level-item">24.7 Percentiles Bucket Aggregation</span></span></a></li></ul></li><li><a class="level is-mobile" href="#25-ElasticSearch-Java-Api-概览"><span class="level-left"><span class="level-item">2.24</span><span class="level-item">25.ElasticSearch Java Api 概览</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-直接使用Http请求"><span class="level-left"><span class="level-item">2.24.1</span><span class="level-item">1.直接使用Http请求</span></span></a></li><li><a class="level is-mobile" href="#2-Java-Low-Level-REST-Client"><span class="level-left"><span class="level-item">2.24.2</span><span class="level-item">2.Java Low Level REST Client</span></span></a></li><li><a class="level is-mobile" href="#3-Java-High-Level-REST-Client"><span class="level-left"><span class="level-item">2.24.3</span><span class="level-item">3.Java High Level REST Client</span></span></a></li><li><a class="level is-mobile" href="#4-其他"><span class="level-left"><span class="level-item">2.24.4</span><span class="level-item">4.其他</span></span></a></li></ul></li><li><a class="level is-mobile" href="#26-ElasticSearch普通HTTP请求"><span class="level-left"><span class="level-item">2.25</span><span class="level-item">26.ElasticSearch普通HTTP请求</span></span></a></li><li><a class="level is-mobile" href="#27-ElasticSearch-Java-Low-Level-REST-Client"><span class="level-left"><span class="level-item">2.26</span><span class="level-item">27.ElasticSearch Java Low Level REST Client</span></span></a></li><li><a class="level is-mobile" href="#28-Java-High-Level-REST-Client"><span class="level-left"><span class="level-item">2.27</span><span class="level-item">28.Java High Level REST Client</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#28-1-索引管理"><span class="level-left"><span class="level-item">2.27.1</span><span class="level-item">28.1 索引管理</span></span></a></li><li><a class="level is-mobile" href="#29-1-添加文档"><span class="level-left"><span class="level-item">2.27.2</span><span class="level-item">29.1 添加文档</span></span></a></li><li><a class="level is-mobile" href="#29-2-获取文档"><span class="level-left"><span class="level-item">2.27.3</span><span class="level-item">29.2 获取文档</span></span></a></li><li><a class="level is-mobile" href="#29-3-判断文档是否存在"><span class="level-left"><span class="level-item">2.27.4</span><span class="level-item">29.3 判断文档是否存在</span></span></a></li><li><a class="level is-mobile" href="#29-4-删除文档"><span class="level-left"><span class="level-item">2.27.5</span><span class="level-item">29.4 删除文档</span></span></a></li><li><a class="level is-mobile" href="#29-4-更新文档"><span class="level-left"><span class="level-item">2.27.6</span><span class="level-item">29.4 更新文档</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/db2/"><span class="level-start"><span class="level-item">db2</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/eladmin/"><span class="level-start"><span class="level-item">eladmin</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/es/"><span class="level-start"><span class="level-item">es</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/githubpage/"><span class="level-start"><span class="level-item">githubpage</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/linux/"><span class="level-start"><span class="level-item">linux</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/nginx/"><span class="level-start"><span class="level-item">nginx</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/redis/"><span class="level-start"><span class="level-item">redis</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%AE%97%E6%B3%95/"><span class="level-start"><span class="level-item">算法</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-26T06:00:16.000Z">2021-07-26</time></p><p class="title"><a href="/2021/07/26/%E4%BD%BF%E7%94%A8cloudflare%E5%8A%A0%E9%80%9FgithubPage/">使用cloudflare免费加速github page</a></p><p class="categories"><a href="/categories/githubpage/">githubpage</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-06-25T07:07:08.000Z">2021-06-25</time></p><p class="title"><a href="/2021/06/25/%E6%94%B9%E9%80%A0eladmin%E4%B8%BA%E5%89%8D%E5%90%8E%E7%AB%AF%E4%B8%80%E8%B5%B7%E9%83%A8%E7%BD%B2/">改造eladmin为前后端一起部署</a></p><p class="categories"><a href="/categories/eladmin/">eladmin</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-06-25T05:07:08.000Z">2021-06-25</time></p><p class="title"><a href="/2021/06/25/%E9%83%A8%E7%BD%B2nginx%E4%BA%8C%E7%BA%A7%E7%9B%AE%E5%BD%95/">部署nginx二级目录</a></p><p class="categories"><a href="/categories/nginx/">nginx</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-06-01T07:15:56.000Z">2021-06-01</time></p><p class="title"><a href="/2021/06/01/LeetCode%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/">LeetCode刷题笔记</a></p><p class="categories"><a href="/categories/%E7%AE%97%E6%B3%95/">算法</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-16T10:05:26.000Z">2021-05-16</time></p><p class="title"><a href="/2021/05/16/redis%E7%AC%94%E8%AE%B0/">最近的Redis笔记</a></p><p class="categories"><a href="/categories/redis/">redis</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/db2/"><span class="tag">db2</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/eladmin/"><span class="tag">eladmin</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/es/"><span class="tag">es</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/githubpage/"><span class="tag">githubpage</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vue/"><span class="tag">vue</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%AE%97%E6%B3%95/"><span class="tag">算法</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Zeroornull</a><p class="is-size-7"><span>&copy; 2021 Zeroornull</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>