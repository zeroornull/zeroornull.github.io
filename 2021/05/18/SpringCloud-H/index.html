<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="theme-color" content="#123456"><meta name="generator" content="Hexo 4.2.0"><meta><title>Sql50题 - Zeroornull</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="zeroornull"><meta name="msapplication-TileImage" content="icons/touch-icon-iphone.png"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="zeroornull"><meta name="apple-mobile-web-app-status-bar-style" content="default"><link rel="apple-touch-icon" sizes="144x144" href="icons/touch-icon-iphone.png"><link rel="apple-touch-icon" sizes="152x152" href="icons/touch-icon-ipad.png"><link rel="apple-touch-icon" sizes="72x72" href="icon/logo.ico"><link rel="apple-touch-icon" sizes="96x96" href="icon/logo.ico"><link rel="apple-touch-icon" sizes="128x128" href="icon/logo.ico"><link rel="apple-touch-icon" sizes="256x256" href="icon/logo.ico"><meta name="description" content="SpringCloud基础笔记"><meta property="og:type" content="blog"><meta property="og:title" content="Sql50题"><meta property="og:url" content="https://zeroornull.github.io/2021/05/18/SpringCloud-H/"><meta property="og:site_name" content="Zeroornull"><meta property="og:description" content="SpringCloud基础笔记"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210430133950.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210430133947.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210430133943.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210430133939.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210430133934.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210430133928.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210430133924.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210430133921.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210430133917.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210430133902.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210430141603.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210430143645.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210430174447.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210504132914.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210505220116.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210505220141.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210510133323.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210510153432.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210510153556.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210510153653.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210510161703.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210511165734.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210512173814.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210512223119.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210513092307.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210513141557.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210513151052.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210513162519.png"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210514135559.png"><meta property="og:image" content="https://github.githubassets.com/images/icons/emoji/unicode/1f62d.png?v8"><meta property="og:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210514150450.png"><meta property="article:published_time" content="2021-05-17T17:11:09.000Z"><meta property="article:modified_time" content="2021-07-27T17:58:51.222Z"><meta property="article:author" content="Zeroornull"><meta property="article:tag" content="SpringCloud"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://gitee.com/penno/blogimg/raw/master/img/20210430133950.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zeroornull.github.io/2021/05/18/SpringCloud-H/"},"headline":"Sql50题","image":["https://gitee.com/penno/blogimg/raw/master/img/20210430133950.png","https://gitee.com/penno/blogimg/raw/master/img/20210430133947.png","https://gitee.com/penno/blogimg/raw/master/img/20210430133943.png","https://gitee.com/penno/blogimg/raw/master/img/20210430133939.png","https://gitee.com/penno/blogimg/raw/master/img/20210430133934.png","https://gitee.com/penno/blogimg/raw/master/img/20210430133928.png","https://gitee.com/penno/blogimg/raw/master/img/20210430133924.png","https://gitee.com/penno/blogimg/raw/master/img/20210430133921.png","https://gitee.com/penno/blogimg/raw/master/img/20210430133917.png","https://gitee.com/penno/blogimg/raw/master/img/20210430133902.png","https://gitee.com/penno/blogimg/raw/master/img/20210430141603.png","https://gitee.com/penno/blogimg/raw/master/img/20210430143645.png","https://gitee.com/penno/blogimg/raw/master/img/20210430174447.png","https://gitee.com/penno/blogimg/raw/master/img/20210504132914.png","https://gitee.com/penno/blogimg/raw/master/img/20210505220116.png","https://gitee.com/penno/blogimg/raw/master/img/20210505220141.png","https://gitee.com/penno/blogimg/raw/master/img/20210510133323.png","https://gitee.com/penno/blogimg/raw/master/img/20210510153432.png","https://gitee.com/penno/blogimg/raw/master/img/20210510153556.png","https://gitee.com/penno/blogimg/raw/master/img/20210510153653.png","https://gitee.com/penno/blogimg/raw/master/img/20210510161703.png","https://gitee.com/penno/blogimg/raw/master/img/20210511165734.png","https://gitee.com/penno/blogimg/raw/master/img/20210512173814.png","https://gitee.com/penno/blogimg/raw/master/img/20210512223119.png","https://gitee.com/penno/blogimg/raw/master/img/20210513092307.png","https://gitee.com/penno/blogimg/raw/master/img/20210513141557.png","https://gitee.com/penno/blogimg/raw/master/img/20210513151052.png","https://gitee.com/penno/blogimg/raw/master/img/20210513162519.png","https://gitee.com/penno/blogimg/raw/master/img/20210514135559.png","https://gitee.com/penno/blogimg/raw/master/img/20210514150450.png"],"datePublished":"2021-05-17T17:11:09.000Z","dateModified":"2021-07-27T17:58:51.222Z","author":{"@type":"Person","name":"Zeroornull"},"description":"SpringCloud基础笔记"}</script><link rel="canonical" href="https://zeroornull.github.io/2021/05/18/SpringCloud-H/"><link rel="alternate" href="/path/to/atom.xml" title="Zeroornull" type="application/atom+xml"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!-->
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Zeroornull</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com">GitHub</a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zeroornull"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-17T17:11:09.000Z" title="2021/5/18 上午1:11:09">2021-05-18</time>发表</span><span class="level-item"><time dateTime="2021-07-27T17:58:51.222Z" title="2021/7/28 上午1:58:51">2021-07-28</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/SpringCloud/">SpringCloud</a></span><span class="level-item">2 小时读完 (大约21721个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Sql50题</h1><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>   SpringCloud基础笔记</p>
<pre><code>    2021-05-18 01:11:09
</code></pre>
<span id="more"></span>

<h2 id="第1章-微服务介绍"><a href="#第1章-微服务介绍" class="headerlink" title="第1章 微服务介绍"></a>第1章 微服务介绍</h2><h3 id="1-课程介绍"><a href="#1-课程介绍" class="headerlink" title="1. 课程介绍"></a>1. 课程介绍</h3><h4 id="1-1-课程内容"><a href="#1-1-课程内容" class="headerlink" title="1.1 课程内容"></a>1.1 课程内容</h4><ol>
<li><p>介绍微服务的由来，以及微服务和 Spring Cloud 之间的关系</p>
</li>
<li><p>介绍 Spring Cloud 核心组件的使用，使小伙伴们通过核心组件可以快速搭建一个微服务架构</p>
</li>
<li><p>介绍 Spring Cloud 中的辅助类组件，例如微服务监控、链路追踪等等</p>
</li>
<li><p>介绍 Spring Cloud Alibaba ，以及相关核心组件的具体用法</p>
</li>
</ol>
<h4 id="1-2-课程收获"><a href="#1-2-课程收获" class="headerlink" title="1.2 课程收获"></a>1.2 课程收获</h4><p>1.了解微服务的由来以及基本原理</p>
<p>2.学会 Spring Cloud 中各个组件的使用</p>
<p>3.了解 Spring Cloud 中核心组件的运行原理</p>
<p>4.掌握通过 Spring Cloud 搭建微服务架构</p>
<p>5.掌握辅助组件的用法</p>
<h3 id="2-微服务介绍"><a href="#2-微服务介绍" class="headerlink" title="2 微服务介绍"></a>2 微服务介绍</h3><p>微服务架构越来越流行，这个没有异议。<br>2009 年，Netflix 重新定义了它的应用程序员的开发模型，这个算是微服务的首次探索。<br>20014 年，<a target="_blank" rel="noopener" href="https://martinfowler.com/articles/microservices.html">《Microservices》</a>，这篇文章以一个更加通俗易懂的方式，为大家定义了微服务。<br>为什么要用微服务？<br>互联网应用产品的两大特点：</p>
<ol>
<li>需求变化快</li>
<li>用户群体庞大<br>在这样的情况下，我们需要构建一个能够灵活扩展，同时能够快速应对外部环境变化的一个应用，使用<br>传统的开发方式，显然无法满足需求。这个时候，微服务就登场了。</li>
</ol>
<h4 id="2-1-什么是微服务"><a href="#2-1-什么是微服务" class="headerlink" title="2.1 什么是微服务"></a>2.1 什么是微服务</h4><p>简单来说，微服务就是一种将一个单一应用程序拆分为一组小型服务的方法，拆分完成后，每一个服务<br>都运行在独立的进程中，服务于服务之间采用轻量级的通信机制来进行沟通（Spring Cloud 中采用基于<br>HTTP 的 RESTful API）。<br>每一个服务，都是围绕具体的业务进行构建，例如一个电商系统，订单服务、支付服务、物流服务、会<br>员服务等等，这些拆分后的应用都是独立的应用，都可以独立的部署到生产环境中。就是在采用微服务<br>之后，我们的项目不再拘泥于一种语言，可以 Java、Go、Python、PHP 等等，混合使用，这在传统的<br>应用开发中，是无法想象的。而使用了微服务之后，我们可以根据业务上下文来选择合适的语言和构建<br>工具进行构建。<br>微服务可以理解为是 SOA 的一个传承，一个本质的区别是微服务是一个真正分布式、去中心化的，微<br>服务的拆分比 SOA 更加彻底。</p>
<h4 id="2-2-微服务优势"><a href="#2-2-微服务优势" class="headerlink" title="2.2 微服务优势"></a>2.2 微服务优势</h4><ol>
<li><p>复杂度可控</p>
</li>
<li><p>独立部署</p>
</li>
<li><p>技术选型灵活</p>
</li>
<li><p>较好的容错性</p>
</li>
<li><p>较强的可扩展性</p>
</li>
</ol>
<h4 id="2-3-使用-Spring-Cloud-的优势"><a href="#2-3-使用-Spring-Cloud-的优势" class="headerlink" title="2.3 使用 Spring Cloud 的优势"></a>2.3 使用 Spring Cloud 的优势</h4><p>Spring Cloud 可以理解为微服务这种思想在 Java 领域的一个具体落地。Spring Cloud 在发展之初，就<br>借鉴了微服务的思想，同时结合 Spring Boot，Spring Cloud 提供了组件的一键式启动和部署的能力，<br>极大的简化了微服务架构的落地。<br>Spring Cloud 这种框架，从设计之初，就充分考虑了分布式架构演化所需要的功能，例如服务注册、配<br>置中心、消息总线以及负载均衡等。这些功能都是以可插拔的形式提供出来的，这样，在分布式系统不<br>断演化的过程中，我们的 Spring Cloud 也可以非常方便的进化。</p>
<h3 id="3-Spring-Cloud-介绍"><a href="#3-Spring-Cloud-介绍" class="headerlink" title="3. Spring Cloud 介绍"></a>3. Spring Cloud 介绍</h3><h4 id="3-1-什么是-Spring-Cloud"><a href="#3-1-什么是-Spring-Cloud" class="headerlink" title="3.1 什么是 Spring Cloud"></a>3.1 什么是 Spring Cloud</h4><p>Spring Cloud 是一系列框架的集合，Spring Cloud 内部包含了许多框架，这些框架互相协作，共同来<br>构建分布式系统。利用这些组件，可以非常方便的构建一个分布式系统。</p>
<h4 id="3-2-核心特性"><a href="#3-2-核心特性" class="headerlink" title="3.2 核心特性"></a>3.2 核心特性</h4><ol>
<li>服务注册与发现</li>
<li>负载均衡</li>
<li>服务之间调用</li>
<li>容错、服务降级、断路器</li>
<li>消息总线</li>
<li>分布式配置中心</li>
<li>链路器</li>
</ol>
<h4 id="3-3-版本名称"><a href="#3-3-版本名称" class="headerlink" title="3.3 版本名称"></a>3.3 版本名称</h4><p>  不同于其他的框架，Spring Cloud 版本名称是通过 A（Angel）、B（Brixton）、C（Camden）、<br>  D（Dalston）、E（Edgware）、F（Finchley）。。 这样来明明的，这些名字使用了伦敦地铁站的名<br>  字，目前最新版是 H （Hoxton）版。</p>
<p>Spring Cloud 中，除了大的版本之外，还有一些小版本，小版本命名方式如下：</p>
<ul>
<li>M ，M 版是 milestone 的缩写，所以我们会看到一些版本叫 M1、M2</li>
<li>RC，RC 是 Release Candidate，表示该项目处于候选状态，这是正式发版之前的一个状态，所以</li>
<li>我们会看到 RC1、RC2SR，SR 是 Service Release ，表示项目正式发布的稳定版，其实相当于 GA（Generally<br>Available） 版。所以，我们会看到 SR1、SR2</li>
<li>SNAPSHOT，这个表示快照版</li>
</ul>
<h3 id="4-Spring-Cloud-体系"><a href="#4-Spring-Cloud-体系" class="headerlink" title="4. Spring Cloud 体系"></a>4. Spring Cloud 体系</h3><h4 id="4-1-Spring-Cloud-包含的组件"><a href="#4-1-Spring-Cloud-包含的组件" class="headerlink" title="4.1 Spring Cloud 包含的组件"></a>4.1 Spring Cloud 包含的组件</h4><p>Spring Cloud Netflix，这个组件，在 Spring Cloud 成立之初，立下了汗马功劳。但是， 2018 年<br>的断更，也是 Netflix 掉链子了。<br>Spring Cloud Config，分布式配置中心，利用 Git/Svn 来集中管理项目的配置文件<br>Spring Cloud Bus，消息总线，可以构建消息驱动的微服务，也可以用来做一些状态管理等<br>Spring Cloud Spring Boot<br>Hoxton 2.2.x<br>Greenwich 2.1.x<br>Finchley 2.0.x<br>Edgware 1.5.x<br>Dalston 1.5.x<br>Spring Cloud Consul，服务注册发现<br>Spring Cloud Stream，基于 Redis、RabbitMQ、Kafka 实现的消息微服务<br>Spring Cloud OpenFeign，提供 OpenFeign 集成到 Spring Boot 应用中的方式，主要解决微服务<br>之间的调用问题<br>Spring Cloud Gateway，Spring Cloud 官方推出的网关服务<br>Spring Cloud Cloudfoundry，利用 Cloudfoundry 集成我们的应用程序<br>Spring Cloud Security，在 Zuul 代理中，为 OAuth2 客户端认证提供支持<br>Spring Cloud AWS ，快速集成亚马逊云服务<br>Spring Cloud Contract，一个消费者驱动的、面向 Java 的契约框架<br>Spring Cloud Zookeeper，基于 Apache Zookeeper 的服务注册和发现<br>Spring Cloud Data Flow，在一个结构化的平台上，组成数据微服务<br>Spring Cloud Kubernetes，Spring Cloud 提供的针对 Kubernetes 的支持<br>Spring Cloud Function<br>Spring Cloud Task，短生命周期的微服务</p>
<h4 id="4-2-Spring-Cloud-和-Spring-Boot-版本关系"><a href="#4-2-Spring-Cloud-和-Spring-Boot-版本关系" class="headerlink" title="4.2 Spring Cloud 和 Spring Boot 版本关系"></a>4.2 Spring Cloud 和 Spring Boot 版本关系</h4><p>Spring Cloud     Spring Boot<br>Hoxton     2.2.x<br>Greenwich     2.1.x<br>Finchley     2.0.x<br>Edgware     1.5.x<br>Dalston     1.5.x</p>
<h2 id="第2章-服务注册中心"><a href="#第2章-服务注册中心" class="headerlink" title="第2章 服务注册中心"></a>第2章 服务注册中心</h2><h3 id="5-Eureka-注册中心"><a href="#5-Eureka-注册中心" class="headerlink" title="5.Eureka 注册中心"></a>5.Eureka 注册中心</h3><p>Eureka 是 Spring Cloud 中的注册中心，类似于 Dubbo 中的 Zookeeper。那么到底什么是注册中心，<br>我们为什么需要注册中心？<br>我们首先来看一个传统的单体应用：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210430133950.png" alt="image-20210316155332454"></p>
<p>在单体应用中，所有的业务都集中在一个项目中，当用户从浏览器发起请求时，直接由前端发起请求给后端，后端调用业务逻辑，给前端请求做出响应，完成一次调用。整个调用过程是一条直线，不需要服务之间的中转，所以没有必要引入注册中心。<br>随着公司项目越来越大，我们会将系统进行拆分，例如一个电商项目，可以拆分为订单模块、物流模块、支付模块、CMS 模块等等。这样，当用户发起请求时，就需要各个模块之间进行协作，这样不可避免的要进行模块之间的调用。此时，我们的系统架构就会发生变化：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210430133947.png" alt="image-20210316155743951"></p>
<p>在这里，大家可以看到，模块之间的调用，变得越来越复杂，而且模块之间还存在强耦合。例如 A 调用B，那么就要在 A 中写上 B 的地址，也意味着 B 的部署位置要固定，同时，如果以后 B 要进行集群化部署，A 也需要修改。<br>为了解决服务之间的耦合，注册中心闪亮登场。</p>
<h4 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h4><p>Eureka 是 Netflix 公司提供的一款服务注册中心，Eureka 基于 REST 来实现服务的注册与发现，曾经，Eureka 是 Spring Cloud 中最重要的核心组件之一。Spring Cloud 中封装了 Eureka，在 Eureka 的基础上，优化了一些配置，然后提供了可视化的页面，可以方便的查看服务的注册情况以及服务注册中心集群的运行情况。<br>Eureka 由两部分：服务端和客户端，服务端就是注册中心，用来接收其他服务的注册，客户端则是一个 Java 客户端，用来注册，并可以实现负载均衡等功能。</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210430133943.png" alt="image-20210316155931763"></p>
<p>从图中，我们可以看出，Eureka 中，有三个角色：<br>Eureka Server：注册中心<br>Eureka Provider：服务提供者<br>Eureka Consumer：服务消费者</p>
<h4 id="5-1-Eureka-搭建"><a href="#5-1-Eureka-搭建" class="headerlink" title="5.1 Eureka 搭建"></a>5.1 Eureka 搭建</h4><p>Eureka 本身是使用 Java 来开发的，Spring Cloud 使用 Spring Boot 技术对 Eureka 进行了封装，所<br>以，在 Spring Cloud 中使用 Eureka 非常方便，只需要引入 spring-cloud-starter-netflix-eurekaserver<br>这个依赖即可，然后就像启动一个普通的 Spring Boot 项目一样启动 Eureka 即可。<br>创建一个普通的 Spring Boot 项目，创建时，添加 Eureka 依赖：</p>
<p> <font color="red">加依赖时出现 问题 始终在报红，后面重写编辑了一下就行了，真是服了</font></p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210430133939.png" alt="image-20210316180719027"></p>
<p>项目创建成功后，在项目启动类上添加注解，标记该项目是一个 Eureka Server：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaApplication</span> </span>{</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">SpringApplication.run(EurekaApplication.class, args);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>@EnableEurekaServer</code> 注解表示开启 Eureka 的功能。<br>接下来，在 application.properties 中添加基本配置信息：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 给当前服务取一个名字</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">eureka</span></span><br><span class="line"><span class="comment"># 设置端口号</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">1111</span></span><br><span class="line"><span class="comment"># 默认情况下，Eureka Server 也是一个普通的微服务，所以当它还是一个注册中心的时候，他会有两层</span></span><br><span class="line"><span class="attr">身份：1.注册中心；2.普通服务，即当前服务会自己把自己注册到自己上面来</span></span><br><span class="line"><span class="comment"># register-with-eureka 设置为 false，表示当前项目不要注册到注册中心上</span></span><br><span class="line"><span class="meta">eureka.client.register-with-eureka</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 表示是否从 Eureka Server 上获取注册信息</span></span><br><span class="line"><span class="meta">eureka.client.fetch-registry</span>=<span class="string">false</span></span><br></pre></td></tr></tbody></table></figure>

<p>配置完成后，就可以启动项目了。<br>如果在项目启动时，遇到 <code>java.lang.TypeNotPresentException: Type</code><br><code>javax.xml.bind.JAXBContext not present</code> 异常，这是因为 JDK9 以上，移除了 JAXB，这个时候，<br>只需要我们手动引入 JAXB 即可。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.glassfish.jaxb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-runtime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.activation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>项目启动成功后，浏览器输入 <a target="_blank" rel="noopener" href="http://localhost:1111/">http://localhost:1111</a> 就可以查看 Eureka 后台管理页面了：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210430133934.png" alt="image-20210316181013169"></p>
<h4 id="5-2-Eureka-集群"><a href="#5-2-Eureka-集群" class="headerlink" title="5.2 Eureka 集群"></a>5.2 Eureka 集群</h4><p>使用了注册中心之后，所有的服务都要通过服务注册中心来进行信息交换。服务注册中心的稳定性就非<br>常重要了，一旦服务注册中心掉线，会影响到整个系统的稳定性。所以，在实际开发中，Eureka 一般<br>都是以集群的形式出现的。<br>Eureka 集群，实际上就是启动多个 Eureka 实例，多个 Eureka 实例之间，互相注册，互相同步数据，<br>共同组成一个 Eureka 集群。<br>搭建 Eureka 集群，首先我们需要一点准备工作，修改电脑的 hosts 文件<br>（ <code>C:\Windows\System32\drivers\etc\hosts </code>）：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210430133928.png" alt="image-20210316181127248"></p>
<p>在 5.1 小节 demo 的基础上，我们在 resources 目录下，再添加两个配置文件，分别为 applicationa.<br>properties 以及 application-b.properties:</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210430133924.png" alt="image-20210316181137268"></p>
<p><code>application-a.properites</code> 内如如下：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 给当前服务取一个名字</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">eureka</span></span><br><span class="line"><span class="comment"># 设置端口号</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">1111</span></span><br><span class="line"><span class="meta">eureka.instance.hostname</span>=<span class="string">eurekaA</span></span><br><span class="line"><span class="comment"># 默认情况下，Eureka Server 也是一个普通的微服务，所以当它还是一个注册中心的时候，他会有两层</span></span><br><span class="line"><span class="attr">身份：1.注册中心；2.普通服务，即当前服务会自己把自己注册到自己上面来</span></span><br><span class="line"><span class="comment"># register-with-eureka 设置为 false，表示当前项目不要注册到注册中心上</span></span><br><span class="line"><span class="meta">eureka.client.register-with-eureka</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 表示是否从 Eureka Server 上获取注册信息</span></span><br><span class="line"><span class="meta">eureka.client.fetch-registry</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># A 服务要注册到 B 上面</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://eurekaB:1112/eureka</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>application-b.properites</code> 内如如下：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 给当前服务取一个名字</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">eureka</span></span><br><span class="line"><span class="comment"># 设置端口号</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">1112</span></span><br><span class="line"><span class="meta">eureka.instance.hostname</span>=<span class="string">eurekaB</span></span><br><span class="line"><span class="comment"># 默认情况下，Eureka Server 也是一个普通的微服务，所以当它还是一个注册中心的时候，他会有两层</span></span><br><span class="line"><span class="attr">身份：1.注册中心；2.普通服务，即当前服务会自己把自己注册到自己上面来</span></span><br><span class="line"><span class="comment"># register-with-eureka 设置为 false，表示当前项目不要注册到注册中心上</span></span><br><span class="line"><span class="meta">eureka.client.register-with-eureka</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 表示是否从 Eureka Server 上获取注册信息</span></span><br><span class="line"><span class="meta">eureka.client.fetch-registry</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://eurekaA:1111/eureka</span></span><br></pre></td></tr></tbody></table></figure>

<p>配置完成后，对当前项目打包，打成 jar 包：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210430133921.png" alt="image-20210316181514722"></p>
<p>打包完成后，在命令行启动两个 Eureka 实例。两个启动命令分别如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar eureka-0.0.1-SNAPSHOT.jar --spring.profiles.active=a</span><br><span class="line">java -jar eureka-0.0.1-SNAPSHOT.jar --spring.profiles.active=b</span><br></pre></td></tr></tbody></table></figure>

<p>启动成功后，就可以看到，两个服务之间互相注册，共同给组成一个集群。</p>
<h4 id="5-3-Eureka-工作细节"><a href="#5-3-Eureka-工作细节" class="headerlink" title="5.3 Eureka 工作细节"></a>5.3 Eureka 工作细节</h4><p>Eureka 本身可以分为两大部分，Eureka Server 和 Eureka Client</p>
<h5 id="5-3-1-Eureka-Server"><a href="#5-3-1-Eureka-Server" class="headerlink" title="5.3.1 Eureka Server"></a>5.3.1 Eureka Server</h5><p>Eureka Server 主要对外提供了三个功能：</p>
<ol>
<li><p>服务注册，所有的服务都注册到 Eureka Server 上面来</p>
</li>
<li><p>提供注册表，注册表就是所有注册上来服务的一个列表，Eureka Client 在调用服务时，需要获取<br> 这个注册表，一般来说，这个注册表会缓存下来，如果缓存失效，则直接获取最新的注册表</p>
</li>
<li><p>同步状态，Eureka Client 通过注册、心跳等机制，和 Eureka Server 同步当前客户端的状态</p>
</li>
</ol>
<h5 id="5-3-2-Eureka-Client"><a href="#5-3-2-Eureka-Client" class="headerlink" title="5.3.2 Eureka Client"></a>5.3.2 Eureka Client</h5><p>  Eureka Client 主要是用来简化每一个服务和 Eureka Server 之间的交互。Eureka Client 会自动拉取、<br>  更新以及缓存 Eureka Server 中的信息，这样，即使 Eureka Server 所有节点都宕机，Eureka Client<br>  依然能够获取到想要调用服务的地址（但是地址可能不准确）。</p>
<h6 id="5-3-2-1-服务注册"><a href="#5-3-2-1-服务注册" class="headerlink" title="5.3.2.1 服务注册"></a>5.3.2.1 服务注册</h6><p>服务提供者将自己注册到服务注册中心（Eureka Server），需要注意，所谓的服务提供者，只是一个<br>业务上上的划分，本质上他就是一个 Eureka Client。当 Eureka Client 向 Eureka Server 注册时，他需<br>要提供自身的一些元数据信息，例如 IP 地址、端口、名称、运行状态等等。</p>
<h6 id="5-3-2-2-服务续约"><a href="#5-3-2-2-服务续约" class="headerlink" title="5.3.2.2 服务续约"></a>5.3.2.2 服务续约</h6><p>Eureka Client 注册到 Eureka Server 上之后，事情没有结束，刚刚开始而已。注册成功后，默认情况<br>下，Eureka CLient 每隔 30 秒就要向 Eureka Server 发送一条心跳消息，来告诉 Eureka Server 我还在<br>运行。如果 Eureka Server 连续 90 秒都有没有收到 Eureka Client 的续约消息（连续三次没发送），它<br>会认为 Eureka Client 已经掉线了，会将掉线的 Eureka Client 从当前的服务注册列表中剔除。</p>
<p>服务续约，有两个相关的属性（一般不建议修改）：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.lease-renewal-interval-in-seconds=30</span><br><span class="line">eureka.instance.lease-expiration-duration-in-seconds=90</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>eureka.instance.lease-renewal-interval-in-seconds 表示服务的续约时间，默认是 30 秒</li>
<li>eureka.instance.lease-expiration-duration-in-seconds 服务失效时间，默认是 90 秒</li>
</ul>
<h6 id="5-3-2-3-服务下线"><a href="#5-3-2-3-服务下线" class="headerlink" title="5.3.2.3 服务下线"></a>5.3.2.3 服务下线</h6><p>当 Eureka Client 下线时，它会主动发送一条消息，告诉 Eureka Server ，我下线啦。</p>
<h6 id="5-3-2-4-获取注册表信息"><a href="#5-3-2-4-获取注册表信息" class="headerlink" title="5.3.2.4 获取注册表信息"></a>5.3.2.4 获取注册表信息</h6><p>Eureka Client 从 Eureka Server 上获取服务的注册信息，并将其缓存在本地。本地客户端，在需要调<br>用远程服务时，会从该信息中查找远程服务所对应的 IP 地址、端口等信息。Eureka Client 上缓存的服<br>务注册信息会定期更新(30 秒)，如果 Eureka Server 返回的注册表信息与本地缓存的注册表信息不同的<br>话，Eureka Client 会自动处理。<br>这里，也涉及到两个属性，一个是是否允许获取注册表信息：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.client.fetch-registry=true</span><br></pre></td></tr></tbody></table></figure>

<p>Eureka Client 上缓存的服务注册信息，定期更新的时间间隔，默认 30 秒：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.client.registry-fetch-interval-seconds=30</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-4-Eureka-集群原理"><a href="#5-4-Eureka-集群原理" class="headerlink" title="5.4 Eureka 集群原理"></a>5.4 Eureka 集群原理</h4><p>我们来看官方的一张 Eureka 集群架构图：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210430133917.png" alt="image-20210316181753787"></p>
<p>在这个集群架构中，Eureka Server 之间通过 Replicate 进行数据同步，不同的 Eureka Server 之间不<br>区分主从节点，所有节点都是平等的。节点之间，通过置顶 serviceUrl 来互相注册，形成一个集群，进<br>而提高节点的可用性。</p>
<p>在 Eureka Server 集群中，如果有某一个节点宕机，Eureka Client 会自动切换到新的 Eureka Server<br>上。每一个 Eureka Server 节点，都会互相同步数据。Eureka Server 的连接方式，可以是单线的，就<br>是 A–&gt;b–&gt;C ，此时，A 的数据也会和 C 之间互相同步。但是一般不建议这种写法，在我们配置<br>serviceUrl 时，可以指定多个注册地址，即 A 可以即注册到 B 上，也可以同时注册到 C 上。<br>Eureka 分区：</p>
<ol>
<li>region：地理上的不同区域</li>
<li>zone：具体的机房</li>
</ol>
<h2 id="第3章-服务注册与消费"><a href="#第3章-服务注册与消费" class="headerlink" title="第3章  服务注册与消费"></a>第3章  服务注册与消费</h2><h3 id="6-1-服务注册"><a href="#6-1-服务注册" class="headerlink" title="6.1 服务注册"></a>6.1 服务注册</h3><p>服务注册就是把一个微服务注册到 Eureka Server 上，这样，当其他服务需要调用该服务时，只需要从<br>Eureka Server 上查询该服务的信息即可。<br>这里我们创建一个 provider，作为我们的服务提供者，创建项目时，选择 Eureka Client 依赖，这样，<br>当服务创建成功后，简单配置一下，就可以被注册到 Eureka Server 上了：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210430133902.png" alt="image-20210430133849777"></p>
<p>项目创建成功后，我们只需要在 application.properties 中配置一下项目的注册地址即可。注册地址的<br>配置，和 Eureka Server 集群的配置很像。配置如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=provider</span><br><span class="line">server.port=1113</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:1111/eureka</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210430141603.png" alt="image-20210430141559828"></p>
<h3 id="6-2-服务消费"><a href="#6-2-服务消费" class="headerlink" title="6.2 服务消费"></a>6.2 服务消费</h3><p>首先在 provider 中提供一个接口，然后创建一个新的 consumer 项目，消费这个接口。<br>在 provider 中，提供一个 hello 接口，如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>{</span><br><span class="line">    <span class="meta">@GetMapping("/hello")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">Hello</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello lunanboy"</span>;</span><br><span class="line">    }   </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>接下来，创建一个 consumer 项目，consumer 项目中，去消费 provider 提供的接口。consumer 要<br>能够获取到 provider 这个接口的地址，他就需要去 Eureka Server 中查询，如果直接在 consumer 中<br>写死 provider 地址，意味着这两个服务之间的耦合度就太高了，我们要降低耦合度。首先我们来看一<br>个写死的调用。</p>
<p>创建一个 consumer 项目，添加 web 和 eureka client 依赖：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210430143645.png"></p>
<p>创建完成后，我们首先也在 application.properties 中配置一下注册信息：</p>
<p>配置完成后，假设我们现在想在 consumer 中调用 provider 提供的服务，我们可以直接将调用写死，<br>就是说，整个调用过程不会涉及到 Eureka Server。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello1")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello1</span><span class="params">()</span> </span>{</span><br><span class="line">    HttpURLConnection con = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"http://localhost:1113/hello"</span>);</span><br><span class="line">        con = (HttpURLConnection) url.openConnection();</span><br><span class="line">        <span class="keyword">if</span> (con.getResponseCode() == <span class="number">200</span>) {</span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(con.getInputStream()));</span><br><span class="line">            String s = br.readLine();</span><br><span class="line">            br.close();</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (MalformedURLException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这是一段利用了 HttpUrlConnection 来发起的请求，请求中 provider 的地址写死了，意味着 provider<br>和 consumer 高度绑定在一起，这个不符合微服务的思想。</p>
<p>要改造它，我们可以借助 Eureka Client 提供的 DiscoveryClient 工具，利用这个工具，我们可以根据<br>服务名从 Eureka Server 上查询到一个服务的详细信息，改造后的代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//导springcloud的</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping("/hello2")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello2</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// provider在部署时可能是一个集群化的</span></span><br><span class="line">    List&lt;ServiceInstance&gt; list = discoveryClient.getInstances(<span class="string">"provider"</span>);</span><br><span class="line">    <span class="comment">// 现在仅有一项</span></span><br><span class="line">    ServiceInstance serviceInstance = list.get(<span class="number">0</span>);</span><br><span class="line">    String host = serviceInstance.getHost();</span><br><span class="line">    <span class="keyword">int</span> port = serviceInstance.getPort();</span><br><span class="line">    HttpURLConnection conn = <span class="keyword">null</span>;</span><br><span class="line">    StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    sb.append(<span class="string">"http://"</span>)</span><br><span class="line">        .append(host)</span><br><span class="line">        .append(<span class="string">":"</span>)</span><br><span class="line">        .append(port)</span><br><span class="line">        .append(<span class="string">"/hello"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(sb.toString());</span><br><span class="line">        conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">        <span class="keyword">if</span> (conn.getResponseCode() == <span class="number">200</span>) {</span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(conn.getInputStream()));</span><br><span class="line">            String s = br.readLine();</span><br><span class="line">            br.close();</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (MalformedURLException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意，DiscoveryClient 查询到的服务列表是一个集合，因为服务在部署的过程中，可能是集群化部<br>署，集合中的每一项就是一个实例。<br>这里我们可以稍微展示一下集群化部署。<br>首先，修改 provider 中的 hello 接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>{</span><br><span class="line"><span class="meta">@Value("${server.port}")</span></span><br><span class="line">Integer port;</span><br><span class="line"><span class="meta">@GetMapping("/hello")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"hello javaboy:"</span> + port;</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>因为我一会会启动多个 provider 实例，多个 provider 实例的端口不同，为了区分调用时到底是哪一个<br>provider 提供的服务，这里在接口返回值中返回端口。<br>修改完成后，对 provider 进行打包。provider 打包成功之后，我们在命令行启动两个 provider 实例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar provider-0.0.1-SNAPSHOT.jar --server.port=1113</span><br><span class="line">java -jar provider-0.0.1-SNAPSHOT.jar --server.port=1116</span><br></pre></td></tr></tbody></table></figure>

<p>启动完成后，检查 Eureka Server 上，这两个 provider 是否成功注册上来。<br>注册成功后，在 consumer 中再去调用 provider，DiscoveryClient 集合中，获取到的就不是一个实例<br>了，而是两个实例。这里我们可以手动实现一个负载均衡：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="meta">@GetMapping("/hello3")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello3</span><span class="params">()</span> </span>{</span><br><span class="line">List&lt;ServiceInstance&gt; list = discoveryClient.getInstances(<span class="string">"provider"</span>);</span><br><span class="line">ServiceInstance instance = list.get((count++) % list.size());</span><br><span class="line">String host = instance.getHost();</span><br><span class="line"><span class="keyword">int</span> port = instance.getPort();</span><br><span class="line">StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">sb.append(<span class="string">"http://"</span>)</span><br><span class="line">.append(host)</span><br><span class="line">.append(<span class="string">":"</span>)</span><br><span class="line">.append(port)</span><br><span class="line">.append(<span class="string">"/hello"</span>);</span><br><span class="line">HttpURLConnection con = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">URL url = <span class="keyword">new</span> URL(sb.toString());</span><br><span class="line">con = (HttpURLConnection) url.openConnection();</span><br><span class="line"><span class="keyword">if</span> (con.getResponseCode() == <span class="number">200</span>) {</span><br><span class="line">BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span></span><br><span class="line">InputStreamReader(con.getInputStream()));</span><br><span class="line">String s = br.readLine();</span><br><span class="line">br.close();</span><br><span class="line"><span class="keyword">return</span> s;</span><br><span class="line">}</span><br><span class="line">} <span class="keyword">catch</span> (MalformedURLException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">} <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在从集合中，获取数据时，通过一个小小举动，就可以实现线性负载均衡。</p>
<h4 id="6-2-2-升级改造"><a href="#6-2-2-升级改造" class="headerlink" title="6.2.2 升级改造"></a>6.2.2 升级改造</h4><p>从两个方面进行改造：</p>
<ol>
<li><p>Http 调用</p>
</li>
<li><p>负载均衡<br> Http 调用，我们使用 Spring 提供的 RestTemplate 来实现。<br> 首先，在当前服务中，提供一个 RestTemplate 的实例：</p>
</li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerApplication</span> </span>{</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">SpringApplication.run(ConsumerApplication.class, args);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">RestTemplate <span class="title">restTemplateOne</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>  然后，在 Http 调用时，不再使用 HttpUrlConnection，而是直接使用 RestTemplate：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//导springcloud的</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DiscoveryClient discoveryClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/hello2")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello2</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// provider在部署时可能是一个集群化的</span></span><br><span class="line">        List&lt;ServiceInstance&gt; list = discoveryClient.getInstances(<span class="string">"provider"</span>);</span><br><span class="line">        <span class="comment">// 现在仅有一项</span></span><br><span class="line">        ServiceInstance serviceInstance = list.get(<span class="number">0</span>);</span><br><span class="line">        String host = serviceInstance.getHost();</span><br><span class="line">        <span class="keyword">int</span> port = serviceInstance.getPort();</span><br><span class="line">        HttpURLConnection conn = <span class="keyword">null</span>;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        sb.append(<span class="string">"http://"</span>)</span><br><span class="line">                .append(host)</span><br><span class="line">                .append(<span class="string">":"</span>)</span><br><span class="line">                .append(port)</span><br><span class="line">                .append(<span class="string">"/hello"</span>);</span><br><span class="line">        String s = restTemplate.getForObject(sb.toString(), String.class);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>用 RestTemplate ，一行代码就实现了 Http 调用。<br>接下来，使用 Ribbon 来快速实现负载均衡。<br>首先，我们需要给 RestTemplate 实例添加一个 @LoadBalanced 注解，开启负载均衡：<br>此时</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="function">RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>此时的 RestTemplate 就自动具备了负载均衡的功能。<br>此时的调用代码如下</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello3")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello3</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 给定一个模糊的provider 随机出一个 </span></span><br><span class="line">        <span class="comment">// 既有负载均衡又有调用</span></span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://provider/hello"</span>, String.class);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>Java 中关于 Http 请求的工具实际上非常多，自带的 <code>HttpUrlConnection</code>，古老的 <code>HttpClient</code>，后起之<br>秀 OkHttp 等，除了这些之外，还有一个好用的工具–RestTemplate，这是 Spring 中就开始提供的<br>Http 请求工具，不过很多小伙伴们可能是因为 Spring Cloud 才听说它。今天我们就来聊一聊这个<br>RestTemplate。</p>
<h3 id="6-3-RestTemplate"><a href="#6-3-RestTemplate" class="headerlink" title="6.3 RestTemplate"></a>6.3 RestTemplate</h3><p>RestTemplate 是从 Spring3.0 开始支持的一个 Http 请求工具，这个请求工具和 Spring Boot 无关，更<br>和 Spring Cloud 无关。RestTemplate 提供了常见的 REST 请求方法模板，例如 GET、POST、PUT、<br>DELETE 请求以及一些通用的请求执行方法 exchange 和 execute 方法。<br>RestTemplate 本身实现了 RestOperations 接口，而在 RestOperations 接口中，定义了常见的<br>RESTful 操作，这些操作在 RestTemplate 中都得到了很好的实现。</p>
<h4 id="6-3-1-GET"><a href="#6-3-1-GET" class="headerlink" title="6.3.1 GET"></a>6.3.1 GET</h4><p>首先我们在 provider 中定义一个 hello2 接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello2")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">Hello2</span><span class="params">(String name)</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello "</span> + name;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>接下来，我们在 consumer 去访问这个接口，这个接口是一个 GET 请求，所以，访问方式，就是调用<br>RestTemplate 中的 GET 请求。<br>可以看到，在 RestTemplate 中，关于 GET 请求，一共有如下两大类方法：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210430174447.png"></p>
<p>这两大类方法实际上是重载的，唯一不同的，就是返回值类型。<br><code>getForObject</code> 返回的是一个对象，这个对象就是服务端返回的具体值。<code>getForEntity</code> 返回的是一个<br><code>ResponseEntity</code>，这个<code>ResponseEntity</code> 中除了服务端返回的具体数据外，还保留了 Http 响应头的数<br>据。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello4")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello4</span><span class="params">()</span></span>{</span><br><span class="line">        String s1 = restTemplate.getForObject(<span class="string">"http://provider/hello2?name={1}"</span>, String.class,<span class="string">"javaboy"</span>);</span><br><span class="line">        System.out.println(s1);</span><br><span class="line">        ResponseEntity&lt;String&gt; responseEntity = restTemplate.getForEntity(<span class="string">"http://provider/hello2"</span>, String.class);</span><br><span class="line">        <span class="comment">//服务端返回的具体数据</span></span><br><span class="line">        String body = responseEntity.getBody();</span><br><span class="line">        <span class="comment">//状态码</span></span><br><span class="line">        HttpStatus statusCode = responseEntity.getStatusCode();</span><br><span class="line">        System.out.println(<span class="string">"HttpStatus = "</span> + statusCode);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">int</span> statusCodeValue = responseEntity.getStatusCodeValue();</span><br><span class="line">        System.out.println(<span class="string">"statusCodeValue = "</span> + statusCodeValue);</span><br><span class="line">        <span class="comment">//响应头</span></span><br><span class="line">        HttpHeaders headers = responseEntity.getHeaders();</span><br><span class="line">        <span class="comment">//header里有很多种 需要遍历以下</span></span><br><span class="line">        Set&lt;String&gt; keySet  = headers.keySet();</span><br><span class="line">        System.out.println(<span class="string">"--------------header----------------"</span>);</span><br><span class="line">        <span class="keyword">for</span> (String s : keySet) {</span><br><span class="line">            System.out.println(s+<span class="string">":"</span> + headers.get(s));</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>这里大家可以看到，<code>getForObject</code> 直接拿到了服务的返回值，<code>getForEntity</code> 不仅仅拿到服务的返回值，<br>还拿到 http 响应的状态码。然后，启动 Eureka Server、provider 以及 consumer ，访问 consumer<br>中的 hello4 接口，既可以看到请求结果。<br>看清楚两者的区别之后，接下来看下两个各自的重载方法，<code>getForObject</code> 和 <code>getForEntity</code> 分别有三个<br>重载方法，两者的三个重载方法基本都是一致的。所以，这里，我们主要看其中一种。三个重载方法，<br>其实代表了三种不同的传参方式。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello5")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello5</span><span class="params">()</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>{</span><br><span class="line">        String s1 = restTemplate.getForObject(<span class="string">"http://provider/hello2?name={1}"</span>, String.class,<span class="string">"javaboy"</span>);</span><br><span class="line">        System.out.println(s1);</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"name"</span>, <span class="string">"zhangsan"</span>);</span><br><span class="line">        s1 = restTemplate.getForObject(<span class="string">"http://provider/hello2?name={name}"</span>, String.class, map);</span><br><span class="line">        System.out.println(s1);</span><br><span class="line">        String url = <span class="string">"http://provider/hello2?name="</span> + URLEncoder.encode(<span class="string">"张三"</span>, <span class="string">"UTF-8"</span>);</span><br><span class="line">        URI uri = URI.create(url);</span><br><span class="line">        s1 = restTemplate.getForObject(uri, String.class);</span><br><span class="line">        System.out.println(s1);</span><br><span class="line"></span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>这就是我们说的三种不同的传参方式。</p>
<h4 id="6-3-2-POST"><a href="#6-3-2-POST" class="headerlink" title="6.3.2 POST"></a>6.3.2 POST</h4><p>首先在 provider 中提供两个 POST 接口，同时，因为 POST 请求可能需要传递 JSON，所以，这里我们<br>创建一个普通的 Maven 项目作为 commons 模块，然后这个 commons 模块被 provider 和<br>consumer 共同引用，这样我们就可以方便的传递 JSON 了。<br>commons 模块创建成功后，首先在 commons 模块中添加 User 对象，然后该模块分别被 provider 和<br>consumer 引用。<br>然后，我们在 provider 中，提供和两个 POST 接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping("/user1")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">addUser1</span><span class="params">(User user)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> user;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@PostMapping("/user2")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">addUser2</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> user;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里定义了两个 User 添加的方法，两个方法代表了两种不同的传参方式。第一种方法是以 key/value<br>形式来传参，第二种方法是以 JSON 形式来传参。<br>定义完成后，接下来，我们在 consumer 中调用这两个 POST 接口。</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210504132914.png" alt="image-20210504132911613"></p>
<p>可以看到，这里的 post 和前面的 get 非常像，只是多出来了三个方法，就是 postForLocation，另外<br>两个 postForObject 和 postForEntiy 和前面 get 基本一致，所以这里我们主要来看 postForObject，<br>看完之后，我们再来看这个额外的 postForLocation。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello6")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello6</span><span class="params">()</span> </span>{</span><br><span class="line">MultiValueMap&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">map.add(<span class="string">"username"</span>, <span class="string">"javaboy"</span>);</span><br><span class="line">map.add(<span class="string">"password"</span>, <span class="string">"123"</span>);</span><br><span class="line">map.add(<span class="string">"id"</span>, <span class="number">99</span>);</span><br><span class="line">User user = restTemplate.postForObject(<span class="string">"http://provider/user1"</span>, map,</span><br><span class="line">User.class);</span><br><span class="line">System.out.println(user);</span><br><span class="line">user.setId(<span class="number">98</span>);</span><br><span class="line">user = restTemplate.postForObject(<span class="string">"http://provider/user2"</span>, user,</span><br><span class="line">User.class);</span><br><span class="line">System.out.println(user);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>post 参数到底是 key/value 形式还是 json 形式，主要看第二个参数，如果第二个参数是<br>MultiValueMap ，则参数是以 key/value 形式来传递的，如果是一个普通对象，则参数是以 json 形式<br>来传递的。<br>最后再看看一下 postForLocation 。有的时候，当我执行完一个 post 请求之后，立马要进行重定向，<br>一个非常常见的场景就是注册，注册是一个 post 请求，注册完成之后，立马重定向到登录页面去登<br>录。对于这种场景，我们就可以使用 postForLocation。<br>首先我们在 provider 上提供一个用户注册接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegisterController</span> </span>{</span><br><span class="line"><span class="meta">@PostMapping("/register")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">register</span><span class="params">(User user)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"redirect:http://provider/loginPage?username="</span> +</span><br><span class="line">user.getUsername();</span><br><span class="line">}</span><br><span class="line"><span class="meta">@GetMapping("/loginPage")</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">loginPage</span><span class="params">(String username)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"loginPage:"</span> + username;</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意，这里的 post 接口，响应一定是 302，否则 postForLocation 无效。<br>注意，重定向的地址，一定要写成绝对路径，不要写相对路径，否则在 consumer 中调用时会出问题</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello7")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello7</span><span class="params">()</span> </span>{</span><br><span class="line">MultiValueMap&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">map.add(<span class="string">"username"</span>, <span class="string">"javaboy"</span>);</span><br><span class="line">map.add(<span class="string">"password"</span>, <span class="string">"123"</span>);</span><br><span class="line">map.add(<span class="string">"id"</span>, <span class="number">99</span>);</span><br><span class="line">URI uri = restTemplate.postForLocation(<span class="string">"http://provider/register"</span>, map);</span><br><span class="line">String s = restTemplate.getForObject(uri, String.class);</span><br><span class="line">System.out.println(s);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这就是 postForLocation ，调用该方法返回的是一个 Uri，这个 Uri 就是重定向的地址（里边也包含了<br>重定向的参数），拿到 Uri 之后，就可以直接发送新的请求了。</p>
<h4 id="6-3-3-PUT"><a href="#6-3-3-PUT" class="headerlink" title="6.3.3 PUT"></a>6.3.3 PUT</h4><p>PUT 请求比较简单，重载的方法也比较少。<br>我们首先在 provider 中提供一个 PUT 接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping("/user1")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser1</span><span class="params">(User user)</span> </span>{</span><br><span class="line">System.out.println(user);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@PutMapping("/user2")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser2</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>{</span><br><span class="line">System.out.println(user);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意，PUT 接口传参其实和 POST 很像，也接受两种类型的参数，key/value 形式以及 JSON 形式。<br>在 consumer 中，我们来调用该接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello8")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello8</span><span class="params">()</span> </span>{</span><br><span class="line">MultiValueMap&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">map.add(<span class="string">"username"</span>, <span class="string">"javaboy"</span>);</span><br><span class="line">map.add(<span class="string">"password"</span>, <span class="string">"123"</span>);</span><br><span class="line">map.add(<span class="string">"id"</span>, <span class="number">99</span>);</span><br><span class="line">restTemplate.put(<span class="string">"http://provider/user1"</span>, map);</span><br><span class="line">User user = <span class="keyword">new</span> User();</span><br><span class="line">user.setId(<span class="number">98</span>);</span><br><span class="line">user.setUsername(<span class="string">"zhangsan"</span>);</span><br><span class="line">user.setPassword(<span class="string">"456"</span>);</span><br><span class="line">restTemplate.put(<span class="string">"http://provider/user1"</span>, user);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>consumer 中的写法基本和 post 类似，也是两种方式，可以传递两种不同类型的参数。</p>
<h4 id="6-3-4-DELETE"><a href="#6-3-4-DELETE" class="headerlink" title="6.3.4 DELETE"></a>6.3.4 DELETE</h4><p>DELETE 也比较容易，我们有两种方式来传递参数，key/value 形式或者 PathVariable（参数放在路径<br>中），首先我们在 provider 中定义两个 DELETE 方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping("/user1")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser1</span><span class="params">(Integer id)</span> </span>{</span><br><span class="line">System.out.println(id);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@DeleteMapping("/user2/{id}")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser2</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> </span>{</span><br><span class="line">System.out.println(id);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后在 consumer 中调用这两个删除的接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello9")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello9</span><span class="params">()</span> </span>{</span><br><span class="line">restTemplate.delete(<span class="string">"http://provider/user1?id={1}"</span>, <span class="number">99</span>);</span><br><span class="line">restTemplate.delete(<span class="string">"http://provider/user2/{1}"</span>, <span class="number">99</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>delete 中参数的传递，也支持 map，这块实际上和 get 是一样的。</p>
<h3 id="6-4-客户端负载均衡"><a href="#6-4-客户端负载均衡" class="headerlink" title="6.4 客户端负载均衡"></a>6.4 客户端负载均衡</h3><p>客户端负载均衡就是相对服务端负载均衡而言的。<br>服务端负载均衡，就是传统的 Nginx 的方式，用 Nginx 做负载均衡，我们称之为服务端负载均衡：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210505220116.png" alt="image-20210505220114463"></p>
<p>这种负载均衡，我们称之为服务端负载均衡，它的一个特点是，就是调用的客户端并不知道具体是哪一<br>个 Server 提供的服务，它也不关心，反正请求发送给 Nginx，Nginx 再将请求转发给 Tomcat，客户端<br>只需要记着 Nginx 的地址即可。<br>客户端负载均衡则是另外一种情形：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210505220141.png" alt="image-20210505220140462"></p>
<p>客户端负载均衡，就是调用的客户端本身是知道所有 Server 的详细信息的，当需要调用 Server 上的接<br>口的时候，客户端从自身所维护的 Server 列表中，根据提前配置好的负载均衡策略，自己挑选一个<br>Server 来调用，此时，客户端知道它所调用的是哪一个 Server。<br>在 RestTemplate 中，要想使用负载均衡功能，只需要给 RestTemplate 实例上添加一个<br>@LoadBalanced 注解即可，此时，RestTemplate 就会自动具备负载均衡功能，这个负载均衡就是客户<br>端负载均衡。</p>
<h3 id="6-5-负载均衡原理"><a href="#6-5-负载均衡原理" class="headerlink" title="6.5 负载均衡原理"></a>6.5 负载均衡原理</h3><p>在 Spring Cloud 中，实现负载均衡非常容易，只需要添加 @LoadBalanced 注解即可。只要添加了该<br>注解，一个原本普普通通做 Rest 请求的工具 RestTemplate 就会自动具备负载均衡功能，这个是怎么<br>实现的呢？<br>整体上来说，这个功能的实现就是三个核心点：</p>
<ol>
<li>从 Eureka Client 本地缓存的服务注册信息中，选择一个可以调用的服务</li>
<li>根据 1 中所选择的服务，重构请求 URL 地址</li>
<li>将 1、2 步的功能嵌入到 RestTemplate 中</li>
</ol>
<h2 id="第4章-Consul"><a href="#第4章-Consul" class="headerlink" title="第4章 Consul"></a>第4章 Consul</h2><p>在 Spring Cloud 中，大部分组件都有备选方案，例如注册中心，除了常见 Eureka 之外，像<br>zookeeper 我们也可以直接使用在 Spring Cloud 中，还有另外一个比较重要的方案，就是 Consul。<br>Consul 是 HashiCorp 公司推出来的开源产品。主要提供了：服务发现、服务隔离、服务配置等功能。<br>相比于 Eureka 和 zookeeper，Consul 配置更加一站式，因为它内置了很多微服务常见的需求：服务<br>发现与注册、分布式一致性协议实现、健康检查、键值对存储、多数据中心等，我们不再需要借助第三<br>方组件来实现这些功能。</p>
<h3 id="7-1-安装"><a href="#7-1-安装" class="headerlink" title="7.1 安装"></a>7.1 安装</h3><p>不同于 Eureka ，Consul 使用 Go 语言开发，所以，使用 Consul ，我们需要先安装软件。</p>
<h5 id="在-Linux-中，首先执行如下命令下载-Consul："><a href="#在-Linux-中，首先执行如下命令下载-Consul：" class="headerlink" title="在 Linux 中，首先执行如下命令下载 Consul："></a>在 Linux 中，首先执行如下命令下载 Consul：</h5><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://releases.hashicorp.com/consul/1.6.2/consul_1.6.2_linux_amd64.zip</span><br></pre></td></tr></tbody></table></figure>

<p>然后解压下载文件：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip consul_1.6.2_linux_amd64.zip</span><br></pre></td></tr></tbody></table></figure>

<p>解压完成后，我们在当前目录下就可以看到 consul 文件，然后执行如下命令，启动 Consul：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./consul agent -dev -ui -node=consul-dev -client=192.168.91.128</span><br></pre></td></tr></tbody></table></figure>

<p>启动成功后，在物理机中，我们可以直接访问 Consul 的后台管理页面（注意，这个访问要确保 8500<br>端口可用，或者直接关闭防火墙）：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210510133323.png" alt="image-20210510133323296"></p>
<h5 id="在windows下安装"><a href="#在windows下安装" class="headerlink" title="在windows下安装"></a>在windows下安装</h5><p>下载 <a target="_blank" rel="noopener" href="https://www.consul.io/downloads">https://www.consul.io/downloads</a></p>
<p>在安装的位置解压得到 consul.exe 文件（我的解压位置是：E:\consul）</p>
<p><strong>环境变量</strong></p>
<p>增加一条E:\consul</p>
<p><strong>启动</strong></p>
<p>cmd 命令窗口执行：<code>consul agent -dev</code></p>
<p>consul 自带 UI 界面，打开网址：<a target="_blank" rel="noopener" href="http://localhost:8500/">http://localhost:8500</a> ，可以看到当前注册的服务界面</p>
<p>cmd 命令窗口执行:consul.exe agent -server ui -bootstrap -client 0.0.0.0 -data-dir=”E:\consul” -bind X.X.X.X</p>
<p>其中X.X.X.X为服务器ip,即可使用<a target="_blank" rel="noopener" href="http://x.x.x.x:8500/">http://X.X.X.X:8500</a> 访问ui而不是只能使用localhost连接</p>
<p>注意：添加环境变量之后有可能无法启动，需要到consul.exe文件夹下面去执行consul agent -dev</p>
<h3 id="7-2-Consul-使用"><a href="#7-2-Consul-使用" class="headerlink" title="7.2 Consul 使用"></a>7.2 Consul 使用</h3><p>简单看一个注册消费的案例。<br>首先我们来创建一个服务提供者。就是一个普通的 Spring Boot 项目，添加如下依赖：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210510153432.png" alt="image-20210510153432091"></p>
<p>项目创建成功后，添加如下配置：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">consul-provider</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">2000</span></span><br><span class="line"><span class="comment"># Consul 相关配置</span></span><br><span class="line"><span class="meta">spring.cloud.consul.host</span>=<span class="string">192.168.91.128</span></span><br><span class="line"><span class="meta">spring.cloud.consul.port</span>=<span class="string">8500</span></span><br><span class="line"><span class="meta">spring.cloud.consul.discovery.service-name</span>=<span class="string">consul-provider</span></span><br></pre></td></tr></tbody></table></figure>

<p>在项目启动类上开启服务发现的功能：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsulProviderApplication</span> </span>{</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">SpringApplication.run(ConsulProviderApplication.class, args);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>最后添加一个测试接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>{</span><br><span class="line"><span class="meta">@GetMapping("/hello")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>接下来就是启动项目，项目启动成功后，访问 consul 后台管理页面，看到如下信息，表示 consul 已经<br>注册成功了。</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210510153556.png" alt="image-20210510153556764"></p>
<h3 id="7-3-Consul-集群注册"><a href="#7-3-Consul-集群注册" class="headerlink" title="7.3 Consul 集群注册"></a>7.3 Consul 集群注册</h3><p>为了区分集群中的哪一个 provider 提供的服务，我们修改一下 consul 中的接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>{</span><br><span class="line"><span class="meta">@Value("${server.port}")</span></span><br><span class="line">Integer port;</span><br><span class="line"><span class="meta">@GetMapping("/hello")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"hello&gt;&gt;"</span> + port;</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>修改完成后，对项目进行打包。打包成功后，命令行执行如下两行命令，启动两个 provider 实例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar consul-provider-0.0.1-SNAPSHOT.jar --server.port=2000</span><br><span class="line">java -jar consul-provider-0.0.1-SNAPSHOT.jar --server.port=2001</span><br></pre></td></tr></tbody></table></figure>

<p>启动成功后，再去 consul 后台管理页面，就可以看到有两个实例了：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210510153653.png" alt="image-20210510153653710"></p>
<h3 id="7-4-消费"><a href="#7-4-消费" class="headerlink" title="7.4 消费"></a>7.4 消费</h3><p>首先创建一个消费实例，创建方式和 provider 一致。<br>创建成功后，添加如下配置：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">consul-consumer</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">2002</span></span><br><span class="line"><span class="meta">spring.cloud.consul.host</span>=<span class="string">192.168.91.128</span></span><br><span class="line"><span class="meta">spring.cloud.consul.port</span>=<span class="string">8500</span></span><br><span class="line"><span class="meta">spring.cloud.consul.discovery.service-name</span>=<span class="string">consul-consumer</span></span><br></pre></td></tr></tbody></table></figure>

<p>开启服务发现，并添加 RestTemplate：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsulConsumerApplication</span> </span>{</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">SpringApplication.run(ConsulConsumerApplication.class, args);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>最后，提供一个服务调用的方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>{</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">LoadBalancerClient loadBalancerClient;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RestTemplate restTemplate;</span><br><span class="line"><span class="meta">@GetMapping("/hello")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line">ServiceInstance choose = loadBalancerClient.choose(<span class="string">"consul-provider"</span>);</span><br><span class="line">System.out.println(<span class="string">"服务地址："</span> + choose.getUri());</span><br><span class="line">System.out.println(<span class="string">"服务名称:"</span> + choose.getServiceId());</span><br><span class="line">String s = restTemplate.getForObject(choose.getUri() + <span class="string">"/hello"</span>,</span><br><span class="line">String.class);</span><br><span class="line">System.out.println(s);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里，我们通过 loadBalancerClient 实例，可以获取要调用的 ServiceInstance。获取到调用地址之<br>后，再用 RestTemplate 去调用。<br>然后，启动项目，浏览器输入 <a target="_blank" rel="noopener" href="http://localhost:2002/hello">http://localhost:2002/hello</a> ，查看请求结果，这个请求自带负载均衡功<br>能。</p>
<h2 id="第5章-Hystrix"><a href="#第5章-Hystrix" class="headerlink" title="第5章 Hystrix"></a>第5章 Hystrix</h2><ol>
<li>基本介绍</li>
<li>简单使用/容错/服务降级</li>
<li>请求命令</li>
<li>异常处理</li>
<li>请求缓存</li>
<li>请求合并</li>
</ol>
<h3 id="8-1-基本介绍"><a href="#8-1-基本介绍" class="headerlink" title="8.1 基本介绍"></a>8.1 基本介绍</h3><p>Hystrix 叫做断路器/熔断器。微服务系统中，整个系统出错的概率非常高，因为在微服务系统中，涉及<br>到的模块太多了，每一个模块出错，都有可能导致整个服务出，当所有模块都稳定运行时，整个服务才<br>算是稳定运行。<br>我们希望当整个系统中，某一个模块无法正常工作时，能够通过我们提前配置的一些东西，来使得整个<br>系统正常运行，即单个模块出问题，不影响整个系统。</p>
<h3 id="8-2-基本用法"><a href="#8-2-基本用法" class="headerlink" title="8.2 基本用法"></a>8.2 基本用法</h3><p>首先创建一个新的 SpringBoot 模块，然后添加依赖：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210510161703.png" alt="image-20210510161703102"></p>
<p>项目创建成功后，添加如下配置，将 Hystrix 注册到 Eureka 上：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">hystrix</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">3000</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:1111/eureka</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后，在项目启动类上添加如下注解，开启断路器，同时提供一个 RestTemplate 实例：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixApplication</span> </span>{</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">SpringApplication.run(HystrixApplication.class, args);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="function">RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>启动类上的注解，也可以使用 @SpringCloudApplication 代替：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringCloudApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixApplication</span> </span>{</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">SpringApplication.run(HystrixApplication.class, args);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="function">RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这样，Hystrix 的配置就算完成了。<br>接下来提供 Hystrix 的接口。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloService</span> </span>{</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RestTemplate restTemplate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 在这个方法中，我们将发起一个远程调用，去调用 provider 中提供的 /hello 接口</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 但是，这个调用可能会失败。</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 我们在这个方法上添加 <span class="doctag">@HystrixCommand</span> 注解，配置 fallbackMethod 属性，这个属性表示</span></span><br><span class="line"><span class="comment">该方法调用失败时的临时替代方法</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = "error")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://provider/hello"</span>, String.class);</span><br><span class="line">}</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 注意，这个方法名字要和 fallbackMethod 一致</span></span><br><span class="line"><span class="comment">* 方法返回值也要和对应的方法一致</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">error</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>{</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">HelloService helloService;</span><br><span class="line"><span class="meta">@GetMapping("/hello")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> helloService.hello();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="8-3-请求命令"><a href="#8-3-请求命令" class="headerlink" title="8.3 请求命令"></a>8.3 请求命令</h3><p>请求命令就是以继承类的方式来替代前面的注解方式。<br>我们来自定义一个 HelloCommand：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>{</span><br><span class="line">RestTemplate restTemplate;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HelloCommand</span><span class="params">(Setter setter, RestTemplate restTemplate)</span> </span>{</span><br><span class="line"><span class="keyword">super</span>(setter);</span><br><span class="line"><span class="keyword">this</span>.restTemplate = restTemplate;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"><span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://provider/hello"</span>, String.class);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>调用方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello2")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello2</span><span class="params">()</span> </span>{</span><br><span class="line">HelloCommand helloCommand = <span class="keyword">new</span></span><br><span class="line">HelloCommand(HystrixCommand.Setter.withGroupKey(HystrixCommandGroupKey.Factory.a</span><br><span class="line">sKey(<span class="string">"javaboy"</span>)), restTemplate);</span><br><span class="line">String execute = helloCommand.execute();<span class="comment">//直接执行</span></span><br><span class="line">System.out.println(execute);</span><br><span class="line">HelloCommand helloCommand2 = <span class="keyword">new</span></span><br><span class="line">HelloCommand(HystrixCommand.Setter.withGroupKey(HystrixCommandGroupKey.Factory.a</span><br><span class="line">sKey(<span class="string">"javaboy"</span>)), restTemplate);</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">Future&lt;String&gt; queue = helloCommand2.queue();</span><br><span class="line">String s = queue.get();</span><br><span class="line">System.out.println(s);<span class="comment">//先入队，后执行</span></span><br><span class="line">} <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">} <span class="keyword">catch</span> (ExecutionException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意：</p>
<ol>
<li>一个实例只能执行一次</li>
<li>可以直接执行，也可以先入队，后执行<br>号外：通过注解实现请求异步调用<br>首先，定义如下方法，返回 Future<string> ：</string></li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = "error")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Future&lt;String&gt; <span class="title">hello2</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;String&gt;() {</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">invoke</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://provider/hello"</span>,</span><br><span class="line">String.class);</span><br><span class="line">}</span><br><span class="line">};</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后，调用该方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello3")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello3</span><span class="params">()</span> </span>{</span><br><span class="line">Future&lt;String&gt; hello2 = helloService.hello2();</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">String s = hello2.get();</span><br><span class="line">System.out.println(s);</span><br><span class="line">} <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">} <span class="keyword">catch</span> (ExecutionException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>通过继承的方式使用 Hystrix，如何实现服务容错/降级？重写继承类的 getFallback 方法即可：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>{</span><br><span class="line">RestTemplate restTemplate;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HelloCommand</span><span class="params">(Setter setter, RestTemplate restTemplate)</span> </span>{</span><br><span class="line"><span class="keyword">super</span>(setter);</span><br><span class="line"><span class="keyword">this</span>.restTemplate = restTemplate;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"><span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://provider/hello"</span>, String.class);</span><br><span class="line">}</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 这个方法就是请求失败的回调</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"error-extends"</span>;</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="8-4-异常处理"><a href="#8-4-异常处理" class="headerlink" title="8.4 异常处理"></a>8.4 异常处理</h3><p>就是当发起服务调用时，如果不是 provider 的原因导致请求调用失败，而是 consumer 中本身代码有<br>问题导致的请求失败，即 consumer 中抛出了异常，这个时候，也会自动进行服务降级，只不过这个时<br>候降级，我们还需要知道到底是哪里出异常了。<br>如下示例代码，如果 hello 方法中，执行时抛出异常，那么一样也会进行服务降级，进入到 error 方法<br>中，在 error 方法中，我们可以获取到异常的详细信息：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloService</span> </span>{</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RestTemplate restTemplate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 在这个方法中，我们将发起一个远程调用，去调用 provider 中提供的 /hello 接口</span></span><br><span class="line"><span class="comment">* &lt;p&gt;</span></span><br><span class="line"><span class="comment">* 但是，这个调用可能会失败。</span></span><br><span class="line"><span class="comment">* &lt;p&gt;</span></span><br><span class="line"><span class="comment">* 我们在这个方法上添加 <span class="doctag">@HystrixCommand</span> 注解，配置 fallbackMethod 属性，这个属性表示</span></span><br><span class="line"><span class="comment">该方法调用失败时的临时替代方法</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = "error")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://provider/hello"</span>, String.class);</span><br><span class="line">}</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 注意，这个方法名字要和 fallbackMethod 一致</span></span><br><span class="line"><span class="comment">* 方法返回值也要和对应的方法一致</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">error</span><span class="params">(Throwable t)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"error:"</span> + t.getMessage();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这是注解的方式。也可以通过继承的方式：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>{</span><br><span class="line">RestTemplate restTemplate;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HelloCommand</span><span class="params">(Setter setter, RestTemplate restTemplate)</span> </span>{</span><br><span class="line"><span class="keyword">super</span>(setter);</span><br><span class="line"><span class="keyword">this</span>.restTemplate = restTemplate;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://provider/hello"</span>, String.class);</span><br><span class="line">}</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 这个方法就是请求失败的回调</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"error-extends:"</span>+getExecutionException().getMessage();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果是通过继承的方式来做 Hystrix，在 getFallback 方法中，我们可以通过 getExecutionException 方<br>法来获取执行的异常信息。<br>另一种可能性（作为了解）。如果抛异常了，我们希望异常直接抛出，不要服务降级，那么只需要配置<br>忽略某一个异常即可：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = "error",ignoreExceptions =</span></span><br><span class="line"><span class="meta">ArithmeticException.class)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://provider/hello"</span>, String.class);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个配置表示当 hello 方法抛出 ArithmeticException 异常时，<strong>不要进行服务降级，直接将错误抛出。</strong></p>
<h3 id="8-5-请求缓存"><a href="#8-5-请求缓存" class="headerlink" title="8.5 请求缓存"></a>8.5 请求缓存</h3><p>请求缓存就是在 consumer 中调用同一个接口，如果参数相同，则可以使用之前缓存下来的数据。<br>首先修改 provider 中的 hello2 接口，一会用来检测缓存配置是否生效：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello2")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello2</span><span class="params">(String name)</span> </span>{</span><br><span class="line">System.out.println(<span class="keyword">new</span> Date() + <span class="string">"&gt;&gt;&gt;"</span> + name);</span><br><span class="line"><span class="keyword">return</span> <span class="string">"hello "</span> + name;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后，在 hystrix 的请求方法中，添加如下注解：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = "error2")</span></span><br><span class="line">    <span class="meta">@CacheResult</span><span class="comment">//这个注解表示该方法的请求结果会被缓存起来，默认情况下，缓存的 key 就是方法的参</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello3</span><span class="params">(String name)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://provider/hello2?name={1}"</span>, String.class, name);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>这个配置完成后，缓存并不会生效，一般来说，我们使用缓存，都有一个缓存生命周期这样一个概念。<br>这里也一样，我们需要初始化 HystrixRequestContext，初始化完成后，缓存开始生效，<br>HystrixRequestContext close 之后，缓存失效。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello4")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello4</span><span class="params">()</span> </span>{</span><br><span class="line">HystrixRequestContext ctx = HystrixRequestContext.initializeContext();</span><br><span class="line">String javaboy = helloService.hello3(<span class="string">"javaboy"</span>);</span><br><span class="line">javaboy = helloService.hello3(<span class="string">"javaboy"</span>);</span><br><span class="line">ctx.close();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>想在这个地方执行 不能忘记编写error2 method</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">error2</span><span class="params">(String name)</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error:lunanboy"</span>;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>在 ctx close 之前，缓存是有效的，close 之后，缓存就失效了。也就是说，访问一次 hello4 接口，<br>provider 只会被调用一次（第二次使用的缓存），如果再次调用 hello4 接口，之前缓存的数据是失效<br>的。<br>默认情况下，缓存的 key 就是所调用方法的参数，如果参数有多个，就是多个参数组合起来作为缓存的<br>key。<br>例如如下方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = "error2")</span></span><br><span class="line"><span class="meta">@CacheResult</span><span class="comment">//这个注解表示该方法的请求结果会被缓存起来，默认情况下，缓存的 key 就是方法的参</span></span><br><span class="line">数，缓存的 value 就是方法的返回值。</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello3</span><span class="params">(String name,Integer age)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://provider/hello2?name={1}"</span>,</span><br><span class="line">String.class, name);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>此时缓存的 key 就是 name+age，但是，如果有多个参数，但是又只想使用其中一个作为缓存的 key，<br>那么我们可以通过 @CacheKey 注解来解决。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = "error2")</span></span><br><span class="line"><span class="meta">@CacheResult</span><span class="comment">//这个注解表示该方法的请求结果会被缓存起来，默认情况下，缓存的 key 就是方法的参</span></span><br><span class="line">数，缓存的 value 就是方法的返回值。</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello3</span><span class="params">(<span class="meta">@CacheKey</span> String name, Integer age)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://provider/hello2?name={1}"</span>,</span><br><span class="line">String.class, name);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>上面这个配置，虽然有两个参数，但是缓存时以 name 为准。也就是说，两次请求中，只要 name 一<br>样，即使 age 不一样，第二次请求也可以使用第一次请求缓存的结果。<br>另外还有一个注解叫做 @CacheRemove()。在做数据缓存时，如果有一个数据删除的方法，我们一般<br>除了删除数据库中的数据，还希望能够顺带删除缓存中的数据，这个时候 @CacheRemove() 就派上用<br>场了。<br>@CacheRemove() 在使用时，必须指定 commandKey 属性，commandKey 其实就是缓存方法的名<br>字，指定了 commandKey，@CacheRemove 才能找到数据缓存在哪里了，进而才能成功删除掉数<br>据。<br>例如如下方法定义缓存与删除缓存：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = "error2")</span></span><br><span class="line"><span class="meta">@CacheResult</span><span class="comment">//这个注解表示该方法的请求结果会被缓存起来，默认情况下，缓存的 key 就是方法的参数，缓存的 value 就是方法的返回值。</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello3</span><span class="params">(String name)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://provider/hello2?name={1}"</span>,</span><br><span class="line">String.class, name);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@HystrixCommand</span></span><br><span class="line"><span class="meta">@CacheRemove(commandKey = "hello3")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">deleteUserByName</span><span class="params">(String name)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>再去调用：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello4")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello4</span><span class="params">()</span> </span>{</span><br><span class="line">HystrixRequestContext ctx = HystrixRequestContext.initializeContext();</span><br><span class="line"><span class="comment">//第一请求完，数据已经缓存下来了</span></span><br><span class="line">String javaboy = helloService.hello3(<span class="string">"javaboy"</span>);</span><br><span class="line"><span class="comment">//删除数据，同时缓存中的数据也会被删除</span></span><br><span class="line">helloService.deleteUserByName(<span class="string">"javaboy"</span>);</span><br><span class="line"><span class="comment">//第二次请求时，虽然参数还是 javaboy，但是缓存数据已经没了，所以这一次，provider 还是会收到请求</span></span><br><span class="line">javaboy = helloService.hello3(<span class="string">"javaboy"</span>);</span><br><span class="line">ctx.close();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果是继承的方式使用 Hystrix ，只需要重写 getCacheKey 方法即可：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">String</span>&gt; </span>{</span><br><span class="line">RestTemplate restTemplate;</span><br><span class="line">String name;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HelloCommand</span><span class="params">(Setter setter, RestTemplate restTemplate,String name)</span> </span>{</span><br><span class="line"><span class="keyword">super</span>(setter);</span><br><span class="line"><span class="keyword">this</span>.name = name;</span><br><span class="line"><span class="keyword">this</span>.restTemplate = restTemplate;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"><span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://provider/hello2?name={1}"</span>,</span><br><span class="line">String.class, name);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getCacheKey</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> name;</span><br><span class="line">}</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 这个方法就是请求失败的回调</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getFallback</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"error-extends:"</span>+getExecutionException().getMessage();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>调用时候，一定记得初始化 HystrixRequestContext:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello2")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello2</span><span class="params">()</span> </span>{</span><br><span class="line">HystrixRequestContext ctx = HystrixRequestContext.initializeContext();</span><br><span class="line">HelloCommand helloCommand = <span class="keyword">new</span></span><br><span class="line">HelloCommand(HystrixCommand.Setter.withGroupKey(HystrixCommandGroupKey.Factory.a</span><br><span class="line">sKey(<span class="string">"javaboy"</span>)), restTemplate,<span class="string">"javaboy"</span>);</span><br><span class="line">String execute = helloCommand.execute();<span class="comment">//直接执行</span></span><br><span class="line">System.out.println(execute);</span><br><span class="line">HelloCommand helloCommand2 = <span class="keyword">new</span></span><br><span class="line">HelloCommand(HystrixCommand.Setter.withGroupKey(HystrixCommandGroupKey.Factory.a</span><br><span class="line">sKey(<span class="string">"javaboy"</span>)), restTemplate,<span class="string">"javaboy"</span>);</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">Future&lt;String&gt; queue = helloCommand2.queue();</span><br><span class="line">String s = queue.get();</span><br><span class="line">System.out.println(s);<span class="comment">//先入队，后执行</span></span><br><span class="line">} <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">} <span class="keyword">catch</span> (ExecutionException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">}</span><br><span class="line">ctx.close();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="8-6-请求合并"><a href="#8-6-请求合并" class="headerlink" title="8.6 请求合并"></a>8.6 请求合并</h3><p>如果 consumer 中，频繁的调用 provider 中的同一个接口，在调用时，只是参数不一样，那么这样情<br>况下，我们就可以将多个请求合并成一个，这样可以有效提高请求发送的效率。<br>首先我们在 provider 中提供一个请求合并的接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>{</span><br><span class="line"><span class="meta">@GetMapping("/user/{ids}")</span><span class="comment">//假设 consumer 传过来的多个 id 的格式是 1,2,3,4....</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getUserByIds</span><span class="params">(<span class="meta">@PathVariable</span> String ids)</span> </span>{</span><br><span class="line">String[] split = ids.split(<span class="string">","</span>);</span><br><span class="line">List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (String s : split) {</span><br><span class="line">User u = <span class="keyword">new</span> User();</span><br><span class="line">u.setId(Integer.parseInt(s));</span><br><span class="line">users.add(u);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> users;</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个接口既可以处理合并之后的请求，也可以处理单个请求（单个请求的话，List 集合中就只有一项数<br>据。）<br>然后，在 Hystrix 中，定义 UserService：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>{</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RestTemplate restTemplate;</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getUsersByIds</span><span class="params">(List&lt;Integer&gt; ids)</span> </span>{</span><br><span class="line">User[] users = restTemplate.getForObject(<span class="string">"http://provider/user/{1}"</span>,</span><br><span class="line">User[].class, StringUtils.join(ids, <span class="string">","</span>));</span><br><span class="line"><span class="keyword">return</span> Arrays.asList(users);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>接下来定义 UserBatchCommand ，相当于我们之前的 HelloCommand：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserBatchCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">List</span>&lt;<span class="title">User</span>&gt;&gt; </span>{</span><br><span class="line"><span class="keyword">private</span> List&lt;Integer&gt; ids;</span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UserBatchCommand</span><span class="params">(List&lt;Integer&gt; ids, UserService userService)</span> </span>{</span><br><span class="line"><span class="keyword">super</span>(HystrixCommand.Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"</span></span><br><span class="line"><span class="string">batchCmd"</span>)).andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"batchKey"</span>)));</span><br><span class="line"><span class="keyword">this</span>.ids = ids;</span><br><span class="line"><span class="keyword">this</span>.userService = userService;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;User&gt; <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"><span class="keyword">return</span> userService.getUsersByIds(ids);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>最后，定义最最关键的请求合并方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserCollapseCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCollapser</span>&lt;<span class="title">List</span>&lt;<span class="title">User</span>&gt;, <span class="title">User</span>, <span class="title">Integer</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserCollapseCommand</span><span class="params">(UserService userService, Integer id)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(HystrixCollapser.Setter.withCollapserKey(HystrixCollapserKey.Factory.asKey(<span class="string">"UserCollapseCommand"</span>)).andCollapserPropertiesDefaults(HystrixCollapserProperties.Setter().withTimerDelayInMilliseconds(<span class="number">200</span>)));</span><br><span class="line">        <span class="keyword">this</span>.userService = userService;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求参数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getRequestArgument</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求合并的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> collection</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> HystrixCommand&lt;List&lt;User&gt;&gt; createCommand(Collection&lt;CollapsedRequest&lt;User, Integer&gt;&gt; collection) {</span><br><span class="line">        List&lt;Integer&gt; ids = <span class="keyword">new</span> ArrayList&lt;&gt;(collection.size());</span><br><span class="line">        <span class="keyword">for</span> (CollapsedRequest&lt;User, Integer&gt; userIntegerCollapsedRequest : collection) {</span><br><span class="line">            ids.add(userIntegerCollapsedRequest.getArgument());</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserBatchCommand(ids, userService);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求结果转发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> users</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> collection</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">mapResponseToRequests</span><span class="params">(List&lt;User&gt; users, Collection&lt;CollapsedRequest&lt;User, Integer&gt;&gt; collection)</span> </span>{</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (CollapsedRequest&lt;User, Integer&gt; userIntegerCollapsedRequest : collection) {</span><br><span class="line">            userIntegerCollapsedRequest.setResponse(users.get(count++));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>最后就是测试调用：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello5")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello5</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>{</span><br><span class="line">        HystrixRequestContext ctx = HystrixRequestContext.initializeContext();</span><br><span class="line">        UserCollapseCommand cmd1 = <span class="keyword">new</span> UserCollapseCommand(userService, <span class="number">99</span>);</span><br><span class="line">        UserCollapseCommand cmd2 = <span class="keyword">new</span> UserCollapseCommand(userService, <span class="number">98</span>);</span><br><span class="line">        UserCollapseCommand cmd3 = <span class="keyword">new</span> UserCollapseCommand(userService, <span class="number">97</span>);</span><br><span class="line">        Future&lt;User&gt; q1 = cmd1.queue();</span><br><span class="line">        Future&lt;User&gt; q2 = cmd2.queue();</span><br><span class="line">        Future&lt;User&gt; q3 = cmd3.queue();</span><br><span class="line">        User u1 = q1.get();</span><br><span class="line">        User u2 = q2.get();</span><br><span class="line">        User u3 = q3.get();</span><br><span class="line">        System.out.println(u1);</span><br><span class="line">        System.out.println(u2);</span><br><span class="line">        System.out.println(u3);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        UserCollapseCommand cmd4 = <span class="keyword">new</span> UserCollapseCommand(userService, <span class="number">96</span>);</span><br><span class="line">        Future&lt;User&gt; q4 = cmd4.queue();</span><br><span class="line">        User u4 = q4.get();</span><br><span class="line">        System.out.println(u4);</span><br><span class="line">        ctx.close();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>通过注解实现请求合并</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>{</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCollapser(batchMethod = "getUsersByIds", collapserProperties =</span></span><br><span class="line"><span class="meta">            {@HystrixProperty(name = "timerDelayInMilliseconds", value = "200")})</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Future&lt;User&gt; <span class="title">getUserById</span><span class="params">(Integer id)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getUsersByIds</span><span class="params">(List&lt;Integer&gt; ids)</span> </span>{</span><br><span class="line">        User[] users = restTemplate.getForObject(<span class="string">"http://provider/user/{1}"</span>,</span><br><span class="line">                User[].class, StringUtils.join(ids, <span class="string">","</span>));</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(users);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里的核心是 @HystrixCollapser 注解。在这个注解中，指定批处理的方法即可。<br>测试代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello6")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello6</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>{</span><br><span class="line">    HystrixRequestContext ctx = HystrixRequestContext.initializeContext();</span><br><span class="line">    Future&lt;User&gt; q1 = userService.getUserById(<span class="number">99</span>);</span><br><span class="line">    Future&lt;User&gt; q2 = userService.getUserById(<span class="number">98</span>);</span><br><span class="line">    Future&lt;User&gt; q3 = userService.getUserById(<span class="number">97</span>);</span><br><span class="line">    User u1 = q1.get();</span><br><span class="line">    User u2 = q2.get();</span><br><span class="line">    User u3 = q3.get();</span><br><span class="line">    System.out.println(u1);</span><br><span class="line">    System.out.println(u2);</span><br><span class="line">    System.out.println(u3);</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    Future&lt;User&gt; q4 = userService.getUserById(<span class="number">96</span>);</span><br><span class="line">    User u4 = q4.get();</span><br><span class="line">    System.out.println(u4);</span><br><span class="line">    ctx.close();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="第6章-OpenFeign"><a href="#第6章-OpenFeign" class="headerlink" title="第6章 OpenFeign"></a>第6章 OpenFeign</h2><h3 id="9-1-OpenFeign"><a href="#9-1-OpenFeign" class="headerlink" title="9.1 OpenFeign"></a>9.1 OpenFeign</h3><p>前面无论是基本调用，还是 Hystrix，我们实际上都是通过手动调用 RestTemplate 来实现远程调用<br>的。使用 RestTemplate 存在一个问题：繁琐，每一个请求，参数不同，请求地址不同，返回数据类型<br>不同，其他都是一样的，所以我们希望能够对请求进行简化。<br>我们希望对请求进行简化，简化方案就是 OpenFeign。<br>一开始这个组件不叫这个名字，一开始就叫 Feign，Netflix Feign，但是 Netflix 中的组件现在已经停止<br>开源工作，OpenFeign 是 Spring Cloud 团队在 Netflix Feign 的基础上开发出来的声明式服务调用组<br>件。关于 OpenFeign 组件的 Issue：<a target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign/issues/373">https://github.com/OpenFeign/feign/issues/373</a></p>
<h4 id="9-1-1-HelloWorld"><a href="#9-1-1-HelloWorld" class="headerlink" title="9.1.1 HelloWorld"></a>9.1.1 HelloWorld</h4><p>继续使用之前的 Provider。<br>新建一个 Spring Boot 模块，创建时，选择 OpenFeign 依赖，如下：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210511165734.png" alt="image-20210511165734741"></p>
<p>项目创建成功后，在 application.properties 中进行配置，使项目注册到 Eureka 上：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">openfeign</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">4000</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:1111/eureka</span></span><br></pre></td></tr></tbody></table></figure>

<p>接下来在启动类上添加注解，开启 Feign 的支持：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenfeignApplication</span> </span>{</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">SpringApplication.run(OpenfeignApplication.class, args);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>接下来，定义 HelloService 接口，去使用 OpenFeign：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient("provider")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> </span>{</span><br><span class="line">    <span class="comment">//这里的方法名无所谓，随意取</span></span><br><span class="line">    <span class="meta">@GetMapping("/hello")</span></span><br><span class="line">    <span class="function">String <span class="title">hello</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>最后调用 HelloController 中，调用 HelloService 进行测试：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>{</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">HelloService helloService;</span><br><span class="line"><span class="meta">@GetMapping("/hello")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> helloService.hello();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>接下来，启动 OpenFeign 项目，进行测试。</p>
<h3 id="9-2-参数传递"><a href="#9-2-参数传递" class="headerlink" title="9.2 参数传递"></a>9.2 参数传递</h3><p>和普通参数传递的区别：</p>
<ol>
<li>参数一定要绑定参数名。</li>
<li>如果通过 header 来传递参数，一定记得中文要转码。<br>测试的服务端接口，继续使用 provider 提供的接口。<br>这里，我们主要在 openfeign 中添加调用接口即可：</li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient("provider")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> </span>{</span><br><span class="line"><span class="meta">@GetMapping("/hello")</span></span><br><span class="line"><span class="function">String <span class="title">hello</span><span class="params">()</span></span>;<span class="comment">//这里的方法名无所谓，随意取</span></span><br><span class="line"><span class="meta">@GetMapping("/hello2")</span></span><br><span class="line"><span class="function">String <span class="title">hello2</span><span class="params">(<span class="meta">@RequestParam("name")</span> String name)</span></span>;</span><br><span class="line"><span class="meta">@PostMapping("/user2")</span></span><br><span class="line"><span class="function">User <span class="title">addUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>;</span><br><span class="line"><span class="meta">@DeleteMapping("/user2/{id}")</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deleteUserById</span><span class="params">(<span class="meta">@PathVariable("id")</span> Integer id)</span></span>;</span><br><span class="line"><span class="meta">@GetMapping("/user3")</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getUserByName</span><span class="params">(<span class="meta">@RequestHeader("name")</span> String name)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意，凡是 key/value 形式的参数，一定要标记参数的名称。</p>
<p>HelloController 中调用 HelloService：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/hello")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>{</span><br><span class="line">String s = helloService.hello2(<span class="string">"江南一点雨"</span>);</span><br><span class="line">System.out.println(s);</span><br><span class="line">User user = <span class="keyword">new</span> User();</span><br><span class="line">user.setId(<span class="number">1</span>);</span><br><span class="line">user.setUsername(<span class="string">"javaboy"</span>);</span><br><span class="line">user.setPassword(<span class="string">"123"</span>);</span><br><span class="line">User u = helloService.addUser(user);</span><br><span class="line">System.out.println(u);</span><br><span class="line">helloService.deleteUserById(<span class="number">1</span>);</span><br><span class="line">helloService.getUserByName(URLEncoder.encode(<span class="string">"江南一点雨"</span>, <span class="string">"UTF-8"</span>));</span><br><span class="line"><span class="keyword">return</span> helloService.hello();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意：<br><strong>放在 header 中的中文参数，一定要编码之后传递。</strong></p>
<h3 id="9-3-继承特性"><a href="#9-3-继承特性" class="headerlink" title="9.3 继承特性"></a>9.3 继承特性</h3><p>将 provider 和 openfeign 中公共的部分提取出来，一起使用。<br>我们新建一个 Module，叫做 hello-api，注意，由于这个模块要被其他模块所依赖，所以这个模块是一<br>个 Maven 项目，但是由于这个模块要用到 SpringMVC 的东西，因此在创建成功后，给这个模块添加一<br>个 web 依赖，导入 SpringMVC 需要的一套东西。<br>项目创建成功后，首先添加依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javaboy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后定义公共接口，就是provider 和 openfeign 中公共的部分：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUserService</span> </span>{</span><br><span class="line"><span class="meta">@GetMapping("/hello")</span></span><br><span class="line"><span class="function">String <span class="title">hello</span><span class="params">()</span></span>;<span class="comment">//这里的方法名无所谓，随意取</span></span><br><span class="line"><span class="meta">@GetMapping("/hello2")</span></span><br><span class="line"><span class="function">String <span class="title">hello2</span><span class="params">(<span class="meta">@RequestParam("name")</span> String name)</span></span>;</span><br><span class="line"><span class="meta">@PostMapping("/user2")</span></span><br><span class="line"><span class="function">User <span class="title">addUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>;</span><br><span class="line"><span class="meta">@DeleteMapping("/user2/{id}")</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deleteUserById</span><span class="params">(<span class="meta">@PathVariable("id")</span> Integer id)</span></span>;</span><br><span class="line"><span class="meta">@GetMapping("/user3")</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getUserByName</span><span class="params">(<span class="meta">@RequestHeader("name")</span> String name)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>定义完成后，接下来，在 provider 和 openfeign 中，分别引用该模块：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javaboy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hello-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>添加成功之后，在 provider 中实现该接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> <span class="keyword">implements</span> <span class="title">IUserService</span> </span>{</span><br><span class="line"><span class="meta">@Value("${server.port}")</span></span><br><span class="line">Integer port;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"hello javaboy:"</span> + port;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello2</span><span class="params">(String name)</span> </span>{</span><br><span class="line">System.out.println(<span class="keyword">new</span> Date() + <span class="string">"&gt;&gt;&gt;"</span> + name);</span><br><span class="line"><span class="keyword">return</span> <span class="string">"hello "</span> + name;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@PostMapping("/user1")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">addUser1</span><span class="params">(User user)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> user;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">addUser2</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> user;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@PutMapping("/user1")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser1</span><span class="params">(User user)</span> </span>{</span><br><span class="line">System.out.println(user);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@PutMapping("/user2")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser2</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>{</span><br><span class="line">System.out.println(user);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@DeleteMapping("/user1")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser1</span><span class="params">(Integer id)</span> </span>{</span><br><span class="line">System.out.println(id);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser2</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> </span>{</span><br><span class="line">System.out.println(id);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getUserByName</span><span class="params">(<span class="meta">@RequestHeader</span> String name)</span> <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">UnsupportedEncodingException </span>{</span><br><span class="line">System.out.println(URLDecoder.decode(name, <span class="string">"UTF-8"</span>));</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在 openfeign 中，定义接口继承自公共接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient("provider")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> <span class="keyword">extends</span> <span class="title">IUserService</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>接下来，测试代码不变。<br>关于继承特性：</p>
<ol>
<li>使用继承特性，代码简洁明了不易出错。服务端和消费端的代码统一，一改俱改，不易出错。这是<br>优点也是缺点，这样会提高服务端和消费端的耦合度。</li>
<li>9.2 中所讲的参数传递，在使用了继承之后，依然不变，参数该怎么传还是怎么传。</li>
</ol>
<h3 id="9-4-日志"><a href="#9-4-日志" class="headerlink" title="9.4 日志"></a>9.4 日志</h3><p>OpenFeign 中，我们可以通过配置日志，来查看整个请求的调用过程。日志级别一共分为四种：</p>
<ol>
<li>NONE：不开启日志，默认就是这个</li>
<li>BASIC：记录请求方法、URL、响应状态码、执行时间</li>
<li>HEADERS：在 BASIC 的基础上，加载请求/响应头</li>
<li>FULL：在 HEADERS 基础上，再增加 body 以及请求元数据。<br>四种级别，可以通过 Bean 来配置：</li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenfeignApplication</span> </span>{</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">SpringApplication.run(OpenfeignApplication.class, args);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line">Logger.<span class="function">Level <span class="title">loggerLevel</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>最后，在 application.properties 中开启日志级别：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logging.level.org.javaboy.openfeign.HelloService=debug</span><br></pre></td></tr></tbody></table></figure>

<p>重启 OpenFeign，进行测试。</p>
<h3 id="9-5-数据压缩"><a href="#9-5-数据压缩" class="headerlink" title="9.5 数据压缩"></a>9.5 数据压缩</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启请求的数据压缩</span></span><br><span class="line"><span class="meta">feign.compression.request.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 开启响应的数据压缩</span></span><br><span class="line"><span class="meta">feign.compression.response.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 压缩的数据类型</span></span><br><span class="line"><span class="meta">feign.compression.request.mime-types</span>=<span class="string">text/html,application/json</span></span><br><span class="line"><span class="comment"># 压缩的数据下限，2048 表示当要传输的数据大于 2048 时，才会进行数据压缩</span></span><br><span class="line"><span class="meta">feign.compression.request.min-request-size</span>=<span class="string">2048</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="9-6-Hystrix"><a href="#9-6-Hystrix" class="headerlink" title="9.6 +Hystrix"></a>9.6 +Hystrix</h3><p>Hystrix 中的容错、服务降级等功能，在 OpenFeign 中一样要使用。<br>首先定义服务降级的方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequestMapping("/javaboy")</span><span class="comment">//防止请求地址重复</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServiceFallback</span> <span class="keyword">implements</span> <span class="title">HelloService</span> </span>{</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello2</span><span class="params">(String name)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"error2"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">addUser2</span><span class="params">(User user)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser2</span><span class="params">(Integer id)</span> </span>{</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getUserByName</span><span class="params">(String name)</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>{</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后，在 HelloService 中配置这个服务降级类：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = "provider",fallback = HelloServiceFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> <span class="keyword">extends</span> <span class="title">IUserService</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>最后，在 application.properties 中开启 Hystrix。</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">feign.hystrix.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></tbody></table></figure>

<p>也可以通过自定义 FallbackFactory 来实现请求降级：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServiceFallbackFactory</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class"><span class="title">FallbackFactory</span>&lt;<span class="title">HelloService</span>&gt; </span>{</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HelloService <span class="title">create</span><span class="params">(Throwable throwable)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> HelloService() {</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"error---"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello2</span><span class="params">(String name)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"error2---"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">addUser2</span><span class="params">(User user)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser2</span><span class="params">(Integer id)</span> </span>{</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getUserByName</span><span class="params">(String name)</span> <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">UnsupportedEncodingException </span>{</span><br><span class="line">}</span><br><span class="line">};</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>HelloService 中进行配置：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = "provider",fallbackFactory =</span></span><br><span class="line"><span class="meta">HelloServiceFallbackFactory.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> <span class="keyword">extends</span> <span class="title">IUserService</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="第7章-Resilience4j"><a href="#第7章-Resilience4j" class="headerlink" title="第7章 Resilience4j"></a>第7章 Resilience4j</h2><h3 id="10-1-Resilience4j-简介"><a href="#10-1-Resilience4j-简介" class="headerlink" title="10.1 Resilience4j 简介"></a>10.1 Resilience4j 简介</h3><p>Resilience4j 是 Spring Cloud Greenwich 版推荐的容错解决方案，相比 Hystrix，Resilience4j 专为<br>Java8 以及函数式编程而设计。<br>Resilience4j 主要提供了如下功能：</p>
<ol>
<li><p>断路器</p>
</li>
<li><p>限流</p>
</li>
<li><p>基于信号量的隔离</p>
</li>
<li><p>缓存</p>
</li>
<li><p>限时</p>
</li>
<li><p>请求重试</p>
</li>
</ol>
<h3 id="10-2-基本用法"><a href="#10-2-基本用法" class="headerlink" title="10.2 基本用法"></a>10.2 基本用法</h3><p>首先搭建一个简单的测试环境。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="10-2-1-断路器"><a href="#10-2-1-断路器" class="headerlink" title="10.2.1 断路器"></a>10.2.1 断路器</h4><p>Resilience4j 提供了很多功能，不同的功能对应不同的依赖，可以按需添加。<br>使用断路器，则首先添加断路器的依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.resilience4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resilience4j-circuitbreaker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.13.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>一个正常执行的例子：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="comment">//获取一个CircuitBreakerRegistry实例，可以调用ofDefaults获取一个</span></span><br><span class="line">CircuitBreakerRegistry实例，也可以自定义属性。</span><br><span class="line">CircuitBreakerRegistry registry = CircuitBreakerRegistry.ofDefaults();</span><br><span class="line">CircuitBreakerConfig config = CircuitBreakerConfig.custom()</span><br><span class="line"><span class="comment">//故障率阈值百分比，超过这个阈值，断路器就会打开</span></span><br><span class="line">.failureRateThreshold(<span class="number">50</span>)</span><br><span class="line"><span class="comment">//断路器保持打开的时间，在到达设置的时间之后，断路器会进入到 half open 状态</span></span><br><span class="line">.waitDurationInOpenState(Duration.ofMillis(<span class="number">1000</span>))</span><br><span class="line"><span class="comment">//当断路器处于half open 状态时，环形缓冲区的大小</span></span><br><span class="line">.ringBufferSizeInHalfOpenState(<span class="number">2</span>)</span><br><span class="line">.ringBufferSizeInClosedState(<span class="number">2</span>)</span><br><span class="line">.build();</span><br><span class="line">CircuitBreakerRegistry r1 = CircuitBreakerRegistry.of(config);</span><br><span class="line">CircuitBreaker cb1 = r1.circuitBreaker(<span class="string">"javaboy"</span>);</span><br><span class="line">CircuitBreaker cb2 = r1.circuitBreaker(<span class="string">"javaboy2"</span>, config);</span><br><span class="line">CheckedFunction0&lt;String&gt; supplier =</span><br><span class="line">CircuitBreaker.decorateCheckedSupplier(cb1, () -&gt; <span class="string">"hello resilience4"</span>;</span><br><span class="line">Try&lt;String&gt; result = Try.of(supplier)</span><br><span class="line">.map(v -&gt; v + <span class="string">" hello world"</span>);</span><br><span class="line">System.out.println(result.isSuccess());</span><br><span class="line">System.out.println(result.get());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>一个出异常的断路器：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>{</span><br><span class="line">CircuitBreakerConfig config = CircuitBreakerConfig.custom()</span><br><span class="line"><span class="comment">//故障率阈值百分比，超过这个阈值，断路器就会打开</span></span><br><span class="line">.failureRateThreshold(<span class="number">50</span>)</span><br><span class="line"><span class="comment">//断路器保持打开的时间，在到达设置的时间之后，断路器会进入到 half open 状态</span></span><br><span class="line">.waitDurationInOpenState(Duration.ofMillis(<span class="number">1000</span>))</span><br><span class="line"><span class="comment">//当断路器处于half open 状态时，环形缓冲区的大小</span></span><br><span class="line">.ringBufferSizeInClosedState(<span class="number">2</span>)</span><br><span class="line">.build();</span><br><span class="line">CircuitBreakerRegistry r1 = CircuitBreakerRegistry.of(config);</span><br><span class="line">CircuitBreaker cb1 = r1.circuitBreaker(<span class="string">"javaboy"</span>);</span><br><span class="line">System.out.println(cb1.getState());<span class="comment">//获取断路器的一个状态</span></span><br><span class="line">cb1.onError(<span class="number">0</span>, <span class="keyword">new</span> RuntimeException());</span><br><span class="line">System.out.println(cb1.getState());<span class="comment">//获取断路器的一个状态</span></span><br><span class="line">cb1.onError(<span class="number">0</span>, <span class="keyword">new</span> RuntimeException());</span><br><span class="line">System.out.println(cb1.getState());<span class="comment">//获取断路器的一个状态</span></span><br><span class="line">CheckedFunction0&lt;String&gt; supplier =</span><br><span class="line">CircuitBreaker.decorateCheckedSupplier(cb1, () -&gt; <span class="string">"hello resilience4j"</span>);</span><br><span class="line">Try&lt;String&gt; result = Try.of(supplier)</span><br><span class="line">.map(v -&gt; v + <span class="string">" hello world"</span>);</span><br><span class="line">System.out.println(result.isSuccess());</span><br><span class="line">System.out.println(result.get());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意，由于 ringBufferSizeInClosedState 的值为 2，表示当有两条数据时才会去统计故障率，所以，<br>下面的手动故障测试，至少调用两次 onError ，断路器才会打开。</p>
<h4 id="10-2-2-限流"><a href="#10-2-2-限流" class="headerlink" title="10.2.2 限流"></a>10.2.2 限流</h4><p>RateLimiter 本身和前面的断路器很像。<br>首先添加依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.resilience4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resilience4j-ratelimiter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.13.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>限流测试：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>{</span><br><span class="line">RateLimiterConfig config = RateLimiterConfig.custom()</span><br><span class="line">.limitRefreshPeriod(Duration.ofMillis(<span class="number">1000</span>))</span><br><span class="line">.limitForPeriod(<span class="number">4</span>)</span><br><span class="line">.timeoutDuration(Duration.ofMillis(<span class="number">1000</span>))</span><br><span class="line">.build();</span><br><span class="line">RateLimiter rateLimiter = RateLimiter.of(<span class="string">"javaboy"</span>, config);</span><br><span class="line">CheckedRunnable checkedRunnable =</span><br><span class="line">RateLimiter.decorateCheckedRunnable(rateLimiter, () -&gt; {</span><br><span class="line">System.out.println(<span class="keyword">new</span> Date());</span><br><span class="line">});</span><br><span class="line">Try.run(checkedRunnable)</span><br><span class="line">.andThenTry(checkedRunnable)</span><br><span class="line">.andThenTry(checkedRunnable)</span><br><span class="line">.andThenTry(checkedRunnable)</span><br><span class="line">.onFailure(t -&gt; System.out.println(t.getMessage()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="10-2-3-请求重试"><a href="#10-2-3-请求重试" class="headerlink" title="10.2.3 请求重试"></a>10.2.3 请求重试</h4><p>首先第一步还是加依赖：</p>
<figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;io.github.resilience4j&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;resilience4j-retry&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;0.13.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>案例：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>{</span><br><span class="line">RetryConfig config = RetryConfig.custom()</span><br><span class="line"><span class="comment">//重试次数</span></span><br><span class="line">.maxAttempts(<span class="number">2</span>)</span><br><span class="line"><span class="comment">//重试间隔</span></span><br><span class="line">.waitDuration(Duration.ofMillis(<span class="number">500</span>))</span><br><span class="line"><span class="comment">//重试异常</span></span><br><span class="line">.retryExceptions(RuntimeException.class)</span><br><span class="line">.build();</span><br><span class="line">Retry retry = Retry.of(<span class="string">"javaboy"</span>, config);</span><br><span class="line">Retry.decorateRunnable(retry, <span class="keyword">new</span> Runnable() {</span><br><span class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//开启了重试功能之后，run 方法执行时，如果抛出异常，会自动触发重试功能</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">if</span> (count++ &lt; <span class="number">3</span>) {</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line">}).run();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="10-3-结合微服务"><a href="#10-3-结合微服务" class="headerlink" title="10.3 结合微服务"></a>10.3 结合微服务</h3><p>Retry、CircuitBreaker、RateLimiter</p>
<h4 id="10-3-1-Retry"><a href="#10-3-1-Retry" class="headerlink" title="10.3.1 Retry"></a>10.3.1 Retry</h4><p>首先创建一个 Spring Boot 项目，创建时，添加 eureka-client 依赖，使之能够注册到 eureka 上。</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210512173814.png" alt="image-20210512173814802"></p>
<p>项目创建成功后，手动添加 Resilience4j 依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.resilience4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resilience4j-spring-boot2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.resilience4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resilience4j-circuitbreaker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.resilience4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resilience4j-ratelimiter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.resilience4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resilience4j-bulkhead<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.resilience4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resilience4j-timelimiter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>resilience4j-spring-boot2 中包含了 Resilience4j 的所有功能，但是没有配置的功能无法使用，需要将<br>之从依赖中剔除掉。<br>接下来，在 application.yml 中配置 retry：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">resilience4j:</span></span><br><span class="line">  <span class="attr">retry:</span></span><br><span class="line">    <span class="comment"># 表示Retry的优先级</span></span><br><span class="line">    <span class="attr">retry-aspect-order:</span> <span class="number">399</span> </span><br><span class="line">    <span class="attr">backends:</span> </span><br><span class="line">      <span class="attr">retryA:</span></span><br><span class="line">        <span class="comment"># 重试次数</span></span><br><span class="line">        <span class="attr">maxRetryAttempts:</span> <span class="number">5</span></span><br><span class="line">        <span class="comment"># 重试等待时间</span></span><br><span class="line">        <span class="attr">waitDuration:</span> <span class="number">500</span></span><br><span class="line">        <span class="comment"># 间隔乘数</span></span><br><span class="line">        <span class="attr">exponentialBackoffMultiplier:</span> <span class="number">1.1</span></span><br><span class="line">        <span class="attr">retryExceptions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">java.lang.RuntimeException</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">resilience4j</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span> </span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:1111/eureka</span></span><br></pre></td></tr></tbody></table></figure>

<p>最后，创建测试 RestTemplate 和 HelloService：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Resilience4j2Application</span> </span>{</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">SpringApplication.run(Resilience4j2Application.class, args);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Retry(name = "retryA")</span><span class="comment">//表示要使用的重试策略</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloService</span> </span>{</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RestTemplate restTemplate;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://localhost:1113/hello"</span>,</span><br><span class="line">String.class);</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>{</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">HelloService helloService;</span><br><span class="line"><span class="meta">@GetMapping("/hello")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> helloService.hello();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="10-3-2-CircuitBreaker"><a href="#10-3-2-CircuitBreaker" class="headerlink" title="10.3.2 CircuitBreaker"></a>10.3.2 CircuitBreaker</h4><p>首先从依赖中删除排除 CircuitBreaker。<br>然后在 application.yml 中进行配置：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">resilience4j:</span></span><br><span class="line">  <span class="attr">retry:</span></span><br><span class="line">	<span class="attr">retry-aspect-order:</span> <span class="number">399</span> <span class="comment"># 表示Retry的优先级</span></span><br><span class="line">	<span class="attr">backends:</span></span><br><span class="line"><span class="attr">retryA:</span></span><br><span class="line"><span class="attr">maxRetryAttempts:</span> <span class="number">5</span> <span class="comment"># 重试次数</span></span><br><span class="line"><span class="attr">waitDuration:</span> <span class="number">500</span> <span class="comment"># 重试等待时间</span></span><br><span class="line"><span class="attr">exponentialBackoffMultiplier:</span> <span class="number">1.1</span> <span class="comment"># 间隔乘数</span></span><br><span class="line"><span class="attr">retryExceptions:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">java.lang.RuntimeException</span></span><br><span class="line"><span class="attr">circuitbreaker:</span></span><br><span class="line"><span class="attr">instances:</span></span><br><span class="line"><span class="attr">cbA:</span></span><br><span class="line"><span class="attr">ringBufferSizeInClosedState:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">ringBufferSizeInHalfOpenState:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">waitInterval:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">recordExceptions:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">org.springframework.web.client.HttpServerErrorException</span></span><br><span class="line"><span class="attr">circuit-breaker-aspect-order:</span> <span class="number">398</span></span><br></pre></td></tr></tbody></table></figure>

<p>配置完成后，用 @CircuitBreakder 注解标记相关方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@CircuitBreaker(name = "cbA", fallbackMethod = "error")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloService</span> </span>{</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RestTemplate restTemplate;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://localhost:1113/hello"</span>,</span><br><span class="line">String.class);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">error</span><span class="params">(Throwable t)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>@CircuitBreaker 注解中的 name 属性用来指定 circuitbreaker 配置，fallbackMethod 属性用来指定<br>服务降级的方法，需要注意的是，服务降级方法中，要添加异常参数。</p>
<h4 id="10-3-3-RateLimiter"><a href="#10-3-3-RateLimiter" class="headerlink" title="10.3.3 RateLimiter"></a>10.3.3 RateLimiter</h4><p>RateLimiter 作为限流工具，主要在服务端使用，用来保护服务端的接口。<br>首先在 provider 中添加 RateLimiter 依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.resilience4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resilience4j-spring-boot2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.resilience4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resilience4j-circuitbreaker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.resilience4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resilience4j-bulkhead<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.resilience4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resilience4j-timelimiter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>接下来，在 provider 的 application.properties 配置文件中，去配置 RateLimiter：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里配置每秒钟处理一个请求</span></span><br><span class="line"><span class="meta">resilience4j.ratelimiter.limiters.rlA.limit-for-period</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">resilience4j.ratelimiter.limiters.rlA.limit-refresh-period</span>=<span class="string">1s</span></span><br><span class="line"><span class="meta">resilience4j.ratelimiter.limiters.rlA.timeout-duration</span>=<span class="string">1s</span></span><br></pre></td></tr></tbody></table></figure>

<p>为了查看请求效果，在 provider 的 HelloController 中打印每一个请求的时间：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@RateLimiter(name = "rlA")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line">String s = <span class="string">"hello javaboy:"</span> + port;</span><br><span class="line">System.out.println(<span class="keyword">new</span> Date());</span><br><span class="line"><span class="keyword">return</span> s;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里通过 @RateLimiter 注解来标记该接口限流。<br>配置完成后，重启 provider。<br>然后，在客户端模拟多个请求，查看限流效果：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) {</span><br><span class="line">restTemplate.getForObject(<span class="string">"http://localhost:1113/hello"</span>, String.class);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="10-4-服务监控"><a href="#10-4-服务监控" class="headerlink" title="10.4 服务监控"></a>10.4 服务监控</h3><p>微服务由于服务数量众多，所以出故障的概率很大，这种时候不能单纯的依靠人肉运维。<br>早期的 Spring Cloud 中，服务监控主要使用 Hystrix Dashboard，集群数据库监控使用 Turbine。<br>在 Greenwich 版本中，官方建议监控工具使用 Micrometer。<br>Micrometer：</p>
<ol>
<li>提供了度量指标，例如 timers、counters</li>
<li>一揽子开箱即用的解决方案，例如缓存、类加载器、垃圾收集等等<br>新建一个 Spring Boot 项目，添加 Actuator 依赖。项目创建成功后，添加如下配置，开启所有端点：</li>
</ol>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">management.endpoints.web.exposure.include</span>=<span class="string">*</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后就可以在浏览器查看项目的各项运行数据，但是这些数据都是 JSON 格式。<br><img src="https://gitee.com/penno/blogimg/raw/master/img/20210512223119.png" alt="image-20210512223119092"></p>
<p>我们需要一个可视化工具来展示这些 JSON 数据。这里主要和大家介绍 Prometheus。</p>
<h4 id="10-4-1-Prometheus"><a href="#10-4-1-Prometheus" class="headerlink" title="10.4.1 Prometheus"></a>10.4.1 Prometheus</h4><p>安装</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget</span><br><span class="line">https://github.com/prometheus/prometheus/releases/download/v2.16.0/prometheus-</span><br><span class="line">2.16.0.linux-amd64.tar.gz</span><br><span class="line">tar -zxvf prometheus-2.16.0.linux-amd64.tar.gz</span><br></pre></td></tr></tbody></table></figure>

<p>解压完成后，配置一下数据路径和要监控的服务地址：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd prometheus-2.16.0.linux-amd64/</span><br><span class="line">vi prometheus.yml</span><br></pre></td></tr></tbody></table></figure>

<p>修改 prometheus.yml 配置文件，主要改两个地方，一个是数据接口，另一个是服务地址：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210513092307.png" alt="image-20210513092307526"></p>
<p>接下来，将 Prometheus 整合到 Spring Boot 项目中。<br>首先加依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.micrometer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后在 application.properties 配置中，添加 Prometheus 配置：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">management.endpoints.web.exposure.include</span>=<span class="string">*</span></span><br><span class="line"><span class="meta">management.endpoint.prometheus.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">management.metrics.export.prometheus.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">management.endpoint.metrics.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></tbody></table></figure>

<p>接下来启动 Prometheus。<br>启动命令：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./prometheus --config.file=prometheus.yml</span><br></pre></td></tr></tbody></table></figure>

<p>启动成功后，浏览器输入 <a target="_blank" rel="noopener" href="http://192.168.91.128:9090/">http://192.168.91.128:9090</a> 查看 Prometheus 数据信息。<br>Grafana：<a target="_blank" rel="noopener" href="https://grafana.com/grafana/download?platform=linux">https://grafana.com/grafana/download?platform=linux</a></p>
<h2 id="第8章-Zuul"><a href="#第8章-Zuul" class="headerlink" title="第8章 Zuul"></a>第8章 Zuul</h2><h3 id="11-1-服务网关"><a href="#11-1-服务网关" class="headerlink" title="11.1 服务网关"></a>11.1 服务网关</h3><p>Zuul 和 Gateway<br>由于每一个微服务的地址都有可能发生变化，无法直接对外公布这些服务地址，基于安全以及高内聚低<br>耦合等设计，我们有必要将内部系统和外部系统做一个切割。<br>一个专门用来处理外部请求的组件，就是服务网关。</p>
<ul>
<li>权限问题统一处理</li>
<li>数据剪裁和聚合</li>
<li>简化客户端的调用</li>
<li>可以针对不同的客户端提供不同的网关支持</li>
</ul>
<p>Spring Cloud 中，网关主要有两种实现方案：</p>
<ul>
<li>Zuul</li>
<li>Spring Cloud Gateway </li>
</ul>
<h3 id="11-2-Zuul"><a href="#11-2-Zuul" class="headerlink" title="11.2 Zuul"></a>11.2 Zuul</h3><p>Zuul 是 Netflix 公司提供的网关服务。<br>Zuul 的功能：</p>
<ul>
<li>权限控制，可以做认证和授权</li>
<li>监控</li>
<li>动态路由</li>
<li>负载均衡</li>
<li>静态资源处理</li>
</ul>
<p>Zuul 中的功能基本上都是基于过滤器来实现，它的过滤器有几种不同的类型：</p>
<ul>
<li>PRE</li>
<li>ROUTING</li>
<li>POST</li>
<li>ERROR</li>
</ul>
<h4 id="11-2-1-HelloWorld"><a href="#11-2-1-HelloWorld" class="headerlink" title="11.2.1 HelloWorld"></a>11.2.1 HelloWorld</h4><p>首先创建项目，添加 Zuul 依赖。</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210513141557.png" alt="image-20210513141557307"></p>
<p>项目创建成功后，将 zuul 注册到 eureka 上：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">zuul</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">2020</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:1111/eureka</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后在启动类上开启网关代理：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span><span class="comment">//开启网关代理</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulApplication</span> </span>{</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">SpringApplication.run(ZuulApplication.class, args);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>配置完成后，重启 Zuul，接下来，在浏览器中，通过 Zuul 的代理就可以访问到 provider 了。<br><a target="_blank" rel="noopener" href="http://localhost:2020/provider/hello">http://localhost:2020/provider/hello</a><br>在这个访问地址中，provider 就是要访问的服务名称，/hello 则是要访问的服务接口。<br>这是一个简单例子，Zuul 中的路由规则也可以自己配置。</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">zuul.routes.javaboy-a.path</span>=<span class="string">/javaboy-a/**</span></span><br><span class="line"><span class="meta">zuul.routes.javaboy-a.service-id</span>=<span class="string">provider</span></span><br></pre></td></tr></tbody></table></figure>

<p>上面这个配置，表示 /javaboy-a/** ，满足这个匹配规则的请求，将被转发到 provider 实例上。<br>上面两行配置，也可以进行简化：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">zuul.routes.provider</span>=<span class="string">/javaboy-a/**</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="11-2-2-请求过滤"><a href="#11-2-2-请求过滤" class="headerlink" title="11.2.2 请求过滤"></a>11.2.2 请求过滤</h4><p>对于来自客户端的请求，可以在 Zuul 中进行预处理，例如权限判断等。<br>定义一个简单的权限过滤器：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤器类型，权限判断一般是pre</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"pre"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤器优先级</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否过滤</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 核心的过滤逻辑写在这里</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 这个方法虽然有返回值，但是这个返回值目前无所谓</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ZuulException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>{</span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        <span class="comment">//获取当前请求</span></span><br><span class="line">        HttpServletRequest request = ctx.getRequest();</span><br><span class="line">        String username = request.getParameter(<span class="string">"username"</span>);</span><br><span class="line">        String password = request.getParameter(<span class="string">"password"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">"lunanboy"</span>.equals(username) || !<span class="string">"123"</span>.equals(password)) {</span><br><span class="line">            <span class="comment">//如果请求不满足,直接在这里给出响应</span></span><br><span class="line">            ctx.setSendZuulResponse(<span class="keyword">false</span>);</span><br><span class="line">            ctx.setResponseStatusCode(<span class="number">401</span>);</span><br><span class="line">            ctx.addZuulResponseHeader(<span class="string">"content-type"</span>, <span class="string">"text/html;charset=utf-8"</span>);</span><br><span class="line">            ctx.setResponseBody(<span class="string">"非法访问"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>重启 Zuul，接下来，发送请求必须带上 username 和 password 参数，否则请求不通过。</p>
<p><a target="_blank" rel="noopener" href="http://localhost:2020/javaboy-a/hello?username=javaboy&amp;password=123">http://localhost:2020/javaboy-a/hello?username=javaboy&amp;password=123</a></p>
<h4 id="11-2-3-Zuul-中的其他配置"><a href="#11-2-3-Zuul-中的其他配置" class="headerlink" title="11.2.3 Zuul 中的其他配置"></a>11.2.3 Zuul 中的其他配置</h4><p><strong>匹配规则</strong></p>
<p>例如有两个服务，一个叫 consumer，另一个叫 consumer-hello，在做路由规则设置时，假如出现了<br>如下配置：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zuul.routes.consumer=/consumer<span class="comment">/**</span></span><br><span class="line"><span class="comment">zuul.routes.consumer-hello=/consumer/hello/**</span></span><br></pre></td></tr></tbody></table></figure>

<p>此时，如果访问一个地址：<a target="_blank" rel="noopener" href="http://localhost:2020/consumer/hello/123%EF%BC%8C%E4%BC%9A%E5%87%BA%E7%8E%B0%E5%86%B2%E7%AA%81%E3%80%82%E5%AE%9E%E9%99%85%E4%B8%8A%EF%BC%8C%E8%BF%99%E4%B8%AA">http://localhost:2020/consumer/hello/123，会出现冲突。实际上，这个</a><br>地址是希望和 consumer-hello 这个服务匹配的，这个时候，只需要把配置文件改为 yml 格式就可以<br>了。</p>
<p><strong>忽略路径</strong></p>
<p>默认情况下，zuul 注册到 eureka 上之后，eureka 上的所有注册服务都会被自动代理。如果不想给某<br>一个服务做代理，可以忽略该服务，配置如下：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">zuul.ignored-services</span>=<span class="string">provider</span></span><br></pre></td></tr></tbody></table></figure>

<p>上面这个配置表示忽略 provider 服务，此时就不会自动代理 provider 服务了。<br>也可以忽略某一类地址：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">zuul.ignored-patterns</span>=<span class="string">/**/hello/**</span></span><br></pre></td></tr></tbody></table></figure>

<p>这个表示请求路径中如果包含 hello，则不做代理。</p>
<p><strong>前缀</strong><br>也可以给路由加前缀。</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">zuul.prefix</span>=<span class="string">/javaboy</span></span><br></pre></td></tr></tbody></table></figure>

<p>这样，以后所有的请求地址自动多了前缀，/javaboy</p>
<h2 id="第9章-Spring-Cloud-Gateway"><a href="#第9章-Spring-Cloud-Gateway" class="headerlink" title="第9章 Spring Cloud Gateway"></a>第9章 Spring Cloud Gateway</h2><h3 id="12-1-简介"><a href="#12-1-简介" class="headerlink" title="12.1 简介"></a>12.1 简介</h3><p>特点：</p>
<p>限流<br>路径重写<br>动态路由<br>集成 Spring Cloud DiscoveryClient<br>集成 Hystrix 断路器</p>
<p>和 Zuul 对比：</p>
<ol>
<li>Zuul 是 Netflix 公司的开源产品，Spring Cloud Gateway 是 Spring 家族中的产品，可以和<br>Spring 家族中的其他组件更好的融合。</li>
<li>Zuul1 不支持长连接，例如 websocket。</li>
<li>Spring Cloud Gateway 支持限流。</li>
<li>Spring Cloud Gateway 基于 Netty 来开发，实现了异步和非阻塞，占用资源更小，性能强于<br>Zuul。</li>
</ol>
<h3 id="12-2-基本用法"><a href="#12-2-基本用法" class="headerlink" title="12.2 基本用法"></a>12.2 基本用法</h3><p>Spring Cloud Gateway 支持两种不同的用法：</p>
<p>编码式<br>yml 配置</p>
<p>两种都来看下。</p>
<p><strong>编码式</strong><br>首先创建 Spring Boot 项目，添加 Spring Cloud Gateway 模块：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210513151052.png" alt="image-20210513151051993"></p>
<p>项目创建成功后，直接配置一个 RouteLocator 这样一个 Bean，就可以实现请求转发。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">RouteLocator <span class="title">routeLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>{</span><br><span class="line"><span class="keyword">return</span> builder.routes()</span><br><span class="line">.route(<span class="string">"javaboy_route"</span>, r -&gt;</span><br><span class="line">r.path(<span class="string">"/get"</span>).uri(<span class="string">"http://httpbin.org"</span>))</span><br><span class="line">.build();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里只需要提供 RouteLocator 这个 Bean，就可以实现请求转发。配置完成后，重启项目，访问：</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/get">http://localhost:8080/get</a></p>
<p>properties 配置</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.gateway.routes[<span class="number">0</span>].id=javaboy_route</span><br><span class="line">spring.cloud.gateway.routes[<span class="number">0</span>].uri=http:<span class="comment">//httpbin.org</span></span><br><span class="line">spring.cloud.gateway.routes[<span class="number">0</span>].predicates[<span class="number">0</span>]=Path=/get</span><br></pre></td></tr></tbody></table></figure>

<p>YML 配置</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">lunanboy_route</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">http://httpbin.org</span></span><br><span class="line">          <span class="attr">predicate:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/get</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="12-2-1-服务化"><a href="#12-2-1-服务化" class="headerlink" title="12.2.1 服务化"></a>12.2.1 服务化</h4><p>首先给 Gateway 添加依赖，将之注册到 Eureka 上。<br>加依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>加配置：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">cloud:</span></span><br><span class="line"><span class="attr">gateway:</span></span><br><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">javaboy_route</span></span><br><span class="line"><span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line"><span class="attr">predicates:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Path=/get</span></span><br><span class="line"><span class="attr">application:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">client:</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line"><span class="attr">defaultZone:</span> <span class="string">http://localhost:1111/eureka</span></span><br></pre></td></tr></tbody></table></figure>

<p>配置路由转发：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line"><span class="comment">#      routes: </span></span><br><span class="line"><span class="comment">#        - id: lunanboy_route</span></span><br><span class="line"><span class="comment">#          url: http://httpbin.org</span></span><br><span class="line"><span class="comment">#          predicate: </span></span><br><span class="line"><span class="comment">#            - Path=/get</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启自动代理</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span> </span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:1111/eureka</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span> </span><br><span class="line">    <span class="attr">org.springframework.cloud.gateway:</span> <span class="string">debug</span></span><br></pre></td></tr></tbody></table></figure>

<p>为什么provider要大写 且需要注释掉routes里面的配置内容</p>
<p>接下来，就可以通过 Gateway 访问到其他注册在 Eureka 上的服务了，访问方式和 Zuul 一样。</p>
<h3 id="12-3-Predicate"><a href="#12-3-Predicate" class="headerlink" title="12.3 Predicate"></a>12.3 Predicate</h3><p>通过时间匹配：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">cloud:</span></span><br><span class="line"><span class="attr">gateway:</span></span><br><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">javaboy_route</span></span><br><span class="line"><span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line"><span class="attr">predicates:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">After=2021-01-01T01:01:01+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></tbody></table></figure>

<p>表示，请求时间在 2021-01-01T01:01:01+08:00[Asia/Shanghai] 时间之后，才会被路由。<br>除了 After 之外，还有两个关键字：</p>
<ul>
<li><p>Before，表示在某个时间点之前进行请求转发</p>
</li>
<li><p>Between，表示在两个时间点之间，两个时间点用 , 隔开</p>
</li>
</ul>
<p>也可以通过请求方式匹配，就是请求方法：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">cloud:</span></span><br><span class="line"><span class="attr">gateway:</span></span><br><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">javaboy_route</span></span><br><span class="line"><span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line"><span class="attr">predicates:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Method=GET</span></span><br></pre></td></tr></tbody></table></figure>

<p>这个配置表示只给 GET 请求进行路由。<br>通过请求路径匹配：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">cloud:</span></span><br><span class="line"><span class="attr">gateway:</span></span><br><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">javaboy_route</span></span><br><span class="line"><span class="attr">uri:</span> <span class="string">http://www.javaboy.org</span></span><br><span class="line"><span class="attr">predicates:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Path=/2019/0612/{segment}</span></span><br></pre></td></tr></tbody></table></figure>

<p>表示路径满足 /2019/0612/ 这个规则，都会被进行转发，例如：</p>
<p>通过参数进行匹配：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">cloud:</span></span><br><span class="line"><span class="attr">gateway:</span></span><br><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">javaboy_route</span></span><br><span class="line"><span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line"><span class="attr">predicates:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Query=name</span></span><br></pre></td></tr></tbody></table></figure>

<p>表示请求中一定要有 name 参数才会进行转发，否则不会进行转发。<br>也可以指定参数和参数的值。<br>例如参数的 key 为 name，value 必须要以 java 开始：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">cloud:</span></span><br><span class="line"><span class="attr">gateway:</span></span><br><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">javaboy_route</span></span><br><span class="line"><span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line"><span class="attr">predicates:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Query=name,java.*</span></span><br></pre></td></tr></tbody></table></figure>

<p>多种匹配方式也可以组合使用。</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">cloud:</span></span><br><span class="line"><span class="attr">gateway:</span></span><br><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">javaboy_route</span></span><br><span class="line"><span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line"><span class="attr">predicates:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Query=name,java.*</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Method=GET</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">After=2021-01-01T01:01:01+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="12-4-Filter"><a href="#12-4-Filter" class="headerlink" title="12.4 Filter"></a>12.4 Filter</h3><p>Spring Cloud Gateway 中的过滤器分为两大类：</p>
<ul>
<li><p>GatewayFilter</p>
</li>
<li><p>GlobalFilter</p>
</li>
</ul>
<p>AddRequestParameter 过滤器使用：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">cloud:</span></span><br><span class="line"><span class="attr">gateway:</span></span><br><span class="line"><span class="attr">routes:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">javaboy_route</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://provider</span></span><br><span class="line">  <span class="attr">filters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">AddRequestParameter=name,javaboy</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Method=GET</span></span><br></pre></td></tr></tbody></table></figure>

<p>  这个过滤器就是在请求转发路由的时候，自动额外添加参数。</p>
<h2 id="第10章-Spring-Cloud-Config"><a href="#第10章-Spring-Cloud-Config" class="headerlink" title="第10章 Spring Cloud Config"></a>第10章 Spring Cloud Config</h2><h3 id="13-1-基本用法"><a href="#13-1-基本用法" class="headerlink" title="13.1 基本用法"></a>13.1 基本用法</h3><p>分布式配置中心解决方案：<br>国内：<br>360：QConf<br>淘宝：diamond<br>百度：disconf<br>国外：<br>Apache Commons Configuration<br>owner<br>cfg4j</p>
<h4 id="13-1-1-简介"><a href="#13-1-1-简介" class="headerlink" title="13.1.1 简介"></a>13.1.1 简介</h4><p>Spring Cloud Config 是一个分布式系统配置管理的解决方案，它包含了 Client 和 Server 。配置文件放<br>在 Server 端，通过 接口的形式提供给 Client。<br>Spring Cloud Config 主要功能：<br>集中管理各个环境、各个微服务的配置文件<br>提供服务端和客户端支持<br>配置文件修改后，可以快速生效<br>配置文件通过 Git/SVn 进行管理，天然支持版本回退功能。<br>支持高并发查询、也支持多种开发语言。</p>
<h4 id="13-1-2-准备工作"><a href="#13-1-2-准备工作" class="headerlink" title="13.1.2 准备工作"></a>13.1.2 准备工作</h4><p>准备工作主要是给 GitHub 上提交数据。<br>本地准备好相应的配置文件，提交到 GitHub：<a target="_blank" rel="noopener" href="https://github.com/wongsung/configRepo">https://github.com/wongsung/configRepo</a></p>
<h4 id="13-1-2-ConfigServer"><a href="#13-1-2-ConfigServer" class="headerlink" title="13.1.2 ConfigServer"></a>13.1.2 ConfigServer</h4><p>首先创建一个 ConfigServer 工程，创建时添加 ConfigServer 依赖：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210513162519.png" alt="image-20210513162519185"></p>
<p>项目创建成功后，项目启动类上添加注解，开启 config server 功能：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigServerApplication</span> </span>{</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">SpringApplication.run(ConfigServerApplication.class, args);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后在配置文件中配置仓库的基本信息：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">config-server</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8081</span></span><br><span class="line"><span class="comment"># 配置文件仓库地址</span></span><br><span class="line"><span class="meta">spring.cloud.config.server.git.uri</span>=<span class="string">https://github.com/wongsung/configRepo.git</span></span><br><span class="line"><span class="comment"># 仓库中，配置文件的目录</span></span><br><span class="line"><span class="meta">spring.cloud.config.server.git.search-paths</span>=<span class="string">client1</span></span><br><span class="line"><span class="comment"># 仓库的用户名密码</span></span><br><span class="line"><span class="meta">spring.cloud.config.server.git.username</span>=<span class="string">1510161612@qq.com</span></span><br><span class="line"><span class="meta">spring.cloud.config.server.git.password</span>=<span class="string"></span></span><br></pre></td></tr></tbody></table></figure>

<p>启动项目后，就可以访问配置文件了。访问地址：<a target="_blank" rel="noopener" href="http://localhost:8081/client1/prod/master">http://localhost:8081/client1/prod/master</a><br>实际上，访问地址有如下规则：</p>
<p>/{application}/{profile}/[{label}]<br>/{application}-{profile}.yml<br>/{application}-{profile}.properties<br>/{label}/{application}-{profile}.yml<br>/{label}/{application}-{profile}.properties</p>
<p>applicaiton 表示配置文件名<br>profile 表示配置文件 profile，例如 test、dev、prod<br>label 表示git 分支，参数可选，默认就是master<br>接下来，可以修改配置文件，并且重新提交到 GitHub，此时，刷新 ConfigServer 接口，就可以及时看<br>到最新的配置内容。</p>
<h4 id="13-1-3-ConfigClient"><a href="#13-1-3-ConfigClient" class="headerlink" title="13.1.3 ConfigClient"></a>13.1.3 ConfigClient</h4><p>创建一个 Spring Boot 项目，添加 ConfigClient 依赖：</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210514135559.png" alt="image-20210514135558965"></p>
<p>项目创建成功后，resources 目录下，添加 bootstrap.properties 配置，内容如下：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面三行配置，分别对应 config-server 中的 {application}、{profile}以及{label}占位符</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">client1</span></span><br><span class="line"><span class="meta">spring.cloud.config.profile</span>=<span class="string">dev</span></span><br><span class="line"><span class="meta">spring.cloud.config.label</span>=<span class="string">master</span></span><br><span class="line"><span class="meta">spring.cloud.config.uri</span>=<span class="string">http://localhost:8080</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8082</span></span><br></pre></td></tr></tbody></table></figure>

<p>接下来创建一个 HelloController 进行测试：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>{</span><br><span class="line"><span class="meta">@Value("${javaboy}")</span></span><br><span class="line">String javaboy;</span><br><span class="line"><span class="meta">@GetMapping("/hello")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> javaboy;</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="13-1-4-配置"><a href="#13-1-4-配置" class="headerlink" title="13.1.4 配置"></a>13.1.4 配置</h4><p>使用占位符灵活控制查询目录。<br>修改 config-server 配置文件：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.cloud.config.server.git.search-paths</span>=<span class="string">{application}</span></span><br></pre></td></tr></tbody></table></figure>

<p>这里的 {application} 占位符，表示链接上来的 client1 的 spring.application.name 属性的值。<br>在 confi-server 中，也可以用 {profile} 表示 client 的 spring.cloud.config.profile，也可以用 {label} 表<br>示 client 的 spring.cloud.config.label<br>虽然在实际开发中，配置文件一般都是放在 Git 仓库中，但是，config-server 也支持将配置文件放在<br>classpath 下。<br>在 config-server 中添加如下配置：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 表示让 config-server 从 classpath 下查找配置，而不是去 Git 仓库中查找</span></span><br><span class="line"><span class="meta">spring.profiles.active</span>=<span class="string">native</span></span><br></pre></td></tr></tbody></table></figure>

<p>也可以在 config-server 中，添加如下配置，表示指定配置文件的位置：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.cloud.config.server.native.search-locations</span>=<span class="string">file:/E:/properties/</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="13-2-配置文件加解密-这个得看视频了-sob"><a href="#13-2-配置文件加解密-这个得看视频了-sob" class="headerlink" title="13.2 配置文件加解密(这个得看视频了):sob:"></a>13.2 配置文件加解密(这个得看视频了)<span class="github-emoji"><span>😭</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f62d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></h3><h4 id="13-2-1-常见加密方案"><a href="#13-2-1-常见加密方案" class="headerlink" title="13.2.1 常见加密方案"></a>13.2.1 常见加密方案</h4><p>不可逆加密<br>可逆加密<br>不可逆加密，就是理论上无法根据加密后的密文推算出明文。一般用在密码加密上，常见的算法如<br>MD5 消息摘要算法、SHA 安全散列算法。<br>可逆加密，看名字就知道可以根据加密后的密文推断出明文的加密方式，可逆加密一般又分为两种：<br>对称加密<br>非对称加密</p>
<p>对称加密指加密的密钥和解密的密钥是一样的。常见算法des、3des、aes<br>非对称加密就是加密的密钥和解密的密钥不一样，加密的叫做公钥，可以告诉任何人，解密的叫做私<br>钥，只有自己知道。常见算法 RSA。</p>
<h4 id="13-2-2-对称加密"><a href="#13-2-2-对称加密" class="headerlink" title="13.2.2 对称加密"></a>13.2.2 对称加密</h4><p>首先下载不限长度的 JCE：<a target="_blank" rel="noopener" href="http://download.oracle.com/otn-pub/java/jce/8/jce_policy-8.zip">http://download.oracle.com/otn-pub/java/jce/8/jce_policy-8.zip</a><br>将下载的文件解压，解压出来的 jar 拷贝到 Java 安装目录中：C:\Program Files\Java\jdk-<br>13.0.1\lib\security<br>然后，在 config-server 的 bootstrap.properties 配置文件中，添加如下内容配置密钥：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 密钥</span></span><br><span class="line"><span class="meta">encrypt.key</span>=<span class="string">javaboy</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后，启动 config-server ，访问如下地址，查看密钥配置是否OK：<a target="_blank" rel="noopener" href="http://localhost:8081/encrypt/status">http://localhost:8081/encrypt/status</a><br>然后，访问：<a target="_blank" rel="noopener" href="http://localhost:8081/encrypt">http://localhost:8081/encrypt</a> ，注意这是一个 POST 请求，访问该地址，可以对一段明<br>文进行加密。把加密后的明文存储到 Git 仓库中，存储时，要注意加一个 {cipher} 前缀。</p>
<p><img src="https://gitee.com/penno/blogimg/raw/master/img/20210514150450.png" alt="image-20210514150450391"></p>
<h4 id="13-2-3-非对称加密"><a href="#13-2-3-非对称加密" class="headerlink" title="13.2.3 非对称加密"></a>13.2.3 非对称加密</h4><p>非对称加密需要我们首先生成一个密钥对。<br>在命令行执行如下命令，生成 keystore：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkeypair -alias config-server -keyalg RSA -keystore</span><br><span class="line">D:\springcloud\config-server.keystore</span><br></pre></td></tr></tbody></table></figure>

<p>命令执行完成后，拷贝生成的 keystore 文件到 config-server 的 resources 目录下。<br>然后在 config-server 的 bootstrap.properties 目录中，添加如下配置：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">encrypt.key-store.location=config-server.keystore</span><br><span class="line">encrypt.key-store.alias=config-server</span><br><span class="line">encrypt.key-store.password=111111</span><br><span class="line">encrypt.key-store.secret=111111</span><br></pre></td></tr></tbody></table></figure>

<p>重启 config-server ，测试方法与对称加密一致。<br>注意，在 pom.xml 的 build 节点中，添加如下配置，防止 keystore 文件被过滤掉。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.keystore<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="13-3-安全管理"><a href="#13-3-安全管理" class="headerlink" title="13.3 安全管理"></a>13.3 安全管理</h3><p>防止用户直接通过访问 config-server 看到配置文件内容，我们可以用 spring security 来保护 configserver<br>接口。</p>
<p>首先在 config-server 中添加 spring security 依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>添加完依赖后，config-server 中的接口就自动被保护起来了。<br>默认自动生成的密码不好记，所以我们可以在 config-server 中，自己配置用户名密码。<br>在 config-server 的配置文件中，添加如下配置，固定用户名密码：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.security.user.name</span>=<span class="string">javaboy</span></span><br><span class="line"><span class="meta">spring.security.user.password</span>=<span class="string">123</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后，在 config-client 的 bootstrap.properties 配置文件中，添加如下配置：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.cloud.config.username</span>=<span class="string">javaboy</span></span><br><span class="line"><span class="meta">spring.cloud.config.password</span>=<span class="string">123</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="13-4-服务化"><a href="#13-4-服务化" class="headerlink" title="13.4 服务化"></a>13.4 服务化</h3><p>前面的配置都是直接在 config-client 中写死 config-server 的地址。<br>首先启动 Eureka 。<br>然后，为了让 config-server 和 config-client 都能注册到 Eureka ，给它俩添加如下依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后，在 application.properties 配置文件中配置注册信息。</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:1111/eureka</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后，修改 config-client 的配置文件，不再直接写死 config-server 的地址了。</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面三行配置，分别对应 config-server 中的 {application}、{profile}以及{label}占位符</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">client1</span></span><br><span class="line"><span class="meta">spring.cloud.config.profile</span>=<span class="string">dev</span></span><br><span class="line"><span class="meta">spring.cloud.config.label</span>=<span class="string">master</span></span><br><span class="line"><span class="comment">#spring.cloud.config.uri=http://localhost:8081</span></span><br><span class="line"><span class="comment"># 开启通过 eureka 获取 config-server 的功能</span></span><br><span class="line"><span class="meta">spring.cloud.config.discovery.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 配置 config-server 服务名称</span></span><br><span class="line"><span class="meta">spring.cloud.config.discovery.service-id</span>=<span class="string">config-server</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8082</span></span><br><span class="line"><span class="meta">spring.cloud.config.username</span>=<span class="string">javaboy</span></span><br><span class="line"><span class="meta">spring.cloud.config.password</span>=<span class="string">123</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:1111/eureka</span></span><br></pre></td></tr></tbody></table></figure>

<p>注意，加入 eureka client 之后，启动 config-server 可能会报错，此时，我们重新生成一个 jks 格式的<br>密钥。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkeypair -alias mytestkey -keyalg RSA -keypass 111111 -keystore</span><br><span class="line">D:\springcloud\config-service.jks -storepass 111111</span><br></pre></td></tr></tbody></table></figure>

<p>生成之后，拷贝到 configserver 的 resources 目录下，同时修改 bootstrap.properties 配置。</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 密钥</span></span><br><span class="line"><span class="comment">#encrypt.key=javaboy</span></span><br><span class="line"><span class="meta">encrypt.key-store.location</span>=<span class="string">classpath:config-service.jks</span></span><br><span class="line"><span class="meta">encrypt.key-store.alias</span>=<span class="string">mytestkey</span></span><br><span class="line"><span class="meta">encrypt.key-store.password</span>=<span class="string">111111</span></span><br><span class="line"><span class="meta">encrypt.key-store.secret</span>=<span class="string">111111</span></span><br><span class="line"><span class="meta">spring.security.user.name</span>=<span class="string">javaboy</span></span><br><span class="line"><span class="meta">spring.security.user.password</span>=<span class="string">123</span></span><br></pre></td></tr></tbody></table></figure>

<p>同时也修改一个 pom.xml 中的过滤条件：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.jks<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="13-5-动态刷新"><a href="#13-5-动态刷新" class="headerlink" title="13.5 动态刷新"></a>13.5 动态刷新</h3><p>当配置文件发生变化之后，config-server 可以及时感知到变化，但是 config-client 不会及时感知到变<br>化，默认情况下，config-client 只有重启才能加载到最新的配置文件。<br>首先给 config-client 添加如下依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后，添加配置，使 refresh 端点暴露出来：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">management.endpoints.web.exposure.include</span>=<span class="string">refresh</span></span><br></pre></td></tr></tbody></table></figure>

<p>最后，再给 config-client 使用了配置文件的地方加上 @RefreshScope 注解，这样，当配置改变后，只<br>需要调用 refresh 端点，config-client 中的配置就可以自动刷新。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>{</span><br><span class="line"><span class="meta">@Value("${javaboy}")</span></span><br><span class="line">String javaboy;</span><br><span class="line"><span class="meta">@GetMapping("/hello")</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">return</span> javaboy;</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>重启 config-client，以后，只要配置文件发生变化，发送 POST 请求，调用 <a target="_blank" rel="noopener" href="http://localhost:8082/actuator/refresh">http://localhost:8082/actuator/refresh</a> 接口即可，配置文件就会自动刷新。</p>
<h3 id="13-6-请求失败重试"><a href="#13-6-请求失败重试" class="headerlink" title="13.6 请求失败重试"></a>13.6 请求失败重试</h3><p>config-client 在调用 config-server 时，一样也可能发生请求失败的问题，这个时候，我们可以配置一<br>个请求重试的功能。<br>要给 config-client 添加重试功能，只需要添加如下依赖即可：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.retry<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-retry<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后，修改配置文件，开启失败快速响应。</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启失败快速响应</span></span><br><span class="line"><span class="meta">spring.cloud.config.fail-fast</span>=<span class="string">true</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后，注释掉配置文件的用户名密码，重启 config-client，此时加载配置文件失败，就会自动重试。<br>也可以通过如下配置保证服务的可用性：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启失败快速响应</span></span><br><span class="line"><span class="meta">spring.cloud.config.fail-fast</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 请求重试的初识间隔时间</span></span><br><span class="line"><span class="meta">spring.cloud.config.retry.initial-interval</span>=<span class="string">1000</span></span><br><span class="line"><span class="comment"># 最大重试次数</span></span><br><span class="line"><span class="meta">spring.cloud.config.retry.max-attempts</span>=<span class="string">6</span></span><br><span class="line"><span class="comment"># 重试时间间隔乘数</span></span><br><span class="line"><span class="meta">spring.cloud.config.retry.multiplier</span>=<span class="string">1.1</span></span><br><span class="line"><span class="comment"># 最大间隔时间</span></span><br><span class="line"><span class="meta">spring.cloud.config.retry.max-interval</span>=<span class="string">2000</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="第11章-Spring-Cloud-Bus"><a href="#第11章-Spring-Cloud-Bus" class="headerlink" title="第11章.Spring Cloud Bus"></a>第11章.Spring Cloud Bus</h2><p>Spring Cloud Bus 通过轻量级的消息代理连接各个微服务，可以用来广播配置文件的更改，或者管理服<br>务监控。<br>安装 RabbitMQ。<br>Docker 中 RabbitMQ 安装命令：</p>
<p>15672是管理界面的端口，5672是服务的端口。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -dit --name Myrabbitmq -e RABBITMQ_DEFAULT_USER=admin -e RABBITMQ_DEFAULT_PASS=admin -p 15672:15672 -p 5672:5672 rabbitmq</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --hostname my-rabbit --name some-rabbit -p 15672:15672 -p 5672:5672 rabbitmq</span><br></pre></td></tr></tbody></table></figure>

<p>首先给client和server加上springcloudbus依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后，给两个分别配置，使之都连接到 RabbitMQ 上：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.rabbitmq.host</span>=<span class="string">192.168.91.128</span></span><br><span class="line"><span class="meta">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="meta">spring.rabbitmq.username</span>=<span class="string">admin</span></span><br><span class="line"><span class="meta">spring.rabbitmq.password</span>=<span class="string">adm</span></span><br></pre></td></tr></tbody></table></figure>

<p>同时，由于 configserver 将提供刷新接口，所以给 configserver 加上 actuator 依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后记得在 config-server 中，添加开启 bus-refresh 端点：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">management.endpoints.web.exposure.include</span>=<span class="string">bus-refresh</span></span><br></pre></td></tr></tbody></table></figure>

<p>由于给 config-server 中的所有接口都添加了保护，所以刷新接口将无法直接访问，此时，可以通过修<br>改 Security 配置，对端点的权限做出修改：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>{</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">http.authorizeRequests()</span><br><span class="line">.anyRequest().authenticated()</span><br><span class="line">.and()</span><br><span class="line">.httpBasic()</span><br><span class="line">.and()</span><br><span class="line">.csrf().disable();</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在这段配置中，开启了 HttpBasic 登录，这样，在发送刷新请求时，就可以直接通过 HttpBasic 配置认<br>证信息了。<br>最后分别启动 config-server 和 config-client，然后修改配置信息提交到 GitHub，刷新 config-client 接<br>口，查看是否有变化。<br>然后，发送如下 POST 请求：<a target="_blank" rel="noopener" href="http://localhost:8081/actuator/bus-refresh">http://localhost:8081/actuator/bus-refresh</a><br>这个 post 是针对 config-server 的，config-server 会把这个刷新的指令传到 rabbitmq ，然后<br>rabbitmq 再把指令传给 各个 client。</p>
<h4 id="逐个刷新"><a href="#逐个刷新" class="headerlink" title="逐个刷新"></a>逐个刷新</h4><p>如果更新配置文件之后，不希望每一个微服务都去刷新配置文件，那么可以通过如下配置解决问题。<br>首先，给每一个 config-client 添加一个 instance-id：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.instance-id=${spring.application.name}:${server.port}</span><br></pre></td></tr></tbody></table></figure>

<p>然后，对 config-client 进行打包。<br>打包完成后，通过如下命令启动两个 config-client 实例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar config-client-0.0.1-SNAPSHOT.jar --server.port=8082</span><br><span class="line">java -jar config-client-0.0.1-SNAPSHOT.jar --server.port=8083</span><br></pre></td></tr></tbody></table></figure>

<p>修改配置文件，并且提交到 GitHub 之后，可以通过如下方式只刷新某一个微服务，例如只刷新 8082<br>的服务。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8081/actuator/bus-refresh/client1:8082</span><br></pre></td></tr></tbody></table></figure>

<p>client1:8082 表示服务的 instance-id。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Sql50题</p><p><a href="https://zeroornull.github.io/2021/05/18/SpringCloud-H/">https://zeroornull.github.io/2021/05/18/SpringCloud-H/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Zeroornull</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-05-18</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-07-28</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/SpringCloud/">SpringCloud</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=60667abe39329f00123aea68&amp;product=sticky-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" href="https://www.afdian.net/@zeroornull" target="_blank" rel="noopener" data-type="afdian"><span class="icon is-small"><i class="fas fa-charging-station"></i></span><span>爱发电</span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="https://qr.alipay.com/fkx00721flijbw5hdn0kab5" alt="支付宝"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/06/01/LeetCode%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">LeetCode刷题笔记</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/05/16/redis%E7%AC%94%E8%AE%B0/"><span class="level-item">最近的Redis笔记</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://z3.ax1x.com/2021/07/27/WhycSH.gif" alt="Zeroornull"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Zeroornull</p><p class="is-size-6 is-block">just one newbie</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>ShangHai</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">18</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">13</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">13</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/zeroornull" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zeroornull"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="SinaBlog" href="https://weibo.com/u/3027767592"><i class="fa-brands fa-weibo"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#前言"><span class="level-left"><span class="level-item">1</span><span class="level-item">前言</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#第1章-微服务介绍"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">第1章 微服务介绍</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-课程介绍"><span class="level-left"><span class="level-item">1.1.1</span><span class="level-item">1. 课程介绍</span></span></a></li><li><a class="level is-mobile" href="#2-微服务介绍"><span class="level-left"><span class="level-item">1.1.2</span><span class="level-item">2 微服务介绍</span></span></a></li><li><a class="level is-mobile" href="#3-Spring-Cloud-介绍"><span class="level-left"><span class="level-item">1.1.3</span><span class="level-item">3. Spring Cloud 介绍</span></span></a></li><li><a class="level is-mobile" href="#4-Spring-Cloud-体系"><span class="level-left"><span class="level-item">1.1.4</span><span class="level-item">4. Spring Cloud 体系</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第2章-服务注册中心"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">第2章 服务注册中心</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#5-Eureka-注册中心"><span class="level-left"><span class="level-item">1.2.1</span><span class="level-item">5.Eureka 注册中心</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第3章-服务注册与消费"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">第3章  服务注册与消费</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-1-服务注册"><span class="level-left"><span class="level-item">1.3.1</span><span class="level-item">6.1 服务注册</span></span></a></li><li><a class="level is-mobile" href="#6-2-服务消费"><span class="level-left"><span class="level-item">1.3.2</span><span class="level-item">6.2 服务消费</span></span></a></li><li><a class="level is-mobile" href="#6-3-RestTemplate"><span class="level-left"><span class="level-item">1.3.3</span><span class="level-item">6.3 RestTemplate</span></span></a></li><li><a class="level is-mobile" href="#6-4-客户端负载均衡"><span class="level-left"><span class="level-item">1.3.4</span><span class="level-item">6.4 客户端负载均衡</span></span></a></li><li><a class="level is-mobile" href="#6-5-负载均衡原理"><span class="level-left"><span class="level-item">1.3.5</span><span class="level-item">6.5 负载均衡原理</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第4章-Consul"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">第4章 Consul</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#7-1-安装"><span class="level-left"><span class="level-item">1.4.1</span><span class="level-item">7.1 安装</span></span></a></li><li><a class="level is-mobile" href="#7-2-Consul-使用"><span class="level-left"><span class="level-item">1.4.2</span><span class="level-item">7.2 Consul 使用</span></span></a></li><li><a class="level is-mobile" href="#7-3-Consul-集群注册"><span class="level-left"><span class="level-item">1.4.3</span><span class="level-item">7.3 Consul 集群注册</span></span></a></li><li><a class="level is-mobile" href="#7-4-消费"><span class="level-left"><span class="level-item">1.4.4</span><span class="level-item">7.4 消费</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第5章-Hystrix"><span class="level-left"><span class="level-item">1.5</span><span class="level-item">第5章 Hystrix</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#8-1-基本介绍"><span class="level-left"><span class="level-item">1.5.1</span><span class="level-item">8.1 基本介绍</span></span></a></li><li><a class="level is-mobile" href="#8-2-基本用法"><span class="level-left"><span class="level-item">1.5.2</span><span class="level-item">8.2 基本用法</span></span></a></li><li><a class="level is-mobile" href="#8-3-请求命令"><span class="level-left"><span class="level-item">1.5.3</span><span class="level-item">8.3 请求命令</span></span></a></li><li><a class="level is-mobile" href="#8-4-异常处理"><span class="level-left"><span class="level-item">1.5.4</span><span class="level-item">8.4 异常处理</span></span></a></li><li><a class="level is-mobile" href="#8-5-请求缓存"><span class="level-left"><span class="level-item">1.5.5</span><span class="level-item">8.5 请求缓存</span></span></a></li><li><a class="level is-mobile" href="#8-6-请求合并"><span class="level-left"><span class="level-item">1.5.6</span><span class="level-item">8.6 请求合并</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第6章-OpenFeign"><span class="level-left"><span class="level-item">1.6</span><span class="level-item">第6章 OpenFeign</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#9-1-OpenFeign"><span class="level-left"><span class="level-item">1.6.1</span><span class="level-item">9.1 OpenFeign</span></span></a></li><li><a class="level is-mobile" href="#9-2-参数传递"><span class="level-left"><span class="level-item">1.6.2</span><span class="level-item">9.2 参数传递</span></span></a></li><li><a class="level is-mobile" href="#9-3-继承特性"><span class="level-left"><span class="level-item">1.6.3</span><span class="level-item">9.3 继承特性</span></span></a></li><li><a class="level is-mobile" href="#9-4-日志"><span class="level-left"><span class="level-item">1.6.4</span><span class="level-item">9.4 日志</span></span></a></li><li><a class="level is-mobile" href="#9-5-数据压缩"><span class="level-left"><span class="level-item">1.6.5</span><span class="level-item">9.5 数据压缩</span></span></a></li><li><a class="level is-mobile" href="#9-6-Hystrix"><span class="level-left"><span class="level-item">1.6.6</span><span class="level-item">9.6 +Hystrix</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第7章-Resilience4j"><span class="level-left"><span class="level-item">1.7</span><span class="level-item">第7章 Resilience4j</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#10-1-Resilience4j-简介"><span class="level-left"><span class="level-item">1.7.1</span><span class="level-item">10.1 Resilience4j 简介</span></span></a></li><li><a class="level is-mobile" href="#10-2-基本用法"><span class="level-left"><span class="level-item">1.7.2</span><span class="level-item">10.2 基本用法</span></span></a></li><li><a class="level is-mobile" href="#10-3-结合微服务"><span class="level-left"><span class="level-item">1.7.3</span><span class="level-item">10.3 结合微服务</span></span></a></li><li><a class="level is-mobile" href="#10-4-服务监控"><span class="level-left"><span class="level-item">1.7.4</span><span class="level-item">10.4 服务监控</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第8章-Zuul"><span class="level-left"><span class="level-item">1.8</span><span class="level-item">第8章 Zuul</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#11-1-服务网关"><span class="level-left"><span class="level-item">1.8.1</span><span class="level-item">11.1 服务网关</span></span></a></li><li><a class="level is-mobile" href="#11-2-Zuul"><span class="level-left"><span class="level-item">1.8.2</span><span class="level-item">11.2 Zuul</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第9章-Spring-Cloud-Gateway"><span class="level-left"><span class="level-item">1.9</span><span class="level-item">第9章 Spring Cloud Gateway</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#12-1-简介"><span class="level-left"><span class="level-item">1.9.1</span><span class="level-item">12.1 简介</span></span></a></li><li><a class="level is-mobile" href="#12-2-基本用法"><span class="level-left"><span class="level-item">1.9.2</span><span class="level-item">12.2 基本用法</span></span></a></li><li><a class="level is-mobile" href="#12-3-Predicate"><span class="level-left"><span class="level-item">1.9.3</span><span class="level-item">12.3 Predicate</span></span></a></li><li><a class="level is-mobile" href="#12-4-Filter"><span class="level-left"><span class="level-item">1.9.4</span><span class="level-item">12.4 Filter</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第10章-Spring-Cloud-Config"><span class="level-left"><span class="level-item">1.10</span><span class="level-item">第10章 Spring Cloud Config</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#13-1-基本用法"><span class="level-left"><span class="level-item">1.10.1</span><span class="level-item">13.1 基本用法</span></span></a></li><li><a class="level is-mobile" href="#13-2-配置文件加解密-这个得看视频了-sob"><span class="level-left"><span class="level-item">1.10.2</span><span class="level-item">13.2 配置文件加解密(这个得看视频了)😭</span></span></a></li><li><a class="level is-mobile" href="#13-3-安全管理"><span class="level-left"><span class="level-item">1.10.3</span><span class="level-item">13.3 安全管理</span></span></a></li><li><a class="level is-mobile" href="#13-4-服务化"><span class="level-left"><span class="level-item">1.10.4</span><span class="level-item">13.4 服务化</span></span></a></li><li><a class="level is-mobile" href="#13-5-动态刷新"><span class="level-left"><span class="level-item">1.10.5</span><span class="level-item">13.5 动态刷新</span></span></a></li><li><a class="level is-mobile" href="#13-6-请求失败重试"><span class="level-left"><span class="level-item">1.10.6</span><span class="level-item">13.6 请求失败重试</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第11章-Spring-Cloud-Bus"><span class="level-left"><span class="level-item">1.11</span><span class="level-item">第11章.Spring Cloud Bus</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/DeepLearning/"><span class="level-start"><span class="level-item">DeepLearning</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/SpringCloud/"><span class="level-start"><span class="level-item">SpringCloud</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/db2/"><span class="level-start"><span class="level-item">db2</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/eladmin/"><span class="level-start"><span class="level-item">eladmin</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/es/"><span class="level-start"><span class="level-item">es</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/githubpage/"><span class="level-start"><span class="level-item">githubpage</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/linux/"><span class="level-start"><span class="level-item">linux</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/nginx/"><span class="level-start"><span class="level-item">nginx</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/redis/"><span class="level-start"><span class="level-item">redis</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/sql/"><span class="level-start"><span class="level-item">sql</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/vue/"><span class="level-start"><span class="level-item">vue</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%B0%8F%E5%AD%A6%E7%94%9F%E4%BD%9C%E6%96%87-%E6%88%91%E7%9A%84%E7%94%9F%E6%B4%BB/"><span class="level-start"><span class="level-item">小学生作文-我的生活</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%AE%97%E6%B3%95/"><span class="level-start"><span class="level-item">算法</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-03T15:40:07.000Z">2021-08-03</time></p><p class="title"><a href="/2021/08/03/%E8%B7%AF%E4%B8%8A%E7%9A%84%E7%8B%97%E5%AD%90/">路上的狗子</a></p><p class="categories"><a href="/categories/%E5%B0%8F%E5%AD%A6%E7%94%9F%E4%BD%9C%E6%96%87-%E6%88%91%E7%9A%84%E7%94%9F%E6%B4%BB/">小学生作文-我的生活</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-29T14:25:07.000Z">2021-07-29</time></p><p class="title"><a href="/2021/07/29/%E6%99%9A%E4%B8%8A10%E7%82%B9%E5%87%BA%E9%97%A8%E6%90%9E%E5%A4%9C%E5%AE%B5/">晚上10点出门搞夜宵</a></p><p class="categories"><a href="/categories/%E5%B0%8F%E5%AD%A6%E7%94%9F%E4%BD%9C%E6%96%87-%E6%88%91%E7%9A%84%E7%94%9F%E6%B4%BB/">小学生作文-我的生活</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-26T06:00:16.000Z">2021-07-26</time></p><p class="title"><a href="/2021/07/26/%E4%BD%BF%E7%94%A8cloudflare%E5%8A%A0%E9%80%9FgithubPage/">使用cloudflare免费加速github page</a></p><p class="categories"><a href="/categories/githubpage/">githubpage</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-23T00:52:07.000Z">2021-07-23</time></p><p class="title"><a href="/2021/07/23/%E9%B8%B5%E9%B8%9F%E8%9B%8B/">鸵鸟蛋</a></p><p class="categories"><a href="/categories/%E5%B0%8F%E5%AD%A6%E7%94%9F%E4%BD%9C%E6%96%87-%E6%88%91%E7%9A%84%E7%94%9F%E6%B4%BB/">小学生作文-我的生活</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-06-25T07:07:08.000Z">2021-06-25</time></p><p class="title"><a href="/2021/06/25/%E6%94%B9%E9%80%A0eladmin%E4%B8%BA%E5%89%8D%E5%90%8E%E7%AB%AF%E4%B8%80%E8%B5%B7%E9%83%A8%E7%BD%B2/">改造eladmin为前后端一起部署</a></p><p class="categories"><a href="/categories/eladmin/">eladmin</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/DeepLearning/"><span class="tag">DeepLearning</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringCloud/"><span class="tag">SpringCloud</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/db2/"><span class="tag">db2</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/eladmin/"><span class="tag">eladmin</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/es/"><span class="tag">es</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/githubpage/"><span class="tag">githubpage</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sql/"><span class="tag">sql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vue/"><span class="tag">vue</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B0%8F%E5%AD%A6%E7%94%9F%E4%BD%9C%E6%96%87-%E6%88%91%E7%9A%84%E7%94%9F%E6%B4%BB/"><span class="tag">小学生作文-我的生活</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%AE%97%E6%B3%95/"><span class="tag">算法</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Zeroornull</a><p class="is-size-7"><span>&copy; 2021 Zeroornull</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><a href="http://www.beian.miit.gov.cn/" target="_blank">皖ICP备2021011041号-1</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>